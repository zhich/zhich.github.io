<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="uhuV0rnYMUWuzeZrPSHxh_QSZ6tM5AWsUD-fXyEVOOc">
  <meta name="baidu-site-verification" content="codeva-jBfPQBw271">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-mac-osx.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"zhich.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.20.0","exturl":true,"sidebar":{"position":"right","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"default"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"giscus","storage":true,"lazyload":true,"nav":null},"stickytabs":true,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":true}}</script><script src="/js/config.js"></script>

    <meta name="description" content="终身学习者。">
<meta property="og:type" content="blog">
<meta property="og:title" content="明年今日">
<meta property="og:url" content="https://zhich.github.io/index.html">
<meta property="og:site_name" content="明年今日">
<meta property="og:description" content="终身学习者。">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="明年今日">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://zhich.github.io/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>明年今日</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">明年今日</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-links"><a href="/links/" rel="section"><i class="fa fa-globe fa-fw fa-fw"></i>links</a></li><li class="menu-item menu-item-happy"><a href="/happy/" rel="section"><i class="fa fa-th fa-fw"></i>happy</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="明年今日"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">明年今日</p>
  <div class="site-description" itemprop="description">终身学习者。</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">27</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3poaWNo" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zhich"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="bWFpbHRvOnpoaWNoMTEyMTM0QGdtYWlsLmNvbQ==" title="E-Mail → mailto:zhich112134@gmail.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</span>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/big/by_nc_sa.svg" alt="Creative Commons"></span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zhich.github.io/2024/05/18/%E9%B8%BF%E8%92%99%E5%BC%80%E5%8F%91%E6%95%99%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="明年今日">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="明年今日">
      <meta itemprop="description" content="终身学习者。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 明年今日">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/18/%E9%B8%BF%E8%92%99%E5%BC%80%E5%8F%91%E6%95%99%E7%A8%8B/" class="post-title-link" itemprop="url">鸿蒙开发教程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-05-18 11:17:00" itemprop="dateCreated datePublished" datetime="2024-05-18T11:17:00+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-06-15 00:14:32" itemprop="dateModified" datetime="2024-06-15T00:14:32+08:00">2024-06-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E9%B8%BF%E8%92%99%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">鸿蒙开发</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <meta name="referrer" content="no-referrer" />



<h3 id="HarmonyOS-项目目录介绍"><a href="#HarmonyOS-项目目录介绍" class="headerlink" title="HarmonyOS 项目目录介绍"></a>HarmonyOS 项目目录介绍</h3><h3 id="ArkTS-基本语法详解"><a href="#ArkTS-基本语法详解" class="headerlink" title="ArkTS 基本语法详解"></a>ArkTS 基本语法详解</h3><p>HarmonyOS 4.0 以后可以使用 ArkTS 或者 HTML&#x2F;CSS&#x2F;JS 技术来开发 HarmonyOS 应用，而 ArkTS 是 HarmonyOS 优选的主力应用开发语言。  </p>
<p>ArkTS 围绕应用开发在 TypeScript（简称 TS）生态基础上做了进一步扩展，继承了 TS 的所有特性，是 TS 的超集。因此，在学习 ArkTS 语言之前，建议首先具<br>备 TS 语言开发能力。</p>
<p>当前，ArkTS 在 TS 的基础上主要扩展了如下能力：</p>
<ul>
<li><strong>基本语法</strong>：ArkTS 定义了声明式 UI 描述、自定义组件和动态扩展 UI 元素的能力，再配合 ArkUI 开发框架中的系统组件及其相关的事件方法、属性方法等共同构成了 UI 开发的主体。</li>
<li><strong>状态管理</strong>：ArkTS 提供了多维度的状态管理机制。在 UI 开发框架中，与 UI 相关联的数据可以在组件内使用，也可以在不同组件层级间传递，比如父子组件之间、爷孙组件之间，还可以在应用全局范围内传递或跨设备传递。另外，从数据的传递形式来看，可分为只读的单向传递和可变更的双向传递。开发者可以灵活的利用这些能力来实现数据和 UI 的联动。</li>
<li><strong>渲染控制</strong>：ArkTS 提供了渲染控制的能力。条件渲染可根据应用的不同状态，渲染对应状态下的 UI 内容。循环渲染可从数据源中迭代获取数据，并在每次迭代过程中创建相应的组件。数据懒加载从数据源中按需迭代数据，并在每次迭代过程中创建相应的组件。</li>
</ul>
<p>未来，ArkTS 会结合应用开发&#x2F;运行的需求持续演进，逐步提供并行和并发能力增强、系统类型增强、分布式开发范式等更多特性。  </p>
<h4 id="ArkTS-基本组成"><a href="#ArkTS-基本组成" class="headerlink" title="ArkTS 基本组成"></a>ArkTS 基本组成</h4><img data-src="https://gitee.com/zch0304/images/raw/master/note/1716005497787.jpg" style="zoom:50%;" /> 

<ul>
<li><strong>装饰器</strong>： 用于装饰类、结构、方法以及变量，并赋予其特殊的含义。如上述示例中 @Entry、@Component 和 @State 都是装饰器，@Component 表示自定义组件，@Entry 表示该自定义组件为入口组件，@State 表示组件中的状态变量，状态变量变化会触发 UI 刷新。  </li>
<li><strong>自定义组件</strong>：可复用的 UI 单元，可组合其它组件，如上述被 @Component 装饰的 struct Index。  </li>
<li><strong>UI 描述</strong>：以声明式的方式来描述 UI 的结构，例如 build() 方法中的代码块  。</li>
<li><strong>系统组件</strong>：ArkUI 框架中默认内置的基础和容器组件，可直接被开发者调用，比如示例中的 Column、Text、Divider、Button。  </li>
<li><strong>事件方法</strong>：组件可以通过链式调用设置多个事件的响应逻辑，如跟随在 Button 后面的 onClick()。  </li>
<li><strong>属性方法</strong>：组件可以通过链式调用配置多项属性，如 fontSize()、width()、height()、backgroundColor() 等。</li>
</ul>
<p>系统组件、属性方法、事件方法具体使用可参考<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuaHVhd2VpLmNvbS9jb25zdW1lci9jbi9kb2MvaGFybW9ueW9zLXJlZmVyZW5jZXMtVjIvdHMtY29tcG9uZW50cy1zdW1tYXJ5LTAwMDAwMDE0NzgxODEzNjktVjI=">基于 ArkTS 的声明式开发范式<i class="fa fa-external-link-alt"></i></span>。</p>
<h4 id="ArkTS-布局结构"><a href="#ArkTS-布局结构" class="headerlink" title="ArkTS 布局结构"></a>ArkTS 布局结构</h4><p>布局的结构通常是分层级的，代表了用户界面中的整体架构。一个常见的页面结构如下所示：</p>
<img data-src="https://gitee.com/zch0304/images/raw/master/note/1716013357130.jpg" style="zoom:50%;" /> 

<p>为实现上述效果，需要在页面中声明对应的元素。其中，Page 表示页面的根节点，Column&#x2F;Row 等元素为系统组件。针对不同的页面结构，ArkUI 提供了不同的布局组件来帮助我们实现对应布局的效果，例如 Row 用于实现线性布局等。  </p>
<h4 id="ArkTS-数据类型"><a href="#ArkTS-数据类型" class="headerlink" title="ArkTS 数据类型"></a>ArkTS 数据类型</h4><p>TypeScript 支持一些基础的数据类型，如布尔型、数组、字符串等。</p>
<h5 id="数字"><a href="#数字" class="headerlink" title="数字"></a>数字</h5><p>TypeScript 里的所有数字都是浮点数，这些浮点数的类型是 <code>number</code>。除了支持十进制，还支持二进制、八进制、十六进制。  </p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数值类型</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">num1</span>: <span class="built_in">number</span> = <span class="number">18</span> <span class="comment">// 十进制</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">num2</span>: <span class="built_in">number</span> = <span class="number">0b10111</span> <span class="comment">// ob 二进制</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">num3</span>: <span class="built_in">number</span> = <span class="number">0o14</span> <span class="comment">// 0o 八进制</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">num4</span>: <span class="built_in">number</span> = <span class="number">0x1f</span> <span class="comment">// 0x 十六进制</span></span><br></pre></td></tr></table></figure>

<h5 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h5><p>TypeScript 里使用 <code>string</code> 表示文本数据类型， 可以使用双引号（ “ ）或单引号（ ‘ ）表示字符串或者反引号（&#96;）。</p>
<blockquote>
<p>反引号中可以配合 ${} 解析变量。</p>
</blockquote>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 字符串类型</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">str1</span>: <span class="built_in">string</span> = <span class="string">&#x27;HarmonyOS Next不支持Android 应用了&#x27;</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">str2</span>: <span class="built_in">string</span> = <span class="string">&quot;ArkTS&quot;</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">str3</span>: <span class="built_in">string</span> = <span class="string">`马总今年<span class="subst">$&#123;num1&#125;</span>岁了`</span></span><br></pre></td></tr></table></figure>

<h5 id="布尔值"><a href="#布尔值" class="headerlink" title="布尔值"></a>布尔值</h5><p>TypeScript 中可以使用 <code>boolean</code> 来表示这个变量是布尔值，可以赋值为 true 或者 false。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 布尔类型 true、false</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">stateOn</span>: <span class="built_in">boolean</span> = <span class="literal">true</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">stateOff</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h5 id="联合类型"><a href="#联合类型" class="headerlink" title="联合类型"></a>联合类型</h5><p>联合类型（Union Types）表示取值可以为多种类型中的一种。如果一个数据可能有多重类型，或者当下还没想好用哪个类型 …</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">flag</span>: <span class="built_in">string</span> | <span class="built_in">number</span> | <span class="built_in">boolean</span></span><br><span class="line">flag = <span class="string">&#x27;1&#x27;</span></span><br><span class="line">flag = <span class="number">1</span></span><br><span class="line">flag = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h5 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h5><p>TypeScrip 有两种方式可以定义数组。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 第一种是使用数组泛型，Array&lt;元素类型&gt;。</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">course1</span>: <span class="title class_">Array</span>&lt;<span class="built_in">string</span>&gt; = [<span class="string">&#x27;Flutter&#x27;</span>, <span class="string">&quot;HarmonyOS&quot;</span>, <span class="string">`Golang`</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第二种是在元素类型后面接上 []，表示由此类型元素组成的一个数组。</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">course2</span>: <span class="built_in">string</span>[] = [<span class="string">&#x27;Flutter&#x27;</span>, <span class="string">&quot;HarmonyOS&quot;</span>, <span class="string">`Golang`</span>]</span><br></pre></td></tr></table></figure>

<h5 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h5><p>enum 类型是对 JavaScript 标准数据类型的一个补充，使用枚举类型可以为一组数值赋予友好的名字。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Color</span> &#123;<span class="title class_">Red</span>, <span class="title class_">Green</span>, <span class="title class_">Blue</span>&#125;</span><br><span class="line"><span class="keyword">let</span> <span class="attr">c</span>: <span class="title class_">Color</span> = <span class="title class_">Color</span>.<span class="property">Green</span></span><br></pre></td></tr></table></figure>

<h5 id="元组"><a href="#元组" class="headerlink" title="元组"></a>元组</h5><p>元组类型允许表示一个已知元素数量和类型的数组，各元素的类型不必相同。 比如，你可以定义一对值分别为 string 和 number 类型的元组。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">x</span>: [<span class="built_in">string</span>, <span class="built_in">number</span>]</span><br><span class="line">x = [<span class="string">&#x27;hello&#x27;</span>, <span class="number">10</span>] <span class="comment">// OK</span></span><br><span class="line">x = [<span class="number">10</span>, <span class="string">&#x27;hello&#x27;</span>] <span class="comment">// Error</span></span><br></pre></td></tr></table></figure>

<h5 id="Any（不推荐使用）"><a href="#Any（不推荐使用）" class="headerlink" title="Any（不推荐使用）"></a>Any（不推荐使用）</h5><p>any 类型，表示的是变量可以是任意类型，相当于关闭了 ts 的类型检测功能，不建议使用。如果是 any 类型，则允许被赋值为任意类型。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">a</span>: <span class="built_in">any</span> = <span class="number">666</span></span><br><span class="line">a = <span class="string">&quot;Semlinker&quot;</span> <span class="comment">// 通过，any 类型可以被赋任意值</span></span><br><span class="line">a = <span class="literal">false</span> <span class="comment">// 通过，any 类型可以被赋任意值</span></span><br><span class="line">a = <span class="number">66</span> <span class="comment">// 通过，any 类型可以被赋任意值</span></span><br><span class="line">a = <span class="literal">undefined</span> <span class="comment">// 通过，any 类型可以被赋任意值</span></span><br><span class="line">a = <span class="literal">null</span> <span class="comment">// 通过，any 类型可以被赋任意值</span></span><br><span class="line">a = [] <span class="comment">// 通过，any 类型可以被赋任意值</span></span><br><span class="line">a = &#123;&#125; <span class="comment">// 通过，any 类型可以被赋任意值</span></span><br></pre></td></tr></table></figure>

<h5 id="Unknown"><a href="#Unknown" class="headerlink" title="Unknown"></a>Unknown</h5><p>unknown 与 any 一样，也相当于关闭了 ts 的类型检测功能。有时候，我们会想要为那些在编程阶段还不清楚类型的变量指定一个类型。这种情况下，我们不希望类型检查器对这些值进行检查而是直接让它们通过编译阶段的检查。那么我们可以使用 unknown 类型来标记这些变量。（同 any ）。</p>
 <figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">notSure</span>: <span class="built_in">unknown</span> = <span class="number">4</span></span><br><span class="line">notSure = <span class="string">&#x27;maybe a string instead&#x27;</span></span><br><span class="line">notSure = <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h5 id="Void"><a href="#Void" class="headerlink" title="Void"></a>Void</h5><p>当一个函数没有返回值时，你通常会见到其返回值类型是 void。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;This is function is void&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Null-和-Undefined"><a href="#Null-和-Undefined" class="headerlink" title="Null 和 Undefined"></a>Null 和 Undefined</h5><p>TypeScript 里，null 和 undefined 两者各自有自己的类型分别叫做 null 和 undefined。  </p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">u</span>: <span class="literal">undefined</span> = <span class="literal">undefined</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">n</span>: <span class="literal">null</span> = <span class="literal">null</span></span><br></pre></td></tr></table></figure>

<h4 id="ArkTS-渲染控制"><a href="#ArkTS-渲染控制" class="headerlink" title="ArkTS 渲染控制"></a>ArkTS 渲染控制</h4><h5 id="if-else：条件渲染"><a href="#if-else：条件渲染" class="headerlink" title="if&#x2F;else：条件渲染"></a>if&#x2F;else：条件渲染</h5><ul>
<li>支持 if、else 和 else if 语句。</li>
<li>if、else if 后跟随的条件语句可以使用状态变量。</li>
<li>允许在容器组件内使用，通过条件渲染语句构建不同的子组件。</li>
<li>当 if、else if 后跟随的状态判断中使用的状态变量值变化时，条件渲染语句会进行更新条件可以包括 Typescript 表达式。</li>
</ul>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (条件表达式) &#123;</span><br><span class="line">  组件内容<span class="number">1</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  组件内容<span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ForEach：循环渲染"><a href="#ForEach：循环渲染" class="headerlink" title="ForEach：循环渲染"></a>ForEach：循环渲染</h5><p>ForEach 接口基于数组类型数据来进行循环渲染，需要与容器组件配合使用，且接口返回的组件应当是允许包含在 ForEach 父容器组件中的子组件。例如，ListItem 组件要求 ForEach 的父容器组件必须为 List 组件。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> arr 要遍历的数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> itemGenerator 页面的生成函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> keyGenerator 键生成函数，提供唯一标识，如果后续数组中数据发生变化，会判断元素的唯一标识是否发生变化，有变更再去做渲染，这样减少了不必要的渲染，提高了页面的渲染效率（可选参数，如果不填会会有默认的键生成函数，生成规则是用角标拼上数组元素的数据）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title class_">ForEach</span>(</span><br><span class="line">  <span class="attr">arr</span>:<span class="title class_">Array</span>&lt;<span class="built_in">any</span>&gt;,</span><br><span class="line">  <span class="attr">itemGenerator</span>:<span class="function">(<span class="params">item: <span class="built_in">any</span>, index: <span class="built_in">number</span></span>) =&gt;</span> <span class="built_in">void</span>,</span><br><span class="line">  keyGenerator ? : <span class="function">(<span class="params">item: <span class="built_in">any</span>, index: <span class="built_in">number</span></span>) =&gt;</span> <span class="built_in">string</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">arr</span>: <span class="built_in">number</span>[] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">8</span>, <span class="number">16</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">ArrayPage</span> &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="attr">arr2</span>: <span class="built_in">string</span>[] = [<span class="string">&#x27;HarmonyOS&#x27;</span>, <span class="string">&#x27;Flutter&#x27;</span>, <span class="string">&#x27;Android&#x27;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">List</span>(&#123; <span class="attr">space</span>: <span class="number">10</span> &#125;) &#123;</span><br><span class="line">      <span class="comment">// 访问全局变量 arr 不要加 this</span></span><br><span class="line">      <span class="title class_">ForEach</span>(arr, <span class="function">(<span class="params">item: <span class="built_in">number</span>, key: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="title class_">ListItem</span>() &#123;</span><br><span class="line">          <span class="title class_">Text</span>(<span class="string">`<span class="subst">$&#123;item&#125;</span>--<span class="subst">$&#123;key&#125;</span>`</span>)</span><br><span class="line">            .<span class="title function_">fontSize</span>(<span class="number">20</span>)</span><br><span class="line">            .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">            .<span class="title function_">height</span>(<span class="number">50</span>)</span><br><span class="line">            .<span class="title function_">textAlign</span>(<span class="title class_">TextAlign</span>.<span class="property">Center</span>)</span><br><span class="line">            .<span class="title function_">backgroundColor</span>(<span class="string">&quot;#eee&quot;</span>)</span><br><span class="line">            .<span class="title function_">borderRadius</span>(<span class="number">10</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, <span class="function">(<span class="params">item: <span class="built_in">number</span></span>) =&gt;</span> item.<span class="title function_">toString</span>())</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 访问局部变量 arr2 要加 this</span></span><br><span class="line">      <span class="title class_">ForEach</span>(<span class="variable language_">this</span>.<span class="property">arr2</span>, <span class="function">(<span class="params">item: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="title class_">ListItem</span>() &#123;</span><br><span class="line">          <span class="title class_">Text</span>(item)</span><br><span class="line">            .<span class="title function_">fontSize</span>(<span class="number">20</span>)</span><br><span class="line">            .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">            .<span class="title function_">height</span>(<span class="number">50</span>)</span><br><span class="line">            .<span class="title function_">textAlign</span>(<span class="title class_">TextAlign</span>.<span class="property">Center</span>)</span><br><span class="line">            .<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Gray</span>)</span><br><span class="line">            .<span class="title function_">borderRadius</span>(<span class="number">10</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, <span class="function">(<span class="params">item: <span class="built_in">string</span></span>) =&gt;</span> item)</span><br><span class="line">    &#125;.<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    .<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    .<span class="title function_">padding</span>(<span class="number">10</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>实际开发中尽量不要使用全局变量，组件中使用全局变量不需要加 this。</p>
</blockquote>
<h5 id="LazyForEach：数据懒加载"><a href="#LazyForEach：数据懒加载" class="headerlink" title="LazyForEach：数据懒加载"></a>LazyForEach：数据懒加载</h5><p>LazyForEach 从提供的数据源中按需迭代数据，并在每次迭代过程中创建相应的组件。当 LazyForEach 在滚动容器中使用，框架会根据滚动容器可视区域按需创建组件，当组件滑出可视区域外时，框架会进行组件销毁回收以降低内存占用。</p>
<h3 id="布局组件"><a href="#布局组件" class="headerlink" title="布局组件"></a>布局组件</h3><h4 id="ArkTS-通用属性"><a href="#ArkTS-通用属性" class="headerlink" title="ArkTS 通用属性"></a>ArkTS 通用属性</h4><p>ArkTS 通用属性用于设置组件的宽高、边距。</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>参数说明</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>width</td>
<td>Length</td>
<td>设置组件自身的宽度，缺省时使用元素自身内容需要 的宽度。若子组件的宽大于父组件的宽，则会画出父 组件的范围。从 API version 9 开始，该接口支持在 ArkTS 卡片中使用。</td>
</tr>
<tr>
<td>height</td>
<td>Length</td>
<td>设置组件自身的高度，缺省时使用元素自身内容需要 的高度。若子组件的高大于父组件的高，则会画出父 组件的范围。从 API version 9 开始，该接口支持在 ArkTS 卡片中使用。</td>
</tr>
<tr>
<td>size</td>
<td>{   width ? : Length,   height ? : Length }</td>
<td>设置高宽尺寸。</td>
</tr>
<tr>
<td>padding</td>
<td>Padding &#124; Length</td>
<td>设置内边距属性。参数为 Length 类型时，四个方向内边距同时生效。默认值：0。padding 设置百分比时，上下左右内边距均以父容器的 width 作为基础值。从 API version 9 开始，该接口支持在 ArkTS 卡片中使用。</td>
</tr>
<tr>
<td>margin</td>
<td>Margin &#124; Length</td>
<td>设置外边距属性。参数为 Length 类型时，四个方向外边距同时生效。默认值：0。margin 设置百分比时，上下左右外边距均以父容器的 width 作为基础值。从 API version 9 开始，该接口支持在 ArkTS 卡片中使用。</td>
</tr>
<tr>
<td>constraintSize</td>
<td>{   minWidth ? : Length,   maxWidth ? : Length,   minHeight ? : Length,   maxHeight ? : Length }</td>
<td>设置约束尺寸，组件布局时，进行尺寸范围限制。 constraintSize 的优先级高于 Width 和 Height。若设置的 minWidth 大于 maxWidth，则 minWidth 生效， minHeight 与 maxHeight 同理。默认值：{   minWidth: 0, maxWidth:   Infinity, minHeight:   0, maxHeight:   Infinity }。</td>
</tr>
</tbody></table>
<p><strong>Length 长度类型，用于描述尺寸单位。</strong></p>
<table>
<thead>
<tr>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>string</td>
<td>需要显式指定像素单位，如 ‘10px’，也可设置百分比字符串，如 ‘100%’。</td>
</tr>
<tr>
<td>number</td>
<td>默认单位 vp。</td>
</tr>
<tr>
<td>Resource</td>
<td>资源引用类型，引入系统资源或者应用资源中的尺寸。</td>
</tr>
</tbody></table>
<p><strong>vp 为虚拟像素单位</strong>：vp 使用虚拟像素，使元素在不同密度的设备上具有一致的视觉体量。</p>
<p><strong>fp 字体像素单位</strong>：字体像素（font pixel）大小默认情况下与 vp 相同，即默认情况下 1 fp &#x3D; 1 vp。如果用户在设置中选择了更大的字体，字体的实际显示大小就会在 vp 的基础上乘以用户设置的缩放系数，即 1 fp &#x3D; 1 vp * 缩放系数。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Index</span> &#123;</span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>(&#123; <span class="attr">space</span>: <span class="number">10</span> &#125;) &#123;</span><br><span class="line">      <span class="title class_">Row</span>() &#123;</span><br><span class="line">        <span class="comment">// 宽度 200，高度 200，外边距 20（蓝色区域），内边距 10（白色区域）</span></span><br><span class="line">        <span class="title class_">Row</span>() &#123;</span><br><span class="line">          <span class="title class_">Row</span>().<span class="title function_">size</span>(&#123;</span><br><span class="line">            <span class="attr">width</span>: <span class="string">&#x27;100%&#x27;</span>, <span class="attr">height</span>: <span class="string">&#x27;100%&#x27;</span></span><br><span class="line">          &#125;).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Yellow</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        .<span class="title function_">width</span>(<span class="number">200</span>)</span><br><span class="line">        .<span class="title function_">height</span>(<span class="number">200</span>)</span><br><span class="line">        .<span class="title function_">padding</span>(<span class="number">10</span>)</span><br><span class="line">        .<span class="title function_">margin</span>(<span class="number">20</span>)</span><br><span class="line">        .<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">White</span>)</span><br><span class="line">      &#125;.<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Blue</span>)</span><br><span class="line"></span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">`This is a text.This is a text.This is a text.This is a text.This is a text`</span>)</span><br><span class="line">        .<span class="title function_">width</span>(<span class="string">&#x27;90%&#x27;</span>)</span><br><span class="line">        .<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Orange</span>)</span><br><span class="line">        .<span class="title function_">constraintSize</span>(&#123; <span class="attr">maxWidth</span>: <span class="number">200</span> &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 父容器尺寸确定时，设置了 layoutWeight 的子元素在主轴布局尺寸按照权重进行分配，忽略本身尺寸设置。</span></span><br><span class="line">      <span class="title class_">Row</span>() &#123;</span><br><span class="line">        <span class="comment">// 权重 1，占主轴剩余空间 1/3</span></span><br><span class="line">        <span class="title class_">Text</span>(<span class="string">&#x27;layoutWeight(1)&#x27;</span>)</span><br><span class="line">          .<span class="title function_">size</span>(&#123; <span class="attr">height</span>: <span class="number">110</span> &#125;)</span><br><span class="line">          .<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Orange</span>)</span><br><span class="line">          .<span class="title function_">textAlign</span>(<span class="title class_">TextAlign</span>.<span class="property">Center</span>)</span><br><span class="line">          .<span class="title function_">layoutWeight</span>(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 权重 2，占主轴剩余空间 2/3</span></span><br><span class="line">        <span class="title class_">Text</span>(<span class="string">&#x27;layoutWeight(2)&#x27;</span>)</span><br><span class="line">          .<span class="title function_">size</span>(&#123;</span><br><span class="line">            <span class="attr">width</span>: <span class="string">&#x27;30%&#x27;</span>, <span class="attr">height</span>: <span class="number">110</span></span><br><span class="line">          &#125;)</span><br><span class="line">          .<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Green</span>)</span><br><span class="line">          .<span class="title function_">textAlign</span>(<span class="title class_">TextAlign</span>.<span class="property">Center</span>)</span><br><span class="line">          .<span class="title function_">layoutWeight</span>(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 未设置 layoutWeight 属性，组件按照自身尺寸渲染</span></span><br><span class="line">        <span class="title class_">Text</span>(<span class="string">&#x27;no layoutWeight&#x27;</span>)</span><br><span class="line">          .<span class="title function_">size</span>(&#123;</span><br><span class="line">            <span class="attr">width</span>: <span class="string">&#x27;33%&#x27;</span>, <span class="attr">height</span>: <span class="number">110</span></span><br><span class="line">          &#125;)</span><br><span class="line">          .<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Brown</span>)</span><br><span class="line">          .<span class="title function_">textAlign</span>(<span class="title class_">TextAlign</span>.<span class="property">Center</span>)</span><br><span class="line">      &#125;.<span class="title function_">size</span>(&#123; <span class="attr">width</span>: <span class="string">&#x27;100%&#x27;</span>, <span class="attr">height</span>: <span class="number">140</span> &#125;)</span><br><span class="line">      .<span class="title function_">backgroundColor</span>(<span class="number">0xCCCCCC</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    .<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    .<span class="title function_">margin</span>(&#123; <span class="attr">top</span>: <span class="number">5</span> &#125;)</span><br><span class="line">    .<span class="title function_">alignItems</span>(<span class="title class_">HorizontalAlign</span>.<span class="property">Center</span>)</span><br><span class="line">    .<span class="title function_">justifyContent</span>(<span class="title class_">FlexAlign</span>.<span class="property">Start</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img data-src="https://gitee.com/zch0304/images/raw/master/note/1716389533793.jpg" style="zoom:80%;" /> 

<h4 id="Column-详解"><a href="#Column-详解" class="headerlink" title="Column 详解"></a>Column 详解</h4><p>Column 是沿垂直方向布局的容器，可以包含多个子组件，多个子组件会在垂直方向上按照顺序排列。</p>
<h5 id="Column-接口"><a href="#Column-接口" class="headerlink" title="Column 接口"></a>Column 接口</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Column</span>(value?: &#123;space?: <span class="built_in">string</span> | <span class="built_in">number</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>参数：</p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>参数类型</th>
<th>必填</th>
<th>参数描述</th>
</tr>
</thead>
<tbody><tr>
<td>space</td>
<td>string &#124; number</td>
<td>否</td>
<td>纵向布局元素垂直方向间距。从 API version 9 开始，space 为负数或者 justifyContent 设置为 FlexAlign.SpaceBetween、 FlexAlign.SpaceAround、FlexAlign.SpaceEvenly 时不生效。默认值：0，单位 vp。说明：可选值为大于等于 0 的数字，或者可以转换为数字的字符串。</td>
</tr>
</tbody></table>
<h5 id="Column-属性"><a href="#Column-属性" class="headerlink" title="Column 属性"></a>Column 属性</h5><table>
<thead>
<tr>
<th>名称</th>
<th>参数类型</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>alignItems</td>
<td>HorizontalAlign</td>
<td>设置子组件在水平方向上的对齐格式。默认值：HorizontalAlign.Center 从 API version 9 开始，该接口支持在 ArkTS 卡片中使用。</td>
</tr>
<tr>
<td>justifyContent8+</td>
<td>FlexAlign</td>
<td>设置子组件在垂直方向上的对齐格式。默认值：FlexAlign.Start 从 API version 9 开始，该接口支持在 ArkTS 卡片中使用。</td>
</tr>
</tbody></table>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Index</span> &#123;</span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>(&#123; <span class="attr">space</span>: <span class="number">10</span> &#125;) &#123;</span><br><span class="line">      <span class="title class_">Row</span>() &#123;</span><br><span class="line">        <span class="title class_">Image</span>($r(<span class="string">&#x27;app.media.app_icon&#x27;</span>)).<span class="title function_">width</span>(<span class="number">100</span>).<span class="title function_">height</span>(<span class="number">100</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      .<span class="title function_">width</span>(<span class="number">140</span>)</span><br><span class="line">      .<span class="title function_">height</span>(<span class="number">140</span>)</span><br><span class="line">      .<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Red</span>)</span><br><span class="line">      .<span class="title function_">alignItems</span>(<span class="title class_">VerticalAlign</span>.<span class="property">Center</span>)</span><br><span class="line">      .<span class="title function_">justifyContent</span>(<span class="title class_">FlexAlign</span>.<span class="property">Center</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    .<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    .<span class="title function_">margin</span>(&#123; <span class="attr">top</span>: <span class="number">5</span> &#125;)</span><br><span class="line">    .<span class="title function_">alignItems</span>(<span class="title class_">HorizontalAlign</span>.<span class="property">Center</span>)</span><br><span class="line">    .<span class="title function_">justifyContent</span>(<span class="title class_">FlexAlign</span>.<span class="property">Start</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Row-详解"><a href="#Row-详解" class="headerlink" title="Row 详解"></a>Row 详解</h4><p>Row 为沿水平方向布局容器，可以包含多个子组件，多个子组件会在水平方向上按照顺序排列。</p>
<h5 id="Row-接口"><a href="#Row-接口" class="headerlink" title="Row 接口"></a>Row 接口</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Row</span>(value?: &#123;space?: <span class="built_in">string</span> | <span class="built_in">number</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>参数：</p>
<table>
<thead>
<tr>
<th>参数 名</th>
<th>参数类 型</th>
<th>必 填</th>
<th>参数描述</th>
</tr>
</thead>
<tbody><tr>
<td>space</td>
<td>string &#124; number</td>
<td>否</td>
<td>横向布局元素间距。从 API version 9 开始，space 为负数或者 justifyContent 设置为 FlexAlign.SpaceBetween、FlexAlign.SpaceAround、FlexAlign.SpaceEvenly 时不生效。默认值：0，单位 vp。说明：可选值为大于等于 0 的数字，或者可以转换为 数字的字符串。</td>
</tr>
</tbody></table>
<h5 id="Row-属性"><a href="#Row-属性" class="headerlink" title="Row 属性"></a>Row 属性</h5><table>
<thead>
<tr>
<th>名称</th>
<th>参数类型</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>alignItems</td>
<td>VerticalAlign</td>
<td>设置子组件在垂直方向上的对齐格式。默认值：VerticalAlign.Center 从 API version 9 开始，该接口支持在 ArkTS 卡片中使用。</td>
</tr>
<tr>
<td>justifyContent8+</td>
<td>FlexAlign</td>
<td>设置子组件在水平方向上的对齐格式。默认值：FlexAlign.Start 从 API version 9 开始，该接口支持在 ArkTS 卡片中使用。</td>
</tr>
</tbody></table>
<h4 id="自定义组件"><a href="#自定义组件" class="headerlink" title="自定义组件"></a>自定义组件</h4><p>自定义组件传值。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Index</span> &#123;</span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>(&#123; <span class="attr">space</span>: <span class="number">10</span> &#125;) &#123;</span><br><span class="line">      <span class="title class_">Container</span>()</span><br><span class="line">      <span class="title class_">Container</span>(&#123; <span class="attr">color</span>: <span class="title class_">Color</span>.<span class="property">Orange</span>, <span class="attr">icon</span>: $r(<span class="string">&#x27;app.media.user&#x27;</span>) &#125;)</span><br><span class="line">      <span class="title class_">Container</span>(&#123; <span class="attr">color</span>: <span class="title class_">Color</span>.<span class="property">Brown</span>, <span class="attr">icon</span>: $r(<span class="string">&#x27;app.media.settings&#x27;</span>) &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    .<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    .<span class="title function_">alignItems</span>(<span class="title class_">HorizontalAlign</span>.<span class="property">Center</span>)</span><br><span class="line">    .<span class="title function_">justifyContent</span>(<span class="title class_">FlexAlign</span>.<span class="property">SpaceBetween</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Container</span> &#123;</span><br><span class="line">  <span class="attr">color</span>: <span class="title class_">Color</span> = <span class="title class_">Color</span>.<span class="property">Red</span></span><br><span class="line">  <span class="attr">icon</span>: <span class="title class_">Resource</span> = $r(<span class="string">&#x27;app.media.app_icon&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Row</span>() &#123;</span><br><span class="line">      <span class="title class_">Image</span>(<span class="variable language_">this</span>.<span class="property">icon</span>).<span class="title function_">width</span>(<span class="number">100</span>).<span class="title function_">height</span>(<span class="number">100</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_">width</span>(<span class="number">140</span>)</span><br><span class="line">    .<span class="title function_">height</span>(<span class="number">140</span>)</span><br><span class="line">    .<span class="title function_">backgroundColor</span>(<span class="variable language_">this</span>.<span class="property">color</span>)</span><br><span class="line">    .<span class="title function_">alignItems</span>(<span class="title class_">VerticalAlign</span>.<span class="property">Center</span>)</span><br><span class="line">    .<span class="title function_">justifyContent</span>(<span class="title class_">FlexAlign</span>.<span class="property">Center</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Row、Column-结合-layoutWeight-实现弹性布局"><a href="#Row、Column-结合-layoutWeight-实现弹性布局" class="headerlink" title="Row、Column 结合 layoutWeight 实现弹性布局"></a>Row、Column 结合 layoutWeight 实现弹性布局</h4><p>ArkTS 中使用 Row、Column 结合 layoutWeight 属性可以实现弹性布局。</p>
<h5 id="水平弹性布局"><a href="#水平弹性布局" class="headerlink" title="水平弹性布局"></a>水平弹性布局</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Index</span> &#123;</span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Row</span>() &#123;</span><br><span class="line">      <span class="title class_">Row</span>().<span class="title function_">height</span>(<span class="number">100</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Red</span>).<span class="title function_">layoutWeight</span>(<span class="number">1</span>)</span><br><span class="line">      <span class="title class_">Row</span>().<span class="title function_">height</span>(<span class="number">100</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Green</span>).<span class="title function_">layoutWeight</span>(<span class="number">1</span>)</span><br><span class="line">      <span class="title class_">Row</span>() &#123;</span><br><span class="line">        <span class="title class_">Text</span>(<span class="string">&#x27;no layoutWeight&#x27;</span>).<span class="title function_">textAlign</span>(<span class="title class_">TextAlign</span>.<span class="property">Center</span>).<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">      &#125;.<span class="title function_">height</span>(<span class="number">100</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Orange</span>).<span class="title function_">size</span>(&#123; <span class="attr">height</span>: <span class="number">100</span>, <span class="attr">width</span>: <span class="number">200</span> &#125;)</span><br><span class="line">    &#125;.<span class="title function_">size</span>(&#123; <span class="attr">width</span>: <span class="string">&#x27;100%&#x27;</span>, <span class="attr">height</span>: <span class="number">100</span> &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img data-src="https://gitee.com/zch0304/images/raw/master/note/1716388652192.jpg"> </p>
<h5 id="垂直弹性布局"><a href="#垂直弹性布局" class="headerlink" title="垂直弹性布局"></a>垂直弹性布局</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Index</span> &#123;</span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>(&#123; <span class="attr">space</span>: <span class="number">10</span> &#125;) &#123;</span><br><span class="line">      <span class="title class_">Row</span>() &#123;</span><br><span class="line">        <span class="title class_">Image</span>(<span class="string">&quot;https://gitee.com/zch0304/images/raw/master/note/test_icon1.jpg&quot;</span>).<span class="title function_">objectFit</span>(<span class="title class_">ImageFit</span>.<span class="property">Fill</span>)</span><br><span class="line">      &#125;.<span class="title function_">size</span>(&#123; <span class="attr">width</span>: <span class="string">&#x27;100%&#x27;</span>, <span class="attr">height</span>: <span class="number">160</span> &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="title class_">Row</span>(&#123; <span class="attr">space</span>: <span class="number">10</span> &#125;) &#123;</span><br><span class="line">        <span class="title class_">Row</span>() &#123;</span><br><span class="line">          <span class="title class_">Image</span>(<span class="string">&quot;https://gitee.com/zch0304/images/raw/master/note/test_icon2.jpg&quot;</span>).<span class="title function_">objectFit</span>(<span class="title class_">ImageFit</span>.<span class="property">Fill</span>)</span><br><span class="line">        &#125;.<span class="title function_">layoutWeight</span>(<span class="number">2</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="title class_">Row</span>() &#123;</span><br><span class="line">          <span class="title class_">Column</span>(&#123; <span class="attr">space</span>: <span class="number">10</span> &#125;) &#123;</span><br><span class="line">            <span class="title class_">Row</span>() &#123;</span><br><span class="line">              <span class="title class_">Image</span>(<span class="string">&quot;https://gitee.com/zch0304/images/raw/master/note/test_icon3.jpg&quot;</span>).<span class="title function_">objectFit</span>(<span class="title class_">ImageFit</span>.<span class="property">Fill</span>)</span><br><span class="line">            &#125;.<span class="title function_">layoutWeight</span>(<span class="number">1</span>).<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="title class_">Row</span>() &#123;</span><br><span class="line">              <span class="title class_">Image</span>(<span class="string">&quot;https://gitee.com/zch0304/images/raw/master/note/test_icon4.jpg&quot;</span>).<span class="title function_">objectFit</span>(<span class="title class_">ImageFit</span>.<span class="property">Fill</span>)</span><br><span class="line">            &#125;.<span class="title function_">layoutWeight</span>(<span class="number">1</span>).<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;.<span class="title function_">layoutWeight</span>(<span class="number">1</span>)</span><br><span class="line">      &#125;.<span class="title function_">size</span>(&#123; <span class="attr">width</span>: <span class="string">&#x27;100%&#x27;</span>, <span class="attr">height</span>: <span class="number">140</span> &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_">margin</span>(<span class="number">5</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img data-src="https://gitee.com/zch0304/images/raw/master/note/1716472510603.jpg"> </p>
<h4 id="Stack-定位组件"><a href="#Stack-定位组件" class="headerlink" title="Stack 定位组件"></a>Stack 定位组件</h4><p>Stack 组件可以实现容器堆叠，子组件按照顺序依次入栈，后一个子组件覆盖前一个子组件。</p>
<h5 id="Stack-接口"><a href="#Stack-接口" class="headerlink" title="Stack 接口"></a>Stack 接口</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Stack</span>(value?: &#123; alignContent?: <span class="title class_">Alignment</span> &#125;)</span><br></pre></td></tr></table></figure>

<p>参数：</p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>参数类型</th>
<th>必 填</th>
<th>参数描述</th>
</tr>
</thead>
<tbody><tr>
<td>alignContent</td>
<td>Alignment</td>
<td>否</td>
<td>设置子组件在容器内的对齐方式。默认值：Alignment.Center。</td>
</tr>
</tbody></table>
<h5 id="Stack-基本使用"><a href="#Stack-基本使用" class="headerlink" title="Stack 基本使用"></a>Stack 基本使用</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Index</span> &#123;</span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>(&#123; <span class="attr">space</span>: <span class="number">10</span> &#125;) &#123;</span><br><span class="line">      <span class="title class_">Stack</span>(&#123; <span class="attr">alignContent</span>: <span class="title class_">Alignment</span>.<span class="property">BottomStart</span> &#125;) &#123;</span><br><span class="line">        <span class="title class_">Row</span>() &#123;</span><br><span class="line">          <span class="title class_">Text</span>(<span class="string">&quot;HarmonyOS&quot;</span>).<span class="title function_">fontSize</span>(<span class="number">40</span>).<span class="title function_">textAlign</span>(<span class="title class_">TextAlign</span>.<span class="property">Center</span>)</span><br><span class="line">        &#125;.<span class="title function_">width</span>(<span class="number">300</span>).<span class="title function_">height</span>(<span class="number">300</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Orange</span>)</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Row</span>().<span class="title function_">width</span>(<span class="number">100</span>).<span class="title function_">height</span>(<span class="number">100</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Blue</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    .<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    .<span class="title function_">alignItems</span>(<span class="title class_">HorizontalAlign</span>.<span class="property">Center</span>)</span><br><span class="line">    .<span class="title function_">justifyContent</span>(<span class="title class_">FlexAlign</span>.<span class="property">Center</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img data-src="https://gitee.com/zch0304/images/raw/master/note/1716473605745.jpg"> </p>
<h5 id="Stack-子组件中-zIndex-控制层级"><a href="#Stack-子组件中-zIndex-控制层级" class="headerlink" title="Stack 子组件中 zIndex 控制层级"></a>Stack 子组件中 zIndex 控制层级</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Index</span> &#123;</span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Stack</span>(&#123; <span class="attr">alignContent</span>: <span class="title class_">Alignment</span>.<span class="property">BottomStart</span> &#125;) &#123;</span><br><span class="line">      <span class="title class_">Column</span>() &#123;</span><br><span class="line">        <span class="title class_">Text</span>(<span class="string">&quot;Stack子元素1&quot;</span>).<span class="title function_">fontSize</span>(<span class="number">20</span>)</span><br><span class="line">      &#125;.<span class="title function_">width</span>(<span class="number">100</span>).<span class="title function_">height</span>(<span class="number">100</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Orange</span>).<span class="title function_">zIndex</span>(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">      <span class="title class_">Column</span>() &#123;</span><br><span class="line">        <span class="title class_">Text</span>(<span class="string">&quot;Stack子元素2&quot;</span>).<span class="title function_">fontSize</span>(<span class="number">20</span>)</span><br><span class="line">      &#125;.<span class="title function_">width</span>(<span class="number">150</span>).<span class="title function_">height</span>(<span class="number">150</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Yellow</span>).<span class="title function_">zIndex</span>(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">      <span class="title class_">Column</span>() &#123;</span><br><span class="line">        <span class="title class_">Text</span>(<span class="string">&quot;Stack子元素3&quot;</span>).<span class="title function_">fontSize</span>(<span class="number">20</span>)</span><br><span class="line">      &#125;.<span class="title function_">width</span>(<span class="number">200</span>).<span class="title function_">height</span>(<span class="number">200</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Pink</span>)</span><br><span class="line">    &#125;.<span class="title function_">width</span>(<span class="number">350</span>).<span class="title function_">height</span>(<span class="number">350</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Gray</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img data-src="https://gitee.com/zch0304/images/raw/master/note/1716474425596.jpg"> </p>
<h5 id="Stack-结合-List-实现动态列表"><a href="#Stack-结合-List-实现动态列表" class="headerlink" title="Stack 结合 List 实现动态列表"></a>Stack 结合 List 实现动态列表</h5><p>要实现的功能：<br>1、实现浮动按钮。<br>2、点击按钮让列表的数字加一。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Index</span> &#123;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">list</span>: <span class="built_in">number</span>[] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>() &#123;</span><br><span class="line">      <span class="title class_">Stack</span>(&#123; <span class="attr">alignContent</span>: <span class="title class_">Alignment</span>.<span class="property">BottomEnd</span> &#125;) &#123;</span><br><span class="line">        <span class="title class_">List</span>(&#123; <span class="attr">space</span>: <span class="number">10</span> &#125;) &#123;</span><br><span class="line">          <span class="title class_">ForEach</span>(<span class="variable language_">this</span>.<span class="property">list</span>, <span class="function">(<span class="params">item: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="title class_">ListItem</span>() &#123;</span><br><span class="line">              <span class="title class_">Text</span>(<span class="string">`<span class="subst">$&#123;item&#125;</span>`</span>)</span><br><span class="line">                .<span class="title function_">fontSize</span>(<span class="number">20</span>)</span><br><span class="line">                .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">                .<span class="title function_">height</span>(<span class="number">50</span>)</span><br><span class="line">                .<span class="title function_">backgroundColor</span>(<span class="string">&#x27;#eee&#x27;</span>)</span><br><span class="line">                .<span class="title function_">textAlign</span>(<span class="title class_">TextAlign</span>.<span class="property">Center</span>)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;.<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>).<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>).<span class="title function_">padding</span>(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Button</span>(&#123; <span class="attr">type</span>: <span class="title class_">ButtonType</span>.<span class="property">Circle</span>, <span class="attr">stateEffect</span>: <span class="literal">true</span> &#125;) &#123;</span><br><span class="line">          <span class="title class_">Text</span>(<span class="string">&#x27;+&#x27;</span>).<span class="title function_">fontSize</span>(<span class="number">40</span>).<span class="title function_">fontColor</span>(<span class="title class_">Color</span>.<span class="property">White</span>)</span><br><span class="line">        &#125;.<span class="title function_">width</span>(<span class="number">55</span>).<span class="title function_">height</span>(<span class="number">55</span>).<span class="title function_">margin</span>(&#123; <span class="attr">right</span>: <span class="number">20</span>, <span class="attr">bottom</span>: <span class="number">20</span> &#125;).<span class="title function_">onClick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">doAdd</span>()</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;.<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>).<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>).<span class="title function_">alignItems</span>(<span class="title class_">HorizontalAlign</span>.<span class="property">Center</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">doAdd</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">list</span>.<span class="title function_">push</span>(<span class="variable language_">this</span>.<span class="property">list</span>[<span class="variable language_">this</span>.<span class="property">list</span>.<span class="property">length</span>-<span class="number">1</span>] + <span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img data-src="https://gitee.com/zch0304/images/raw/master/note/1716475790377.jpg" style="zoom: 50%;" /> 

<h5 id="Stack-结合-List-实现浮动导航"><a href="#Stack-结合-List-实现浮动导航" class="headerlink" title="Stack 结合 List 实现浮动导航"></a>Stack 结合 List 实现浮动导航</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Index</span> &#123;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">list</span>: <span class="built_in">number</span>[] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>() &#123;</span><br><span class="line">      <span class="title class_">Stack</span>(&#123; <span class="attr">alignContent</span>: <span class="title class_">Alignment</span>.<span class="property">BottomEnd</span> &#125;) &#123;</span><br><span class="line">        <span class="title class_">Stack</span>(&#123; <span class="attr">alignContent</span>: <span class="title class_">Alignment</span>.<span class="property">TopEnd</span> &#125;) &#123;</span><br><span class="line">          <span class="title class_">List</span>(&#123; <span class="attr">space</span>: <span class="number">10</span> &#125;) &#123;</span><br><span class="line">            <span class="title class_">ForEach</span>(<span class="variable language_">this</span>.<span class="property">list</span>, <span class="function">(<span class="params">item: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">              <span class="title class_">ListItem</span>() &#123;</span><br><span class="line">                <span class="title class_">Text</span>(<span class="string">`<span class="subst">$&#123;item&#125;</span>`</span>)</span><br><span class="line">                  .<span class="title function_">fontSize</span>(<span class="number">20</span>)</span><br><span class="line">                  .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">                  .<span class="title function_">height</span>(<span class="number">50</span>)</span><br><span class="line">                  .<span class="title function_">backgroundColor</span>(<span class="string">&#x27;#eee&#x27;</span>)</span><br><span class="line">                  .<span class="title function_">textAlign</span>(<span class="title class_">TextAlign</span>.<span class="property">Center</span>)</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;.<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>).<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>).<span class="title function_">padding</span>(&#123; <span class="attr">left</span>: <span class="number">10</span>, <span class="attr">top</span>: <span class="number">70</span>, <span class="attr">right</span>: <span class="number">10</span>, <span class="attr">bottom</span>: <span class="number">10</span> &#125;)</span><br><span class="line"></span><br><span class="line">          <span class="title class_">Row</span>() &#123;</span><br><span class="line">            <span class="title class_">Text</span>(<span class="string">&quot;导航&quot;</span>).<span class="title function_">fontSize</span>(<span class="number">16</span>).<span class="title function_">textAlign</span>(<span class="title class_">TextAlign</span>.<span class="property">Center</span>).<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">          &#125;.<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>).<span class="title function_">height</span>(<span class="number">60</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Orange</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Button</span>(&#123; <span class="attr">type</span>: <span class="title class_">ButtonType</span>.<span class="property">Circle</span>, <span class="attr">stateEffect</span>: <span class="literal">true</span> &#125;) &#123;</span><br><span class="line">          <span class="title class_">Text</span>(<span class="string">&#x27;+&#x27;</span>).<span class="title function_">fontSize</span>(<span class="number">40</span>).<span class="title function_">fontColor</span>(<span class="title class_">Color</span>.<span class="property">White</span>)</span><br><span class="line">        &#125;.<span class="title function_">width</span>(<span class="number">55</span>).<span class="title function_">height</span>(<span class="number">55</span>).<span class="title function_">margin</span>(&#123; <span class="attr">right</span>: <span class="number">20</span>, <span class="attr">bottom</span>: <span class="number">20</span> &#125;).<span class="title function_">onClick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">doAdd</span>()</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;.<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>).<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>).<span class="title function_">alignItems</span>(<span class="title class_">HorizontalAlign</span>.<span class="property">Center</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">doAdd</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">list</span>.<span class="title function_">push</span>(<span class="variable language_">this</span>.<span class="property">list</span>[<span class="variable language_">this</span>.<span class="property">list</span>.<span class="property">length</span>-<span class="number">1</span>] + <span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img data-src="https://gitee.com/zch0304/images/raw/master/note/1716477035040.jpg" style="zoom:50%;" /> 

<h4 id="弹性布局（Flex）"><a href="#弹性布局（Flex）" class="headerlink" title="弹性布局（Flex）"></a>弹性布局（Flex）</h4><p>Flex 弹性布局可以更加方便的对容器中的子元素进行排列、对齐和分配剩余空间等。单行的 Flex 跟 Row 组件的表现几乎一致，单列的 Flex 则跟 Column 组件表现几乎一致。但 Row 与 Column 都是单行单列的，Flex 则可以突破了这个限制，当主轴上空间不足时，则向纵轴上去扩展显示。</p>
<img data-src="https://gitee.com/zch0304/images/raw/master/note/1716554468902.jpg" style="zoom:50%;" /> 

<h5 id="Flex-接口"><a href="#Flex-接口" class="headerlink" title="Flex 接口"></a>Flex 接口</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Flex</span>(value?: &#123; direction?: <span class="title class_">FlexDirection</span>, wrap?: <span class="title class_">FlexWrap</span>, justifyContent?: <span class="title class_">FlexAlign</span>, alignItems?: <span class="title class_">ItemAlign</span>, alignContent?: <span class="title class_">FlexAlign</span> &#125;)</span><br></pre></td></tr></table></figure>

<p>标准 Flex 布局容器。从 API version 9 开始，该接口支持在 ArkTS 片中使用。</p>
<h5 id="Flex-参数"><a href="#Flex-参数" class="headerlink" title="Flex 参数"></a>Flex 参数</h5><table>
<thead>
<tr>
<th>参数名</th>
<th>参数类型</th>
<th>必 填</th>
<th>默认值</th>
<th>参数描述</th>
</tr>
</thead>
<tbody><tr>
<td>direction</td>
<td>FlexDirection</td>
<td>否</td>
<td>FlexDirection.Row</td>
<td>子组件在 Flex 容器上排列的方向，即主轴的方向。</td>
</tr>
<tr>
<td>wrap</td>
<td>FlexWrap</td>
<td>否</td>
<td>FlexWrap.NoWrap</td>
<td>Flex 容器是单行&#x2F;列还是多行&#x2F;列排列。说明：在多行布局时，通过交叉轴方向，确认新行堆叠方向。</td>
</tr>
<tr>
<td>justifyContent</td>
<td>FlexAlign</td>
<td>否</td>
<td>FlexAlign.Start</td>
<td>子组件在 Flex 容器主轴上的对齐格式。</td>
</tr>
<tr>
<td>alignItems</td>
<td>ItemAlign</td>
<td>否</td>
<td>ItemAlign.Start</td>
<td>子组件在 Flex 容器交叉轴上的对齐格式。</td>
</tr>
<tr>
<td>alignContent</td>
<td>FlexAlign</td>
<td>否</td>
<td>FlexAlign.Start</td>
<td>交叉轴中有额外的空间时，多行内容的对齐方式。仅在 wrap 为 Wrap 或 WrapReverse 下生效。</td>
</tr>
</tbody></table>
<h5 id="Flex-轴的基本概念"><a href="#Flex-轴的基本概念" class="headerlink" title="Flex 轴的基本概念"></a>Flex 轴的基本概念</h5><ul>
<li><strong>主轴</strong>：Flex 组件布局方向的轴线，子元素默认沿着主轴排列。主轴开始的位置称为主轴起始点，结束位置称为主轴结束点。</li>
<li><strong>交叉轴</strong>：垂直于主轴方向的轴线。交叉轴开始的位置称为交叉轴起始点，结束位置称为交叉轴结束点。</li>
</ul>
<h5 id="direction-参数控制布局方向"><a href="#direction-参数控制布局方向" class="headerlink" title="direction 参数控制布局方向"></a>direction 参数控制布局方向</h5><p>Flex 布局中通过 direction 可以改变布局方向，在弹性布局中，容器的子元素可以按照任意方向排列。通过设置参数 direction，可以决定主轴的方向，从而控制子组件的排列方向。</p>
<img data-src="https://gitee.com/zch0304/images/raw/master/note/1716557181764.jpg" style="zoom:50%;" /> 

<ul>
<li>FlexDirection.Row：主轴为水平方向，子组件从起始端沿着水平方向开始排布。</li>
<li>FlexDirection.RowReverse：主轴为水平方向，子组件从终点端沿着 FlexDirection. Row 相反的方向开始排布。</li>
<li>FlexDirection.Column：主轴为垂直方向，子组件从起始端沿着垂直方向开始排布。</li>
<li>FlexDirection.ColumnReverse：主轴为垂直方向，子组件从终点端沿着 FlexDirection. Column 相反的方向开始排布。</li>
</ul>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Index</span> &#123;</span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Flex</span>(&#123; <span class="attr">direction</span>: <span class="title class_">FlexDirection</span>.<span class="property">Row</span> &#125;) &#123;</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;1&#x27;</span>).<span class="title function_">width</span>(<span class="string">&#x27;33%&#x27;</span>).<span class="title function_">height</span>(<span class="number">50</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Red</span>)</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;2&#x27;</span>).<span class="title function_">width</span>(<span class="string">&#x27;33%&#x27;</span>).<span class="title function_">height</span>(<span class="number">50</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Green</span>)</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;3&#x27;</span>).<span class="title function_">width</span>(<span class="string">&#x27;33%&#x27;</span>).<span class="title function_">height</span>(<span class="number">50</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Orange</span>)</span><br><span class="line">    &#125;.<span class="title function_">width</span>(<span class="string">&#x27;90%&#x27;</span>).<span class="title function_">height</span>(<span class="number">70</span>).<span class="title function_">padding</span>(<span class="number">10</span>).<span class="title function_">backgroundColor</span>(<span class="string">&#x27;#ccc&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img data-src="https://gitee.com/zch0304/images/raw/master/note/1716557759593.jpg"> </p>
<h5 id="wrap-参数控制布局换行"><a href="#wrap-参数控制布局换行" class="headerlink" title="wrap 参数控制布局换行"></a>wrap 参数控制布局换行</h5><p>弹性布局分为单行布局和多行布局。默认情况下，Flex 容器中的子元素都排在一条线（又称“轴线”） 上。wrap 属性控制当子元素主轴尺寸之和大于容器主轴尺寸时，Flex 是单行布局还是多行布局。在多行布局时，通过交叉轴方向，确认新行堆叠方向。 </p>
<p><strong>FlexWrap. NoWrap</strong>（默认值）：不换行。如果子组件的宽度总和大于父元素的宽度，则子组件会被压缩宽度。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Index</span> &#123;</span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Flex</span>(&#123; <span class="attr">wrap</span>: <span class="title class_">FlexWrap</span>.<span class="property">NoWrap</span> &#125;) &#123;</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;1&#x27;</span>).<span class="title function_">width</span>(<span class="string">&#x27;50%&#x27;</span>).<span class="title function_">height</span>(<span class="number">50</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Red</span>)</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;2&#x27;</span>).<span class="title function_">width</span>(<span class="string">&#x27;50%&#x27;</span>).<span class="title function_">height</span>(<span class="number">50</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Green</span>)</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;3&#x27;</span>).<span class="title function_">width</span>(<span class="string">&#x27;50%&#x27;</span>).<span class="title function_">height</span>(<span class="number">50</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Orange</span>)</span><br><span class="line">    &#125;.<span class="title function_">width</span>(<span class="string">&#x27;90%&#x27;</span>).<span class="title function_">padding</span>(<span class="number">10</span>).<span class="title function_">backgroundColor</span>(<span class="string">&#x27;#ccc&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img data-src="https://gitee.com/zch0304/images/raw/master/note/1716557759593.jpg"> </p>
<p><strong>FlexWrap. Wrap</strong>：换行，每一行子组件按照主轴方向排列。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Index</span> &#123;</span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Flex</span>(&#123; <span class="attr">wrap</span>: <span class="title class_">FlexWrap</span>.<span class="property">Wrap</span> &#125;) &#123;</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;1&#x27;</span>).<span class="title function_">width</span>(<span class="string">&#x27;50%&#x27;</span>).<span class="title function_">height</span>(<span class="number">50</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Red</span>)</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;2&#x27;</span>).<span class="title function_">width</span>(<span class="string">&#x27;50%&#x27;</span>).<span class="title function_">height</span>(<span class="number">50</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Green</span>)</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;3&#x27;</span>).<span class="title function_">width</span>(<span class="string">&#x27;50%&#x27;</span>).<span class="title function_">height</span>(<span class="number">50</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Orange</span>)</span><br><span class="line">    &#125;.<span class="title function_">width</span>(<span class="string">&#x27;90%&#x27;</span>).<span class="title function_">padding</span>(<span class="number">10</span>).<span class="title function_">backgroundColor</span>(<span class="string">&#x27;#ccc&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img data-src="https://gitee.com/zch0304/images/raw/master/note/1716558674189.jpg"> </p>
<p><strong>FlexWrap. WrapReverse</strong>：换行，每一行子组件按照主轴反方向排列。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Index</span> &#123;</span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Flex</span>(&#123; <span class="attr">wrap</span>: <span class="title class_">FlexWrap</span>.<span class="property">WrapReverse</span> &#125;) &#123;</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;1&#x27;</span>).<span class="title function_">width</span>(<span class="string">&#x27;50%&#x27;</span>).<span class="title function_">height</span>(<span class="number">50</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Red</span>)</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;2&#x27;</span>).<span class="title function_">width</span>(<span class="string">&#x27;50%&#x27;</span>).<span class="title function_">height</span>(<span class="number">50</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Green</span>)</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;3&#x27;</span>).<span class="title function_">width</span>(<span class="string">&#x27;50%&#x27;</span>).<span class="title function_">height</span>(<span class="number">50</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Orange</span>)</span><br><span class="line">    &#125;.<span class="title function_">width</span>(<span class="string">&#x27;90%&#x27;</span>).<span class="title function_">padding</span>(<span class="number">10</span>).<span class="title function_">backgroundColor</span>(<span class="string">&#x27;#ccc&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img data-src="https://gitee.com/zch0304/images/raw/master/note/1716558853253.jpg" style="zoom:80%;" /> 

<h5 id="justifyContent-配置主轴对齐方式"><a href="#justifyContent-配置主轴对齐方式" class="headerlink" title="justifyContent 配置主轴对齐方式"></a>justifyContent 配置主轴对齐方式</h5><img data-src="https://gitee.com/zch0304/images/raw/master/note/1716559329865.jpg" style="zoom: 67%;" /> 

<p><strong>FlexAlign.Start</strong>（默认值）：子组件在主轴方向起始端对齐，第一个子组件与父元素边沿对齐，其他元素与前一个元素对齐。</p>
<p><strong>FlexAlign.Center</strong>：子组件在主轴方向居中对齐。</p>
<p><strong>FlexAlign.End</strong>：子组件在主轴方向终点端对齐，最后一个子组件与父元素边沿对齐，其它元素与后一个元素对齐。</p>
<p><strong>FlexAlign.SpaceBetween</strong>：Flex 主轴方向均匀分配弹性元素，相邻子组件之间距离相同。第一个子组件和最后一个子组件与父元素边沿对齐。</p>
<p><strong>FlexAlign.SpaceAround</strong>：Flex 主轴方向均匀分配弹性元素，相邻子组件之间距离相同。第一个子组件到主轴起始端的距离和最后一个子组件到主轴终点端的距离是相邻元素之间距离的一半。</p>
<p><strong>FlexAlign.SpaceEvenly</strong>：Flex 主轴方向元素等间距布局，相邻子组件之间的间距、第一个子组件与主轴起始端的间距、最后一个子组件到主轴终点端的间距均相等。</p>
<h5 id="alignContent-配置内容对齐"><a href="#alignContent-配置内容对齐" class="headerlink" title="alignContent 配置内容对齐"></a>alignContent 配置内容对齐</h5><p>可以通过 alignContent 参数设置子组件各行在交叉轴剩余空间内的对齐方式，只在多行的 ﬂex 布局中生效（仅在 wrap 为 Wrap 或 WrapReverse 下生效），可选值有：</p>
<p><strong>FlexAlign.Start</strong>：子组件各行与交叉轴起点对齐，默认值。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Index</span> &#123;</span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Flex</span>(&#123; <span class="attr">justifyContent</span>: <span class="title class_">FlexAlign</span>.<span class="property">SpaceBetween</span>, <span class="attr">wrap</span>: <span class="title class_">FlexWrap</span>.<span class="property">Wrap</span>, <span class="attr">alignContent</span>: <span class="title class_">FlexAlign</span>.<span class="property">Start</span> &#125;) &#123;</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;1&#x27;</span>).<span class="title function_">width</span>(<span class="string">&#x27;30%&#x27;</span>).<span class="title function_">height</span>(<span class="number">20</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Red</span>)</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;2&#x27;</span>).<span class="title function_">width</span>(<span class="string">&#x27;60%&#x27;</span>).<span class="title function_">height</span>(<span class="number">20</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Green</span>)</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;3&#x27;</span>).<span class="title function_">width</span>(<span class="string">&#x27;40%&#x27;</span>).<span class="title function_">height</span>(<span class="number">20</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Orange</span>)</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;4&#x27;</span>).<span class="title function_">width</span>(<span class="string">&#x27;30%&#x27;</span>).<span class="title function_">height</span>(<span class="number">20</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Pink</span>)</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;5&#x27;</span>).<span class="title function_">width</span>(<span class="string">&#x27;20%&#x27;</span>).<span class="title function_">height</span>(<span class="number">20</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Yellow</span>)</span><br><span class="line">    &#125;.<span class="title function_">height</span>(<span class="number">100</span>).<span class="title function_">backgroundColor</span>(<span class="string">&#x27;#ccc&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img data-src="https://gitee.com/zch0304/images/raw/master/note/1716561030772.jpg"> </p>
<p><strong>FlexAlign.Center</strong>：子组件各行在交叉轴方向居中对齐。</p>
<p><img data-src="https://gitee.com/zch0304/images/raw/master/note/1716561257608.jpg"> </p>
<p><strong>FlexAlign.End</strong>：子组件各行与交叉轴终点对齐。</p>
<p><img data-src="https://gitee.com/zch0304/images/raw/master/note/1716561389788.jpg"> </p>
<p><strong>FlexAlign.SpaceBetween</strong>：子组件各行与交叉轴两端对齐，各行间垂直间距平均分布。</p>
<p><img data-src="https://gitee.com/zch0304/images/raw/master/note/1716561544100.jpg"> </p>
<p><strong>FlexAlign.SpaceAround</strong>：子组件各行间距相等，是元素首尾行与交叉轴两端距离的两倍。</p>
<img data-src="https://gitee.com/zch0304/images/raw/master/note/1716561707980.jpg" style="zoom:80%;" /> 

<p><strong>FlexAlign.SpaceEvenly</strong>：子组件各行间距，子组件首尾行与交叉轴两端距离都相等。</p>
<img data-src="https://gitee.com/zch0304/images/raw/master/note/1716561851381.jpg" style="zoom:80%;" /> 

<h5 id="alignItems-参数控制交叉轴对齐方式"><a href="#alignItems-参数控制交叉轴对齐方式" class="headerlink" title="alignItems 参数控制交叉轴对齐方式"></a>alignItems 参数控制交叉轴对齐方式</h5><p>容器和子元素都可以设置交叉轴对齐方式，且子元素设置的对齐方式优先级较高。可以通过 Flex 组件的 alignItems 参数设置子组件在交叉轴的对齐方式。</p>
<p><strong>ItemAlign.Auto</strong>：使用 Flex 容器中默认配置。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Index</span> &#123;</span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Flex</span>(&#123; <span class="attr">alignItems</span>: <span class="title class_">ItemAlign</span>.<span class="property">Auto</span> &#125;) &#123;</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;1&#x27;</span>).<span class="title function_">width</span>(<span class="string">&#x27;33%&#x27;</span>).<span class="title function_">height</span>(<span class="number">20</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Red</span>)</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;2&#x27;</span>).<span class="title function_">width</span>(<span class="string">&#x27;33%&#x27;</span>).<span class="title function_">height</span>(<span class="number">40</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Green</span>)</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;3&#x27;</span>).<span class="title function_">width</span>(<span class="string">&#x27;33%&#x27;</span>).<span class="title function_">height</span>(<span class="number">60</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Orange</span>)</span><br><span class="line">    &#125;.<span class="title function_">height</span>(<span class="number">80</span>).<span class="title function_">backgroundColor</span>(<span class="string">&#x27;#ccc&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img data-src="https://gitee.com/zch0304/images/raw/master/note/1716816140506.jpg" style="zoom:80%;" /> 

<p><strong>ItemAlign.Start</strong>：交叉轴方向首部对齐，默认值。</p>
<img data-src="https://gitee.com/zch0304/images/raw/master/note/1716816140506.jpg" style="zoom:80%;" /> 

<p><strong>ItemAlign.Center</strong>：交叉轴方向居中对齐。</p>
<img data-src="https://gitee.com/zch0304/images/raw/master/note/1716816486562.jpg" style="zoom:80%;" /> 

<p><strong>ItemAlign.End</strong>：交叉轴方向底部对齐。</p>
<img data-src="https://gitee.com/zch0304/images/raw/master/note/1716817062907.jpg" style="zoom:80%;" /> 

<p><strong>ItemAlign.Stretch</strong>：交叉轴方向拉伸填充，在未设置尺寸时，拉伸到容器尺寸。</p>
<img data-src="https://gitee.com/zch0304/images/raw/master/note/1716817484409.jpg" style="zoom:80%;" /> 

<p><strong>ItemAlign. Baseline</strong>：交叉轴方向文本基线对齐。</p>
<img data-src="https://gitee.com/zch0304/images/raw/master/note/1716817697841.jpg" style="zoom:80%;" /> 

<h5 id="Flex-自适应拉伸布局属性"><a href="#Flex-自适应拉伸布局属性" class="headerlink" title="Flex 自适应拉伸布局属性"></a>Flex 自适应拉伸布局属性</h5><p>Row、Column 结合 layoutWeight 可以实现自适应拉伸弹性布局。</p>
<p><strong>1、ﬂexGrow 属性</strong></p>
<p>设置父容器的剩余空间分配给此属性所在组件的比例。用于“瓜分”父组件的剩余空间。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Index</span> &#123;</span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Flex</span>() &#123;</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;1&#x27;</span>).<span class="title function_">flexGrow</span>(<span class="number">1</span>).<span class="title function_">height</span>(<span class="number">60</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Red</span>)</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;2&#x27;</span>).<span class="title function_">flexGrow</span>(<span class="number">2</span>).<span class="title function_">height</span>(<span class="number">60</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Green</span>)</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;no flexGrow&#x27;</span>).<span class="title function_">width</span>(<span class="number">100</span>).<span class="title function_">height</span>(<span class="number">60</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Orange</span>)</span><br><span class="line">    &#125;.<span class="title function_">height</span>(<span class="number">80</span>).<span class="title function_">backgroundColor</span>(<span class="string">&#x27;#ccc&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img data-src="https://gitee.com/zch0304/images/raw/master/note/1716819203162.jpg" style="zoom:80%;" /> 

<p>父容器宽度 400vp，三个子组件原始宽度为 100vp，总和 300vp，剩余空间 100vp 根据 ﬂexGrow 值的占比分配给子组件，未设置 ﬂexGrow 的子组件不参与“瓜分”。 第一个元素以及第二个元素以 2:3 分配剩下的 100vp。第一个元素为 100vp+100vp2&#x2F;5&#x3D;140vp，第 二个元素为 100vp+100vp3&#x2F;5&#x3D;160vp。</p>
<p><strong>2、ﬂexShrink 属性</strong></p>
<p>当父容器空间不足时，子组件的压缩比例。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Index</span> &#123;</span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Flex</span>() &#123;</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;flexShrink(3)&#x27;</span>).<span class="title function_">flexShrink</span>(<span class="number">3</span>).<span class="title function_">width</span>(<span class="number">200</span>).<span class="title function_">height</span>(<span class="number">60</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Red</span>)</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;no flexShrink&#x27;</span>).<span class="title function_">width</span>(<span class="number">200</span>).<span class="title function_">height</span>(<span class="number">60</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Green</span>)</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;flexShrink(1)&#x27;</span>).<span class="title function_">flexShrink</span>(<span class="number">1</span>).<span class="title function_">width</span>(<span class="number">200</span>).<span class="title function_">height</span>(<span class="number">60</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Orange</span>)</span><br><span class="line">    &#125;.<span class="title function_">width</span>(<span class="number">400</span>).<span class="title function_">height</span>(<span class="number">80</span>).<span class="title function_">backgroundColor</span>(<span class="string">&#x27;#ccc&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img data-src="https://gitee.com/zch0304/images/raw/master/note/1716821744026.jpg" style="zoom:80%;" /> 

<h5 id="Flex-应用案例"><a href="#Flex-应用案例" class="headerlink" title="Flex 应用案例"></a>Flex 应用案例</h5><p>弹性布局在开发场景中用例特别多，比如页面头部导航栏的均匀分布、页面框架的搭建、多行多列数据的排列等等。</p>
<p><strong>1、热搜功能</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Index</span> &#123;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">hotSearch</span>: <span class="built_in">string</span>[] = [<span class="string">&#x27;乒乓球&#x27;</span>, <span class="string">&#x27;NBA直播&#x27;</span>, <span class="string">&#x27;世界杯&#x27;</span>, <span class="string">&#x27;广东城际铁路&#x27;</span>, <span class="string">&#x27;Flutter教程&#x27;</span>, <span class="string">&#x27;HarmonyOS&#x27;</span>, <span class="string">&#x27;ArkTS&#x27;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>() &#123;</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;热门搜索&#x27;</span>)</span><br><span class="line">        .<span class="title function_">fontSize</span>(<span class="number">30</span>)</span><br><span class="line">        .<span class="title function_">fontWeight</span>(<span class="title class_">FontWeight</span>.<span class="property">Bold</span>)</span><br><span class="line">        .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">        .<span class="title function_">textAlign</span>(<span class="title class_">TextAlign</span>.<span class="property">Start</span>)</span><br><span class="line">        .<span class="title function_">padding</span>(<span class="number">10</span>)</span><br><span class="line">        .<span class="title function_">fontColor</span>(<span class="string">&#x27;#666&#x27;</span>)</span><br><span class="line">      <span class="title class_">Flex</span>(&#123; <span class="attr">wrap</span>: <span class="title class_">FlexWrap</span>.<span class="property">Wrap</span> &#125;) &#123;</span><br><span class="line">        <span class="title class_">ForEach</span>(<span class="variable language_">this</span>.<span class="property">hotSearch</span>, <span class="function">(<span class="params">item: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="title class_">Text</span>(<span class="string">`<span class="subst">$&#123;item&#125;</span>`</span>)</span><br><span class="line">            .<span class="title function_">fontSize</span>(<span class="number">18</span>)</span><br><span class="line">            .<span class="title function_">backgroundColor</span>(<span class="string">&#x27;#eee&#x27;</span>)</span><br><span class="line">            .<span class="title function_">padding</span>(&#123; <span class="attr">left</span>: <span class="number">16</span>, <span class="attr">top</span>: <span class="number">10</span>, <span class="attr">right</span>: <span class="number">16</span>, <span class="attr">bottom</span>: <span class="number">10</span> &#125;)</span><br><span class="line">            .<span class="title function_">margin</span>(<span class="number">10</span>)</span><br><span class="line">            .<span class="title function_">borderRadius</span>(<span class="number">12</span>)</span><br><span class="line">        &#125;, <span class="function">(<span class="params">item: <span class="built_in">string</span></span>) =&gt;</span> item)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;.<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>).<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img data-src="https://gitee.com/zch0304/images/raw/master/note/1716910862339.jpg" style="zoom:80%;" /> 

<p><strong>2、帮助列表</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">HelpListInterface</span> &#123;</span><br><span class="line">  <span class="attr">title</span>: <span class="built_in">string</span>,</span><br><span class="line">  <span class="attr">icon</span>: <span class="title class_">Resource</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Index</span> &#123;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">helpList</span>: <span class="title class_">HelpListInterface</span>[] = [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&quot;我的订阅&quot;</span>,</span><br><span class="line">      <span class="attr">icon</span>: $r(<span class="string">&quot;app.media.subscribe&quot;</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&quot;常见问题&quot;</span>,</span><br><span class="line">      <span class="attr">icon</span>: $r(<span class="string">&quot;app.media.problem&quot;</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&quot;在线客服&quot;</span>,</span><br><span class="line">      <span class="attr">icon</span>: $r(<span class="string">&quot;app.media.customer_service&quot;</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&quot;意见反馈&quot;</span>,</span><br><span class="line">      <span class="attr">icon</span>: $r(<span class="string">&quot;app.media.opinion&quot;</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&quot;关怀模式&quot;</span>,</span><br><span class="line">      <span class="attr">icon</span>: $r(<span class="string">&quot;app.media.give&quot;</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&quot;会员中心&quot;</span>,</span><br><span class="line">      <span class="attr">icon</span>: $r(<span class="string">&quot;app.media.user&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>() &#123;</span><br><span class="line">      <span class="title class_">Flex</span>(&#123; <span class="attr">wrap</span>: <span class="title class_">FlexWrap</span>.<span class="property">Wrap</span> &#125;) &#123;</span><br><span class="line">        <span class="title class_">ForEach</span>(<span class="variable language_">this</span>.<span class="property">helpList</span>, <span class="function">(<span class="params">item: HelpListInterface</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="title class_">Column</span>() &#123;</span><br><span class="line">            <span class="title class_">Image</span>(item.<span class="property">icon</span>).<span class="title function_">width</span>(<span class="number">42</span>).<span class="title function_">height</span>(<span class="number">42</span>)</span><br><span class="line">            <span class="title class_">Text</span>(<span class="string">`<span class="subst">$&#123;item.title&#125;</span>`</span>).<span class="title function_">fontSize</span>(<span class="number">15</span>).<span class="title function_">fontColor</span>(<span class="string">&#x27;#666&#x27;</span>).<span class="title function_">padding</span>(&#123; <span class="attr">top</span>: <span class="number">10</span> &#125;)</span><br><span class="line">          &#125;.<span class="title function_">width</span>(<span class="string">&#x27;25%&#x27;</span>).<span class="title function_">padding</span>(<span class="number">5</span>).<span class="title function_">margin</span>(&#123; <span class="attr">bottom</span>: <span class="number">10</span> &#125;)</span><br><span class="line">        &#125;, <span class="function">(<span class="params">item: HelpListInterface</span>) =&gt;</span> item.<span class="property">title</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      .<span class="title function_">margin</span>(<span class="number">10</span>)</span><br><span class="line">      .<span class="title function_">backgroundColor</span>(<span class="string">&#x27;#fff&#x27;</span>)</span><br><span class="line">      .<span class="title function_">borderRadius</span>(<span class="number">10</span>)</span><br><span class="line">      .<span class="title function_">padding</span>(&#123; <span class="attr">top</span>: <span class="number">15</span>, <span class="attr">bottom</span>: <span class="number">5</span> &#125;)</span><br><span class="line">    &#125;.<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>).<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>).<span class="title function_">backgroundColor</span>(<span class="string">&#x27;#eee&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img data-src="https://gitee.com/zch0304/images/raw/master/note/1716912172452.jpg" style="zoom:80%;" /> 

<h4 id="相对布局（RelativeContainer）"><a href="#相对布局（RelativeContainer）" class="headerlink" title="相对布局（RelativeContainer）"></a>相对布局（RelativeContainer）</h4><p>相对布局组件，用于复杂场景中元素对齐的布局。</p>
<p>RelativeContainer 就是采用相对布局的容器，支持容器内部的子元素设置相对位置关系。子元素支持指定兄弟元素作为锚点，也支持指定父容器作为锚点，基于锚点做相对位置布局。下图是一个 RelativeContainer 的概念图，图中的虚线表示位置的依赖关系。</p>
<img data-src="https://gitee.com/zch0304/images/raw/master/note/1716991550056.jpg" style="zoom: 33%;" /> 

<h5 id="规则说明"><a href="#规则说明" class="headerlink" title="规则说明"></a>规则说明</h5><p>1、容器内子组件区分水平方向，垂直方向：</p>
<p>​    （1）水平方向为 left，middle，right，对应容器的 HorizontalAlign.Start，HorizontalAlign.Center，HorizontalAlign.End。</p>
<p>​    （2）垂直方向为 top，center，bottom，对应容器的 VerticalAlign.Top，VerticalAlign.Center，VerticalAlign.Bottom。</p>
<p>2、子组件可以将容器或者其他子组件设为锚点：</p>
<p>​    （1）参与相对布局的容器内组件必须设置 id，不设置 id 的组件不显示，RelativeContainer 容器的固定 id 为 __container__。</p>
<p>​    （2）此子组件某一方向上的三个位置可以将容器或其它子组件的同方向三个位置为锚点，同方向上两个以上位置设置锚点以后会跳过第三个。</p>
<p>​    （3）前端页面设置的子组件尺寸大小不会受到相对布局规则的影响。子组件某个方向上设置两个或以上 alignRules 时不建议设置此方向尺寸大小。</p>
<p>​    （4）对齐后需要额外偏移可设置 <strong>oﬀset</strong>。</p>
<p>3、特殊情况：</p>
<p>​    （1）互相依赖，环形依赖时容器内子组件全部不绘制。</p>
<p>​    （2）同方向上两个以上位置设置锚点但锚点位置逆序时，此子组件大小为 0，即不绘制。</p>
<p>​    （3）容器不设置宽高时，容器与容器内子组件不绘制。</p>
<h5 id="基本使用演示"><a href="#基本使用演示" class="headerlink" title="基本使用演示"></a>基本使用演示</h5><figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Index</span> &#123;</span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>() &#123;</span><br><span class="line">      <span class="title class_">RelativeContainer</span>() &#123;</span><br><span class="line">        <span class="title class_">Row</span>()</span><br><span class="line">          .<span class="title function_">width</span>(<span class="number">100</span>)</span><br><span class="line">          .<span class="title function_">height</span>(<span class="number">100</span>)</span><br><span class="line">          .<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Orange</span>)</span><br><span class="line">          .<span class="title function_">alignRules</span>(&#123;</span><br><span class="line">            <span class="attr">left</span>: &#123; <span class="attr">anchor</span>: <span class="string">&#x27;__container__&#x27;</span>, <span class="attr">align</span>: <span class="title class_">HorizontalAlign</span>.<span class="property">Start</span> &#125;,</span><br><span class="line">            <span class="attr">top</span>: &#123; <span class="attr">anchor</span>: <span class="string">&#x27;__container__&#x27;</span>, <span class="attr">align</span>: <span class="title class_">VerticalAlign</span>.<span class="property">Top</span> &#125;</span><br><span class="line">          &#125;)</span><br><span class="line">          .<span class="title function_">id</span>(<span class="string">&#x27;row1&#x27;</span>)</span><br><span class="line">          .<span class="title function_">offset</span>(&#123; <span class="attr">x</span>: <span class="number">20</span>, <span class="attr">y</span>: <span class="number">20</span> &#125;)</span><br><span class="line">      &#125;.<span class="title function_">width</span>(<span class="number">200</span>).<span class="title function_">height</span>(<span class="number">200</span>).<span class="title function_">border</span>(&#123; <span class="attr">width</span>: <span class="number">2</span>, <span class="attr">color</span>: <span class="title class_">Color</span>.<span class="property">Green</span> &#125;).<span class="title function_">id</span>(<span class="string">&#x27;rc&#x27;</span>)</span><br><span class="line">    &#125;.<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>).<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img data-src="https://gitee.com/zch0304/images/raw/master/note/1716995097983.jpg" style="zoom:80%;" /> 

<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Index</span> &#123;</span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">RelativeContainer</span>() &#123;</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">        .<span class="title function_">id</span>(<span class="string">&#x27;text1&#x27;</span>)</span><br><span class="line">        .<span class="title function_">width</span>(<span class="number">100</span>)</span><br><span class="line">        .<span class="title function_">height</span>(<span class="number">100</span>)</span><br><span class="line">        .<span class="title function_">fontSize</span>(<span class="number">30</span>)</span><br><span class="line">        .<span class="title function_">textAlign</span>(<span class="title class_">TextAlign</span>.<span class="property">Center</span>)</span><br><span class="line">        .<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Red</span>)</span><br><span class="line">        .<span class="title function_">alignRules</span>(&#123;</span><br><span class="line">          <span class="attr">top</span>: &#123; <span class="attr">anchor</span>: <span class="string">&#x27;__container__&#x27;</span>, <span class="attr">align</span>: <span class="title class_">VerticalAlign</span>.<span class="property">Top</span> &#125;,</span><br><span class="line">          <span class="attr">middle</span>: &#123; <span class="attr">anchor</span>: <span class="string">&#x27;__container__&#x27;</span>, <span class="attr">align</span>: <span class="title class_">HorizontalAlign</span>.<span class="property">Center</span> &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">        .<span class="title function_">id</span>(<span class="string">&#x27;text2&#x27;</span>)</span><br><span class="line">        .<span class="title function_">width</span>(<span class="number">100</span>)</span><br><span class="line">        .<span class="title function_">height</span>(<span class="number">100</span>)</span><br><span class="line">        .<span class="title function_">fontSize</span>(<span class="number">30</span>)</span><br><span class="line">        .<span class="title function_">textAlign</span>(<span class="title class_">TextAlign</span>.<span class="property">Center</span>)</span><br><span class="line">        .<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Green</span>)</span><br><span class="line">        .<span class="title function_">alignRules</span>(&#123;</span><br><span class="line">          <span class="attr">top</span>: &#123; <span class="attr">anchor</span>: <span class="string">&#x27;text1&#x27;</span>, <span class="attr">align</span>: <span class="title class_">VerticalAlign</span>.<span class="property">Bottom</span> &#125;,</span><br><span class="line">          <span class="attr">right</span>: &#123; <span class="attr">anchor</span>: <span class="string">&#x27;text1&#x27;</span>, <span class="attr">align</span>: <span class="title class_">HorizontalAlign</span>.<span class="property">Start</span> &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">        .<span class="title function_">id</span>(<span class="string">&#x27;text3&#x27;</span>)</span><br><span class="line">        .<span class="title function_">width</span>(<span class="number">100</span>)</span><br><span class="line">        .<span class="title function_">height</span>(<span class="number">100</span>)</span><br><span class="line">        .<span class="title function_">fontSize</span>(<span class="number">30</span>)</span><br><span class="line">        .<span class="title function_">textAlign</span>(<span class="title class_">TextAlign</span>.<span class="property">Center</span>)</span><br><span class="line">        .<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Blue</span>)</span><br><span class="line">        .<span class="title function_">alignRules</span>(&#123;</span><br><span class="line">          <span class="attr">top</span>: &#123; <span class="attr">anchor</span>: <span class="string">&#x27;text1&#x27;</span>, <span class="attr">align</span>: <span class="title class_">VerticalAlign</span>.<span class="property">Bottom</span> &#125;,</span><br><span class="line">          <span class="attr">left</span>: &#123; <span class="attr">anchor</span>: <span class="string">&#x27;text1&#x27;</span>, <span class="attr">align</span>: <span class="title class_">HorizontalAlign</span>.<span class="property">Start</span> &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">        .<span class="title function_">id</span>(<span class="string">&#x27;text4&#x27;</span>)</span><br><span class="line">        .<span class="title function_">width</span>(<span class="number">100</span>)</span><br><span class="line">        .<span class="title function_">height</span>(<span class="number">100</span>)</span><br><span class="line">        .<span class="title function_">fontSize</span>(<span class="number">30</span>)</span><br><span class="line">        .<span class="title function_">textAlign</span>(<span class="title class_">TextAlign</span>.<span class="property">Center</span>)</span><br><span class="line">        .<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Yellow</span>)</span><br><span class="line">        .<span class="title function_">alignRules</span>(&#123;</span><br><span class="line">          <span class="attr">top</span>: &#123; <span class="attr">anchor</span>: <span class="string">&#x27;text1&#x27;</span>, <span class="attr">align</span>: <span class="title class_">VerticalAlign</span>.<span class="property">Bottom</span> &#125;,</span><br><span class="line">          <span class="attr">left</span>: &#123; <span class="attr">anchor</span>: <span class="string">&#x27;text1&#x27;</span>, <span class="attr">align</span>: <span class="title class_">HorizontalAlign</span>.<span class="property">End</span> &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">        .<span class="title function_">id</span>(<span class="string">&#x27;text5&#x27;</span>)</span><br><span class="line">        .<span class="title function_">width</span>(<span class="number">100</span>)</span><br><span class="line">        .<span class="title function_">height</span>(<span class="number">100</span>)</span><br><span class="line">        .<span class="title function_">fontSize</span>(<span class="number">30</span>)</span><br><span class="line">        .<span class="title function_">textAlign</span>(<span class="title class_">TextAlign</span>.<span class="property">Center</span>)</span><br><span class="line">        .<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Pink</span>)</span><br><span class="line">        .<span class="title function_">alignRules</span>(&#123;</span><br><span class="line">          <span class="attr">top</span>: &#123; <span class="attr">anchor</span>: <span class="string">&#x27;text3&#x27;</span>, <span class="attr">align</span>: <span class="title class_">VerticalAlign</span>.<span class="property">Bottom</span> &#125;,</span><br><span class="line">          <span class="attr">left</span>: &#123; <span class="attr">anchor</span>: <span class="string">&#x27;text3&#x27;</span>, <span class="attr">align</span>: <span class="title class_">HorizontalAlign</span>.<span class="property">Start</span> &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img data-src="https://gitee.com/zch0304/images/raw/master/note/1717678884319.jpg" style="zoom:80%;" /> 

<h5 id="实现底部弹出按钮案例"><a href="#实现底部弹出按钮案例" class="headerlink" title="实现底部弹出按钮案例"></a>实现底部弹出按钮案例</h5><figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Index</span> &#123;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">flag</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>() &#123;</span><br><span class="line">      <span class="title class_">Stack</span>(&#123; <span class="attr">alignContent</span>: <span class="title class_">Alignment</span>.<span class="property">BottomEnd</span> &#125;) &#123;</span><br><span class="line">        <span class="title class_">List</span>(&#123; <span class="attr">space</span>: <span class="number">10</span> &#125;) &#123;</span><br><span class="line">          <span class="title class_">ForEach</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>], <span class="function">(<span class="params">item: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="title class_">ListItem</span>() &#123;</span><br><span class="line">              <span class="title class_">Text</span>(<span class="string">`<span class="subst">$&#123;item&#125;</span>`</span>)</span><br><span class="line">                .<span class="title function_">fontSize</span>(<span class="number">30</span>)</span><br><span class="line">                .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">                .<span class="title function_">height</span>(<span class="number">80</span>)</span><br><span class="line">                .<span class="title function_">backgroundColor</span>(<span class="string">&#x27;#eee&#x27;</span>)</span><br><span class="line">                .<span class="title function_">borderRadius</span>(<span class="number">10</span>)</span><br><span class="line">                .<span class="title function_">textAlign</span>(<span class="title class_">TextAlign</span>.<span class="property">Center</span>)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;.<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>).<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>).<span class="title function_">padding</span>(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">        <span class="title class_">RelativeContainer</span>() &#123;</span><br><span class="line">          <span class="title class_">Button</span>(&#123; <span class="attr">stateEffect</span>: <span class="literal">true</span> &#125;) &#123;</span><br><span class="line">            <span class="title class_">Text</span>(<span class="string">&#x27;+&#x27;</span>).<span class="title function_">textAlign</span>(<span class="title class_">TextAlign</span>.<span class="property">Center</span>).<span class="title function_">fontColor</span>(<span class="title class_">Color</span>.<span class="property">White</span>).<span class="title function_">fontSize</span>(<span class="number">30</span>)</span><br><span class="line">          &#125;</span><br><span class="line">          .<span class="title function_">id</span>(<span class="string">&#x27;add&#x27;</span>)</span><br><span class="line">          .<span class="title function_">width</span>(<span class="number">80</span>)</span><br><span class="line">          .<span class="title function_">height</span>(<span class="number">80</span>)</span><br><span class="line">          .<span class="title function_">alignRules</span>(&#123;</span><br><span class="line">            <span class="attr">top</span>: &#123; <span class="attr">anchor</span>: <span class="string">&#x27;__container__&#x27;</span>, <span class="attr">align</span>: <span class="title class_">VerticalAlign</span>.<span class="property">Top</span> &#125;,</span><br><span class="line">            <span class="attr">left</span>: &#123; <span class="attr">anchor</span>: <span class="string">&#x27;__container__&#x27;</span>, <span class="attr">align</span>: <span class="title class_">HorizontalAlign</span>.<span class="property">Start</span> &#125;</span><br><span class="line">          &#125;)</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">flag</span>) &#123;</span><br><span class="line">            <span class="title class_">Button</span>() &#123;</span><br><span class="line">              <span class="title class_">Text</span>(<span class="string">&#x27;A&#x27;</span>).<span class="title function_">textAlign</span>(<span class="title class_">TextAlign</span>.<span class="property">Center</span>).<span class="title function_">fontColor</span>(<span class="title class_">Color</span>.<span class="property">White</span>).<span class="title function_">fontSize</span>(<span class="number">30</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            .<span class="title function_">id</span>(<span class="string">&#x27;A&#x27;</span>)</span><br><span class="line">            .<span class="title function_">width</span>(<span class="number">80</span>)</span><br><span class="line">            .<span class="title function_">height</span>(<span class="number">80</span>)</span><br><span class="line">            .<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Orange</span>)</span><br><span class="line">            .<span class="title function_">alignRules</span>(&#123;</span><br><span class="line">              <span class="attr">bottom</span>: &#123; <span class="attr">anchor</span>: <span class="string">&#x27;add&#x27;</span>, <span class="attr">align</span>: <span class="title class_">VerticalAlign</span>.<span class="property">Top</span> &#125;,</span><br><span class="line">              <span class="attr">right</span>: &#123; <span class="attr">anchor</span>: <span class="string">&#x27;add&#x27;</span>, <span class="attr">align</span>: <span class="title class_">HorizontalAlign</span>.<span class="property">End</span> &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            .<span class="title function_">offset</span>(&#123; <span class="attr">y</span>: -<span class="number">30</span> &#125;)</span><br><span class="line">            .<span class="title function_">opacity</span>(<span class="number">0.8</span>)</span><br><span class="line"></span><br><span class="line">            <span class="title class_">Button</span>() &#123;</span><br><span class="line">              <span class="title class_">Text</span>(<span class="string">&#x27;B&#x27;</span>).<span class="title function_">textAlign</span>(<span class="title class_">TextAlign</span>.<span class="property">Center</span>).<span class="title function_">fontColor</span>(<span class="title class_">Color</span>.<span class="property">White</span>).<span class="title function_">fontSize</span>(<span class="number">30</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            .<span class="title function_">id</span>(<span class="string">&#x27;B&#x27;</span>)</span><br><span class="line">            .<span class="title function_">width</span>(<span class="number">80</span>)</span><br><span class="line">            .<span class="title function_">height</span>(<span class="number">80</span>)</span><br><span class="line">            .<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Gray</span>)</span><br><span class="line">            .<span class="title function_">alignRules</span>(&#123;</span><br><span class="line">              <span class="attr">bottom</span>: &#123; <span class="attr">anchor</span>: <span class="string">&#x27;add&#x27;</span>, <span class="attr">align</span>: <span class="title class_">VerticalAlign</span>.<span class="property">Top</span> &#125;,</span><br><span class="line">              <span class="attr">right</span>: &#123; <span class="attr">anchor</span>: <span class="string">&#x27;add&#x27;</span>, <span class="attr">align</span>: <span class="title class_">HorizontalAlign</span>.<span class="property">Start</span> &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            .<span class="title function_">offset</span>(&#123; <span class="attr">x</span>: -<span class="number">10</span>, <span class="attr">y</span>: -<span class="number">10</span> &#125;)</span><br><span class="line">            .<span class="title function_">opacity</span>(<span class="number">0.8</span>)</span><br><span class="line"></span><br><span class="line">            <span class="title class_">Button</span>() &#123;</span><br><span class="line">              <span class="title class_">Text</span>(<span class="string">&#x27;C&#x27;</span>).<span class="title function_">textAlign</span>(<span class="title class_">TextAlign</span>.<span class="property">Center</span>).<span class="title function_">fontColor</span>(<span class="title class_">Color</span>.<span class="property">White</span>).<span class="title function_">fontSize</span>(<span class="number">30</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            .<span class="title function_">id</span>(<span class="string">&#x27;C&#x27;</span>)</span><br><span class="line">            .<span class="title function_">width</span>(<span class="number">80</span>)</span><br><span class="line">            .<span class="title function_">height</span>(<span class="number">80</span>)</span><br><span class="line">            .<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Green</span>)</span><br><span class="line">            .<span class="title function_">alignRules</span>(&#123;</span><br><span class="line">              <span class="attr">top</span>: &#123; <span class="attr">anchor</span>: <span class="string">&#x27;add&#x27;</span>, <span class="attr">align</span>: <span class="title class_">VerticalAlign</span>.<span class="property">Top</span> &#125;,</span><br><span class="line">              <span class="attr">right</span>: &#123; <span class="attr">anchor</span>: <span class="string">&#x27;add&#x27;</span>, <span class="attr">align</span>: <span class="title class_">HorizontalAlign</span>.<span class="property">Start</span> &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            .<span class="title function_">offset</span>(&#123; <span class="attr">x</span>: -<span class="number">30</span> &#125;)</span><br><span class="line">            .<span class="title function_">opacity</span>(<span class="number">0.8</span>)</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        .<span class="title function_">width</span>(<span class="number">88</span>)</span><br><span class="line">        .<span class="title function_">height</span>(<span class="number">88</span>)</span><br><span class="line">        .<span class="title function_">onClick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">flag</span> = !<span class="variable language_">this</span>.<span class="property">flag</span></span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img data-src="https://gitee.com/zch0304/images/raw/master/note/1717682221884.jpg" style="zoom:80%;" /> 

<h4 id="Image-图片组件以及-HarmonyOS-图标库"><a href="#Image-图片组件以及-HarmonyOS-图标库" class="headerlink" title="Image 图片组件以及 HarmonyOS 图标库"></a>Image 图片组件以及 HarmonyOS 图标库</h4><p>Image 图片组件，支持本地图片和网络图片的渲染展示。</p>
<h5 id="加载网络图片"><a href="#加载网络图片" class="headerlink" title="加载网络图片"></a>加载网络图片</h5><p>1、需要在 src&#x2F;main&#x2F;module.json5 中申请网络权限。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;requestPermissions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ohos.permission.INTERNET&quot;</span></span><br><span class="line"> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<p>2、加载远程图片。</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Image</span>(<span class="string">&#x27;https://gitee.com/zch0304/images/raw/master/note/test_icon1.jpg&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="加载本地图片"><a href="#加载本地图片" class="headerlink" title="加载本地图片"></a>加载本地图片</h5><figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// resources\base\media 目录</span></span><br><span class="line"><span class="title class_">Image</span>($r(<span class="string">&#x27;app.media.startIcon&#x27;</span>)).<span class="title function_">width</span>(<span class="number">100</span>).<span class="title function_">height</span>(<span class="number">100</span>).<span class="title function_">margin</span>(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// resources\rawfile 目录</span></span><br><span class="line"><span class="title class_">Image</span>($rawfile(<span class="string">&#x27;img.png&#x27;</span>)).<span class="title function_">width</span>(<span class="number">100</span>).<span class="title function_">height</span>(<span class="number">100</span>).<span class="title function_">margin</span>(<span class="number">10</span>)</span><br></pre></td></tr></table></figure>

<h5 id="HarmonyOS-图标库"><a href="#HarmonyOS-图标库" class="headerlink" title="HarmonyOS 图标库"></a>HarmonyOS 图标库</h5><p><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuaGFybW9ueW9zLmNvbS9jbi9kZXNpZ24vaGFybW9ueW9zLWljb24v">https://developer.harmonyos.com/cn/design/harmonyos-icon/<i class="fa fa-external-link-alt"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuaWNvbmZvbnQuY24v">https://www.iconfont.cn/<i class="fa fa-external-link-alt"></i></span></p>
<h4 id="List-组件详解"><a href="#List-组件详解" class="headerlink" title="List 组件详解"></a>List 组件详解</h4><p>List 适合用于呈现同类数据类型或数据类型集，例如图片和文本。在列表中显示数据集合是许多应用程序中的常见要求（如通讯录、音乐列表、购物清单等）。</p>
<p>List 包含 ListItem、ListItemGroup 子组件。</p>
<h5 id="List-接口"><a href="#List-接口" class="headerlink" title="List 接口"></a>List 接口</h5><figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">List</span>(value?:&#123;space?: <span class="built_in">number</span> | <span class="built_in">string</span>, initialIndex?: <span class="built_in">number</span>, scroller?: <span class="title class_">Scroller</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>从 API version 9 开始，该接口支持在 ArkTS 卡片中使用。</p>
<p>参数：</p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>参数类型</th>
<th>必填</th>
<th>参数描述</th>
</tr>
</thead>
<tbody><tr>
<td>space</td>
<td>number &#124; string</td>
<td>否</td>
<td>子组件主轴方向的间隔。默认值：0。说明：设置为除 -1 外其它负数或百分比时，按默认值显示。space 参数值小于 List 分割线宽度时，子组件主轴方向的间隔取分割线宽度。</td>
</tr>
<tr>
<td>initialIndex</td>
<td>number</td>
<td>否</td>
<td>设置当前 List 初次加载时视口起始位置显示的 item 的索引值。默认值：0。说明：设置为除 -1 外其它负数或超过了当前 List 最后一个 item 的索引值时视为无效取值，无效取值按默认值显示。</td>
</tr>
<tr>
<td>scroller</td>
<td><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuaHVhd2VpLmNvbS9jb25zdW1lci9jbi9kb2MvaGFybW9ueW9zLXJlZmVyZW5jZXMtVjIvdHMtY29udGFpbmVyLXNjcm9sbC0wMDAwMDAxNDI3OTAyNDgwLVYyI1pILUNOX1RPUElDXzAwMDAwMDE1MjM2NDg3OTBfX3Njcm9sbGVy">Scroller<i class="fa fa-external-link-alt"></i></span></td>
<td>否</td>
<td>可滚动组件的控制器。用于与可滚动组件进行绑定。说明：不允许和其它滚动类组件绑定同一个滚动控制对象。</td>
</tr>
</tbody></table>
<h5 id="List-属性"><a href="#List-属性" class="headerlink" title="List 属性"></a>List 属性</h5><table>
<thead>
<tr>
<th>名称</th>
<th>参数类型</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>listDirection</td>
<td><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuaHVhd2VpLmNvbS9jb25zdW1lci9jbi9kb2MvaGFybW9ueW9zLXJlZmVyZW5jZXMtVjIvdHMtYXBwZW5kaXgtZW51bXMtMDAwMDAwMTQ3ODA2MTc0MS1WMiNaSC1DTl9UT1BJQ18wMDAwMDAxNTc0MjQ4Nzg5X19heGlz">Axis<i class="fa fa-external-link-alt"></i></span></td>
<td>设置 List 组件排列方向。默认值：Axis.Vertical。从 API version 9 开始，该接口支持在 ArkTS 卡片中使用。</td>
</tr>
<tr>
<td>divider</td>
<td>{ strokeWidth: Length;     color?: ResourceColor;     startMargin?: Length;     endMargin?: Length; } &#124; null</td>
<td>设置 ListItem 分割线样式，默认无分割线。- strokeWidth：分割线的线宽。- color：分割线的颜色。- startMargin：分割线与列表侧边起始端的距离。- endMargin：分割线与列表侧边结束端的距离。从 API version 9 开始，该接口支持在ArkTS卡片中使用。endMargin + startMargin 不能超过列宽度。startMargin 和 endMargin 不支持设置百分比。List 的分割线画在主轴方向两个子组件之间，第一个子组件上方和最后一个子组件下方不会绘制分割线。多列模式下，ListItem 与 ListItem 之间的分割线起始边距从每一列的交叉轴方向起始边开始计算，其它情况从 List 交叉轴方向起始边开始计算。</td>
</tr>
<tr>
<td>scrollBar</td>
<td><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuaHVhd2VpLmNvbS9jb25zdW1lci9jbi9kb2MvaGFybW9ueW9zLXJlZmVyZW5jZXMtVjIvdHMtYXBwZW5kaXgtZW51bXMtMDAwMDAwMTQ3ODA2MTc0MS1WMiNaSC1DTl9UT1BJQ18wMDAwMDAxNTc0MjQ4Nzg5X19iYXJzdGF0ZQ==">BarState<i class="fa fa-external-link-alt"></i></span></td>
<td>设置滚动条状态。默认值：BarState.Oﬀ 从 API version 9 开始，该接口支持在 ArkTS卡片中使用。</td>
</tr>
<tr>
<td>cachedCount</td>
<td>number</td>
<td>设置列表中 ListItem &#x2F; ListItemGroup 的预加载数量，其中 ListItemGroup 将作为一个整体进行计算，ListItemGroup 中的所有 ListItem 会一次性全部加载出来。具体使用可参考<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuaHVhd2VpLmNvbS9jb25zdW1lci9jbi9kb2MvaGFybW9ueW9zLWd1aWRlcy1WMi91aS10cy1wZXJmb3JtYW5jZS1pbXByb3ZlbWVudC1yZWNvbW1lbmRhdGlvbi0wMDAwMDAxNDc3OTgxMDAxLVYyI1pILUNOX1RPUElDXzAwMDAwMDE1MjM2NDg0MThfXyVFNSU4NyU4RiVFNSVCMCU5MSVFNSVCQSU5NCVFNyU5NCVBOCVFNiVCQiU5MSVFNSU4QSVBOCVFNyU5OSVCRCVFNSU5RCU5Nw==">减少应用白块说明<i class="fa fa-external-link-alt"></i></span>。默认值：1。从 API version 9 开始，该接口支持在 ArkTS 卡片中使用。说明：单列模式下，会在 List 显示的 ListItem 前后各缓存 cachedCount 个 ListItem。多列模式下，会在 List 显示的 ListItem 前后各缓存 cachedCount 个 ListItem。</td>
</tr>
<tr>
<td>editMode(deprecated)</td>
<td>boolean</td>
<td>声明当前 List 组件是否处于可编辑模式。可参考<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuaHVhd2VpLmNvbS9jb25zdW1lci9jbi9kb2MvaGFybW9ueW9zLXJlZmVyZW5jZXMtVjIvdHMtY29udGFpbmVyLWxpc3QtMDAwMDAwMTQ3Nzk4MTIxMy1WMiNzZWN0aW9uNTE1NDE4MTQxMDEyMTk=">示例 3<i class="fa fa-external-link-alt"></i></span> 实现删除选中的 list 项。从 API version9 开始废弃。默认值：false。</td>
</tr>
<tr>
<td>edgeEﬀect</td>
<td><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuaHVhd2VpLmNvbS9jb25zdW1lci9jbi9kb2MvaGFybW9ueW9zLXJlZmVyZW5jZXMtVjIvdHMtYXBwZW5kaXgtZW51bXMtMDAwMDAwMTQ3ODA2MTc0MS1WMiNaSC1DTl9UT1BJQ18wMDAwMDAxNTc0MjQ4Nzg5X19lZGdlZWZmZWN0">EdgeEﬀect<i class="fa fa-external-link-alt"></i></span></td>
<td>设置组件的滑动效果。默认值：EdgeEﬀect.Spring。从 API version 9 开始，该接口支持在 ArkTS 卡片中使用。</td>
</tr>
<tr>
<td>chainAnimation</td>
<td>boolean</td>
<td>设置当前 List 是否启用链式联动动效，开启后列表滑动以及顶部和底部拖拽时会有链式联动的效果。链式联动效果：List 内的 listitem 间隔一定距离，在基本的滑动交互行为下，主动对象驱动从动对象进行联动，驱动效果遵循弹簧物理动效。默认值：false。- false：不启用链式联动。- true：启用链式联动。从 API version 9 开始，该接口支持在 ArkTS 卡片中 使用。</td>
</tr>
<tr>
<td>multiSelectable8+</td>
<td>boolean</td>
<td>是否开启鼠标框选。默认值：false。- false：关闭框选。- true：开启框选。从 API version 9 开始，该接口支持在 ArkTS 卡片中使用。</td>
</tr>
<tr>
<td>lanes9+</td>
<td>number &#124; <span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuaHVhd2VpLmNvbS9jb25zdW1lci9jbi9kb2MvaGFybW9ueW9zLXJlZmVyZW5jZXMtVjIvdHMtdHlwZXMtMDAwMDAwMTQ3Nzk4MTI0MS1WMiNaSC1DTl9UT1BJQ18wMDAwMDAxNTczOTI4ODg5X19sZW5ndGhjb25zdHJhaW4=">LengthConstrain<i class="fa fa-external-link-alt"></i></span></td>
<td>以列模式为例（listDirection 为 Axis.Vertical）：lanes 用于决定 List 组件在交叉轴方向按几列布局。默认值：1。规则如下：- lanes 为指定的数量时，根据指定的数量与 List 组件的交叉轴尺寸除以列数作为列的宽度。- lanes 设置了 {minLength，maxLength} 时， 根据 List 组件的宽度自适应决定 lanes 数量（即列数），保证缩放过程中 lane 的宽度符合 {minLength，maxLength} 的限制。其中，minLength 条件会被优先满足，即优先保证符合 ListItem 的交叉轴尺寸符合最小限制。- lanes 设置了 {minLength，maxLength}，如果父组件交叉轴方向尺寸约束为无穷大时，固定按一列排列，列宽度按显示区域内最大的 ListItem 计算。- ListItemGroup 在多列模式下也是独占一行，ListItemGroup 中的 ListItem 按照 List 组件的 lanes 属性设置值来布局。- lanes 设置了 {minLength，maxLength} 时，计算列数会按照 ListItemGroup 的交叉轴尺寸计算。当 ListItemGroup 交叉轴尺寸与 List 交叉轴尺寸不一致时，ListItemGroup 中的列数与 List 中的列数可能不一样。该接口支持在 ArkTS 卡片中使用。</td>
</tr>
<tr>
<td>alignListItem9+</td>
<td>ListItemAlign</td>
<td>List 交叉轴方向宽度大于 ListItem 交叉轴宽度 * lanes 时，ListItem 在 List 交叉轴方向的布局方式，默认为首部对齐。默认值：ListItemAlign.Start。该接口支持在 ArkTS 卡片中使用。</td>
</tr>
<tr>
<td>sticky9+</td>
<td>StickyStyle</td>
<td>配合 ListItemGroup 组件使用，设置 ListItemGroup 中 header 和 footer 是否要吸顶或吸底。默认值：StickyStyle.None。该接口支持在 ArkTS 卡片中使用。说明：sticky 属性可设置为 StickyStyle.Header &#124; StickyStyle.Footer 以同时支持 header 吸顶和 footer 吸底。</td>
</tr>
</tbody></table>
<h5 id="List-事件"><a href="#List-事件" class="headerlink" title="List 事件"></a>List 事件</h5><table>
<thead>
<tr>
<th>名称</th>
<th>功能描述</th>
</tr>
</thead>
<tbody><tr>
<td>onItemDelete(deprecated) (event: (index: number) &#x3D;&gt; boolean)</td>
<td>当 List 组件在编辑模式时，点击 ListItem 右边出现的删除按钮时触发。从 API version9 开始废弃。- index：被删除的列表项的索引值。</td>
</tr>
<tr>
<td>onScroll(event: (scrollOﬀset: number, scrollState: ScrollState) &#x3D;&gt; void)</td>
<td>列表滑动时触发。- scrollOﬀset：滑动偏移量。- scrollState：当前滑动状态。使用控制器调用 ScrollEdge 和 ScrollToIndex 时不会触发，其余情况有滚动就会触发该事件。从 API version 9 开始，该接口支持在 ArkTS 卡片中使用。</td>
</tr>
<tr>
<td>onScrollIndex(event: (start: number, end: number) &#x3D;&gt; void)</td>
<td>列表滑动时触发。计算索引值时，ListItemGroup 作为一个整体占一个索引值，不计算 ListItemGroup 内部 ListItem 的索引值。- start：滑动起始位置索引值。- end：滑动结束位置索引值。触发该事件的条件：列表初始化时会触发一次，List 显示区域内第一个子组件的索引值或后一个子组件的索引值有变化时会触发。List 的边缘效果为弹簧效果时，在 List 滑动到边缘继续滑动和松手回弹过程不会触发 onScrollIndex 事件。从 API version 9 开始，该接口支持在 ArkTS 卡片中使用。</td>
</tr>
<tr>
<td>onReachStart(event: () &#x3D;&gt; void)</td>
<td>列表到达起始位置时触发。从 API version 9 开始，该接口支持在 ArkTS 卡片中使用。说明：List 初始化时如果 initialIndex 为 0 会触发一次，List 滚动到起始位置时触发一次。List 边缘效果为弹簧效果时，滑动经过起始位置时触发一次，回弹回起始位置时再触发 一次。</td>
</tr>
<tr>
<td>onReachEnd(event: () &#x3D;&gt; void)</td>
<td>列表到达末尾位置时触发。从 API version 9 开始，该接口支持在 ArkTS 卡片中使用。说明：List 边缘效果为弹簧效果时，滑动经过末尾位置时触发一次，回弹回末尾位置时再触发一次。</td>
</tr>
<tr>
<td>onScrollFrameBegin9+ (event: (oﬀset: number, state: ScrollState) &#x3D;&gt; { oﬀsetRemain })</td>
<td>列表开始滑动时触发，事件参数传入即将发生的滑动量，事件处理函数中可根据应用场景计算实际需要的滑动量并作为事件处理函数的返回值返回，列表将按照返回值的实际滑动量进行滑动。- oﬀset：即将发生的滑动量，单位 vp。- state：当前滑动状态。- oﬀsetRemain：实际滑动量，单位 vp。触发该事件的条件：手指拖动 List、List 惯性滑动时每帧开始时触发；List 超出边缘回弹、 使用滚动控制器的滚动不会触发。该接口支持在 ArkTS 卡片中使用。说明：当 listDirection 的值为 Axis.Vertical 时，返回垂直方向滑动量，当 listDirection 的值为 Axis.Horizontal 时，返回水平方向滑动量。</td>
</tr>
<tr>
<td>onScrollStart9+(event: () &#x3D;&gt; void)</td>
<td>列表滑动开始时触发。手指拖动列表或列表的滚动条触发的滑动开始时，会触发该事件。使用 Scroller 滑动控制器触发的带动画的滑动，动画开始时会触发该事件。该接口支持在 ArkTS 卡片中使用。</td>
</tr>
<tr>
<td>onScrollStop(event: () &#x3D;&gt; void)</td>
<td>列表滑动停止时触发。手拖动列表或列表的滚动条触发的滑动，手离开屏幕并且滑动停止时会触发该事件；使用 Scroller 滑动控制器触发的带动画的滑动，动画停止会触发该事件。从 API version 9 开始，该接口支持在 ArkTS 卡片中使用。</td>
</tr>
<tr>
<td>onItemMove(event: (from: number, to: number) &#x3D;&gt; boolean)</td>
<td>列表元素发生移动时触发。- from：移动前索引值。- to：移动后索引值。</td>
</tr>
<tr>
<td>onItemDragStart(event: (event: ItemDragInfo, itemIndex: number) &#x3D;&gt; ((() &#x3D;&gt; any) &#124; void)</td>
<td>开始拖拽列表元素时触发。- event：见 ItemDragInfo 对象说明。- itemIndex：被拖拽列表元素索引值。</td>
</tr>
<tr>
<td>onItemDragEnter(event: (event: ItemDragInfo) &#x3D;&gt; void)</td>
<td>拖拽进入列表元素范围内时触发。- event：见 ItemDragInfo 对象说明。</td>
</tr>
<tr>
<td>onItemDragMove(event: (event: ItemDragInfo, itemIndex: number, insertIndex: number) &#x3D;&gt; void)</td>
<td>拖拽在列表元素范围内移动时触发。- event：见 ItemDragInfo 对象说明。- itemIndex：拖拽起始位置。- insertIndex：拖拽插入位置。</td>
</tr>
<tr>
<td>onItemDragLeave(event: (event: ItemDragInfo, itemIndex: number) &#x3D;&gt; void)</td>
<td>拖拽离开列表元素时触发。- event：见 ItemDragInfo 对象说明。- itemIndex：拖拽离开的列表元素索引值。</td>
</tr>
<tr>
<td>onItemDrop(event: (event: ItemDragInfo, itemIndex: number, insertIndex: number, isSuccess: boolean) &#x3D;&gt; void)</td>
<td>绑定该事件的列表元素可作为拖拽释放目标，当在列表元素内停止拖拽时触发。- event：见 ItemDragInfo 对象说明。- itemIndex：拖拽起始位置。- insertIndex：拖拽插入位置。- isSuccess：是否成功释放。说明：跨 List 拖拽时，当拖拽释放的位置绑定了 onItemDrop 时会返回 true，否则为 false。List 内部拖拽时，isSuccess 为 onItemMove 事件的返回值。</td>
</tr>
</tbody></table>
<h5 id="List-普通垂直列表"><a href="#List-普通垂直列表" class="headerlink" title="List 普通垂直列表"></a>List 普通垂直列表</h5><figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Index</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="attr">arr</span>: <span class="built_in">number</span>[] = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>]</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>() &#123;</span><br><span class="line">      <span class="title class_">List</span>(&#123; <span class="attr">space</span>: <span class="number">10</span>, <span class="attr">initialIndex</span>: <span class="number">0</span> &#125;) &#123;</span><br><span class="line">        <span class="title class_">ForEach</span>(<span class="variable language_">this</span>.<span class="property">arr</span>, <span class="function">(<span class="params">item: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="title class_">ListItem</span>() &#123;</span><br><span class="line">            <span class="title class_">Text</span>(item.<span class="title function_">toString</span>())</span><br><span class="line">              .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">              .<span class="title function_">height</span>(<span class="number">100</span>)</span><br><span class="line">              .<span class="title function_">fontSize</span>(<span class="number">24</span>)</span><br><span class="line">              .<span class="title function_">textAlign</span>(<span class="title class_">TextAlign</span>.<span class="property">Center</span>)</span><br><span class="line">              .<span class="title function_">borderRadius</span>(<span class="number">10</span>)</span><br><span class="line">              .<span class="title function_">backgroundColor</span>(<span class="number">0xFFFFFF</span>)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;, <span class="function">(<span class="params">item: <span class="built_in">number</span></span>) =&gt;</span> item.<span class="title function_">toString</span>())</span><br><span class="line">      &#125;</span><br><span class="line">      .<span class="title function_">listDirection</span>(<span class="title class_">Axis</span>.<span class="property">Vertical</span>) <span class="comment">// 排列方向</span></span><br><span class="line">      .<span class="title function_">divider</span>(&#123; <span class="attr">strokeWidth</span>: <span class="number">2</span>, <span class="attr">color</span>: <span class="number">0xFF0000</span>, <span class="attr">startMargin</span>: <span class="number">20</span>, <span class="attr">endMargin</span>: <span class="number">20</span> &#125;) <span class="comment">// 每行之间的分界线</span></span><br><span class="line">      .<span class="title function_">edgeEffect</span>(<span class="title class_">EdgeEffect</span>.<span class="property">None</span>) <span class="comment">// 滑动到边缘无效果</span></span><br><span class="line">      .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">      .<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">      .<span class="title function_">padding</span>(<span class="number">10</span>)</span><br><span class="line">    &#125;.<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>).<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Gray</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="List-微信用户中心布局"><a href="#List-微信用户中心布局" class="headerlink" title="List 微信用户中心布局"></a>List 微信用户中心布局</h5><figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">UserListInterface</span> &#123;</span><br><span class="line">  <span class="attr">title</span>: <span class="built_in">string</span>,</span><br><span class="line">  <span class="attr">img</span>: <span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Index</span> &#123;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">list</span>: <span class="title class_">UserListInterface</span>[] = [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&quot;服务&quot;</span>,</span><br><span class="line">      <span class="attr">img</span>: <span class="string">&quot;https://gitee.com/zch0304/images/raw/master/note/userlist/01.jpg&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&quot;收藏&quot;</span>,</span><br><span class="line">      <span class="attr">img</span>: <span class="string">&quot;https://gitee.com/zch0304/images/raw/master/note/userlist/02.jpg&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&quot;朋友圈&quot;</span>,</span><br><span class="line">      <span class="attr">img</span>: <span class="string">&quot;https://gitee.com/zch0304/images/raw/master/note/userlist/03.jpg&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&quot;视频号&quot;</span>,</span><br><span class="line">      <span class="attr">img</span>: <span class="string">&quot;https://gitee.com/zch0304/images/raw/master/note/userlist/04.jpg&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&quot;卡包&quot;</span>,</span><br><span class="line">      <span class="attr">img</span>: <span class="string">&quot;https://gitee.com/zch0304/images/raw/master/note/userlist/05.jpg&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&quot;表情&quot;</span>,</span><br><span class="line">      <span class="attr">img</span>: <span class="string">&quot;https://gitee.com/zch0304/images/raw/master/note/userlist/06.jpg&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&quot;设置&quot;</span>,</span><br><span class="line">      <span class="attr">img</span>: <span class="string">&quot;https://gitee.com/zch0304/images/raw/master/note/userlist/07.jpg&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>() &#123;</span><br><span class="line">      <span class="title class_">List</span>(&#123; <span class="attr">space</span>: <span class="number">10</span>, <span class="attr">initialIndex</span>: <span class="number">0</span> &#125;) &#123;</span><br><span class="line">        <span class="title class_">ListItem</span>() &#123;</span><br><span class="line">          <span class="title class_">RelativeContainer</span>() &#123;</span><br><span class="line">            <span class="title class_">Image</span>(<span class="string">&quot;https://gitee.com/zch0304/images/raw/master/note/test_icon4.jpg&quot;</span>)</span><br><span class="line">              .<span class="title function_">id</span>(<span class="string">&#x27;avatar&#x27;</span>)</span><br><span class="line">              .<span class="title function_">width</span>(<span class="number">80</span>)</span><br><span class="line">              .<span class="title function_">height</span>(<span class="number">80</span>)</span><br><span class="line">              .<span class="title function_">objectFit</span>(<span class="title class_">ImageFit</span>.<span class="property">Fill</span>)</span><br><span class="line">              .<span class="title function_">alignRules</span>(&#123;</span><br><span class="line">                <span class="attr">left</span>: &#123; <span class="attr">anchor</span>: <span class="string">&#x27;__container__&#x27;</span>, <span class="attr">align</span>: <span class="title class_">HorizontalAlign</span>.<span class="property">Start</span> &#125;,</span><br><span class="line">                <span class="attr">top</span>: &#123; <span class="attr">anchor</span>: <span class="string">&#x27;__container__&#x27;</span>, <span class="attr">align</span>: <span class="title class_">VerticalAlign</span>.<span class="property">Top</span> &#125;</span><br><span class="line">              &#125;)</span><br><span class="line">              .<span class="title function_">margin</span>(&#123; <span class="attr">left</span>: <span class="number">20</span>, <span class="attr">top</span>: <span class="number">30</span> &#125;)</span><br><span class="line"></span><br><span class="line">            <span class="title class_">Text</span>(<span class="string">&quot;明年今日&quot;</span>)</span><br><span class="line">              .<span class="title function_">id</span>(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">              .<span class="title function_">fontSize</span>(<span class="number">18</span>)</span><br><span class="line">              .<span class="title function_">alignRules</span>(&#123;</span><br><span class="line">                <span class="attr">left</span>: &#123; <span class="attr">anchor</span>: <span class="string">&#x27;avatar&#x27;</span>, <span class="attr">align</span>: <span class="title class_">HorizontalAlign</span>.<span class="property">End</span> &#125;,</span><br><span class="line">                <span class="attr">top</span>: &#123; <span class="attr">anchor</span>: <span class="string">&#x27;avatar&#x27;</span>, <span class="attr">align</span>: <span class="title class_">VerticalAlign</span>.<span class="property">Top</span> &#125;</span><br><span class="line">              &#125;)</span><br><span class="line">              .<span class="title function_">margin</span>(&#123; <span class="attr">left</span>: <span class="number">10</span> &#125;)</span><br><span class="line"></span><br><span class="line">            <span class="title class_">Text</span>(<span class="string">&quot;微信号：zhich&quot;</span>)</span><br><span class="line">              .<span class="title function_">id</span>(<span class="string">&#x27;account&#x27;</span>)</span><br><span class="line">              .<span class="title function_">fontSize</span>(<span class="number">14</span>)</span><br><span class="line">              .<span class="title function_">alignRules</span>(&#123;</span><br><span class="line">                <span class="attr">left</span>: &#123; <span class="attr">anchor</span>: <span class="string">&#x27;avatar&#x27;</span>, <span class="attr">align</span>: <span class="title class_">HorizontalAlign</span>.<span class="property">End</span> &#125;,</span><br><span class="line">                <span class="attr">bottom</span>: &#123; <span class="attr">anchor</span>: <span class="string">&#x27;avatar&#x27;</span>, <span class="attr">align</span>: <span class="title class_">VerticalAlign</span>.<span class="property">Bottom</span> &#125;</span><br><span class="line">              &#125;)</span><br><span class="line">              .<span class="title function_">margin</span>(&#123; <span class="attr">left</span>: <span class="number">10</span> &#125;)</span><br><span class="line">          &#125;.<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>).<span class="title function_">height</span>(<span class="string">&#x27;200vp&#x27;</span>).<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">White</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="title class_">ListItem</span>() &#123;</span><br><span class="line">          <span class="title class_">CustomItem</span>(&#123; <span class="attr">model</span>: <span class="variable language_">this</span>.<span class="property">list</span>[<span class="number">0</span>] &#125;)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="title class_">ListItem</span>() &#123;</span><br><span class="line">          <span class="title class_">Column</span>() &#123;</span><br><span class="line">            <span class="title class_">ForEach</span>(<span class="variable language_">this</span>.<span class="property">list</span>, <span class="function">(<span class="params">item: UserListInterface, key</span>) =&gt;</span> &#123;</span><br><span class="line">              <span class="keyword">if</span> (key &gt; <span class="number">0</span> &amp;&amp; key &lt; <span class="variable language_">this</span>.<span class="property">list</span>.<span class="property">length</span> - <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="title class_">CustomItem</span>(&#123; <span class="attr">model</span>: item &#125;)</span><br><span class="line">                <span class="title class_">Divider</span>()</span><br><span class="line">                  .<span class="title function_">strokeWidth</span>(<span class="number">1</span>)</span><br><span class="line">                  .<span class="title function_">color</span>(<span class="string">&quot;#eee&quot;</span>)</span><br><span class="line">                  .<span class="title function_">padding</span>(&#123; <span class="attr">left</span>: <span class="number">20</span>, <span class="attr">right</span>: <span class="number">20</span> &#125;)</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;, <span class="function">(<span class="params">item: UserListInterface</span>) =&gt;</span> item.<span class="property">img</span>)</span><br><span class="line">          &#125;.<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">White</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="title class_">ListItem</span>() &#123;</span><br><span class="line">          <span class="title class_">CustomItem</span>(&#123; <span class="attr">model</span>: <span class="variable language_">this</span>.<span class="property">list</span>[<span class="variable language_">this</span>.<span class="property">list</span>.<span class="property">length</span>-<span class="number">1</span>] &#125;)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">      .<span class="title function_">edgeEffect</span>(<span class="title class_">EdgeEffect</span>.<span class="property">Spring</span>)</span><br><span class="line">      .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">      .<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    &#125;.<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>).<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>).<span class="title function_">backgroundColor</span>(<span class="number">0xeeeeee</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">CustomItem</span> &#123;</span><br><span class="line">  <span class="attr">model</span>: <span class="title class_">UserListInterface</span> = &#123; <span class="attr">title</span>: <span class="string">&quot;&quot;</span>, <span class="attr">img</span>: <span class="string">&quot;&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Row</span>() &#123;</span><br><span class="line">      <span class="title class_">Row</span>() &#123;</span><br><span class="line">        <span class="title class_">Image</span>(<span class="variable language_">this</span>.<span class="property">model</span>.<span class="property">img</span>)</span><br><span class="line">          .<span class="title function_">width</span>(<span class="number">28</span>)</span><br><span class="line">          .<span class="title function_">height</span>(<span class="number">28</span>)</span><br><span class="line">          .<span class="title function_">objectFit</span>(<span class="title class_">ImageFit</span>.<span class="property">Cover</span>)</span><br><span class="line">        <span class="title class_">Text</span>(<span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.model.title&#125;</span>`</span>).<span class="title function_">fontSize</span>(<span class="number">16</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="title class_">Image</span>(<span class="string">&quot;https://gitee.com/zch0304/images/raw/master/note/userlist/arrow_forward.jpg&quot;</span>)</span><br><span class="line">        .<span class="title function_">width</span>(<span class="number">28</span>)</span><br><span class="line">        .<span class="title function_">height</span>(<span class="number">28</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    .<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">White</span>)</span><br><span class="line">    .<span class="title function_">padding</span>(<span class="number">10</span>)</span><br><span class="line">    .<span class="title function_">justifyContent</span>(<span class="title class_">FlexAlign</span>.<span class="property">SpaceBetween</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img data-src="https://gitee.com/zch0304/images/raw/master/note/1718296042527.jpg" style="zoom: 50%;" /> 

<h5 id="List-文章列表布局"><a href="#List-文章列表布局" class="headerlink" title="List 文章列表布局"></a>List 文章列表布局</h5><figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Article</span> &#123;</span><br><span class="line">  <span class="attr">key</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">title</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">img</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">author</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">date</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">key: <span class="built_in">string</span>, title: <span class="built_in">string</span>, img: <span class="built_in">string</span>, author: <span class="built_in">string</span>, date: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">key</span> = key;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">title</span> = title;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">img</span> = img;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">author</span> = author;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">date</span> = date;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Article</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../model/Article&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Index</span> &#123;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">articleList</span>: <span class="title class_">Array</span>&lt;<span class="title class_">Article</span>&gt; = [</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Article</span>(</span><br><span class="line">      <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;新手攻略|开启关怀模式，与家人更亲近~&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;https://gitee.com/zch0304/images/raw/master/note/article/01.png&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;国家电网&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;2024-12-2&#x27;</span></span><br><span class="line">    ),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Article</span>(</span><br><span class="line">      <span class="string">&#x27;2&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;反诈课堂|光伏骗局套路多听我给您细细说!&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;https://gitee.com/zch0304/images/raw/master/note/article/02.png&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;国家电网&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;2024-4-2&#x27;</span></span><br><span class="line">    ),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Article</span>(</span><br><span class="line">      <span class="string">&#x27;3&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;新手攻略| 联合办、网上办一次办，这些地方的用户注&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;https://gitee.com/zch0304/images/raw/master/note/article/03.png&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;国家电网&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;2024-1-12&#x27;</span></span><br><span class="line">    ),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Article</span>(</span><br><span class="line">      <span class="string">&#x27;4&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;新手攻略|轻轻一点，电费一键查询&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;https://gitee.com/zch0304/images/raw/master/note/article/04.png&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;国家电网&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;2024-12-2&#x27;</span></span><br><span class="line">    ),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Article</span>(</span><br><span class="line">      <span class="string">&#x27;5&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;关注|局地降温超16C!寒潮天气来袭，注意防寒保暖!&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;https://gitee.com/zch0304/images/raw/master/note/article/05.png&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;国家电网&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;2024-2-6&#x27;</span></span><br><span class="line">    ),</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>() &#123;</span><br><span class="line">      <span class="title class_">List</span>() &#123;</span><br><span class="line">        <span class="title class_">ForEach</span>(<span class="variable language_">this</span>.<span class="property">articleList</span>, <span class="function">(<span class="params">item: Article</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="title class_">ListItem</span>() &#123;</span><br><span class="line">            <span class="title class_">Row</span>() &#123;</span><br><span class="line">              <span class="title class_">Column</span>() &#123;</span><br><span class="line">                <span class="title class_">Text</span>(item.<span class="property">title</span>).<span class="title function_">fontSize</span>(<span class="number">16</span>).<span class="title function_">fontWeight</span>(<span class="title class_">FontWeight</span>.<span class="property">Bold</span>)</span><br><span class="line">                <span class="title class_">Text</span>(<span class="string">`<span class="subst">$&#123;item.author&#125;</span>  <span class="subst">$&#123;item.date&#125;</span>`</span>).<span class="title function_">fontSize</span>(<span class="number">14</span>)</span><br><span class="line">              &#125;</span><br><span class="line">              .<span class="title function_">layoutWeight</span>(<span class="number">1</span>)</span><br><span class="line">              .<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">              .<span class="title function_">justifyContent</span>(<span class="title class_">FlexAlign</span>.<span class="property">SpaceBetween</span>)</span><br><span class="line">              .<span class="title function_">alignItems</span>(<span class="title class_">HorizontalAlign</span>.<span class="property">Start</span>)</span><br><span class="line"></span><br><span class="line">              <span class="title class_">Image</span>(item.<span class="property">img</span>).<span class="title function_">width</span>(<span class="number">100</span>).<span class="title function_">height</span>(<span class="number">68</span>).<span class="title function_">margin</span>(&#123; <span class="attr">left</span>: <span class="number">5</span> &#125;).<span class="title function_">borderRadius</span>(<span class="number">10</span>)</span><br><span class="line">            &#125;.<span class="title function_">height</span>(<span class="number">80</span>).<span class="title function_">alignItems</span>(<span class="title class_">VerticalAlign</span>.<span class="property">Center</span>).<span class="title function_">padding</span>(&#123; <span class="attr">bottom</span>: <span class="number">10</span>, <span class="attr">top</span>: <span class="number">10</span> &#125;)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;, <span class="function">(<span class="params">item: Article</span>) =&gt;</span> item.<span class="property">key</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      .<span class="title function_">margin</span>(<span class="number">10</span>)</span><br><span class="line">      .<span class="title function_">padding</span>(<span class="number">10</span>)</span><br><span class="line">      .<span class="title function_">backgroundColor</span>(<span class="string">&#x27;#fff&#x27;</span>)</span><br><span class="line">      .<span class="title function_">divider</span>(&#123; <span class="attr">strokeWidth</span>: <span class="number">1</span>, <span class="attr">color</span>: <span class="string">&#x27;#eee&#x27;</span> &#125;)</span><br><span class="line">    &#125;.<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>).<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>).<span class="title function_">backgroundColor</span>(<span class="string">&#x27;#eee&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img data-src="https://gitee.com/zch0304/images/raw/master/note/1718376141035.jpg" style="zoom: 60%;" /> 

<h5 id="List-水平滑动列表"><a href="#List-水平滑动列表" class="headerlink" title="List 水平滑动列表"></a>List 水平滑动列表</h5><figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ListItemModel</span> &#123;</span><br><span class="line">  <span class="attr">key</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">title</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">img</span>: <span class="built_in">string</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">key: <span class="built_in">string</span>, title: <span class="built_in">string</span>, img: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">key</span> = key;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">title</span> = title;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">img</span> = img;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ListItemModel</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../model/ListItemModel&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Index</span> &#123;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">list</span>: <span class="title class_">Array</span>&lt;<span class="title class_">ListItemModel</span>&gt; = [</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ListItemModel</span>(</span><br><span class="line">      <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;关怀模式&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;https://gitee.com/zch0304/images/raw/master/note/article/01.png&#x27;</span></span><br><span class="line">    ),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ListItemModel</span>(</span><br><span class="line">      <span class="string">&#x27;2&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;光伏骗局套&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;https://gitee.com/zch0304/images/raw/master/note/article/02.png&#x27;</span></span><br><span class="line">    ),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ListItemModel</span>(</span><br><span class="line">      <span class="string">&#x27;3&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;网办小助手&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;https://gitee.com/zch0304/images/raw/master/note/article/03.png&#x27;</span></span><br><span class="line">    ),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ListItemModel</span>(</span><br><span class="line">      <span class="string">&#x27;4&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;电费一键查询&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;https://gitee.com/zch0304/images/raw/master/note/article/04.png&#x27;</span></span><br><span class="line">    )</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>() &#123;</span><br><span class="line">      <span class="title class_">List</span>(&#123; <span class="attr">space</span>: <span class="number">10</span> &#125;) &#123;</span><br><span class="line">        <span class="title class_">ForEach</span>(<span class="variable language_">this</span>.<span class="property">list</span>, <span class="function">(<span class="params">item: ListItemModel</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="title class_">ListItem</span>() &#123;</span><br><span class="line">            <span class="title class_">Column</span>() &#123;</span><br><span class="line">              <span class="title class_">Image</span>(item.<span class="property">img</span>).<span class="title function_">width</span>(<span class="number">100</span>).<span class="title function_">height</span>(<span class="number">68</span>).<span class="title function_">margin</span>(&#123; <span class="attr">top</span>: <span class="number">10</span> &#125;).<span class="title function_">borderRadius</span>(<span class="number">10</span>)</span><br><span class="line">              <span class="title class_">Text</span>(item.<span class="property">title</span>).<span class="title function_">fontSize</span>(<span class="number">16</span>).<span class="title function_">margin</span>(&#123; <span class="attr">top</span>: <span class="number">10</span> &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">            .<span class="title function_">width</span>(<span class="number">100</span>)</span><br><span class="line">            .<span class="title function_">height</span>(<span class="number">110</span>)</span><br><span class="line">            .<span class="title function_">alignItems</span>(<span class="title class_">HorizontalAlign</span>.<span class="property">Center</span>)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;, <span class="function">(<span class="params">item: ListItemModel</span>) =&gt;</span> item.<span class="property">key</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">      .<span class="title function_">height</span>(<span class="number">120</span>)</span><br><span class="line">      .<span class="title function_">padding</span>(&#123; <span class="attr">left</span>: <span class="number">10</span>, <span class="attr">right</span>: <span class="number">10</span> &#125;)</span><br><span class="line">      .<span class="title function_">listDirection</span>(<span class="title class_">Axis</span>.<span class="property">Horizontal</span>)</span><br><span class="line">      .<span class="title function_">alignListItem</span>(<span class="title class_">ListItemAlign</span>.<span class="property">Center</span>)</span><br><span class="line">      .<span class="title function_">border</span>(&#123; <span class="attr">width</span>: <span class="number">1</span>, <span class="attr">color</span>: <span class="string">&#x27;#ccc&#x27;</span> &#125;)</span><br><span class="line">    &#125;.<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>).<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>).<span class="title function_">backgroundColor</span>(<span class="string">&#x27;#eee&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img data-src="https://gitee.com/zch0304/images/raw/master/note/1718381624325.jpg"> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zhich.github.io/2023/08/08/Kotlin-%E5%8D%8F%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="明年今日">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="明年今日">
      <meta itemprop="description" content="终身学习者。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 明年今日">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/08/08/Kotlin-%E5%8D%8F%E7%A8%8B/" class="post-title-link" itemprop="url">Kotlin 协程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-08-08 22:25:00" itemprop="dateCreated datePublished" datetime="2023-08-08T22:25:00+08:00">2023-08-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-06-03 22:53:51" itemprop="dateModified" datetime="2024-06-03T22:53:51+08:00">2024-06-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Kotlin/" itemprop="url" rel="index"><span itemprop="name">Kotlin</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <meta name="referrer" content="no-referrer" />





<h3 id="协程是什么"><a href="#协程是什么" class="headerlink" title="协程是什么"></a>协程是什么</h3><p>协程基于线程，它是轻量级线程。</p>
<ul>
<li>协程让<strong>异步逻辑同步化</strong>，杜绝回调地狱。</li>
<li>协程最核心的点就是，函数或者一段程序能够被<strong>挂起</strong>，稍后再在挂起的位置<strong>恢复</strong>。</li>
</ul>
<h3 id="在-Android-中协程用来解决什么问题"><a href="#在-Android-中协程用来解决什么问题" class="headerlink" title="在 Android 中协程用来解决什么问题"></a>在 Android 中协程用来解决什么问题</h3><ul>
<li><strong>处理耗时任务</strong>，这种任务常常会阻塞主线程。</li>
<li><strong>保证主线程安全</strong>，即安全地从主线程调用任务 suspend 函数。</li>
</ul>
<h3 id="协程的挂起和恢复"><a href="#协程的挂起和恢复" class="headerlink" title="协程的挂起和恢复"></a>协程的挂起和恢复</h3><p>常规函数基础操作包括：invoke（或 call）和 return，协程增加了 suspend 和 resume。</p>
<ul>
<li>suspend：也称为挂起或暂停，用于暂停执行当前协程，并保存所有局部变量。</li>
<li>resume：用于让已暂停的协程从其暂停处继续执行。</li>
</ul>
<h3 id="挂起与阻塞的区别"><a href="#挂起与阻塞的区别" class="headerlink" title="挂起与阻塞的区别"></a>挂起与阻塞的区别</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GlobalScope.launch(Dispatchers.Main) &#123;</span><br><span class="line">    <span class="comment">// 挂起</span></span><br><span class="line">    delay(<span class="number">5000</span>)</span><br><span class="line">    Log.d(<span class="string">&quot;tag&quot;</span>, <span class="string">&quot;<span class="subst">$&#123;Thread.currentThread().name&#125;</span>:after delay.&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 阻塞</span></span><br><span class="line">Thread.sleep(<span class="number">5000</span>)</span><br><span class="line">Log.d(<span class="string">&quot;tag&quot;</span>, <span class="string">&quot;<span class="subst">$&#123;Thread.currentThread().name&#125;</span>:after sleep.&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="挂起函数"><a href="#挂起函数" class="headerlink" title="挂起函数"></a>挂起函数</h3><ul>
<li>使用 suspend 关键字修饰的函数叫做挂起函数。</li>
<li>挂起函数只能在<strong>协程体内</strong>或<strong>其它挂起函数内</strong>调用。</li>
</ul>
<h3 id="协程的两部分"><a href="#协程的两部分" class="headerlink" title="协程的两部分"></a>协程的两部分</h3><p>Kotlin 的协程实现分为两个层次：</p>
<ul>
<li>基础设施层，标准库的协程 API，主要对协程提供了概念和语义上最基本的支持。</li>
<li>业务框架层，协程的上层框架支持。</li>
</ul>
<p>基础设施层的一个 demo：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlin.coroutines.*</span><br><span class="line"></span><br><span class="line"><span class="comment">// 协程体</span></span><br><span class="line"><span class="keyword">val</span> continuation = <span class="keyword">suspend</span> &#123;</span><br><span class="line">    <span class="number">5</span></span><br><span class="line">&#125;.createCoroutine(<span class="keyword">object</span> : Continuation&lt;<span class="built_in">Int</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> context: CoroutineContext = EmptyCoroutineContext</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">resumeWith</span><span class="params">(result: <span class="type">Result</span>&lt;<span class="type">Int</span>&gt;)</span></span> &#123;</span><br><span class="line">        println(<span class="string">&quot;Coroutine End: <span class="variable">$result</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">continuation.resume(<span class="built_in">Unit</span>)</span><br></pre></td></tr></table></figure>

<p>基础设施层使用的是 <code>kotlin.coroutines.*</code> 而业务框架层使用的是 <code>kotlinx.coroutines.*</code>。</p>
<h3 id="调度器"><a href="#调度器" class="headerlink" title="调度器"></a>调度器</h3><p>所有协程必须在调度器中运行，即使它们在主线程上运行也是如此。</p>
<ul>
<li><p><strong>Dispatchers.Main</strong>。Android 上的主线程，用来处理 UI 交互和一些轻量级任务（调用 suspend 函数；调用 UI 函数；更新 LiveData）。</p>
</li>
<li><p><strong>Dispatchers.IO</strong>。非主线程，专为磁盘和网络 IO 进行了优化（数据库；文件读写；网络处理）。</p>
</li>
<li><p><strong>Dispatchers.Default</strong>。非主线程，专为 CPU 密集型任务进行了优化（数组排序；JSON 数据解析；处理差异判断）。</p>
</li>
</ul>
<h3 id="任务泄漏"><a href="#任务泄漏" class="headerlink" title="任务泄漏"></a>任务泄漏</h3><ul>
<li>当某个协程任务丢失，无法追踪，会导致内存、CPU、磁盘等资源浪费，甚至发送一个无用的网络请求，这种情况称为任务泄漏。</li>
<li>为了能够避免协程泄漏，Kotlin 引入了结构化并发机制。</li>
</ul>
<h3 id="结构化并发"><a href="#结构化并发" class="headerlink" title="结构化并发"></a>结构化并发</h3><p>使用结构化并发可以做到：</p>
<ul>
<li>取消任务，当某项任务不再需要时，取消它。</li>
<li>追踪任务，当任务正在执行时，追踪它。</li>
<li>发出错误信号，当协程失败时，发出错误信号表明有错误发生。</li>
</ul>
<h3 id="CoroutineScope"><a href="#CoroutineScope" class="headerlink" title="CoroutineScope"></a>CoroutineScope</h3><p>1、定义协程必须指定其 CoroutineScope，它会跟踪所有协程，同样它还可以<strong>取消由它所启动的所有协程</strong>。</p>
<p>2、常用的相关 API 有：</p>
<ul>
<li><strong>GlobalScope</strong>，生命周期是 process 级别的，即使 Activity 或 Fragment 已经被销毁，协程仍然在执行。</li>
<li><strong>MainScope</strong>，在 Activity 中使用，可以在 onDestroy() 中取消协程。</li>
<li><strong>viewModelScope</strong>，只能在 ViewModel 中使用，绑定 ViewModel 生命周期。</li>
<li><strong>lifecycleScope</strong>，只能在 Activity、Fragment 中使用，会绑定 Activity 和 Fragment 的生命周期。</li>
</ul>
<h3 id="MainScope-使用"><a href="#MainScope-使用" class="headerlink" title="MainScope 使用"></a>MainScope 使用</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CoroutineActivity</span> : <span class="type">AppCompatActivity</span>(), CoroutineScope <span class="keyword">by</span> MainScope() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_coroutine)</span><br><span class="line"></span><br><span class="line">        submit()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">submit</span><span class="params">()</span></span> &#123;</span><br><span class="line">        btnSubmit?.setOnClickListener &#123;</span><br><span class="line">            launch &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    delay(<span class="number">5000</span>)</span><br><span class="line">                &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                     * 取消协程会抛出异常</span></span><br><span class="line"><span class="comment">                     * kotlinx.coroutines.JobCancellationException: Job was cancelled; job=SupervisorJobImpl&#123;Cancelling&#125;@7e7375b</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    e.printStackTrace()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDestroy</span><span class="params">()</span></span> &#123;</span><br><span class="line">        cancel()</span><br><span class="line">        <span class="keyword">super</span>.onDestroy()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="协程构建器"><a href="#协程构建器" class="headerlink" title="协程构建器"></a>协程构建器</h3><p>launch 和 async 构建器都可以用来启动新协程：</p>
<ul>
<li><strong>launch</strong>，返回一个 Job 并且不附带任何结果值。</li>
<li><strong>async</strong>，返回一个 Deferred，Deferred 也是一个 Job，可以使用 .await() 在一个延期的值上得到它的最终结果。</li>
</ul>
<p>等待一个作业：</p>
<ul>
<li>join 和 await。</li>
<li>组合并发。</li>
</ul>
<p>测试构建器：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `coroutine builder`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> job1 = launch &#123;</span><br><span class="line">        delay(<span class="number">200</span>)</span><br><span class="line">        println(<span class="string">&quot;job1 finished.&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> job2 = async &#123;</span><br><span class="line">        delay(<span class="number">200</span>)</span><br><span class="line">        println(<span class="string">&quot;job2 finished.&quot;</span>)</span><br><span class="line">        <span class="string">&quot;job2 result&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    println(job2.await())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">job1 finished.</span><br><span class="line">job2 finished.</span><br><span class="line">job2 result</span><br></pre></td></tr></table></figure>

<blockquote>
<p>runBlocking 把当前线程包装成一个协程，它会阻塞当前线程等待子协程执行完再结束。</p>
</blockquote>
<h3 id="join-和-await-等待协程作业"><a href="#join-和-await-等待协程作业" class="headerlink" title="join 和 await 等待协程作业"></a>join 和 await 等待协程作业</h3><p>测试 join：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `coroutine join`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> job1 = launch &#123;</span><br><span class="line">        delay(<span class="number">2000</span>)</span><br><span class="line">        println(<span class="string">&quot;One&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    job1.join()</span><br><span class="line">    <span class="keyword">val</span> job2 = launch &#123;</span><br><span class="line">        delay(<span class="number">200</span>)</span><br><span class="line">        println(<span class="string">&quot;Two&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> job3 = launch &#123;</span><br><span class="line">        delay(<span class="number">200</span>)</span><br><span class="line">        println(<span class="string">&quot;Three&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">One</span><br><span class="line">Two</span><br><span class="line">Three</span><br></pre></td></tr></table></figure>

<p>测试 await：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `coroutine await`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> job1 = async &#123;</span><br><span class="line">        delay(<span class="number">2000</span>)</span><br><span class="line">        println(<span class="string">&quot;One&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    job1.await()</span><br><span class="line">    <span class="keyword">val</span> job2 = async &#123;</span><br><span class="line">        delay(<span class="number">200</span>)</span><br><span class="line">        println(<span class="string">&quot;Two&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> job3 = async &#123;</span><br><span class="line">        delay(<span class="number">200</span>)</span><br><span class="line">        println(<span class="string">&quot;Three&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">One</span><br><span class="line">Two</span><br><span class="line">Three</span><br></pre></td></tr></table></figure>

<h3 id="async-组合并发"><a href="#async-组合并发" class="headerlink" title="async 组合并发"></a>async 组合并发</h3><p>测试同步 sync：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `coroutine sync`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> time = measureTimeMillis &#123;</span><br><span class="line">        <span class="keyword">val</span> one = doOne()</span><br><span class="line">        <span class="keyword">val</span> two = doTwo()</span><br><span class="line">        println(<span class="string">&quot;The result:<span class="subst">$&#123;one + two&#125;</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    println(<span class="string">&quot;Completed in <span class="variable">$time</span> ms&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">doOne</span><span class="params">()</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    delay(<span class="number">1000</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">doTwo</span><span class="params">()</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    delay(<span class="number">1000</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">The result:<span class="number">2</span></span><br><span class="line">Completed <span class="keyword">in</span> <span class="number">2018</span> ms</span><br></pre></td></tr></table></figure>

<p>测试异步 async：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `coroutine async`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> time = measureTimeMillis &#123;</span><br><span class="line">        <span class="keyword">val</span> one = async &#123;</span><br><span class="line">            doOne()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">val</span> two = async &#123;</span><br><span class="line">            doTwo()</span><br><span class="line">        &#125;</span><br><span class="line">        println(<span class="string">&quot;The result:<span class="subst">$&#123;one.await() + two.await()&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 以下形式，结果是 2m。</span></span><br><span class="line"><span class="comment">        val one = async &#123;</span></span><br><span class="line"><span class="comment">            doOne()</span></span><br><span class="line"><span class="comment">        &#125;.await()</span></span><br><span class="line"><span class="comment">        val two = async &#123;</span></span><br><span class="line"><span class="comment">            doTwo()</span></span><br><span class="line"><span class="comment">        &#125;.await()</span></span><br><span class="line"><span class="comment">        println(&quot;The result:$&#123;one + two&#125;&quot;)*/</span></span><br><span class="line">    &#125;</span><br><span class="line">    println(<span class="string">&quot;Completed in <span class="variable">$time</span> ms&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">The result:<span class="number">2</span></span><br><span class="line">Completed <span class="keyword">in</span> <span class="number">1034</span> ms</span><br></pre></td></tr></table></figure>

<h3 id="协程的启动模式"><a href="#协程的启动模式" class="headerlink" title="协程的启动模式"></a>协程的启动模式</h3><ul>
<li><p><strong>DEFAULT</strong>：协程创建后，立即开始调度，在调度前如果协程被取消，其将直接进入取消响应的状态。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `start mode DEFAULT`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> job = launch(start = CoroutineStart.DEFAULT) &#123;</span><br><span class="line">        delay(<span class="number">5000</span>)</span><br><span class="line">        println(<span class="string">&quot;Job finished.&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    delay(<span class="number">1000</span>)</span><br><span class="line">    job.cancel()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 什么也不打印</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>ATOMIC</strong>：协程创建后，立即开始调度，协程执行到第一个挂起点之前不响应取消。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `start mode ATOMIC`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> job = launch(start = CoroutineStart.ATOMIC) &#123;</span><br><span class="line">        <span class="keyword">var</span> count = <span class="number">0</span></span><br><span class="line">        <span class="keyword">val</span> time = measureTimeMillis &#123;</span><br><span class="line">            <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">0</span> until <span class="number">2100000000</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                    count++</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        println(<span class="string">&quot;Before delay <span class="variable">$time</span> ms. count=<span class="variable">$count</span>&quot;</span>)</span><br><span class="line">        delay(<span class="number">5000</span>)</span><br><span class="line">        println(<span class="string">&quot;Job finished.&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    delay(<span class="number">1000</span>)</span><br><span class="line">    job.cancel()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">Before delay <span class="number">1513</span> ms, count=<span class="number">1050000000.</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>LAZY</strong>：只有协程被需要时，包括主动调用协程的 start、join 或者 await 等函数时才会开始调度，如果调度前就被取消，那么该协程将直接进入异常结束状态。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `start mode LAZY`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> job = async (start = CoroutineStart.LAZY) &#123;</span><br><span class="line">        delay(<span class="number">2000</span>)</span><br><span class="line">        println(<span class="string">&quot;Job finished.&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 调度前就取消，会抛出异常 kotlinx.coroutines.JobCancellationException</span></span><br><span class="line">    job.cancel()</span><br><span class="line">    job.await()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>UNDISPATCHED</strong>：协程创建后立即在<strong>当前函数调用栈</strong>中执行，直到遇到第一个真正挂起的点。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `start mode UNDISPATCHED`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> job = async(context = Dispatchers.IO, start = CoroutineStart.UNDISPATCHED) &#123;</span><br><span class="line">        println(<span class="string">&quot;thread1: <span class="subst">$&#123;Thread.currentThread().name&#125;</span>&quot;</span>)</span><br><span class="line">        delay(<span class="number">1000</span>)</span><br><span class="line">        println(<span class="string">&quot;thread2: <span class="subst">$&#123;Thread.currentThread().name&#125;</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">thread1: Test worker <span class="meta">@coroutine</span>#<span class="number">2</span></span><br><span class="line">thread2: DefaultDispatcher-worker-<span class="number">1</span> <span class="meta">@coroutine</span>#<span class="number">2</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="协程的作用域构建器"><a href="#协程的作用域构建器" class="headerlink" title="协程的作用域构建器"></a>协程的作用域构建器</h3><h4 id="coroutineScope-与-runBlocking"><a href="#coroutineScope-与-runBlocking" class="headerlink" title="coroutineScope 与 runBlocking"></a>coroutineScope 与 runBlocking</h4><ul>
<li>runBlocking 是常规函数，而 coroutineScope 是挂起函数。</li>
<li>它们都会等待其协程体结束，主要区别在于 runBlocking 会阻塞当前线程来等待，而 coroutineScope 只是挂起，会释放底层线程用于其它用途。</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `coroutine coroutineScope builder`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    coroutineScope &#123;</span><br><span class="line">        <span class="keyword">val</span> job1 = launch &#123;</span><br><span class="line">            delay(<span class="number">400</span>)</span><br><span class="line">            println(<span class="string">&quot;job1 finished.&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">val</span> job2 = async &#123;</span><br><span class="line">            delay(<span class="number">200</span>)</span><br><span class="line">            println(<span class="string">&quot;job2 finished.&quot;</span>)</span><br><span class="line">            <span class="keyword">throw</span> IllegalArgumentException()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">job2 finished.</span><br><span class="line"></span><br><span class="line">java.lang.IllegalArgumentException...</span><br></pre></td></tr></table></figure>

<h4 id="coroutineScope-与-supervisorScope"><a href="#coroutineScope-与-supervisorScope" class="headerlink" title="coroutineScope 与 supervisorScope"></a>coroutineScope 与 supervisorScope</h4><ul>
<li>coroutineScope：一个协程失败了，所有其它兄弟协程也会被取消。</li>
<li>supervisorScope：一个协程失败了，不会影响其它兄弟协程。</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `coroutine supervisorScope builder`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    supervisorScope &#123;</span><br><span class="line">        <span class="keyword">val</span> job1 = launch &#123;</span><br><span class="line">            delay(<span class="number">400</span>)</span><br><span class="line">            println(<span class="string">&quot;job1 finished.&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">val</span> job2 = async &#123;</span><br><span class="line">            delay(<span class="number">200</span>)</span><br><span class="line">            println(<span class="string">&quot;job2 finished.&quot;</span>)</span><br><span class="line">            <span class="keyword">throw</span> IllegalArgumentException()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">job2 finished.</span><br><span class="line">job1 finished.</span><br></pre></td></tr></table></figure>

<h3 id="Job-对象"><a href="#Job-对象" class="headerlink" title="Job 对象"></a>Job 对象</h3><ul>
<li>对于每一个创建的协程（通过 launch 或者 async），会返回一个 Job 实例，该实例是协程的唯一标示，并且负责管理协程的生命周期。</li>
<li>一个任务可以包含一系列状态：新创建（<strong>New</strong>）、活跃（<strong>Active</strong>）、完成中（<strong>Completing</strong>）、已完成（<strong>Completed</strong>）、取消中（<strong>Cancelling</strong>）和已取消（<strong>Cancelled</strong>）。虽然我们无法直接访问这些状态，但是我们可以访问 Job 的属性：isActive、isCancelled 和 isCompleted。</li>
</ul>
<h3 id="Job-的生命周期"><a href="#Job-的生命周期" class="headerlink" title="Job 的生命周期"></a>Job 的生命周期</h3><p>如果协程处于活跃状态，协程运行出错或者调用 job.cancel() 都会将当前任务置为取消中（Cancelling）状态（isActive &#x3D; false，isCancelled &#x3D; true）。当所有的子协程都完成后，协程会进入已取消（Cancelled）状态，此时 isCompleted &#x3D; true。</p>
<p><img data-src="https://gitee.com/zch0304/images/raw/master/note/676350c3f83e92cda2f87c2b90471451.png"> </p>
<h3 id="协程的取消"><a href="#协程的取消" class="headerlink" title="协程的取消"></a>协程的取消</h3><ul>
<li><p>取消作用域会取消它的子协程。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `scope cancel`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> scope = CoroutineScope(Dispatchers.Default)</span><br><span class="line">    scope.launch &#123;</span><br><span class="line">        delay(<span class="number">1000</span>)</span><br><span class="line">        println(<span class="string">&quot;job1.&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    scope.launch &#123;</span><br><span class="line">        delay(<span class="number">1000</span>)</span><br><span class="line">        println(<span class="string">&quot;job2.&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    delay(<span class="number">100</span>)</span><br><span class="line">    scope.cancel()</span><br><span class="line">    delay(<span class="number">2000</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 无打印结果</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>被取消的子协程不会影响其余兄弟协程。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `brother cancel`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> scope = CoroutineScope(Dispatchers.Default)</span><br><span class="line">    <span class="keyword">val</span> job1 = scope.launch &#123;</span><br><span class="line">        delay(<span class="number">1000</span>)</span><br><span class="line">        println(<span class="string">&quot;job1.&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> job2 = scope.launch &#123;</span><br><span class="line">        delay(<span class="number">1000</span>)</span><br><span class="line">        println(<span class="string">&quot;job2.&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    delay(<span class="number">100</span>)</span><br><span class="line">    job1.cancel()</span><br><span class="line">    delay(<span class="number">2000</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">job2.</span><br></pre></td></tr></table></figure>
</li>
<li><p>协程通过抛出一个特殊的异常 CancellationException 来处理取消操作。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `CancellationException`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> job1 = GlobalScope.launch &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            delay(<span class="number">1000</span>)</span><br><span class="line">            println(<span class="string">&quot;job1.&quot;</span>)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">            e.printStackTrace()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    delay(<span class="number">100</span>)</span><br><span class="line">    <span class="comment">/* job1.cancel(CancellationException(&quot;取消&quot;))</span></span><br><span class="line"><span class="comment">     job1.join()*/</span></span><br><span class="line">    job1.cancelAndJoin()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">kotlinx.coroutines.JobCancellationException: StandaloneCoroutine was cancelled;</span><br></pre></td></tr></table></figure>
</li>
<li><p>所有 kotlinx.coroutines 中的挂起函数（withContext, delay 等）都是可取消的。</p>
</li>
</ul>
<h3 id="CPU-密集型任务取消"><a href="#CPU-密集型任务取消" class="headerlink" title="CPU 密集型任务取消"></a>CPU 密集型任务取消</h3><ul>
<li><p>isActive 是一个可以被使用在 CoroutineScope 中的扩展属性，检查 Job 是否处于活跃状态。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `cancel cpu task <span class="keyword">by</span> isActive`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> job = launch(Dispatchers.Default) &#123;</span><br><span class="line">        <span class="keyword">var</span> nextPrintTime = System.currentTimeMillis()</span><br><span class="line">        <span class="keyword">var</span> i = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> (i &lt; <span class="number">5</span> &amp;&amp; isActive) &#123;</span><br><span class="line">            <span class="keyword">if</span> (System.currentTimeMillis() &gt;= nextPrintTime) &#123;</span><br><span class="line">                println(<span class="string">&quot;job: I&#x27;m sleeping <span class="subst">$&#123;i++&#125;</span> ...&quot;</span>)</span><br><span class="line">                nextPrintTime += <span class="number">500</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    delay(<span class="number">1300</span>)</span><br><span class="line">    println(<span class="string">&quot;main: I&#x27;m tired of waiting!&quot;</span>)</span><br><span class="line">    job.cancelAndJoin()</span><br><span class="line">    println(<span class="string">&quot;main: Now I can quit.&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">job: I<span class="string">&#x27;m sleeping 0 ...</span></span><br><span class="line"><span class="string">job: I&#x27;</span>m sleeping <span class="number">1</span> ...</span><br><span class="line">job: I<span class="string">&#x27;m sleeping 2 ...</span></span><br><span class="line"><span class="string">main: I&#x27;</span>m tired of waiting!</span><br><span class="line">main: Now I can quit.</span><br></pre></td></tr></table></figure>
</li>
<li><p>ensureActive()，如果 Job 处于非活跃状态，这个方法会抛出异常。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `cancel cpu task <span class="keyword">by</span> ensureActive`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> job = launch(Dispatchers.Default) &#123;</span><br><span class="line">        <span class="keyword">var</span> nextPrintTime = System.currentTimeMillis()</span><br><span class="line">        <span class="keyword">var</span> i = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> (i &lt; <span class="number">5</span>) &#123;</span><br><span class="line">            ensureActive() <span class="comment">// 抛出 CancellationException 异常，但被静默处理掉了。</span></span><br><span class="line">            <span class="keyword">if</span> (System.currentTimeMillis() &gt;= nextPrintTime) &#123;</span><br><span class="line">                println(<span class="string">&quot;job: I&#x27;m sleeping <span class="subst">$&#123;i++&#125;</span> ...&quot;</span>)</span><br><span class="line">                nextPrintTime += <span class="number">500</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    delay(<span class="number">1300</span>)</span><br><span class="line">    println(<span class="string">&quot;main: I&#x27;m tired of waiting!&quot;</span>)</span><br><span class="line">    job.cancelAndJoin()</span><br><span class="line">    println(<span class="string">&quot;main: Now I can quit.&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">job: I<span class="string">&#x27;m sleeping 0 ...</span></span><br><span class="line"><span class="string">job: I&#x27;</span>m sleeping <span class="number">1</span> ...</span><br><span class="line">job: I<span class="string">&#x27;m sleeping 2 ...</span></span><br><span class="line"><span class="string">main: I&#x27;</span>m tired of waiting!</span><br><span class="line">main: Now I can quit.</span><br></pre></td></tr></table></figure>
</li>
<li><p>yield 函数会检查所在协程的状态，如果已经取消，则抛出 CancellationException 予以响应。此外，它还会尝试出让线程的执行权，给其它协程提供执行机会。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `cancel cpu task <span class="keyword">by</span> yield`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> job = launch(Dispatchers.Default) &#123;</span><br><span class="line">        <span class="keyword">var</span> nextPrintTime = System.currentTimeMillis()</span><br><span class="line">        <span class="keyword">var</span> i = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> (i &lt; <span class="number">5</span>) &#123;</span><br><span class="line">            yield()</span><br><span class="line">            <span class="keyword">if</span> (System.currentTimeMillis() &gt;= nextPrintTime) &#123;</span><br><span class="line">                println(<span class="string">&quot;job: I&#x27;m sleeping <span class="subst">$&#123;i++&#125;</span> ...&quot;</span>)</span><br><span class="line">                nextPrintTime += <span class="number">500</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    delay(<span class="number">1300</span>)</span><br><span class="line">    println(<span class="string">&quot;main: I&#x27;m tired of waiting!&quot;</span>)</span><br><span class="line">    job.cancelAndJoin()</span><br><span class="line">    println(<span class="string">&quot;main: Now I can quit.&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">job: I<span class="string">&#x27;m sleeping 0 ...</span></span><br><span class="line"><span class="string">job: I&#x27;</span>m sleeping <span class="number">1</span> ...</span><br><span class="line">job: I<span class="string">&#x27;m sleeping 2 ...</span></span><br><span class="line"><span class="string">main: I&#x27;</span>m tired of waiting!</span><br><span class="line">main: Now I can quit.</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="协程取消的副作用"><a href="#协程取消的副作用" class="headerlink" title="协程取消的副作用"></a>协程取消的副作用</h3><ul>
<li><p>在 finally 中释放资源。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `release resources`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> job = launch &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            repeat(<span class="number">1000</span>) &#123; i -&gt;</span><br><span class="line">                println(<span class="string">&quot;job: I&#x27;m sleeping <span class="variable">$i</span> ...&quot;</span>)</span><br><span class="line">                delay(<span class="number">500</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            println(<span class="string">&quot;job: I&#x27;m running finally.&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    delay(<span class="number">1300</span>)</span><br><span class="line">    println(<span class="string">&quot;main: I&#x27;m tired of waiting!&quot;</span>)</span><br><span class="line">    job.cancelAndJoin()</span><br><span class="line">    println(<span class="string">&quot;main: Now I can quit.&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">job: I<span class="string">&#x27;m sleeping 0 ...</span></span><br><span class="line"><span class="string">job: I&#x27;</span>m sleeping <span class="number">1</span> ...</span><br><span class="line">job: I<span class="string">&#x27;m sleeping 2 ...</span></span><br><span class="line"><span class="string">main: I&#x27;</span>m tired of waiting!</span><br><span class="line">job: I<span class="string">&#x27;m running finally.</span></span><br><span class="line"><span class="string">main: Now I can quit.</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>use 函数：该函数只能被实现了 Closeable 的对象使用，程序结束的时候会自动调用 close 方法，适合文件对象。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `use function`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="comment">/*val br = BufferedReader(FileReader(&quot;E:\\Hello.txt&quot;))</span></span><br><span class="line"><span class="comment">    var line: String?</span></span><br><span class="line"><span class="comment">    try &#123;</span></span><br><span class="line"><span class="comment">        while (true) &#123;</span></span><br><span class="line"><span class="comment">            line = br.readLine() ?: break</span></span><br><span class="line"><span class="comment">            println(line)</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">    &#125; catch (e: Exception) &#123;</span></span><br><span class="line"><span class="comment">    &#125; finally &#123;</span></span><br><span class="line"><span class="comment">        try &#123;</span></span><br><span class="line"><span class="comment">            br.close()</span></span><br><span class="line"><span class="comment">        &#125; catch (e: Exception) &#123;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line"></span><br><span class="line">    BufferedReader(FileReader(<span class="string">&quot;E:\\Hello.txt&quot;</span>)).use &#123;</span><br><span class="line">        <span class="keyword">var</span> line: String?</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            line = it.readLine() ?: <span class="keyword">break</span></span><br><span class="line">            println(line)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="不能取消的任务"><a href="#不能取消的任务" class="headerlink" title="不能取消的任务"></a>不能取消的任务</h3><p>处于取消中状态的协程不能够挂起（运行不能取消的代码），当协程被取消后需要调用挂起函数，我们需要将清理任务的代码放置于 NonCancellable CoroutineContext 中。这样会挂起运行中的代码，并保持协程取消中状态直到任务处理完成。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `cancel with NonCancelable`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> job = launch &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            repeat(<span class="number">1000</span>) &#123; i -&gt;</span><br><span class="line">                println(<span class="string">&quot;job: I&#x27;m sleeping <span class="variable">$i</span> ...&quot;</span>)</span><br><span class="line">                delay(<span class="number">500</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            withContext(NonCancellable) &#123;</span><br><span class="line">                println(<span class="string">&quot;job: I&#x27;m running finally.&quot;</span>)</span><br><span class="line">                delay(<span class="number">1000</span>)</span><br><span class="line">                println(<span class="string">&quot;job: And I&#x27;ve just delayed for 1 sec because I&#x27;m non-cancellable.&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    delay(<span class="number">1300</span>)</span><br><span class="line">    println(<span class="string">&quot;main: I&#x27;m tired of waiting!&quot;</span>)</span><br><span class="line">    job.cancelAndJoin()</span><br><span class="line">    println(<span class="string">&quot;main: Now I can quit.&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">job: I<span class="string">&#x27;m sleeping 0 ...</span></span><br><span class="line"><span class="string">job: I&#x27;</span>m sleeping <span class="number">1</span> ...</span><br><span class="line">job: I<span class="string">&#x27;m sleeping 2 ...</span></span><br><span class="line"><span class="string">main: I&#x27;</span>m tired of waiting!</span><br><span class="line">job: I<span class="string">&#x27;m running finally.</span></span><br><span class="line"><span class="string">job: And I&#x27;</span>ve just delayed <span class="keyword">for</span> <span class="number">1</span> sec because I<span class="string">&#x27;m non-cancellable.</span></span><br><span class="line"><span class="string">main: Now I can quit.</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>NonCancellable 可用于常驻任务。</p>
</blockquote>
<h3 id="超时任务"><a href="#超时任务" class="headerlink" title="超时任务"></a>超时任务</h3><ul>
<li><p>很多情况下取消一个协程的理由是它有可能超时。用 withTimeout 进行超时操作，如果规定时间内未完成任务则会抛出异常。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `deal with withTimeout`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    withTimeout(<span class="number">1300</span>) &#123;</span><br><span class="line">        repeat(<span class="number">1000</span>) &#123; i -&gt;</span><br><span class="line">            println(<span class="string">&quot;job: I&#x27;m sleeping <span class="variable">$i</span> ...&quot;</span>)</span><br><span class="line">            delay(<span class="number">500</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">job: I<span class="string">&#x27;m sleeping 0 ...</span></span><br><span class="line"><span class="string">job: I&#x27;</span>m sleeping <span class="number">1</span> ...</span><br><span class="line">job: I<span class="string">&#x27;m sleeping 2 ...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Timed out waiting for 1300 ms</span></span><br><span class="line"><span class="string">kotlinx.coroutines.TimeoutCancellationException: Timed out waiting for 1300 ms</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>withTimeoutOrNull 通过返回 null 来进行超时操作，从而替代抛出一个异常。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `deal with withTimeoutOrNull`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> result = withTimeoutOrNull(<span class="number">1300</span>) &#123;</span><br><span class="line">        repeat(<span class="number">1000</span>) &#123; i -&gt;</span><br><span class="line">            println(<span class="string">&quot;job: I&#x27;m sleeping <span class="variable">$i</span> ...&quot;</span>)</span><br><span class="line">            delay(<span class="number">500</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">&quot;Done&quot;</span></span><br><span class="line">    &#125; ?: <span class="string">&quot;Undone&quot;</span></span><br><span class="line">    println(<span class="string">&quot;Result is <span class="variable">$result</span>.&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">job: I<span class="string">&#x27;m sleeping 0 ...</span></span><br><span class="line"><span class="string">job: I&#x27;</span>m sleeping <span class="number">1</span> ...</span><br><span class="line">job: I<span class="string">&#x27;m sleeping 2 ...</span></span><br><span class="line"><span class="string">Result is Undone.</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="协程的上下文"><a href="#协程的上下文" class="headerlink" title="协程的上下文"></a>协程的上下文</h3><p>CoroutineContext 是一组用于定义协程行为的元素，它由如下几项构成：</p>
<ul>
<li><strong>Job</strong>：控制协程的生命周期。</li>
<li><strong>CoroutineDispatcher</strong>：向合适的线程分发任务。</li>
<li><strong>CoroutineName</strong>：协程的名称，调试的时候很有用。</li>
<li><strong>CoroutineExceptionHandler</strong>：处理未被捕获的异常。</li>
</ul>
<h4 id="组合上下文中的元素"><a href="#组合上下文中的元素" class="headerlink" title="组合上下文中的元素"></a>组合上下文中的元素</h4><p>有时我们需要在协程上下文中定义多个元素，我们可以使用 “+” 操作符来实现。比如，我们可以显示指定一个调度器来启动协程并且同时显示指定一个命名：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `CoroutineContext`<span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    launch(Dispatchers.Default + CoroutineName(<span class="string">&quot;hello&quot;</span>)) &#123;</span><br><span class="line">        println(<span class="string">&quot;I&#x27;m working in thread <span class="subst">$&#123;Thread.currentThread().name&#125;</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">I<span class="string">&#x27;m working in thread DefaultDispatcher-worker-1 @hello#2</span></span><br></pre></td></tr></table></figure>

<h4 id="协程上下文的继承"><a href="#协程上下文的继承" class="headerlink" title="协程上下文的继承"></a>协程上下文的继承</h4><p>对于新创建的协程，它的 CoroutineContext 会包含一个全新的 Job 实例，它会帮助我们控制协程的生命周期。而<strong>剩下的元素会从 CoroutineContext 的父类继承</strong>，该父类可能是另外一个协程或者创建该协程的 CoroutineScope。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `CoroutineContext extend`<span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">val</span> scope = CoroutineScope(Job() + Dispatchers.IO + CoroutineName(<span class="string">&quot;hello&quot;</span>))</span><br><span class="line">    <span class="keyword">val</span> job = scope.launch &#123;</span><br><span class="line">        <span class="comment">// 新的协程会将 CoroutineScope 作为父级</span></span><br><span class="line">        println(<span class="string">&quot;<span class="subst">$&#123;coroutineContext[Job]&#125;</span> <span class="subst">$&#123;Thread.currentThread().name&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">val</span> result = async &#123;</span><br><span class="line">             <span class="comment">// 通过 async 创建的新协程会将当前协程作为父级</span></span><br><span class="line">            println(<span class="string">&quot;<span class="subst">$&#123;coroutineContext[Job]&#125;</span> <span class="subst">$&#123;Thread.currentThread().name&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="string">&quot;OK&quot;</span></span><br><span class="line">        &#125;.await()</span><br><span class="line">    &#125;</span><br><span class="line">    job.join()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line"><span class="string">&quot;hello#2&quot;</span>:StandaloneCoroutine&#123;Active&#125;@55b8c583 DefaultDispatcher-worker-<span class="number">1</span> <span class="meta">@hello</span>#<span class="number">2</span></span><br><span class="line"><span class="string">&quot;hello#3&quot;</span>:DeferredCoroutine&#123;Active&#125;@64e55ef0 DefaultDispatcher-worker-<span class="number">3</span> <span class="meta">@hello</span>#<span class="number">3</span></span><br></pre></td></tr></table></figure>

<h4 id="协程上下文的公式"><a href="#协程上下文的公式" class="headerlink" title="协程上下文的公式"></a>协程上下文的公式</h4><p>协程上下文 &#x3D; <strong>默认值</strong> + <strong>继承的 CoroutineContext</strong> + <strong>参数</strong>。</p>
<ul>
<li>一些元素包含默认值：Dispatchers.Default 是默认的 CoroutineDispatcher，以及 “coroutine” 作为默认的 CoroutineName。</li>
<li>继承的 CoroutineContext 是 CoroutineScope 或者其父协程的 CoroutineContext。</li>
<li>传入协程构建器的参数的优先级高于继承的上下文，隐藏会覆盖对应参数值。</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `CoroutineContext extend2`<span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">val</span> coroutineExceptionHandler = CoroutineExceptionHandler &#123; _, excption -&gt;</span><br><span class="line">        println(<span class="string">&quot;CoroutineExceptionHandler got <span class="variable">$excption</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> scope = CoroutineScope(Job() + Dispatchers.Main + coroutineExceptionHandler)</span><br><span class="line">    <span class="comment">// 新的 CoroutineContext = 父级 CoroutineContext + Job()</span></span><br><span class="line">    <span class="keyword">val</span> job = scope.launch(Dispatchers.IO) &#123;</span><br><span class="line">        <span class="comment">// 新协程</span></span><br><span class="line">        println(<span class="string">&quot;<span class="subst">$&#123;coroutineContext[Job]&#125;</span> <span class="subst">$&#123;Thread.currentThread().name&#125;</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    job.join()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line"><span class="string">&quot;coroutine#2&quot;</span>:StandaloneCoroutine&#123;Active&#125;@78ec7afa DefaultDispatcher-worker-<span class="number">1</span> <span class="meta">@coroutine</span>#<span class="number">2</span></span><br></pre></td></tr></table></figure>

<h3 id="协程的异常处理"><a href="#协程的异常处理" class="headerlink" title="协程的异常处理"></a>协程的异常处理</h3><h4 id="异常处理的必要性"><a href="#异常处理的必要性" class="headerlink" title="异常处理的必要性"></a>异常处理的必要性</h4><p>当应用出现一些意外情况时，给用户提供合适的体验非常重要。一方面，目睹应用崩溃是个很糟糕的体验，另一方面，当用户操作失败时，也必须要能给出正确的提示信息。</p>
<h4 id="异常的传播"><a href="#异常的传播" class="headerlink" title="异常的传播"></a>异常的传播</h4><p>协程构建器有两种形式：<strong>自动传播异常</strong>（launch 与 actor），<strong>向用户暴露异常</strong>（async 与 produce）。当这些构建器用于创建一个<strong>根协程</strong>时（该协程不是另一个协程的子协程），前者这类构建器，异常会在它发生的第一时间被抛出，而后者则依赖用户来最终消费异常，例如通过 await 或 receive。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `exception propagation`<span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">val</span> job = GlobalScope.launch &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> IndexOutOfBoundsException()</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">            println(<span class="string">&quot;Caught IndexOutOfBoundsException&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    job.join()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> deferred = GlobalScope.async &#123;</span><br><span class="line">        <span class="keyword">throw</span> ArithmeticException()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        deferred.await()</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">        println(<span class="string">&quot;Caught ArithmeticException&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">Caught IndexOutOfBoundsException</span><br><span class="line">Caught ArithmeticException</span><br></pre></td></tr></table></figure>

<h4 id="非根协程的异常"><a href="#非根协程的异常" class="headerlink" title="非根协程的异常"></a>非根协程的异常</h4><p>其它协程所创建的协程中，产生的异常总是会被传播。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `exception propagation2`<span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">val</span> scope = CoroutineScope(Job())</span><br><span class="line">    <span class="keyword">val</span> job = scope.launch &#123;</span><br><span class="line">        async &#123;</span><br><span class="line">            <span class="comment">// 如果 async 抛出异常，launch 就会立刻抛出异常，而不会调用 .await()</span></span><br><span class="line">            <span class="keyword">throw</span> IllegalArgumentException()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    job.join()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">&quot;DefaultDispatcher-worker-1 @coroutine#3&quot;</span> java.lang.IllegalArgumentException</span><br></pre></td></tr></table></figure>

<h4 id="异常的传播特性"><a href="#异常的传播特性" class="headerlink" title="异常的传播特性"></a>异常的传播特性</h4><p>当一个协程由于一个异常而运行失败时，它会传播这个异常并传递给它的父级。接下来，父级会进行下面几步操作：</p>
<ul>
<li>取消它的子级。</li>
<li>取消它自己。</li>
<li>将异常传播并传递给它的父级。</li>
</ul>
<h4 id="SupervisorJob"><a href="#SupervisorJob" class="headerlink" title="SupervisorJob"></a>SupervisorJob</h4><ul>
<li>使用 SupervisorJob 时，一个子协程的运行失败不会影响到其它子协程。SupervisorJob 不会传播异常给它的父级，它会<strong>让子协程自己处理异常</strong>。</li>
<li>这种需求常见于在作用域内定义作业的 UI 组件，如果任一个 UI 的子作业执行失败了，它并不总是有必要取消整个 UI 组件，但是如果 UI 组件被销毁了，由于它的结果不再被需要了，它就有必要使所有的子作业执行失败。</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test SupervisorJob`<span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">val</span> supervisor = CoroutineScope(SupervisorJob())</span><br><span class="line">    <span class="keyword">val</span> job1 = supervisor.launch &#123;</span><br><span class="line">        delay(<span class="number">100</span>)</span><br><span class="line">        println(<span class="string">&quot;child 1.&quot;</span>)</span><br><span class="line">        <span class="keyword">throw</span> IllegalArgumentException()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> job2 = supervisor.launch &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            delay(<span class="built_in">Long</span>.MAX_VALUE)</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            println(<span class="string">&quot;child 2 finished.&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//        delay(200)</span></span><br><span class="line"><span class="comment">//        supervisor.cancel()</span></span><br><span class="line">    joinAll(job1, job2)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">child <span class="number">1.</span></span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">&quot;DefaultDispatcher-worker-2 @coroutine#2&quot;</span> java.lang.IllegalArgumentException</span><br><span class="line">一直运行中......</span><br></pre></td></tr></table></figure>

<h4 id="supervisorScope"><a href="#supervisorScope" class="headerlink" title="supervisorScope"></a>supervisorScope</h4><p>当作业自身执行失败的时候，所有子作业将会全部被取消。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test supervisorScope`<span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    supervisorScope &#123;</span><br><span class="line">        launch &#123;</span><br><span class="line">            delay(<span class="number">100</span>)</span><br><span class="line">            println(<span class="string">&quot;child 1.&quot;</span>)</span><br><span class="line">            <span class="keyword">throw</span> IllegalArgumentException()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            delay(<span class="built_in">Long</span>.MAX_VALUE)</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            println(<span class="string">&quot;child 2 finished.&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">child <span class="number">1.</span></span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">&quot;Test worker @coroutine#2&quot;</span> java.lang.IllegalArgumentException</span><br><span class="line">一直运行中......</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test supervisorScope2`<span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    supervisorScope &#123;</span><br><span class="line">        launch &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                println(<span class="string">&quot;The child is sleeping.&quot;</span>)</span><br><span class="line">                delay(<span class="built_in">Long</span>.MAX_VALUE)</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                println(<span class="string">&quot;The child is cancelled.&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        yield()</span><br><span class="line">        println(<span class="string">&quot;Throwing an exception from the scope.&quot;</span>)</span><br><span class="line">        <span class="keyword">throw</span> AssertionError()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">The child <span class="keyword">is</span> sleeping.</span><br><span class="line">Throwing an exception from the scope.</span><br><span class="line">The child <span class="keyword">is</span> cancelled.</span><br><span class="line"></span><br><span class="line">java.lang.AssertionError</span><br></pre></td></tr></table></figure>

<h4 id="异常的捕获"><a href="#异常的捕获" class="headerlink" title="异常的捕获"></a>异常的捕获</h4><ul>
<li>使用 CoroutineExceptionHandler 对协程的异常进行捕获。</li>
<li>以下的条件被满足时，异常就会被捕获。<ul>
<li><strong>时机</strong>：异常是被自动抛出异常的协程所抛出的（使用 launch，而不是 async 时）。</li>
<li><strong>位置</strong>：在 CoroutineScope 的 CoroutineContext 中或在一个根协程（CoroutineScope 或者 supervisorScope 的直接子协程）中。</li>
</ul>
</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test coroutineExceptionHandler`<span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">val</span> handler = CoroutineExceptionHandler &#123; _, excption -&gt;</span><br><span class="line">        println(<span class="string">&quot;Caught <span class="variable">$excption</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> job = GlobalScope.launch(handler) &#123;</span><br><span class="line">        <span class="keyword">throw</span> AssertionError()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> deferred = GlobalScope.async(handler) &#123;</span><br><span class="line">        <span class="keyword">throw</span> ArithmeticException()</span><br><span class="line">    &#125;</span><br><span class="line">    job.join()</span><br><span class="line">    deferred.await()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">Caught java.lang.AssertionError</span><br><span class="line"></span><br><span class="line">java.lang.ArithmeticException</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test coroutineExceptionHandler2`<span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">val</span> handler = CoroutineExceptionHandler &#123; _, excption -&gt;</span><br><span class="line">        println(<span class="string">&quot;Caught <span class="variable">$excption</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> scope = CoroutineScope(Job())</span><br><span class="line">    <span class="keyword">val</span> job = scope.launch(handler) &#123;</span><br><span class="line">        launch &#123;</span><br><span class="line">            <span class="keyword">throw</span> ArithmeticException()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    job.join()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">Caught java.lang.ArithmeticException</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test coroutineExceptionHandler3`<span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">val</span> handler = CoroutineExceptionHandler &#123; _, excption -&gt;</span><br><span class="line">        println(<span class="string">&quot;Caught <span class="variable">$excption</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> scope = CoroutineScope(Job())</span><br><span class="line">    <span class="keyword">val</span> job = scope.launch &#123;</span><br><span class="line">        <span class="comment">// handler 放这里捕获不到异常</span></span><br><span class="line">        launch(handler) &#123;</span><br><span class="line">            <span class="keyword">throw</span> ArithmeticException()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    job.join()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">&quot;DefaultDispatcher-worker-1 @coroutine#3&quot;</span> java.lang.ArithmeticException</span><br></pre></td></tr></table></figure>

<h4 id="Android-中全局异常处理"><a href="#Android-中全局异常处理" class="headerlink" title="Android 中全局异常处理"></a>Android 中全局异常处理</h4><ul>
<li>全局异常处理器可以获取到所有协程未处理的未捕获异常，不过它并不能对异常进行捕获，虽然<strong>不能阻止程序崩溃</strong>，全局异常处理器在程序调试和异常上报等场景中仍然有非常大的用处。</li>
<li>我们需要在 classpath 下面创建 META-INF&#x2F;services 目录，并在其中创建一个名为 kotlinx.coroutines.CoroutineExceptionHandler 的文件，文件内容就是我们的全局异常处理器的全类名。</li>
</ul>
<p>正常情况捕获异常（程序不崩溃）：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> handler = CoroutineExceptionHandler &#123; _, excption -&gt;</span><br><span class="line">    Log.d(<span class="string">&quot;tag&quot;</span>, <span class="string">&quot;Caught <span class="variable">$excption</span>&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">btnGlobalCoroutineExceptionHandler?.setOnClickListener &#123;</span><br><span class="line">    GlobalScope.launch(handler) &#123;</span><br><span class="line">        <span class="string">&quot;abc&quot;</span>.substring(<span class="number">10</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">D/tag: Caught java.lang.StringIndexOutOfBoundsException: length=<span class="number">3</span>; index=<span class="number">10</span></span><br></pre></td></tr></table></figure>

<p>全局异常处理器获取未被捕获异常（程序崩溃）：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">btnGlobalCoroutineExceptionHandler?.setOnClickListener &#123;</span><br><span class="line">    GlobalScope.launch &#123;</span><br><span class="line">        <span class="string">&quot;abc&quot;</span>.substring(<span class="number">10</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">D/tag: Unhandled Coroutine Exception: java.lang.StringIndexOutOfBoundsException: length=<span class="number">3</span>; index=<span class="number">10</span></span><br><span class="line">    </span><br><span class="line">    --------- beginning of crash</span><br><span class="line">E/AndroidRuntime: FATAL EXCEPTION: DefaultDispatcher-worker-<span class="number">1</span></span><br><span class="line">    Process: com.zch.kotlin, PID: <span class="number">3436</span></span><br><span class="line">    java.lang.StringIndexOutOfBoundsException: length=<span class="number">3</span>; index=<span class="number">10</span></span><br><span class="line">        at java.lang.String.substring(String.java:<span class="number">1899</span>)</span><br></pre></td></tr></table></figure>

<h4 id="取消与异常"><a href="#取消与异常" class="headerlink" title="取消与异常"></a>取消与异常</h4><ul>
<li>取消与异常紧密相关，协程内部使用 CancellationException 来进行取消，这个异常会被忽略。</li>
<li>当子协程被取消时，不会取消它的父协程。</li>
<li>如果一个协程遇到了 CancellationException 以外的异常，它将使用该异常取消它的父协程。当父协程的所有子协程都结束后，异常才会被父协程处理。</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test cancel and exception`<span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">val</span> job = launch &#123;</span><br><span class="line">        <span class="keyword">val</span> child = launch &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                delay(<span class="built_in">Long</span>.MAX_VALUE)</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                println(<span class="string">&quot;Child is cancelled.&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        yield()</span><br><span class="line">        println(<span class="string">&quot;Cancelling child.&quot;</span>)</span><br><span class="line">        child.cancelAndJoin()</span><br><span class="line">        yield()</span><br><span class="line">        println(<span class="string">&quot;Parent is not cancelled.&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    job.join()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">Cancelling child.</span><br><span class="line">Child <span class="keyword">is</span> cancelled.</span><br><span class="line">Parent <span class="keyword">is</span> not cancelled.</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test cancel and exception2`<span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">val</span> handler = CoroutineExceptionHandler &#123; _, excption -&gt;</span><br><span class="line">        println(<span class="string">&quot;Caught <span class="variable">$excption</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> job = GlobalScope.launch(handler) &#123;</span><br><span class="line">        launch &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                delay(<span class="built_in">Long</span>.MAX_VALUE)</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                withContext(NonCancellable) &#123;</span><br><span class="line">                    println(<span class="string">&quot;Children are cancelled, but exception is not handled until all children termination.&quot;</span>)</span><br><span class="line">                    delay(<span class="number">100</span>)</span><br><span class="line">                    println(<span class="string">&quot;The first child finished its non cancellable block.&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        launch &#123;</span><br><span class="line">            delay(<span class="number">10</span>)</span><br><span class="line">            println(<span class="string">&quot;Second child throws an exception.&quot;</span>)</span><br><span class="line">            <span class="keyword">throw</span> ArithmeticException()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    job.join()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">Second child throws an exception.</span><br><span class="line">Children are cancelled, but exception <span class="keyword">is</span> not handled until all children termination.</span><br><span class="line">The first child finished its non cancellable block.</span><br><span class="line">Caught java.lang.ArithmeticException</span><br></pre></td></tr></table></figure>

<h4 id="异常聚合"><a href="#异常聚合" class="headerlink" title="异常聚合"></a>异常聚合</h4><p>当协程的多个子协程因为异常而失败时，一般情况下取第一个异常进行处理。在第一个异常之后发生的所有其它异常，都将被绑定到第一个异常之上。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test exception aggreation`<span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">val</span> handler = CoroutineExceptionHandler &#123; _, excption -&gt;</span><br><span class="line">        println(<span class="string">&quot;Caught <span class="variable">$excption</span> <span class="subst">$&#123;excption.suppressed.contentToString()&#125;</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> job = GlobalScope.launch(handler) &#123;</span><br><span class="line">        launch &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                delay(<span class="built_in">Long</span>.MAX_VALUE)</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> ArithmeticException()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        launch &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                delay(<span class="built_in">Long</span>.MAX_VALUE)</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> IndexOutOfBoundsException()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        launch &#123;</span><br><span class="line">            delay(<span class="number">100</span>)</span><br><span class="line">            <span class="keyword">throw</span> IOException()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    job.join()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">Caught java.io.IOException [java.lang.IndexOutOfBoundsException, java.lang.ArithmeticException]</span><br></pre></td></tr></table></figure>

<h3 id="Flow"><a href="#Flow" class="headerlink" title="Flow"></a>Flow</h3><h4 id="异步返回多个值的方案"><a href="#异步返回多个值的方案" class="headerlink" title="异步返回多个值的方案"></a>异步返回多个值的方案</h4><p>集合、序列、挂起函数、Flow。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回了多个值，但不是异步</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">simpleList</span><span class="params">()</span></span> = listOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回了多个值，但不是异步（一次返回一个值）</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">simpleSequence</span><span class="params">()</span></span> = sequence &#123;</span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1.</span><span class="number">.3</span>) &#123;</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>) <span class="comment">// 阻塞</span></span><br><span class="line"><span class="comment">//            delay(1000) // 不能用</span></span><br><span class="line">        yield(i)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回了多个值，是异步（一次性返回了多个值）</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">simpleList2</span><span class="params">()</span></span>: List&lt;<span class="built_in">Int</span>&gt; &#123;</span><br><span class="line">    delay(<span class="number">1000</span>)</span><br><span class="line">    <span class="keyword">return</span> listOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回了多个值，是异步（一次返回一个值）</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">simpleFlow</span><span class="params">()</span></span> = flow &#123;</span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1.</span><span class="number">.3</span>) &#123;</span><br><span class="line">        delay(<span class="number">1000</span>) <span class="comment">// 模拟耗时操作</span></span><br><span class="line">        emit(i) <span class="comment">// 发射，返回一个元素</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test multiple values`<span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">//        simpleList().forEach &#123; println(it) &#125;</span></span><br><span class="line">    simpleSequence().forEach &#123; println(it) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test multiple values2`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    simpleList2().forEach &#123; println(it) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test multiple values3`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="comment">// 启动另外一个协程，证明 simpleFlow 没有阻塞主线程</span></span><br><span class="line">    launch &#123;</span><br><span class="line">        <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1.</span><span class="number">.3</span>) &#123;</span><br><span class="line">            println(<span class="string">&quot;I&#x27;m not blocked <span class="variable">$i</span>.&quot;</span>)</span><br><span class="line">            delay(<span class="number">1500</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    simpleFlow().collect &#123; println(it) &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Flow-与其它方式的区别"><a href="#Flow-与其它方式的区别" class="headerlink" title="Flow 与其它方式的区别"></a>Flow 与其它方式的区别</h4><ul>
<li>名为 flow 的 Flow 类型构建器函数。</li>
<li>flow{…} 构建块中的代码可以挂起。</li>
<li>函数 simpleFlow 不再标有 suspend 修饰符。</li>
<li>流使用 emit 函数发射值。</li>
<li>流使用 collect 函数收集值。</li>
</ul>
<p><img data-src="https://gitee.com/zch0304/images/raw/master/note/1663391441985.png"> </p>
<h4 id="冷流"><a href="#冷流" class="headerlink" title="冷流"></a>冷流</h4><p>Flow 是一种类似于序列的冷流，flow 构建器中的代码直到流被收集的时候才运行。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">simpleFlow2</span><span class="params">()</span></span> = flow &#123;</span><br><span class="line">    println(<span class="string">&quot;Flow started.&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1.</span><span class="number">.3</span>) &#123;</span><br><span class="line">        delay(<span class="number">1000</span>)</span><br><span class="line">        emit(i)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test flow <span class="keyword">is</span> cold`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> flow = simpleFlow2()</span><br><span class="line">    println(<span class="string">&quot;Calling collect...&quot;</span>)</span><br><span class="line">    flow.collect &#123; println(it) &#125;</span><br><span class="line">    println(<span class="string">&quot;Calling collect again...&quot;</span>)</span><br><span class="line">    flow.collect &#123; println(it) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">Calling collect...</span><br><span class="line">Flow started.</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line">Calling collect again...</span><br><span class="line">Flow started.</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br></pre></td></tr></table></figure>

<h4 id="流的连续性"><a href="#流的连续性" class="headerlink" title="流的连续性"></a>流的连续性</h4><ul>
<li>流的每次单独收集都是按顺序执行的，除非使用特殊操作符。</li>
<li>从上游到下游每个过渡操作符都会处理每个发射出的值，然后再交给末端操作符。</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test flow continuation`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    (<span class="number">1.</span><span class="number">.5</span>).asFlow().filter &#123;</span><br><span class="line">        it % <span class="number">2</span> == <span class="number">0</span></span><br><span class="line">    &#125;.map &#123;</span><br><span class="line">        <span class="string">&quot;string <span class="variable">$it</span>&quot;</span></span><br><span class="line">    &#125;.collect &#123;</span><br><span class="line">        println(<span class="string">&quot;Collect <span class="variable">$it</span>.&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">Collect string <span class="number">2.</span></span><br><span class="line">Collect string <span class="number">4.</span></span><br></pre></td></tr></table></figure>

<h4 id="流构建器"><a href="#流构建器" class="headerlink" title="流构建器"></a>流构建器</h4><ul>
<li>flowOf 构建器定义了一个发射固定值集的流。</li>
<li>使用 .asFlow() 扩展函数，可以将各种集合与序列转换为流。</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test flow builder`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    flowOf(<span class="string">&quot;one&quot;</span>, <span class="string">&quot;two&quot;</span>, <span class="string">&quot;three&quot;</span>)</span><br><span class="line">        .onEach &#123; delay(<span class="number">1000</span>) &#125;</span><br><span class="line">        .collect &#123; println(it) &#125;</span><br><span class="line"></span><br><span class="line">    (<span class="number">1.</span><span class="number">.3</span>).asFlow().collect &#123; println(it) &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="流上下文"><a href="#流上下文" class="headerlink" title="流上下文"></a>流上下文</h4><ul>
<li>流的收集总是在调用协程的上下文中发生，流的该属性称为<strong>上下文保存</strong>。</li>
<li>flow{…} 构建器中的代码必须遵循上下文保存属性，并且不允许从其它上下文中发射（emit）。</li>
<li>flowOn 操作符，该函数用于更改流发射的上下文。</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">simpleFlow3</span><span class="params">()</span></span> = flow &#123;</span><br><span class="line">    println(<span class="string">&quot;Flow started <span class="subst">$&#123;Thread.currentThread().name&#125;</span>.&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1.</span><span class="number">.3</span>) &#123;</span><br><span class="line">        delay(<span class="number">1000</span>)</span><br><span class="line">        emit(i)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;.flowOn(Dispatchers.Default)</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test flow on`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    simpleFlow3().collect &#123; println(<span class="string">&quot;Collected <span class="variable">$it</span> <span class="subst">$&#123;Thread.currentThread().name&#125;</span>&quot;</span>) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">Flow started DefaultDispatcher-worker-<span class="number">1</span> <span class="meta">@coroutine</span>#<span class="number">2.</span></span><br><span class="line">Collected <span class="number">1</span> Test worker <span class="meta">@coroutine</span>#<span class="number">1</span></span><br><span class="line">Collected <span class="number">2</span> Test worker <span class="meta">@coroutine</span>#<span class="number">1</span></span><br><span class="line">Collected <span class="number">3</span> Test worker <span class="meta">@coroutine</span>#<span class="number">1</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果去掉 .flowOn(Dispatchers.Default)，那么发射和收集都是在 Test worker 线程中。</p>
</blockquote>
<h4 id="在指定协程中收集流"><a href="#在指定协程中收集流" class="headerlink" title="在指定协程中收集流"></a>在指定协程中收集流</h4><p>使用 launchIn 替换 collect，我们可以在单独的协程中启动流的收集。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">events</span><span class="params">()</span></span> = (<span class="number">1.</span><span class="number">.3</span>).asFlow().onEach &#123; delay(<span class="number">100</span>) &#125;.flowOn(Dispatchers.Default)</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test flow launchIn`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> job = events()</span><br><span class="line">        .onEach &#123; println(<span class="string">&quot;Event: <span class="variable">$it</span> <span class="subst">$&#123;Thread.currentThread().name&#125;</span>&quot;</span>) &#125;</span><br><span class="line"><span class="comment">//            .launchIn(CoroutineScope(Dispatchers.IO))</span></span><br><span class="line">        .launchIn(<span class="keyword">this</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//        delay(200)</span></span><br><span class="line"><span class="comment">//        job.cancelAndJoin()</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">Event: <span class="number">1</span> Test worker <span class="meta">@coroutine</span>#<span class="number">2</span></span><br><span class="line">Event: <span class="number">2</span> Test worker <span class="meta">@coroutine</span>#<span class="number">2</span></span><br><span class="line">Event: <span class="number">3</span> Test worker <span class="meta">@coroutine</span>#<span class="number">2</span></span><br></pre></td></tr></table></figure>

<h4 id="流的取消"><a href="#流的取消" class="headerlink" title="流的取消"></a>流的取消</h4><p>流采用与协程同样的协作取消。像往常一样，流的收集可以是当流在一个可取消的挂起函数（例如 delay）中挂起的时候取消。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">simpleFlow4</span><span class="params">()</span></span> = flow &#123;</span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1.</span><span class="number">.3</span>) &#123;</span><br><span class="line">        delay(<span class="number">1000</span>)</span><br><span class="line">        println(<span class="string">&quot;Emitting <span class="variable">$i</span>.&quot;</span>)</span><br><span class="line">        emit(i)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test cancel flow`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    withTimeoutOrNull(<span class="number">2500</span>) &#123;</span><br><span class="line">        simpleFlow4().collect &#123; println(it) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    println(<span class="string">&quot;Done.&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">Emitting <span class="number">1.</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line">Emitting <span class="number">2.</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line">Done.</span><br></pre></td></tr></table></figure>

<h4 id="流的取消检测"><a href="#流的取消检测" class="headerlink" title="流的取消检测"></a>流的取消检测</h4><ul>
<li><p>为方便起见，流构建器对每个发射值执行附加的 ensureActive 检测以进行取消，这意味着从 flow{…} 发出的繁忙循环是可以取消的。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">simpleFlow5</span><span class="params">()</span></span> = flow &#123;</span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1.</span><span class="number">.5</span>) &#123;</span><br><span class="line">        println(<span class="string">&quot;Emitting <span class="variable">$i</span>.&quot;</span>)</span><br><span class="line">        emit(i)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test cancel flow check`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    simpleFlow5().collect &#123;</span><br><span class="line">        println(it)</span><br><span class="line">        <span class="keyword">if</span> (it == <span class="number">3</span>) cancel()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">Emitting <span class="number">1.</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line">Emitting <span class="number">2.</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line">Emitting <span class="number">3.</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"></span><br><span class="line">BlockingCoroutine was cancelled</span><br><span class="line">kotlinx.coroutines.JobCancellationException: BlockingCoroutine was cancelled; job=<span class="string">&quot;coroutine#1&quot;</span>:BlockingCoroutine&#123;Cancelled&#125;@5da3da3d</span><br></pre></td></tr></table></figure>
</li>
<li><p>出于性能原因，大多数其它流操作不会自动执行其它取消检测，在协程处于繁忙循环的情况下，必须明确检测是否取消，通过 <strong>cancellable</strong> 操作符来执行此操作。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test cancel flow check`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    (<span class="number">1.</span><span class="number">.5</span>).asFlow().cancellable().collect &#123;</span><br><span class="line">        println(it)</span><br><span class="line">        <span class="keyword">if</span> (it == <span class="number">3</span>) cancel()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"></span><br><span class="line">BlockingCoroutine was cancelled</span><br><span class="line">kotlinx.coroutines.JobCancellationException: BlockingCoroutine was cancelled; job=<span class="string">&quot;coroutine#1&quot;</span>:BlockingCoroutine&#123;Cancelled&#125;@63bbd396</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="背压"><a href="#背压" class="headerlink" title="背压"></a>背压</h4><p><strong>1、使用缓冲与 flowOn 处理背压</strong></p>
<ul>
<li><p>buffer()：并发运行流中发射元素的代码。</p>
</li>
<li><p>当必须更改 CoroutineDispatcher 时，flowOn 操作符使用了相同的缓冲机制，但是 buffer 函数显示地请求缓冲而<strong>不改变执行上下文</strong>。</p>
</li>
</ul>
<p><strong>2、合并与处理最新值</strong></p>
<ul>
<li>conflate()：合并发射项，不对每个值进行处理。</li>
<li>collectLastest()：取消并重新发射最后一个值。</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">simpleFlow6</span><span class="params">()</span></span> = flow &#123;</span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1.</span><span class="number">.3</span>) &#123;</span><br><span class="line">        delay(<span class="number">100</span>)</span><br><span class="line">        emit(i)</span><br><span class="line">        println(<span class="string">&quot;Emitting <span class="variable">$i</span> <span class="subst">$&#123;Thread.currentThread().name&#125;</span>.&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test flow back pressure`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> time = measureTimeMillis &#123;</span><br><span class="line">        simpleFlow6()</span><br><span class="line"><span class="comment">//                .buffer(50) // 并行发射 3 个元素，需要 100 ms</span></span><br><span class="line"><span class="comment">//                .flowOn(Dispatchers.Default) // 让发射在后台线程，也是并行发射，需要 100 ms</span></span><br><span class="line"><span class="comment">//                .conflate()</span></span><br><span class="line"><span class="comment">//                .collect &#123;</span></span><br><span class="line">            .collectLatest &#123;</span><br><span class="line">                delay(<span class="number">300</span>) <span class="comment">// 处理这个元素消耗 300 ms</span></span><br><span class="line">                println(<span class="string">&quot;Collected <span class="variable">$it</span> <span class="subst">$&#123;Thread.currentThread().name&#125;</span>&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    println(<span class="string">&quot;Collected in <span class="variable">$time</span> ms.&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不处理背压情况下，上面程序大概需要消耗 （100 + 300）* 3 &#x3D; 1200 ms。</p>
<ul>
<li>使用 buffer()，大概需要 100 + 3 * 300 &#x3D; 1000 ms，因为该方式发射元素是异步的。</li>
<li>使用 flowOn 操作符，也是大概需要 100 + 3 * 300 &#x3D; 1000 ms，该方式发射元素也是异步，但是发射元素切换到了后台线程。</li>
<li>使用 conflate，合并发射项，不对每个值进行处理，大概需要 100 + 2 * 300 &#x3D; 700 ms。该方式发射元素是异步的，收集过程忽略了中间的元素，只处理了前后两个元素。</li>
<li>使用 collectLastest，上面程序大概需要消耗 700 ms。该方式发射元素也是异步，它会取消并重新发射最后一个值。</li>
</ul>
<h4 id="操作符"><a href="#操作符" class="headerlink" title="操作符"></a>操作符</h4><h5 id="转换操作符"><a href="#转换操作符" class="headerlink" title="转换操作符"></a>转换操作符</h5><ul>
<li>可以使用操作符转换流，就像使用集合与序列一样。</li>
<li>转换操作符应用于上游流，并返回下游流。</li>
<li>这些操作符也是冷操作符，就像流一样。这类操作符本身不是挂起函数。</li>
<li>它运行的速度很快，返回新的转换流的定义。</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">performRequest</span><span class="params">(request: <span class="type">Int</span>)</span></span>: String &#123;</span><br><span class="line">    delay(<span class="number">1000</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;response <span class="variable">$request</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test transform flow <span class="keyword">operator</span>`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    (<span class="number">1.</span><span class="number">.3</span>).asFlow()</span><br><span class="line"><span class="comment">//            .map &#123; performRequest(it) &#125;</span></span><br><span class="line">        .transform &#123;</span><br><span class="line">            emit(<span class="string">&quot;Making request <span class="variable">$it</span>&quot;</span>)</span><br><span class="line">            emit(performRequest(it))</span><br><span class="line">        &#125;</span><br><span class="line">        .collect &#123; println(it) &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>map 转换一次。transform 可以转换发射多次。</p>
<h5 id="限长操作符"><a href="#限长操作符" class="headerlink" title="限长操作符"></a>限长操作符</h5><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">numbers</span><span class="params">()</span></span> = flow &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        emit(<span class="number">1</span>)</span><br><span class="line">        emit(<span class="number">2</span>)</span><br><span class="line">        println(<span class="string">&quot;This line will not execute.&quot;</span>)</span><br><span class="line">        emit(<span class="number">3</span>)</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        println(<span class="string">&quot;Finally in numbers.&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test limit length <span class="keyword">operator</span>`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    numbers().take(<span class="number">2</span>).collect &#123; println(it) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line">Finally <span class="keyword">in</span> numbers.</span><br></pre></td></tr></table></figure>

<h5 id="末端流操作符"><a href="#末端流操作符" class="headerlink" title="末端流操作符"></a>末端流操作符</h5><p>末端流操作符是在流上用于启动流收集的挂起函数。collect 是最基础的末端操作符，但是还有另外一些更方便的使用的末端操作符：</p>
<ul>
<li>转化为各种集合，例如 toList 与 toSet。</li>
<li>获取第一个（first）值与确保流发射单个（Single）值的操作符。</li>
<li>使用 reduce 与 fold 将流规约到单个值。</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test terminal <span class="keyword">operator</span>`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> sum = (<span class="number">1.</span><span class="number">.5</span>).asFlow()</span><br><span class="line">        .map &#123; it * it &#125;</span><br><span class="line">        .reduce &#123; a, b -&gt; a + b &#125;</span><br><span class="line">    println(sum)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line"><span class="number">55</span></span><br></pre></td></tr></table></figure>

<h5 id="组合操作符"><a href="#组合操作符" class="headerlink" title="组合操作符"></a>组合操作符</h5><p>就像 Kotlin 标准库中的 Sequence.zip 扩展函数一样，流拥有一个 zip 操作符用于组合两个流中的相关值。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test zip <span class="keyword">operator</span>`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> numbs = (<span class="number">1.</span><span class="number">.3</span>).asFlow()</span><br><span class="line">    <span class="keyword">val</span> strs = flowOf(<span class="string">&quot;One&quot;</span>, <span class="string">&quot;Two&quot;</span>, <span class="string">&quot;Three&quot;</span>)</span><br><span class="line">    numbs.zip(strs) &#123; a, b -&gt; <span class="string">&quot;<span class="variable">$a</span> -&gt; <span class="variable">$b</span>&quot;</span> &#125;.collect &#123; println(it) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line"><span class="number">1</span> -&gt; One</span><br><span class="line"><span class="number">2</span> -&gt; Two</span><br><span class="line"><span class="number">3</span> -&gt; Three</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test zip2 <span class="keyword">operator</span>`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> numbs = (<span class="number">1.</span><span class="number">.3</span>).asFlow().onEach &#123; delay(<span class="number">300</span>) &#125;</span><br><span class="line">    <span class="keyword">val</span> strs = flowOf(<span class="string">&quot;One&quot;</span>, <span class="string">&quot;Two&quot;</span>, <span class="string">&quot;Three&quot;</span>).onEach &#123; delay(<span class="number">400</span>) &#125;</span><br><span class="line">    <span class="keyword">val</span> startTime = System.currentTimeMillis()</span><br><span class="line">    numbs.zip(strs) &#123; a, b -&gt; <span class="string">&quot;<span class="variable">$a</span> -&gt; <span class="variable">$b</span>&quot;</span> &#125;.collect &#123;</span><br><span class="line">        println(<span class="string">&quot;<span class="variable">$it</span> at <span class="subst">$&#123;System.currentTimeMillis() - startTime&#125;</span> ms from start.&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line"><span class="number">1</span> -&gt; One at <span class="number">442</span> ms from start.</span><br><span class="line"><span class="number">2</span> -&gt; Two at <span class="number">839</span> ms from start.</span><br><span class="line"><span class="number">3</span> -&gt; Three at <span class="number">1246</span> ms from start.</span><br></pre></td></tr></table></figure>

<h5 id="展平操作符"><a href="#展平操作符" class="headerlink" title="展平操作符"></a>展平操作符</h5><p>流表示异步接收的值序列，所以很容易遇到这样的情况：每个值都会触发对另一个值序列的请求，然而，由于流具有异步的性质，因此需要不同的展平模式，存在一系列的流展平操作符：</p>
<ul>
<li>flatMapConcat 连接模式。</li>
<li>flatMapMerge 合并模式。</li>
<li>flatMapLastest 最新展平模式。</li>
</ul>
<p><img data-src="https://gitee.com/zch0304/images/raw/master/note/1663680667795.jpg"> </p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">requestFlow</span><span class="params">(i: <span class="type">Int</span>)</span></span> = flow&lt;String&gt; &#123;</span><br><span class="line">    emit(<span class="string">&quot;<span class="variable">$i</span>: First.&quot;</span>)</span><br><span class="line">    delay(<span class="number">500</span>)</span><br><span class="line">    emit(<span class="string">&quot;<span class="variable">$i</span>: Second.&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test flatMapConcat <span class="keyword">operator</span>`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> startTime = System.currentTimeMillis()</span><br><span class="line">    (<span class="number">1.</span><span class="number">.3</span>).asFlow()</span><br><span class="line">        .onEach &#123;</span><br><span class="line">            delay(<span class="number">100</span>)</span><br><span class="line">        &#125;.flatMapConcat &#123;</span><br><span class="line">            requestFlow(it)</span><br><span class="line">        &#125;.collect &#123;</span><br><span class="line">            println(<span class="string">&quot;<span class="variable">$it</span> at <span class="subst">$&#123;System.currentTimeMillis() - startTime&#125;</span> ms from start.&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line"><span class="number">1</span>: First. at <span class="number">138</span> ms from start.</span><br><span class="line"><span class="number">1</span>: Second. at <span class="number">665</span> ms from start.</span><br><span class="line"><span class="number">2</span>: First. at <span class="number">774</span> ms from start.</span><br><span class="line"><span class="number">2</span>: Second. at <span class="number">1289</span> ms from start.</span><br><span class="line"><span class="number">3</span>: First. at <span class="number">1398</span> ms from start.</span><br><span class="line"><span class="number">3</span>: Second. at <span class="number">1911</span> ms from start.</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test flatMapMerge <span class="keyword">operator</span>`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> startTime = System.currentTimeMillis()</span><br><span class="line">    (<span class="number">1.</span><span class="number">.3</span>).asFlow()</span><br><span class="line">        .onEach &#123;</span><br><span class="line">            delay(<span class="number">100</span>)</span><br><span class="line">        &#125;.flatMapMerge &#123;</span><br><span class="line">            requestFlow(it)</span><br><span class="line">        &#125;.collect &#123;</span><br><span class="line">            println(<span class="string">&quot;<span class="variable">$it</span> at <span class="subst">$&#123;System.currentTimeMillis() - startTime&#125;</span> ms from start.&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line"><span class="number">1</span>: First. at <span class="number">192</span> ms from start.</span><br><span class="line"><span class="number">2</span>: First. at <span class="number">293</span> ms from start.</span><br><span class="line"><span class="number">3</span>: First. at <span class="number">404</span> ms from start.</span><br><span class="line"><span class="number">1</span>: Second. at <span class="number">698</span> ms from start.</span><br><span class="line"><span class="number">2</span>: Second. at <span class="number">806</span> ms from start.</span><br><span class="line"><span class="number">3</span>: Second. at <span class="number">919</span> ms from start.</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test flatMapLatest <span class="keyword">operator</span>`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> startTime = System.currentTimeMillis()</span><br><span class="line">    (<span class="number">1.</span><span class="number">.3</span>).asFlow()</span><br><span class="line">        .onEach &#123;</span><br><span class="line">            delay(<span class="number">100</span>)</span><br><span class="line">        &#125;.flatMapLatest &#123;</span><br><span class="line">            requestFlow(it)</span><br><span class="line">        &#125;.collect &#123;</span><br><span class="line">            println(<span class="string">&quot;<span class="variable">$it</span> at <span class="subst">$&#123;System.currentTimeMillis() - startTime&#125;</span> ms from start.&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line"><span class="number">1</span>: First. at <span class="number">178</span> ms from start.</span><br><span class="line"><span class="number">2</span>: First. at <span class="number">326</span> ms from start.</span><br><span class="line"><span class="number">3</span>: First. at <span class="number">441</span> ms from start.</span><br><span class="line"><span class="number">3</span>: Second. at <span class="number">943</span> ms from start.</span><br></pre></td></tr></table></figure>

<h4 id="流的异常处理"><a href="#流的异常处理" class="headerlink" title="流的异常处理"></a>流的异常处理</h4><p>当运算符中的发射器或代码抛出异常时，有几种处理异常的方法：</p>
<ul>
<li>try&#x2F;catch 块。</li>
<li>catch 函数。</li>
</ul>
<p><strong>1、捕获下游异常</strong>：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">exceptionFlow</span><span class="params">()</span></span> = flow &#123;</span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1.</span><span class="number">.3</span>) &#123;</span><br><span class="line">        println(<span class="string">&quot;Emitting <span class="variable">$i</span>.&quot;</span>)</span><br><span class="line">        emit(i)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test flow exception`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        exceptionFlow().collect &#123;</span><br><span class="line">            println(it)</span><br><span class="line">            check(it &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="string">&quot;Collect <span class="variable">$it</span>.&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">        println(<span class="string">&quot;Caught <span class="variable">$e</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">Emitting <span class="number">1.</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line">Emitting <span class="number">2.</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line">Caught java.lang.IllegalStateException: Collect <span class="number">2.</span></span><br></pre></td></tr></table></figure>

<p><strong>2、捕获上游异常</strong>：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test flow exception2`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    flow &#123;</span><br><span class="line">        emit(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">throw</span> ArithmeticException(<span class="string">&quot;Div 0.&quot;</span>)</span><br><span class="line">    &#125;.<span class="keyword">catch</span> &#123;</span><br><span class="line">        println(<span class="string">&quot;Caught <span class="variable">$it</span>&quot;</span>)</span><br><span class="line">    &#125;.flowOn(Dispatchers.IO)</span><br><span class="line">        .collect &#123;</span><br><span class="line">            println(it)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line">Caught java.lang.ArithmeticException: Div <span class="number">0.</span></span><br></pre></td></tr></table></figure>

<p><strong>3、恢复异常</strong>：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test flow exception3`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    flow &#123;</span><br><span class="line">        <span class="keyword">throw</span> ArithmeticException(<span class="string">&quot;Div 0.&quot;</span>)</span><br><span class="line">        emit(<span class="number">1</span>)</span><br><span class="line">    &#125;.<span class="keyword">catch</span> &#123;</span><br><span class="line">        println(<span class="string">&quot;Caught <span class="variable">$it</span>&quot;</span>)</span><br><span class="line">        emit(<span class="number">10</span>)</span><br><span class="line">    &#125;.flowOn(Dispatchers.IO)</span><br><span class="line">        .collect &#123;</span><br><span class="line">            println(it)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">Caught java.lang.ArithmeticException: Div <span class="number">0.</span></span><br><span class="line"><span class="number">10</span></span><br></pre></td></tr></table></figure>

<h4 id="流的完成"><a href="#流的完成" class="headerlink" title="流的完成"></a>流的完成</h4><p>当流收集完成时（普通情况或异常情况），它可能需要执行一个动作。</p>
<ul>
<li>命令式 finally 块。</li>
<li>onCompletion 声明式处理。</li>
</ul>
<p>1、finally 形式：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test flow complete <span class="keyword">in</span> <span class="keyword">finally</span>`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">simpleFlow</span><span class="params">()</span></span> = (<span class="number">1.</span><span class="number">.3</span>).asFlow()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        simpleFlow().collect &#123;</span><br><span class="line">            println(it)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        println(<span class="string">&quot;Done.&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line">Done.</span><br></pre></td></tr></table></figure>

<p>2、onCompletion 函数可以拿到上游异常信息，但捕获异常还是需要 catch 函数。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test flow complete <span class="keyword">in</span> onCompletion`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">simpleFlow</span><span class="params">()</span></span> = flow &#123;</span><br><span class="line">        emit(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">throw</span> RuntimeException()</span><br><span class="line">    &#125;</span><br><span class="line">    simpleFlow()</span><br><span class="line">        .onCompletion &#123; exception -&gt;</span><br><span class="line">            <span class="keyword">if</span> (exception != <span class="literal">null</span>) &#123;</span><br><span class="line">                println(<span class="string">&quot;Flow completed exceptionally.&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        .<span class="keyword">catch</span> &#123; exception -&gt;</span><br><span class="line">            println(<span class="string">&quot;Caught <span class="variable">$exception</span>.&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        .collect &#123;</span><br><span class="line">            println(it)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line">Flow completed exceptionally.</span><br><span class="line">Caught java.lang.RuntimeException.</span><br></pre></td></tr></table></figure>

<p>3、onCompletion 函数也能拿到下游异常信息，但捕获异常需要用 try&#x2F;catch 形式。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test flow complete <span class="keyword">in</span> onCompletion2`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">simpleFlow</span><span class="params">()</span></span> = flow &#123;</span><br><span class="line">        emit(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">throw</span> RuntimeException()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        simpleFlow()</span><br><span class="line">            .onCompletion &#123; exception -&gt;</span><br><span class="line">                <span class="keyword">if</span> (exception != <span class="literal">null</span>) &#123;</span><br><span class="line">                    println(<span class="string">&quot;Flow completed exceptionally.&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;.collect &#123;</span><br><span class="line">                println(it)</span><br><span class="line">                check(it &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="string">&quot;Collect <span class="variable">$it</span>.&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">        println(<span class="string">&quot;Caught <span class="variable">$e</span>.&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line">Flow completed exceptionally.</span><br><span class="line">Caught java.lang.RuntimeException.</span><br></pre></td></tr></table></figure>

<h3 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h3><h4 id="什么是-Channel"><a href="#什么是-Channel" class="headerlink" title="什么是 Channel"></a>什么是 Channel</h4><p>Channel 实际上是一个<strong>并发安全的队列</strong>，它可以用来连接协程，实现不同协程的通信。</p>
<p><img data-src="https://gitee.com/zch0304/images/raw/master/note/1666439476014.jpg"> </p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test know Channel`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> channel = Channel&lt;<span class="built_in">Int</span>&gt;()</span><br><span class="line">    <span class="comment">// 生产者</span></span><br><span class="line">    <span class="keyword">val</span> producer = GlobalScope.launch &#123;</span><br><span class="line">        <span class="keyword">var</span> i = <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            delay(<span class="number">1000</span>)</span><br><span class="line">            println(<span class="string">&quot;send <span class="variable">$i</span>.&quot;</span>)</span><br><span class="line">            channel.send(i++)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 消费者</span></span><br><span class="line">    <span class="keyword">val</span> consumer = GlobalScope.launch &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="comment">// delay(3000)</span></span><br><span class="line">            <span class="keyword">val</span> element = channel.receive()</span><br><span class="line">            println(<span class="string">&quot;receive <span class="variable">$element</span>.&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    joinAll(producer, consumer)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">send <span class="number">1.</span></span><br><span class="line">receive <span class="number">1.</span></span><br><span class="line">send <span class="number">2.</span></span><br><span class="line">receive <span class="number">2.</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h4 id="Channel-的容量"><a href="#Channel-的容量" class="headerlink" title="Channel 的容量"></a>Channel 的容量</h4><p>Channel 实际上就是一个队列，队列中一定存在缓冲区，那么一旦这个缓冲区满了，并且一直没有人调用 receive 并取走函数，send 就需要挂起。故意让接收端的节奏放慢，发现 send 总是会挂起，直到 receive 之后才会继续往下执行。</p>
<p>比如上面的代码让消费者延迟 3s，那么生产者 send 一个元素后，需要等消费者在 3s 之后 receive 到元素才能 send 下一个元素。因为 Channel 默认的容量是 0。</p>
<h4 id="迭代-Channel"><a href="#迭代-Channel" class="headerlink" title="迭代 Channel"></a>迭代 Channel</h4><p>Channel 本身确实像序列，所以我们在读取的时候可以直接获取一个 Channel 的 iterator。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test iterator Channel`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> channel = Channel&lt;<span class="built_in">Int</span>&gt;(Channel.UNLIMITED)</span><br><span class="line">    <span class="comment">// 生产者</span></span><br><span class="line">    <span class="keyword">val</span> producer = GlobalScope.launch &#123;</span><br><span class="line">        <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1.</span><span class="number">.5</span>) &#123;</span><br><span class="line">            <span class="keyword">val</span> element = i * i</span><br><span class="line">            println(<span class="string">&quot;send <span class="variable">$element</span>.&quot;</span>)</span><br><span class="line">            channel.send(element)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 消费者</span></span><br><span class="line">    <span class="keyword">val</span> consumer = GlobalScope.launch &#123;</span><br><span class="line"><span class="comment">//            val it = channel.iterator()</span></span><br><span class="line"><span class="comment">//            while (it.hasNext()) &#123;</span></span><br><span class="line"><span class="comment">//                val element = it.next()</span></span><br><span class="line"><span class="comment">//                println(&quot;receive $element.&quot;)</span></span><br><span class="line"><span class="comment">//                delay(2000)</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (element <span class="keyword">in</span> channel) &#123;</span><br><span class="line">            println(<span class="string">&quot;receive <span class="variable">$element</span>.&quot;</span>)</span><br><span class="line">            delay(<span class="number">2000</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    joinAll(producer, consumer)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">send <span class="number">1.</span></span><br><span class="line">send <span class="number">4.</span></span><br><span class="line">send <span class="number">9.</span></span><br><span class="line">send <span class="number">16.</span></span><br><span class="line">send <span class="number">25.</span></span><br><span class="line">receive <span class="number">1.</span></span><br><span class="line">receive <span class="number">4.</span></span><br><span class="line">receive <span class="number">9.</span></span><br><span class="line">receive <span class="number">16.</span></span><br><span class="line">receive <span class="number">25.</span></span><br></pre></td></tr></table></figure>

<h4 id="produce-与-actor"><a href="#produce-与-actor" class="headerlink" title="produce 与 actor"></a>produce 与 actor</h4><ul>
<li>构造生产者与消费者的<strong>便捷方法</strong>。</li>
<li>我们可以通过 produce 方法启动一个生产者协程，并返回一个 ReceiveChannel，其它协程就可以用这个 Channel 来接收数据了。反过来，我们可以用 actor 启动一个消费者协程。</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test fast producer Channel`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> receiveChannel: ReceiveChannel&lt;<span class="built_in">Int</span>&gt; = GlobalScope.produce &#123;</span><br><span class="line">        repeat(<span class="number">5</span>) &#123;</span><br><span class="line">            delay(<span class="number">1000</span>)</span><br><span class="line">            send(it)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> consumer = GlobalScope.launch &#123;</span><br><span class="line">        <span class="keyword">for</span> (element <span class="keyword">in</span> receiveChannel) &#123;</span><br><span class="line">            println(<span class="string">&quot;receive <span class="variable">$element</span>.&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    consumer.join()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">receive <span class="number">0.</span></span><br><span class="line">receive <span class="number">1.</span></span><br><span class="line">receive <span class="number">2.</span></span><br><span class="line">receive <span class="number">3.</span></span><br><span class="line">receive <span class="number">4.</span></span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test fast consumer Channel`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> sendChannel: SendChannel&lt;<span class="built_in">Int</span>&gt; = GlobalScope.actor&lt;<span class="built_in">Int</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">val</span> element = receive()</span><br><span class="line">            println(<span class="string">&quot;receive <span class="variable">$element</span>.&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> producer = GlobalScope.launch &#123;</span><br><span class="line">        <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">0.</span><span class="number">.3</span>) &#123;</span><br><span class="line">            sendChannel.send(i)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    producer.join()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">receive <span class="number">0.</span></span><br><span class="line">receive <span class="number">1.</span></span><br><span class="line">receive <span class="number">2.</span></span><br><span class="line">receive <span class="number">3.</span></span><br></pre></td></tr></table></figure>

<h4 id="Channel-的关闭"><a href="#Channel-的关闭" class="headerlink" title="Channel 的关闭"></a>Channel 的关闭</h4><ul>
<li>produce 和 actor 返回的 Channel 都会随着对应的协程执行完毕而关闭，也正是这样，Channel 才被称为<strong>热数据流</strong>。</li>
<li>对于一个 Channel，如果我们调用了它的 close 方法，它会立即停止接收新元素，也就是说这时它的 <strong>isClosedForSend</strong> 会立即返回 true。而由于 Channel 缓冲区的存在，这时候可能还有一些元素没有被处理完，因此要等所有的元素都被读取之后 isCloseForReceive 才会返回 true。</li>
<li>Channel 的生命周期最好由主导方来维护，建议<strong>由主导的一方实现关闭</strong>。</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test close Channel`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> channel = Channel&lt;<span class="built_in">Int</span>&gt;(<span class="number">3</span>)</span><br><span class="line">    <span class="comment">// 生产者</span></span><br><span class="line">    <span class="keyword">val</span> producer = GlobalScope.launch &#123;</span><br><span class="line">        List(<span class="number">3</span>) &#123;</span><br><span class="line">            println(<span class="string">&quot;send <span class="variable">$it</span>.&quot;</span>)</span><br><span class="line">            channel.send(it)</span><br><span class="line">        &#125;</span><br><span class="line">        channel.close()</span><br><span class="line">        println(<span class="string">&quot;Close Channel. | - ClosedForSend: <span class="subst">$&#123;channel.isClosedForSend&#125;</span>. | - ClosedForReceive: <span class="subst">$&#123;channel.isClosedForReceive&#125;</span>.&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 消费者</span></span><br><span class="line">    <span class="keyword">val</span> consumer = GlobalScope.launch &#123;</span><br><span class="line">        <span class="keyword">for</span> (element <span class="keyword">in</span> channel) &#123;</span><br><span class="line">            println(<span class="string">&quot;receive <span class="variable">$element</span>.&quot;</span>)</span><br><span class="line">            delay(<span class="number">1000</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        println(<span class="string">&quot;After Consuming. | - ClosedForSend: <span class="subst">$&#123;channel.isClosedForSend&#125;</span>. | - ClosedForReceive: <span class="subst">$&#123;channel.isClosedForReceive&#125;</span>.&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    joinAll(producer, consumer)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">send <span class="number">0.</span></span><br><span class="line">send <span class="number">1.</span></span><br><span class="line">send <span class="number">2.</span></span><br><span class="line">receive <span class="number">0.</span></span><br><span class="line">Close Channel. | - ClosedForSend: <span class="literal">true</span>. | - ClosedForReceive: <span class="literal">false</span>.</span><br><span class="line">receive <span class="number">1.</span></span><br><span class="line">receive <span class="number">2.</span></span><br><span class="line">After Consuming. | - ClosedForSend: <span class="literal">true</span>. | - ClosedForReceive: <span class="literal">true</span>.</span><br></pre></td></tr></table></figure>

<h4 id="BroadcastChannel"><a href="#BroadcastChannel" class="headerlink" title="BroadcastChannel"></a>BroadcastChannel</h4><p>前面提到，发送端和接收端在 Channel 中存在一对多的情形，从数据处理本身来讲，虽然有多个接收端，但是同一个元素只会被一个接收端读到。广播则不然，<strong>多个接收端不存在互斥行为</strong>。</p>
<p><img data-src="https://gitee.com/zch0304/images/raw/master/note/1666502596729.jpg"> </p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test broadcastChannel`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line"><span class="comment">//        val broadcastChannel = BroadcastChannel&lt;Int&gt;(Channel.BUFFERED)</span></span><br><span class="line">    <span class="keyword">val</span> channel = Channel&lt;<span class="built_in">Int</span>&gt;()</span><br><span class="line">    <span class="keyword">val</span> broadcastChannel = channel.broadcast(<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">val</span> producer = GlobalScope.launch &#123;</span><br><span class="line">        List(<span class="number">3</span>) &#123;</span><br><span class="line">            delay(<span class="number">100</span>)</span><br><span class="line">            broadcastChannel.send(it)</span><br><span class="line">        &#125;</span><br><span class="line">        broadcastChannel.close()</span><br><span class="line">    &#125;</span><br><span class="line">    List(<span class="number">3</span>) &#123; index -&gt;</span><br><span class="line">        GlobalScope.launch &#123;</span><br><span class="line">            <span class="keyword">val</span> receiveChannel = broadcastChannel.openSubscription()</span><br><span class="line">            <span class="keyword">for</span> (i <span class="keyword">in</span> receiveChannel) &#123;</span><br><span class="line">                println(<span class="string">&quot;[#<span class="variable">$index</span>] receive: <span class="variable">$i</span>.&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.joinAll()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">[#<span class="number">2</span>] receive: <span class="number">0.</span></span><br><span class="line">[#<span class="number">0</span>] receive: <span class="number">0.</span></span><br><span class="line">[#<span class="number">1</span>] receive: <span class="number">0.</span></span><br><span class="line">[#<span class="number">1</span>] receive: <span class="number">1.</span></span><br><span class="line">[#<span class="number">2</span>] receive: <span class="number">1.</span></span><br><span class="line">[#<span class="number">0</span>] receive: <span class="number">1.</span></span><br><span class="line">[#<span class="number">1</span>] receive: <span class="number">2.</span></span><br><span class="line">[#<span class="number">2</span>] receive: <span class="number">2.</span></span><br><span class="line">[#<span class="number">0</span>] receive: <span class="number">2.</span></span><br></pre></td></tr></table></figure>

<h3 id="select-多路复用"><a href="#select-多路复用" class="headerlink" title="select - 多路复用"></a>select - 多路复用</h3><h4 id="什么是多路复用"><a href="#什么是多路复用" class="headerlink" title="什么是多路复用"></a>什么是多路复用</h4><p>数据通信系统或计算机网络系统中，传输媒体的带宽或容量往往会大于传输单一信号的需求，为了有效地利用通信线路，希望<strong>一个信道同时传输多路信号</strong>，这就是所谓的多路复用技术（Multiplexing）。</p>
<h4 id="复用多个-await"><a href="#复用多个-await" class="headerlink" title="复用多个 await"></a>复用多个 await</h4><p>两个 API 分别从网络和本地缓存获取数据，期望哪个先返回就先用哪个做展示。</p>
<p><img data-src="https://gitee.com/zch0304/images/raw/master/note/1666531343879.png">  </p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">Response</span>&lt;<span class="type">T</span>&gt;(<span class="keyword">val</span> value: T, <span class="keyword">val</span> isLocal: <span class="built_in">Boolean</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">User</span>(<span class="keyword">val</span> name: String, <span class="keyword">val</span> address: String)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> CoroutineScope.<span class="title">getUserFromLocal</span><span class="params">(name: <span class="type">String</span>)</span></span> = async(Dispatchers.IO) &#123;</span><br><span class="line">    delay(<span class="number">1000</span>)</span><br><span class="line">    User(name, <span class="string">&quot;Local&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> CoroutineScope.<span class="title">getUserFromServer</span><span class="params">(name: <span class="type">String</span>)</span></span> = async(Dispatchers.IO) &#123;</span><br><span class="line">    delay(<span class="number">2000</span>)</span><br><span class="line">    User(name, <span class="string">&quot;Server&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test select await`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    GlobalScope.launch &#123;</span><br><span class="line">        <span class="keyword">val</span> localRequest = getUserFromLocal(<span class="string">&quot;AAA&quot;</span>)</span><br><span class="line">        <span class="keyword">val</span> serverRequest = getUserFromServer(<span class="string">&quot;BBB&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> userResponse = select&lt;Response&lt;User&gt;&gt; &#123;</span><br><span class="line">            localRequest.onAwait &#123; Response(it, <span class="literal">true</span>) &#125;</span><br><span class="line">            serverRequest.onAwait &#123; Response(it, <span class="literal">false</span>) &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        userResponse.value.let &#123;</span><br><span class="line">            println(it)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.join()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">User(name=AAA, address=Local)</span><br></pre></td></tr></table></figure>

<h4 id="复用多个-Channel"><a href="#复用多个-Channel" class="headerlink" title="复用多个 Channel"></a>复用多个 Channel</h4><p>跟 await 类似，会接收到最快的那个 Channel 消息。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test select Channel`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> channels = listOf(Channel&lt;<span class="built_in">Int</span>&gt;(), Channel&lt;<span class="built_in">Int</span>&gt;())</span><br><span class="line">    GlobalScope.launch &#123;</span><br><span class="line">        delay(<span class="number">100</span>)</span><br><span class="line">        channels[<span class="number">0</span>].send(<span class="number">200</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    GlobalScope.launch &#123;</span><br><span class="line">        delay(<span class="number">50</span>)</span><br><span class="line">        channels[<span class="number">1</span>].send(<span class="number">100</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> result = select&lt;<span class="built_in">Int</span>?&gt; &#123;</span><br><span class="line">        channels.forEach &#123; channel -&gt;</span><br><span class="line">            channel.onReceive &#123; it &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    println(result)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line"><span class="number">100</span></span><br></pre></td></tr></table></figure>

<h4 id="SelectClause"><a href="#SelectClause" class="headerlink" title="SelectClause"></a>SelectClause</h4><p>我们怎么知道哪些事件可以被 <strong>select</strong> 呢？其实所有能够被 select 的事件都是 <strong>SelectClauseN</strong> 类型，包括：</p>
<ul>
<li><p><strong>SelectClause0</strong>：对应事件没有返回值，例如 join 没有返回值，对应的 onJoin 就是这个类型，使用时 onJoin 的参数是一个无参函数。</p>
</li>
<li><p><strong>SelectClause1</strong>：对应事件有返回值，前面的 onAwait 和 onReceive 都是此类情况。</p>
</li>
<li><p><strong>SelectClause2</strong>：对应事件有返回值，此外还需要额外的一个参数，例如 Channel.onSend 有两个参数，第一个就是一个 Channel 数据类型的值，表示即将发送的值，第二个是发送成功时的回调。</p>
</li>
</ul>
<p>如果我们想要确认挂起函数是否支持 select，只需要查看其是否存在对应的 SelectClauseN 即可。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test SelectClause0`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> job1 = GlobalScope.launch &#123;</span><br><span class="line">        println(<span class="string">&quot;job 1&quot;</span>)</span><br><span class="line">        delay(<span class="number">100</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> job2 = GlobalScope.launch &#123;</span><br><span class="line">        println(<span class="string">&quot;job 2&quot;</span>)</span><br><span class="line">        delay(<span class="number">10</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    select&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">        job1.onJoin &#123;</span><br><span class="line">            println(<span class="string">&quot;job 1 onJoin&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        job2.onJoin &#123;</span><br><span class="line">            println(<span class="string">&quot;job 2 onJoin&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">job <span class="number">1</span></span><br><span class="line">job <span class="number">2</span></span><br><span class="line">job <span class="number">2</span> onJoin</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test SelectClause2`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">val</span> channels = listOf(Channel&lt;<span class="built_in">Int</span>&gt;(), Channel&lt;<span class="built_in">Int</span>&gt;())</span><br><span class="line">    println(channels)</span><br><span class="line">    launch(Dispatchers.IO) &#123;</span><br><span class="line">        select &#123;</span><br><span class="line">            launch &#123;</span><br><span class="line">                delay(<span class="number">10</span>)</span><br><span class="line">                channels[<span class="number">1</span>].onSend(<span class="number">200</span>) &#123; sentChannel -&gt;</span><br><span class="line">                    println(<span class="string">&quot;sent on <span class="variable">$sentChannel</span>&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            launch &#123;</span><br><span class="line">                delay(<span class="number">100</span>)</span><br><span class="line">                channels[<span class="number">0</span>].onSend(<span class="number">100</span>) &#123; sentChannel -&gt;</span><br><span class="line">                    println(<span class="string">&quot;sent on <span class="variable">$sentChannel</span>&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    GlobalScope.launch &#123;</span><br><span class="line">        println(channels[<span class="number">0</span>].receive())</span><br><span class="line">    &#125;</span><br><span class="line">    GlobalScope.launch &#123;</span><br><span class="line">        println(channels[<span class="number">1</span>].receive())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    delay(<span class="number">1000</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">[<span class="symbol">RendezvousChannel@</span>24c4ddae&#123;EmptyQueue&#125;, <span class="symbol">RendezvousChannel@</span><span class="number">766653e6</span>&#123;EmptyQueue&#125;]</span><br><span class="line"><span class="number">200</span></span><br><span class="line">sent on <span class="symbol">RendezvousChannel@</span><span class="number">766653e6</span>&#123;EmptyQueue&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使用-Flow-实现多路复用"><a href="#使用-Flow-实现多路复用" class="headerlink" title="使用 Flow 实现多路复用"></a>使用 Flow 实现多路复用</h4><p>多数情况下，我们可以通过构造合适的 Flow 来实现多路复用的效果。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test select flow`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="comment">// 函数 -&gt; 协程 -&gt; Flow -&gt; Flow 合并</span></span><br><span class="line">    <span class="keyword">val</span> name = <span class="string">&quot;guest&quot;</span></span><br><span class="line">    coroutineScope &#123;</span><br><span class="line">        listOf(::getUserFromLocal, ::getUserFromServer)</span><br><span class="line">            .map &#123; function -&gt;</span><br><span class="line">                function.call(name)</span><br><span class="line">            &#125;.map &#123; deferred -&gt;</span><br><span class="line">                flow &#123;</span><br><span class="line">                    emit(deferred.await())</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;.merge()</span><br><span class="line">            .collect &#123; user -&gt;</span><br><span class="line">                println(user)</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">User(name=guest, address=Local)</span><br><span class="line">User(name=guest, address=Server)</span><br></pre></td></tr></table></figure>

<h3 id="并发安全"><a href="#并发安全" class="headerlink" title="并发安全"></a>并发安全</h3><p>由于协程是基于线程的，既然线程有并发问题，那么协程也一定有。</p>
<h4 id="不安全的并发访问"><a href="#不安全的并发访问" class="headerlink" title="不安全的并发访问"></a>不安全的并发访问</h4><p>我们使用线程在解决并发问题的时候总是会遇到线程安全问题，而 Java 平台上的 Kotlin 协程实现免不了存在并发调度的情况，因此线程安全同样值得留意。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test not safe concurrent`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">var</span> count = <span class="number">0</span></span><br><span class="line">    List(<span class="number">10000</span>) &#123;</span><br><span class="line">        GlobalScope.launch &#123;</span><br><span class="line">            count++</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.joinAll()</span><br><span class="line">    println(count)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果（每次打印可能不一样）</span></span><br><span class="line"><span class="number">9997</span></span><br></pre></td></tr></table></figure>

<p>Java API 中安全的并发访问：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test safe concurrent`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">var</span> count = AtomicInteger(<span class="number">0</span>)</span><br><span class="line">    List(<span class="number">10000</span>) &#123;</span><br><span class="line">        GlobalScope.launch &#123;</span><br><span class="line">            count.incrementAndGet()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.joinAll()</span><br><span class="line">    println(count.<span class="keyword">get</span>())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果（每次打印都一样）</span></span><br><span class="line"><span class="number">10000</span></span><br></pre></td></tr></table></figure>

<h4 id="协程的并发工具"><a href="#协程的并发工具" class="headerlink" title="协程的并发工具"></a>协程的并发工具</h4><p>除了我们在线程中常用的解决并发问题的手段之外，协程框架也提供了一些并发安全的工具，包括：</p>
<ul>
<li><strong>Channel</strong>：并发安全的消息通道，我们已经非常熟悉。</li>
<li><strong>Mutex</strong>：轻量级锁，它的 lock 和 unlock 从语义上与线程锁比较类似，之所以轻量是因为它在获取不到锁时不会阻塞线程，而是挂起等待锁的释放。</li>
<li><strong>Semaphore</strong>：轻量级信号量，信号量可以有多个，协程在获取到信号量后即可执行并发操作。当 Semaphore 的参数为 1 时，效果等价于 Mutex。</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test safe concurrent tools`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">var</span> count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">val</span> mutex = Mutex()</span><br><span class="line">    List(<span class="number">10000</span>) &#123;</span><br><span class="line">        GlobalScope.launch &#123;</span><br><span class="line">            mutex.withLock &#123;</span><br><span class="line">                count++</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.joinAll()</span><br><span class="line">    println(count)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果（每次打印都一样）</span></span><br><span class="line"><span class="number">10000</span></span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test safe concurrent tools2`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">var</span> count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">val</span> semaphore = Semaphore(<span class="number">1</span>)</span><br><span class="line">    List(<span class="number">10000</span>) &#123;</span><br><span class="line">        GlobalScope.launch &#123;</span><br><span class="line">            semaphore.withPermit &#123;</span><br><span class="line">                count++</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.joinAll()</span><br><span class="line">    println(count)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="避免访问外部可变状态"><a href="#避免访问外部可变状态" class="headerlink" title="避免访问外部可变状态"></a>避免访问外部可变状态</h4><p>编写函数时要求它不得访问外部状态，只能基于参数做运算，通过返回值提供运算结果。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `test avoid access outer variable`<span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="keyword">var</span> count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">val</span> result = count + List(<span class="number">10000</span>) &#123;</span><br><span class="line">        GlobalScope.async &#123; <span class="number">1</span> &#125;</span><br><span class="line">    &#125;.map &#123;</span><br><span class="line">        it.await()</span><br><span class="line">    &#125;.sum()</span><br><span class="line">    println(result)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果（每次打印都一样）</span></span><br><span class="line"><span class="number">10000</span></span><br></pre></td></tr></table></figure>

<h3 id="冷流还是热流"><a href="#冷流还是热流" class="headerlink" title="冷流还是热流"></a>冷流还是热流</h3><ul>
<li>Flow 是冷流，什么是冷流？简单来说，如果 Flow 有了订阅者 Collector 以后，发射出来的值才会实实在在的存在于内存之中，这跟懒加载的概念很像。</li>
<li>与之相对的是热流，StateFlow 和 SharedFlow 是热流，在垃圾回收之前，都是存在于内存之中，并且处于活跃状态的。</li>
</ul>
<h3 id="StateFlow"><a href="#StateFlow" class="headerlink" title="StateFlow"></a>StateFlow</h3><p>StateFlow 是一个状态容器式<strong>可观察数据流</strong>，可以向其收集器发出当前状态更新和新状态更新。还可通过其 value 属性读取当前状态。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">NumberViewModel</span> : <span class="type">ViewModel</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// StateFlow 与 LiveData 很像，但能使用 Flow 的操作符。</span></span><br><span class="line">    <span class="keyword">val</span> number = MutableStateFlow(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">increment</span><span class="params">()</span></span> &#123;</span><br><span class="line">        number.value++</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">decrement</span><span class="params">()</span></span> &#123;</span><br><span class="line">        number.value--</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">NumberFragment</span> : <span class="type">Fragment</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> mNumberViewModel: NumberViewModel <span class="keyword">by</span> viewModels()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onViewCreated</span><span class="params">(view: <span class="type">View</span>, savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onViewCreated(view, savedInstanceState)</span><br><span class="line">        </span><br><span class="line">        btnPlus.setOnClickListener &#123;</span><br><span class="line">            <span class="comment">// 加法</span></span><br><span class="line">            mNumberViewModel.increment()</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        btnMinus.setOnClickListener &#123;</span><br><span class="line">            <span class="comment">// 减法</span></span><br><span class="line">            mNumberViewModel.decrement()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        lifecycleScope.launch &#123;</span><br><span class="line">            <span class="comment">// 收集数据</span></span><br><span class="line">            mNumberViewModel.number.collect &#123;</span><br><span class="line">                tvNumber.text = it.toString()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SharedFlow"><a href="#SharedFlow" class="headerlink" title="SharedFlow"></a>SharedFlow</h3><p>SharedFlow 会向从其中收集值的所有使用方发出数据。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用 SharedFlow 模拟 EventBus 收发数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">object</span> LocalEventBus &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> events = MutableSharedFlow&lt;Event&gt;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">postEvent</span><span class="params">(event: <span class="type">Event</span>)</span></span> &#123;</span><br><span class="line">        <span class="comment">// 发送数据</span></span><br><span class="line">        events.emit(event)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">Event</span>(<span class="keyword">val</span> timestamp: <span class="built_in">Long</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SharedViewModel</span> : <span class="type">ViewModel</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> job: Job? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开始刷新数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">startRefresh</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// 开启协程</span></span><br><span class="line">        job = viewModelScope.launch(Dispatchers.IO) &#123;</span><br><span class="line">            <span class="comment">// 发送数据</span></span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                LocalEventBus.postEvent(Event(System.currentTimeMillis()))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 停止刷新数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">stopRefresh</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// 关闭协程</span></span><br><span class="line">        job?.cancel()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送数据界面</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SharedFlowFragment</span> : <span class="type">Fragment</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> mSharedViewModel: SharedViewModel <span class="keyword">by</span> viewModels()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onViewCreated</span><span class="params">(view: <span class="type">View</span>, savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onViewCreated(view, savedInstanceState)</span><br><span class="line">        </span><br><span class="line">        btnStart.setOnClickListener &#123;</span><br><span class="line">            <span class="comment">// 发送[开始刷新数据]指令</span></span><br><span class="line">            mSharedViewModel.startRefresh()</span><br><span class="line">        &#125;</span><br><span class="line">        btnStop.setOnClickListener &#123;</span><br><span class="line">            <span class="comment">// 发送[停止刷新数据]指令</span></span><br><span class="line">            mSharedViewModel.stopRefresh()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 收集数据界面</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TextsFragment</span> : <span class="type">Fragment</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onViewCreated</span><span class="params">(view: <span class="type">View</span>, savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onViewCreated(view, savedInstanceState)</span><br><span class="line">        </span><br><span class="line"> 	    lifecycleScope.launch &#123;</span><br><span class="line">            <span class="comment">// 收集数据</span></span><br><span class="line">            LocalEventBus.events.collect &#123;</span><br><span class="line">                textView.text = <span class="string">&quot;<span class="subst">$&#123;tag&#125;</span>: <span class="subst">$&#123;it.timestamp&#125;</span>&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Flow-的应用"><a href="#Flow-的应用" class="headerlink" title="Flow 的应用"></a>Flow 的应用</h3><h4 id="Flow-与文件下载的应用"><a href="#Flow-与文件下载的应用" class="headerlink" title="Flow 与文件下载的应用"></a>Flow 与文件下载的应用</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 下载状态</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title class_">DownloadStatus</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 空状态</span></span><br><span class="line">    <span class="keyword">object</span> None : DownloadStatus()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 下载进度</span></span><br><span class="line">    <span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">Progress</span>(<span class="keyword">val</span> value: <span class="built_in">Int</span>) : DownloadStatus()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 错误</span></span><br><span class="line">    <span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">Error</span>(<span class="keyword">val</span> throwable: Throwable) : DownloadStatus()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 完成</span></span><br><span class="line">    <span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">Done</span>(<span class="keyword">val</span> file: File) : DownloadStatus()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 下载文件管理类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">object</span> DownloadManager &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 下载文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url String 远程文件地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file File 下载到的本地文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Flow&lt;DownloadStatus&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">download</span><span class="params">(url: <span class="type">String</span>, file: <span class="type">File</span>)</span></span>: Flow&lt;DownloadStatus&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> flow &#123;</span><br><span class="line">            <span class="keyword">val</span> request = Request.Builder().url(url).<span class="keyword">get</span>().build()</span><br><span class="line">            <span class="keyword">val</span> response = OkHttpClient.Builder().build().newCall(request).execute()</span><br><span class="line">            <span class="keyword">if</span> (response.isSuccessful) &#123;</span><br><span class="line">                response.body()!!.let &#123; body -&gt;</span><br><span class="line">                    <span class="keyword">val</span> total = body.contentLength()</span><br><span class="line">                    <span class="comment">// 文件读写</span></span><br><span class="line">                    file.outputStream().use &#123; outputStream -&gt;</span><br><span class="line">                        <span class="keyword">val</span> inputStream = body.byteStream()</span><br><span class="line">                        <span class="keyword">var</span> emittedProgress = <span class="number">0L</span></span><br><span class="line">                        inputStream.copyTo(outputStream) &#123; bytesCopied -&gt;</span><br><span class="line">                            <span class="keyword">val</span> progress = bytesCopied * <span class="number">100</span> / total</span><br><span class="line">                            <span class="keyword">if</span> (progress - emittedProgress &gt; <span class="number">5</span>) &#123;</span><br><span class="line">                                delay(<span class="number">100</span>)</span><br><span class="line">                                emit(DownloadStatus.Progress(progress.toInt()))</span><br><span class="line">                                emittedProgress = progress</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                emit(DownloadStatus.Done(file))</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> IOException(response.toString())</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.<span class="keyword">catch</span> &#123;</span><br><span class="line">            file.delete()</span><br><span class="line">            emit(DownloadStatus.Error(it))</span><br><span class="line">        &#125;.flowOn(Dispatchers.IO)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 扩展方法 读写文件并返回下载进度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@receiver</span> InputStream</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> out OutputStream</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bufferSize Int</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> progress Function1&lt;Long, Unit&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> Long</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> InputStream.<span class="title">copyTo</span><span class="params">(<span class="keyword">out</span>: <span class="type">OutputStream</span>, bufferSize: <span class="type">Int</span> = DEFAULT_BUFFER_SIZE, progress: (<span class="type">Long</span>) -&gt; <span class="type">Unit</span>)</span></span>: <span class="built_in">Long</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> bytesCopied: <span class="built_in">Long</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">val</span> buffer = ByteArray(bufferSize)</span><br><span class="line">    <span class="keyword">var</span> bytes = read(buffer)</span><br><span class="line">    <span class="keyword">while</span> (bytes &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">out</span>.write(buffer, <span class="number">0</span>, bytes)</span><br><span class="line">        bytesCopied += bytes</span><br><span class="line">        bytes = read(buffer)</span><br><span class="line"></span><br><span class="line">        progress(bytesCopied)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bytesCopied</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 下载文件界面</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DownloadFragment</span> : <span class="type">Fragment</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> URL = <span class="string">&quot;https://img1.baidu.com/it/u=413643897,2296924942&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=800&amp;h=500&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">download</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// sdcard/Android/data/com.zch.flowpractice/files/pic.png</span></span><br><span class="line">        <span class="keyword">val</span> file = File(requireActivity().getExternalFilesDir(<span class="literal">null</span>)?.path, <span class="string">&quot;pic.jpg&quot;</span>)</span><br><span class="line">        lifecycleScope.launch &#123;</span><br><span class="line">            DownloadManager.download(URL, file).collect &#123; status -&gt;</span><br><span class="line">                <span class="keyword">when</span> (status) &#123;</span><br><span class="line">                    <span class="keyword">is</span> DownloadStatus.Progress -&gt; &#123;</span><br><span class="line">                        progressBar.progress = status.value</span><br><span class="line">                        tvProgress.text = <span class="string">&quot;<span class="subst">$&#123;status.value&#125;</span>%&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">is</span> DownloadStatus.Error -&gt; &#123;</span><br><span class="line">                        ToastUtils.showLong(<span class="string">&quot;下载错误&quot;</span>)</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">is</span> DownloadStatus.Done -&gt; &#123;</span><br><span class="line">                        progressBar.progress = <span class="number">100</span></span><br><span class="line">                        tvProgress.text = <span class="string">&quot;100%&quot;</span></span><br><span class="line">                        ToastUtils.showShort(<span class="string">&quot;下载完成&quot;</span>)</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">else</span> -&gt; &#123;</span><br><span class="line">                        ToastUtils.showShort(<span class="string">&quot;下载失败&quot;</span>)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Flow-与-Room-的应用"><a href="#Flow-与-Room-的应用" class="headerlink" title="Flow 与 Room 的应用"></a>Flow 与 Room 的应用</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Room 实体类声明</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">User</span>(</span><br><span class="line">    <span class="comment">// 主键</span></span><br><span class="line">    <span class="meta">@PrimaryKey</span></span><br><span class="line">    <span class="keyword">val</span> uid: <span class="built_in">Int</span>,</span><br><span class="line">    <span class="comment">// 数据库里存入的字段名</span></span><br><span class="line">    <span class="meta">@ColumnInfo(name = <span class="string">&quot;first_name&quot;</span>)</span></span><br><span class="line">    <span class="keyword">val</span> firstName: String,</span><br><span class="line">    <span class="comment">// 数据库里存入的字段名</span></span><br><span class="line">    <span class="meta">@ColumnInfo(name = <span class="string">&quot;last_name&quot;</span>)</span></span><br><span class="line">    <span class="keyword">val</span> lastName: String</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Dao 类声明</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Dao</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line">    <span class="comment">// 这里设置了一下冲突，如果两条记录相同则会替换</span></span><br><span class="line">    <span class="meta">@Insert(onConflict = OnConflictStrategy.REPLACE)</span></span><br><span class="line">    <span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">insert</span><span class="params">(user: <span class="type">User</span>)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里不需要挂起（返回 Flow 或 LiveData 都不需要）</span></span><br><span class="line">    <span class="meta">@Query(<span class="string">&quot;SELECT * FROM user&quot;</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getAll</span><span class="params">()</span></span>: Flow&lt;List&lt;User&gt;&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 数据库操作类</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * entities      数据库里存入的表，可是多个</span></span><br><span class="line"><span class="comment"> * version       数据库的版本号</span></span><br><span class="line"><span class="comment"> * exportSchema  是否生成 json 文件，用于查看数据库的结构</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Database(entities = [User::class], version = 1, exportSchema = false)</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AppDataBase</span> : <span class="type">RoomDatabase</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Dao 对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">UserDao</span><span class="params">()</span></span>: UserDao</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">var</span> instance: AppDataBase? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">getInstance</span><span class="params">(context: <span class="type">Context</span>)</span></span>: AppDataBase &#123;</span><br><span class="line">            <span class="comment">// 对象锁</span></span><br><span class="line">            <span class="keyword">return</span> instance ?: synchronized(<span class="keyword">this</span>) &#123;</span><br><span class="line">                Room.databaseBuilder(context, AppDataBase::<span class="keyword">class</span>.java, <span class="string">&quot;user_db&quot;</span>)</span><br><span class="line">                    .build().also &#123; instance = it &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * User ViewModel</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserViewModel</span>(app: Application) : AndroidViewModel(app) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user User</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">insert</span><span class="params">(user: <span class="type">User</span>)</span></span> &#123;</span><br><span class="line">        viewModelScope.launch &#123;</span><br><span class="line">            AppDataBase.getInstance(getApplication()).UserDao().insert(user)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取所有数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Flow&lt;List&lt;User&gt;&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getAll</span><span class="params">()</span></span>: Flow&lt;List&lt;User&gt;&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> AppDataBase.getInstance(getApplication()).UserDao().getAll()</span><br><span class="line">            .<span class="keyword">catch</span> &#123; e -&gt;</span><br><span class="line">                e.printStackTrace()</span><br><span class="line">            &#125;.flowOn(Dispatchers.IO)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户界面</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserFragment</span> : <span class="type">BaseBindingFragment</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> mBinding: FragmentUserBinding <span class="keyword">by</span> lazy &#123;</span><br><span class="line">        FragmentUserBinding.inflate(layoutInflater)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> mUserAdapter: UserAdapter <span class="keyword">by</span> lazy &#123;</span><br><span class="line">        UserAdapter()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> mUserViewModel: UserViewModel <span class="keyword">by</span> viewModels()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getBindingRoot</span><span class="params">()</span></span> = mBinding.root</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">initView</span><span class="params">()</span></span> &#123;</span><br><span class="line">        mBinding.rvUser.adapter = mUserAdapter</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">initEvent</span><span class="params">()</span></span> &#123;</span><br><span class="line">        mBinding.btnAddUser.setOnClickListener &#123;</span><br><span class="line">            mBinding.run &#123;</span><br><span class="line">                <span class="comment">// 插入数据</span></span><br><span class="line">                mUserViewModel.insert(</span><br><span class="line">                    User(</span><br><span class="line">                        edtUid.text.toString().toInt(),</span><br><span class="line">                        edtFirstName.text.toString(),</span><br><span class="line">                        edtLastName.text.toString()</span><br><span class="line">                    )</span><br><span class="line">                )</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">initData</span><span class="params">()</span></span> &#123;</span><br><span class="line">        lifecycleScope.launch &#123;</span><br><span class="line">            <span class="comment">// 获取所有数据</span></span><br><span class="line">            mUserViewModel.getAll().collect &#123;</span><br><span class="line">                mUserAdapter.submitList(it)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Flow-与-Retrofit-的应用"><a href="#Flow-与-Retrofit-的应用" class="headerlink" title="Flow 与 Retrofit 的应用"></a>Flow 与 Retrofit 的应用</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 文章实体类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@property</span> id 文章 id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@property</span> text 文章内容</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">Article</span>(<span class="keyword">val</span> id: <span class="built_in">Int</span>, <span class="keyword">val</span> text: String)</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 文章接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">ArticleApi</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GET(<span class="string">&quot;article&quot;</span>)</span></span><br><span class="line">    <span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">searchArticle</span><span class="params">(<span class="meta">@Query(<span class="string">&quot;key&quot;</span>)</span> key: <span class="type">String</span>)</span></span>: List&lt;Article&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Retrofit 网络请求管理类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">object</span> RetrofitClient &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> URL = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> instance: Retrofit <span class="keyword">by</span> lazy &#123;</span><br><span class="line">        Retrofit.Builder()</span><br><span class="line">            .client(OkHttpClient.Builder().build())</span><br><span class="line">            .baseUrl(URL)</span><br><span class="line">            .addConverterFactory(GsonConverterFactory.create())</span><br><span class="line">            .build()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> articleApi: ArticleApi <span class="keyword">by</span> lazy &#123;</span><br><span class="line">        instance.create(ArticleApi::<span class="keyword">class</span>.java)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 文章 ViewModel</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArticleViewModel</span> : <span class="type">ViewModel</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> articles = MutableLiveData&lt;List&lt;Article&gt;&gt;()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">searchArticle</span><span class="params">(key: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        viewModelScope.launch(Dispatchers.Main) &#123;</span><br><span class="line">            flow &#123;</span><br><span class="line">                <span class="keyword">val</span> list = RetrofitClient.articleApi.searchArticle(key)</span><br><span class="line">                emit(list)</span><br><span class="line">            &#125;.flowOn(Dispatchers.IO)</span><br><span class="line">                .<span class="keyword">catch</span> &#123; e -&gt; e.printStackTrace() &#125;</span><br><span class="line">                .collect &#123;</span><br><span class="line">                    articles.value = it</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 文章界面</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArticleFragment</span> : <span class="type">BaseBindingFragment</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> articleViewModel <span class="keyword">by</span> viewModels&lt;ArticleViewModel&gt;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> mBinding: FragmentArticleBinding <span class="keyword">by</span> lazy &#123;</span><br><span class="line">        FragmentArticleBinding.inflate(layoutInflater)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getBindingRoot</span><span class="params">()</span></span> = mBinding.root</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">initView</span><span class="params">()</span></span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">initEvent</span><span class="params">()</span></span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">initData</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// 请求数据</span></span><br><span class="line">        articleViewModel.searchArticle(<span class="string">&quot;三国演义&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 监听数据据返回</span></span><br><span class="line">        articleViewModel.articles.observe(viewLifecycleOwner) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zhich.github.io/2023/04/26/Kotlin-%E6%95%99%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="明年今日">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="明年今日">
      <meta itemprop="description" content="终身学习者。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 明年今日">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/04/26/Kotlin-%E6%95%99%E7%A8%8B/" class="post-title-link" itemprop="url">Kotlin 教程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-04-26 21:47:00" itemprop="dateCreated datePublished" datetime="2023-04-26T21:47:00+08:00">2023-04-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-06-03 22:53:51" itemprop="dateModified" datetime="2024-06-03T22:53:51+08:00">2024-06-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Kotlin/" itemprop="url" rel="index"><span itemprop="name">Kotlin</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <meta name="referrer" content="no-referrer" />





<h3 id="基础类型"><a href="#基础类型" class="headerlink" title="基础类型"></a>基础类型</h3><p>Java 中存在 int, float, boolean 等基础类型，这些基础类型在 Kotlin 里将全部以对象的形式继续存在。有几点变化需要注意。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Int 无法自动转换为 Double, 需要自己先做类型转换（as Double, toDouble(), 方式很多）</span></span><br><span class="line"><span class="keyword">var</span> a: <span class="built_in">Int</span> = <span class="number">2</span></span><br><span class="line"><span class="keyword">var</span> b: <span class="built_in">Double</span> = a.toDouble()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Char 不能直接等值于其对应的 ASCII 码值，需要类型转换</span></span><br><span class="line"><span class="keyword">var</span> c: <span class="built_in">Char</span> = <span class="string">&#x27;a&#x27;</span></span><br><span class="line"><span class="keyword">var</span> x: <span class="built_in">Int</span> = c.toInt()</span><br></pre></td></tr></table></figure>

<h3 id="变量声明"><a href="#变量声明" class="headerlink" title="变量声明"></a>变量声明</h3><p>Kotlin 中使用 var 定义可读可写变量，使用 val 定义只读变量（相当于 Java 当中的 final）。定义变量时，如果满足类型推断，类型可以省略。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> id = <span class="string">&quot;100&quot;</span> <span class="comment">// 类型为 String</span></span><br><span class="line"><span class="keyword">var</span> name: String = <span class="string">&quot;张三&quot;</span> <span class="comment">// 类型为 String</span></span><br><span class="line"><span class="keyword">val</span> age: <span class="built_in">Int</span> = <span class="number">30</span></span><br></pre></td></tr></table></figure>

<h3 id="类型声明"><a href="#类型声明" class="headerlink" title="类型声明"></a>类型声明</h3><p>在 Kotlin 语言中，“:” 被广泛用于变量类型的定义。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义变量类型</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">test</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> zhangSan: User</span><br><span class="line">    <span class="keyword">var</span> liSi: User</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义函数参数和返回值</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">getUser</span><span class="params">(id: <span class="type">Int</span>)</span></span>: User &#123;</span><br><span class="line">    <span class="keyword">return</span> User(<span class="number">100</span>, <span class="string">&quot;dd&quot;</span>, <span class="number">30</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>“:”还被用于声明类继承或接口实现。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">constructor</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 继承 User 类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VipUser</span> : <span class="type">User</span>() &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">DB</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">addUser</span><span class="params">(user: <span class="type">User</span>)</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现 DB 接口</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RoomDB</span> : <span class="type">DB</span> &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">addUser</span><span class="params">(user: <span class="type">User</span>)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="类型检测"><a href="#类型检测" class="headerlink" title="类型检测"></a>类型检测</h3><p>Java 中使用 instanceof 来判断某变量是否为某类型，而 Kotlin 中使用 is 来进行类型检测。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * is 判断属于某类型</span></span><br><span class="line"><span class="comment"> * !is 判断不属于某类型</span></span><br><span class="line"><span class="comment"> * as 类型强转，失败时抛出类型强转失败异常</span></span><br><span class="line"><span class="comment"> * as? 类型强转，但失败时不会抛出异常而是返回 null</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (myObject <span class="keyword">is</span> User) &#123;</span><br><span class="line">    <span class="comment">// 只要进来了，就代表 myObject 是 User 类型了，不需要强转就可以直接使用 User 的属性</span></span><br><span class="line">    myObject.id = <span class="number">101</span></span><br><span class="line">    myObject.name = <span class="string">&quot;Hello&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Any-和-Unit"><a href="#Any-和-Unit" class="headerlink" title="Any 和 Unit"></a>Any 和 Unit</h3><ul>
<li><strong>Any</strong>: Kotlin 的顶层父类是 Any, 对应 Java 中的 Object, 但是比 Object 少了 wait()&#x2F;notify() 等函数。</li>
<li><strong>Unit</strong>: Kotlin 中的 Unit 对应 Java 中的 void。</li>
</ul>
<h3 id="可见性修饰符"><a href="#可见性修饰符" class="headerlink" title="可见性修饰符"></a>可见性修饰符</h3><ul>
<li>默认的可见性修饰符是 <code>public</code>。</li>
<li>新增的可见性修饰符 <code>internal</code> 表示仅当前模块（AS 中的 module）可见，其它模块不能访问。</li>
</ul>
<h3 id="逻辑语句"><a href="#逻辑语句" class="headerlink" title="逻辑语句"></a>逻辑语句</h3><h4 id="if-else-语句"><a href="#if-else-语句" class="headerlink" title="if-else 语句"></a>if-else 语句</h4><p>Kotlin 中的 if-else 基本和 Java 一致，但还是有一些特殊的地方。比如它可以作为一个逻辑表达式使用，逻辑表达式还可以以代码块的形式出现，代码块最后的表达式作为该块的返回值。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 逻辑表达式的使用</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">getMax</span><span class="params">(x: <span class="type">Int</span>, y: <span class="type">Int</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> max = <span class="keyword">if</span> (x &gt; y) x <span class="keyword">else</span> y</span><br><span class="line">    <span class="keyword">return</span> max</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 代码块形式的逻辑表达式</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">getMax2</span><span class="params">(x: <span class="type">Int</span>, y: <span class="type">Int</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> max = <span class="keyword">if</span> (x &gt; y) &#123;</span><br><span class="line">        println(<span class="string">&quot;Max num is x.&quot;</span>)</span><br><span class="line">        x <span class="comment">// 返回最后一行，即 x 的值</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        println(<span class="string">&quot;Max num is y.&quot;</span>)</span><br><span class="line">        y <span class="comment">// 返回最后一行，即 y 的值</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> max</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="when-语句"><a href="#when-语句" class="headerlink" title="when 语句"></a>when 语句</h4><p>Kotlin 中的 when 语句取代了 Java 中的 switch-case 语句，功能上要强大许多，可以有多种形式的条件表达。与 if-else 一样，Kotlin 中的 when 也可以作为逻辑表达式使用，也有返回值。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// when 有判断参数</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">whenDemo</span><span class="params">(obj: <span class="type">Any</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">when</span> (obj) &#123;</span><br><span class="line">        <span class="number">1</span> -&gt; println(<span class="string">&quot;是数字 1&quot;</span>)</span><br><span class="line">        -<span class="number">1</span>, <span class="number">0</span> -&gt; println(<span class="string">&quot;是数字 -1 或 0&quot;</span>)</span><br><span class="line">        <span class="keyword">in</span> <span class="number">1.</span><span class="number">.10</span> -&gt; println(<span class="string">&quot;是不大于 10 的正整数&quot;</span>)</span><br><span class="line">        <span class="string">&quot;abc&quot;</span> -&gt; println(<span class="string">&quot;是字符串 abc&quot;</span>)</span><br><span class="line">        <span class="keyword">is</span> User -&gt; &#123;</span><br><span class="line">            println(<span class="string">&quot;是 User 对象&quot;</span>)</span><br><span class="line">            println(obj.name) <span class="comment">// 直接可以使用 User 的属性了</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> -&gt; println(<span class="string">&quot;其它操作&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// when 没有判断参数</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">whenDemo2</span><span class="params">(position: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> columns = <span class="number">10</span></span><br><span class="line">    <span class="keyword">when</span> &#123;</span><br><span class="line">        position % columns == <span class="number">0</span> -&gt; &#123; <span class="comment">// position 位于第一列</span></span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">        (position + <span class="number">1</span>) % columns == <span class="number">0</span> -&gt; &#123; <span class="comment">// position 位于最后一列</span></span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// when 有返回值</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">whenDemo3</span><span class="params">(score: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> result = <span class="keyword">when</span> (score) &#123;</span><br><span class="line">        <span class="keyword">in</span> <span class="number">90.</span><span class="number">.100</span> -&gt; <span class="string">&quot;优秀&quot;</span></span><br><span class="line">        <span class="keyword">in</span> <span class="number">80.</span><span class="number">.89</span> -&gt; <span class="string">&quot;良好&quot;</span></span><br><span class="line">        <span class="keyword">in</span> <span class="number">60.</span><span class="number">.79</span> -&gt; <span class="string">&quot;及格&quot;</span></span><br><span class="line">        <span class="keyword">else</span> -&gt; <span class="string">&quot;不及格&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    println(<span class="string">&quot;你的成绩<span class="variable">$result</span>&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 标准函数 repeat()：</span></span><br><span class="line">repeat(<span class="number">100</span>) &#123; <span class="comment">// 执行 100 次</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// .. 包括右边界 [0,99]</span></span><br><span class="line"><span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">0.</span><span class="number">.99</span>) &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// until 不包括右边界 [0,99]</span></span><br><span class="line"><span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">0</span> until <span class="number">100</span>) &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>while 语句、continue 语句和 break 语句等逻辑都与 Java 基本一致，这里不再赘述。</p>
</blockquote>
<h4 id="标签"><a href="#标签" class="headerlink" title="标签"></a>标签</h4><p>Kotlin 中可以对任意表达式进行标签标记，标签的格式为标识符后跟 @ 符号，例如 abc@、fooBar@ 都是有效的标签。这些标签，可以搭配 return、break、continue 等跳转行为来使用。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">labelTest</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="symbol">la@</span> <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1.</span><span class="number">.10</span>) &#123;</span><br><span class="line">        println(<span class="string">&quot;outer index <span class="variable">$i</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> (j <span class="keyword">in</span> <span class="number">1.</span><span class="number">.10</span>) &#123;</span><br><span class="line">            println(<span class="string">&quot;inner index <span class="variable">$j</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> (j % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span><span class="symbol">@la</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h3><p>使用 <code>arrayOf</code> 创建数组，基本数据类型使用对应的 <code>intArrayOf</code> 等。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> arr1 = arrayOf&lt;<span class="built_in">Int</span>&gt;()</span><br><span class="line"><span class="keyword">var</span> arr2 = intArrayOf()</span><br><span class="line"><span class="keyword">var</span> arr3 = floatArrayOf()</span><br></pre></td></tr></table></figure>

<h3 id="字符串模板"><a href="#字符串模板" class="headerlink" title="字符串模板"></a>字符串模板</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Java 中字符串模板</span></span><br><span class="line">String name = <span class="string">&quot;ZhangSan&quot;</span>;</span><br><span class="line">int age = <span class="number">30</span>;</span><br><span class="line">String introduction = String.format(<span class="string">&quot;我是s%，今年%d岁了&quot;</span>, name, age);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Kotlin 中字符串模板</span></span><br><span class="line"><span class="keyword">val</span> name = <span class="string">&quot;ZhangSan&quot;</span></span><br><span class="line"><span class="keyword">val</span> age = <span class="number">30</span></span><br><span class="line"><span class="keyword">val</span> introduction = <span class="string">&quot;我是<span class="subst">$&#123;name&#125;</span>，今年<span class="subst">$&#123;age&#125;</span>岁了&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><p>Kotlin 中的函数通过关键字 fun 定义的，具体的参数和返回值定义结构如下。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">myFun</span><span class="params">(para1: <span class="type">Int</span>, para2: <span class="type">String</span>)</span></span>: String &#123; ... &#125;</span><br></pre></td></tr></table></figure>

<p>Kotlin 中的函数可以是全局函数，成员函数或者局部函数，甚至还可以作为某个对象的扩展函数临时添加。</p>
<h4 id="全局函数-顶级函数"><a href="#全局函数-顶级函数" class="headerlink" title="全局函数&#x2F;顶级函数"></a>全局函数&#x2F;顶级函数</h4><p>全局函数（顶级函数）是文件级别的，以包为作用域。</p>
<p>例如 com.zch.kotlin.biz1 包中的 Common.kt 文件中有以下方法：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">sayHello</span><span class="params">()</span></span> &#123;</span><br><span class="line">    println(<span class="string">&quot;Hello&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么在当前包的其它文件中就不能有相同的方法 sayHello，否则会报错。</p>
<p>如果 com.zch.kotlin.biz2 包中的某文件中也有以下方法：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">sayHello</span><span class="params">()</span></span> &#123;</span><br><span class="line">    println(<span class="string">&quot;Hello&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么在其它文件中同时调用两者就需要加上相应的包来访问。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.zch.kotlin.biz1.sayHello</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">hello</span><span class="params">()</span></span> &#123;</span><br><span class="line">    sayHello()</span><br><span class="line">    com.zch.kotlin.biz2.sayHello()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="成员函数"><a href="#成员函数" class="headerlink" title="成员函数"></a>成员函数</h4><p>成员函数是在类或对象内部定义的函数。</p>
<h4 id="局部函数"><a href="#局部函数" class="headerlink" title="局部函数"></a>局部函数</h4><p>Kotlin 支持局部函数，即一个函数在另一个函数内部：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">getUserInfo</span><span class="params">()</span></span>: String &#123;</span><br><span class="line">    <span class="keyword">val</span> country = <span class="string">&quot;中国&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 函数中的函数，叫“局部函数”</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getProvince</span><span class="params">()</span></span>: String &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;<span class="subst">$&#123;country&#125;</span>广东省&quot;</span> <span class="comment">// 局部函数可以访问外部函数的局部变量。</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> name = <span class="string">&quot;ZhangSan&quot;</span></span><br><span class="line">    <span class="keyword">val</span> age = <span class="number">30</span></span><br><span class="line">    <span class="keyword">val</span> userInfo = <span class="string">&quot;我是<span class="subst">$&#123;name&#125;</span>，今年<span class="subst">$&#123;age&#125;</span>岁了，我来自<span class="subst">$&#123;getProvince()&#125;</span>。&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> userInfo</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果是频繁调用的函数，不建议声明为局部函数，因为每次调用时，就会产生一个函数对象。</p>
</blockquote>
<h4 id="函数参数默认值"><a href="#函数参数默认值" class="headerlink" title="函数参数默认值"></a>函数参数默认值</h4><p>函数中的某个参数可以用 “&#x3D;” 号指定其默认值，调用函数方法时可不传这个参数，但其它参数需要用 “&#x3D;” 号指定。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">calculate</span><span class="params">(a: <span class="type">Int</span>, b: <span class="type">Int</span> = <span class="number">10</span>, c: <span class="type">Int</span>)</span></span> = a + b + c <span class="comment">// 原本直接 return 的函数可以用 = 符号简化</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> sum = calculate(<span class="number">5</span>, c = <span class="number">20</span>) <span class="comment">// sum = 35</span></span><br></pre></td></tr></table></figure>

<h4 id="扩展函数和扩展属性"><a href="#扩展函数和扩展属性" class="headerlink" title="扩展函数和扩展属性"></a>扩展函数和扩展属性</h4><p>Kotlin 支持在<strong>包范围内</strong>对已存在的类进行函数和属性扩展。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 给 Activity 扩展一个 log 函数</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> Activity.<span class="title">log</span><span class="params">(msg: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">    Log.d(<span class="string">&quot;tag&quot;</span>, <span class="string">&quot;Activity---<span class="variable">$msg</span>&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 给 Context 扩展一个 log 函数</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> Context.<span class="title">log</span><span class="params">(msg: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">    Log.d(<span class="string">&quot;tag&quot;</span>, <span class="string">&quot;Context---<span class="variable">$msg</span>&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">log(<span class="string">&quot;hello&quot;</span>) <span class="comment">// 调用 Activity.log</span></span><br><span class="line">(<span class="keyword">this</span> <span class="keyword">as</span> Context).log(<span class="string">&quot;hello2&quot;</span>) <span class="comment">// 调用 Context.log</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 给 ViewGroup 扩展一个 firstChild 属性</span></span><br><span class="line"><span class="keyword">val</span> ViewGroup.firstChild: View <span class="keyword">get</span>() = getChildAt(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">contentLayout.firstChild <span class="comment">// 调用</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：1、扩展需要在包级范围内进行，如果写在 class 内是无效的。2、已经存在的方法或属性，是无法被扩展的，依旧会调用已有的方法。3、扩展函数是静态解析的，在编译时就确定了调用函数（没有多态）。</p>
</blockquote>
<h4 id="infix-函数"><a href="#infix-函数" class="headerlink" title="infix 函数"></a>infix 函数</h4><p>标有 <code>infix</code> 关键字的函数也可以使用中缀表示法（忽略该调用的点与圆括号）调用。中缀函数必须满足以下要求：</p>
<ul>
<li>它们必须是成员函数或扩展函数；</li>
<li>它们必须只有一个参数；</li>
<li>其参数不得接受可变数量的参数且不能有默认值。</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">infix</span> <span class="function"><span class="keyword">fun</span> <span class="built_in">Int</span>.<span class="title">shl</span><span class="params">(x: <span class="type">Int</span>)</span></span>: <span class="built_in">Int</span> &#123; …… &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用中缀表示法调用该函数</span></span><br><span class="line"><span class="number">1</span> shl <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 等同于这样</span></span><br><span class="line"><span class="number">1.</span>shl(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 中缀函数调用的优先级低于算术操作符、类型转换以及 rangeTo 操作符。 以下表达式是等价的：</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span> shl <span class="number">2</span> + <span class="number">3</span> 等价于 <span class="number">1</span> shl (<span class="number">2</span> + <span class="number">3</span>)</span><br><span class="line"><span class="number">0</span> until n * <span class="number">2</span> 等价于 <span class="number">0</span> until (n * <span class="number">2</span>)</span><br><span class="line">xs union ys <span class="keyword">as</span> Set&lt;*&gt; 等价于 xs union (ys <span class="keyword">as</span> Set&lt;*&gt;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 另一方面，中缀函数调用的优先级高于布尔操作符 &amp;&amp; 与 ||、is- 与 in- 检测以及其他一些操作符。这些表达式也是等价的：</span></span><br><span class="line"></span><br><span class="line">a &amp;&amp; b xor c 等价于 a &amp;&amp; (b xor c)</span><br><span class="line">a xor b <span class="keyword">in</span> c 等价于 (a xor b) <span class="keyword">in</span> c</span><br></pre></td></tr></table></figure>

<p>中缀函数总是要求指定接收者与参数。当使用中缀表示法在当前接收者上调用方法时，需要显式使用 <code>this</code>；不能像常规方法调用那样省略。这是确保非模糊解析所必需的。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyStringCollection</span> &#123;</span><br><span class="line">    <span class="keyword">infix</span> <span class="function"><span class="keyword">fun</span> <span class="title">add</span><span class="params">(s: <span class="type">String</span>)</span></span> &#123; <span class="comment">/*……*/</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">build</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">this</span> add <span class="string">&quot;abc&quot;</span>   <span class="comment">// 正确</span></span><br><span class="line">        add(<span class="string">&quot;abc&quot;</span>)       <span class="comment">// 正确</span></span><br><span class="line">        add <span class="string">&quot;abc&quot;</span>      <span class="comment">// 错误：必须指定接收者</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="内联函数"><a href="#内联函数" class="headerlink" title="内联函数"></a>内联函数</h4><ul>
<li>内联函数配合「函数类型」，可以减少「函数类型」生成的对象  。</li>
<li>使⽤ <code>inline</code> 关键字声明的函数是「内联函数」，在「编译时」会将「内联函数」中的函数体直接插⼊到调⽤处。  所以在写内联函数的时候需要注意，尽量将内联函数中的代码行数减少。</li>
</ul>
<p><code>noinline</code> 可以禁止部分函数参数参与内联编译：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">(inlined: () -&gt; <span class="type">Unit</span>, <span class="keyword">noinline</span> notInlined:() -&gt; <span class="type">Unit</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="匿名函数"><a href="#匿名函数" class="headerlink" title="匿名函数"></a>匿名函数</h4><ul>
<li>匿名函数的特点是可以明确指定其返回值类型。</li>
<li>它和常规函数的定义几乎相似。他们的区别在于，匿名函数没有函数名。</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 常规函数</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">test</span><span class="params">(x : <span class="type">Int</span> , y : <span class="type">Int</span>)</span></span> : <span class="built_in">Int</span> = x + y</span><br><span class="line"></span><br><span class="line"><span class="comment">// 匿名函数</span></span><br><span class="line"><span class="function"><span class="title">fun</span><span class="params">(x : <span class="type">Int</span> , y : <span class="type">Int</span>)</span></span> : <span class="built_in">Int</span> = x + y</span><br></pre></td></tr></table></figure>

<h4 id="Lambda-表达式"><a href="#Lambda-表达式" class="headerlink" title="Lambda 表达式"></a>Lambda 表达式</h4><p><code>Lambda</code> 表达式的本质是 <code>匿名函数</code>，因为在其底层实现中还是通过匿名函数来实现的。但是我们在用的时候不必关心其底层实现。不过 Lambda 的出现确实是减少了代码量的编写，同时也使代码变得更加简洁明了。</p>
<p><strong>1、Lambda 的特点：</strong></p>
<ul>
<li>Lambda 表达式总是被大括号括着。</li>
<li>其参数（如果存在）在符号 “-&gt;” 之前声明（参数类型可以省略）。</li>
<li>函数体（如果存在）在符号 “-&gt;” 后面。</li>
</ul>
<p><strong>2、Lambda 语法：</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、无参数的情况：</span><br><span class="line"><span class="keyword">val</span>/<span class="keyword">var</span> 变量名 = &#123; 操作的代码 &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 源代码</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">myFun1</span><span class="params">()</span></span> &#123;</span><br><span class="line">    println(<span class="string">&quot;无参数&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// lambda 代码</span></span><br><span class="line"><span class="keyword">val</span> myFun1 = &#123; println(<span class="string">&quot;无参数&quot;</span>) &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">test1</span><span class="params">()</span></span> &#123;</span><br><span class="line">    myFun1() <span class="comment">// 调用</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// -------------------------------------------</span></span><br><span class="line"><span class="number">2</span>、有参数的情况：</span><br><span class="line"><span class="keyword">val</span>/<span class="keyword">var</span> 变量名 : (参数的类型，参数类型，...) -&gt; 返回值类型 = &#123;参数<span class="number">1</span>，参数<span class="number">2</span>，... -&gt; 操作参数的代码 &#125;</span><br><span class="line">可等价于</span><br><span class="line"><span class="comment">// 此种写法：即表达式的返回值类型会根据操作的代码自推导出来。</span></span><br><span class="line"><span class="keyword">val</span>/<span class="keyword">var</span> 变量名 = &#123; 参数<span class="number">1</span> ： 类型，参数<span class="number">2</span> : 类型, ... -&gt; 操作参数的代码 &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 源代码</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">myFun2</span><span class="params">(a: <span class="type">Int</span>, b: <span class="type">Int</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// lambda</span></span><br><span class="line"><span class="keyword">val</span> myFun2: (<span class="built_in">Int</span>, <span class="built_in">Int</span>) -&gt; <span class="built_in">Int</span> = &#123; a, b -&gt; a + b &#125;</span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line"><span class="keyword">val</span> myFun2 = &#123; a: <span class="built_in">Int</span>, b: <span class="built_in">Int</span> -&gt; a + b &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">test2</span><span class="params">()</span></span> &#123;</span><br><span class="line">    myFun2(<span class="number">1</span>, <span class="number">2</span>) <span class="comment">// 调用</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// -------------------------------------------</span></span><br><span class="line"><span class="number">3</span>、lambda 表达式作为函数中的参数：</span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">test</span><span class="params">(a : <span class="type">Int</span>, 参数名 : (参数1 ： 类型，参数2 : 类型, ... ) -&gt; 表达式返回类型)</span></span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 源代码</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">myFun3</span><span class="params">(a: <span class="type">Int</span>, b: <span class="type">Int</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">sum</span><span class="params">(num1: <span class="type">Int</span>, num2: <span class="type">Int</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> num1 + num2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// lambda</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">myFun33</span><span class="params">(a: <span class="type">Int</span>, b: (<span class="type">num1</span>: <span class="type">Int</span>, <span class="type">num2</span>: <span class="type">Int</span>) -&gt; <span class="type">Int</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b.invoke(<span class="number">3</span>, <span class="number">5</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">test3</span><span class="params">()</span></span> &#123;</span><br><span class="line">    myFun33(<span class="number">10</span>, &#123; num1: <span class="built_in">Int</span>, num2: <span class="built_in">Int</span> -&gt; num1 + num2 &#125;) <span class="comment">// 调用</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>invoke() 函数：表示为通过函数变量调用自身，因为上面例子中的变量 b 是一个匿名函数。</p>
</blockquote>
<p><strong>3、it</strong></p>
<p>当一个高阶函数中 Lambda 表达式的参数只有一个的时候可以使用 it 来使用此参数。it 可表示为单个参数的隐式名称，是 Kotlin 语言约定的。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> arr = intArrayOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"><span class="keyword">var</span> sum = <span class="number">0</span></span><br><span class="line">arr.forEach &#123;</span><br><span class="line">    sum += it</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>4、下划线（_）</strong></p>
<p>在使用 Lambda 表达式的时候，可以用下划线 （_） 表示未使用的参数，表示不处理这个参数。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> map = mapOf(<span class="string">&quot;key1&quot;</span> to <span class="string">&quot;value1&quot;</span>, <span class="string">&quot;key2&quot;</span> to <span class="string">&quot;value2&quot;</span>, <span class="string">&quot;key3&quot;</span> to <span class="string">&quot;value3&quot;</span>)</span><br><span class="line"><span class="comment">// 不需要 key 的时候</span></span><br><span class="line">map.forEach &#123; _, value -&gt;</span><br><span class="line">    println(<span class="string">&quot;<span class="variable">$value</span>&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>5、带接收者的函数字面值</strong></p>
<p>在 Kotlin 中，提供了指定的接受者对象调用 Lambda 表达式的功能。在函数字面值的函数体中，可以调用该接收者对象上的方法而无需任何额外的限定符。它类似于扩展函数，它允许在函数体内访问接收者对象的成员。</p>
<p><strong>5.1、匿名函数作为接收者类型</strong></p>
<p>匿名函数语法允许你直接指定函数字面值的接收者类型，如果你需要使用带接收者的函数类型声明一个变量，并在之后使用它，这将非常有用。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> add = <span class="function"><span class="keyword">fun</span> <span class="built_in">Int</span>.<span class="params">( other : <span class="type">Int</span>)</span></span> : <span class="built_in">Int</span> = <span class="keyword">this</span> + other</span><br><span class="line">println(<span class="number">2.</span>add(<span class="number">3</span>)) <span class="comment">// 输出 5</span></span><br></pre></td></tr></table></figure>

<p><strong>5.2、Lambda 表达式作为接收者类型</strong></p>
<p>要用 Lambda 表达式作为接收者类型的前提是<strong>接收者类型可以从上下文中推断出来</strong>。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HTML</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">body</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">myFun5</span><span class="params">(<span class="keyword">init</span>: <span class="type">HTML</span>.() -&gt; <span class="type">Unit</span>)</span></span>: HTML &#123;</span><br><span class="line">    <span class="keyword">val</span> html = HTML() <span class="comment">// 创建接收者对象</span></span><br><span class="line">    html.<span class="keyword">init</span>()       <span class="comment">// 将该接收者对象传给该 lambda</span></span><br><span class="line">    <span class="keyword">return</span> html</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">test111</span><span class="params">()</span></span> &#123;</span><br><span class="line">    myFun5 &#123; <span class="comment">// 带接收者的 lambda 由此开始</span></span><br><span class="line">        body() <span class="comment">// 调用该接收者对象的一个方法</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>6、闭包</strong></p>
<p>所谓闭包，即是函数中包含函数，这里的函数我们可以包含（Lambda 表达式，匿名函数，局部函数，对象表达式）。我们熟知，函数式编程是现在和未来良好的一种编程趋势，故而 Kotlin 也有这一个特性。Java 是不支持闭包的。</p>
<p><strong>6.1、携带状态</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 让函数返回一个函数，并携带状态值</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">myFun4</span><span class="params">(b: <span class="type">Int</span>)</span></span>: () -&gt; <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="number">3</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="title">fun</span><span class="params">()</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">        a++</span><br><span class="line">        <span class="keyword">return</span> a + b</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">test4</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> t = myFun4(<span class="number">3</span>)</span><br><span class="line">    println(t()) <span class="comment">// 输出 7</span></span><br><span class="line">    println(t()) <span class="comment">// 输出 8</span></span><br><span class="line">    println(t()) <span class="comment">// 输出 9</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>6.2、引用外部变量，并改变外部变量的值</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sum : <span class="built_in">Int</span> = <span class="number">0</span></span><br><span class="line"><span class="keyword">val</span> arr = arrayOf(<span class="number">1</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">9</span>)</span><br><span class="line">arr.filter &#123; it &lt; <span class="number">7</span>  &#125;.forEach &#123; sum += it &#125;</span><br><span class="line"></span><br><span class="line">println(sum) <span class="comment">// 输出 9</span></span><br></pre></td></tr></table></figure>

<p><strong>7、Lambda 表达式简写</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果函数的最后⼀个参数是 lambda, 那么 lambda 表达式可以放在圆括号之外：</span></span><br><span class="line">lessons.forEach()&#123; lesson : Lesson -&gt;</span><br><span class="line">   <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果你的函数传⼊参数只有⼀个 lambda 的话，那么⼩括号可以省略的：</span></span><br><span class="line">lessons.forEach &#123; lesson : Lesson -&gt;</span><br><span class="line">   <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果 lambda 表达式只有⼀个参数，那么可以省略，通过隐式的 it 来访问：</span></span><br><span class="line">lessons.forEach &#123; <span class="comment">// it</span></span><br><span class="line">   <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="高阶函数"><a href="#高阶函数" class="headerlink" title="高阶函数"></a>高阶函数</h4><p>在 <code>Kotlin</code> 中，高阶函数即指：将函数用作一个函数的参数或者返回值的函数。</p>
<p><strong>将函数用作函数参数的情况</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sumBy 函数的源码</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> CharSequence.<span class="title">sumBy</span><span class="params">(selector: (<span class="type">Char</span>) -&gt; <span class="type">Int</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> sum: <span class="built_in">Int</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> (element <span class="keyword">in</span> <span class="keyword">this</span>) &#123;</span><br><span class="line">        sum += selector(element)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">test</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> str = <span class="string">&quot;abc&quot;</span></span><br><span class="line">    <span class="keyword">val</span> sum = str.sumBy &#123; it.toInt() &#125;</span><br><span class="line">    println(sum) <span class="comment">// 输出 294。因为字符 a 对应的值为 97，b 对应 98，c 对应 99。故而该值即为 97 + 98 + 99 = 294</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>将函数用作一个函数的返回值</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">lock</span><span class="params">(lock: <span class="type">Lock</span>, body: () -&gt; <span class="type">T</span>)</span></span>: T &#123;</span><br><span class="line">    lock.lock()</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> body()</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">toBeSynchronized</span><span class="params">()</span></span> = sharedResource.operation()</span><br><span class="line"><span class="keyword">val</span> result = lock(lock, ::toBeSynchronized) </span><br><span class="line"></span><br><span class="line"><span class="comment">// 上面的写法也可以写作：</span></span><br><span class="line"><span class="keyword">val</span> result = lock(lock, &#123;sharedResource.operation()&#125; )</span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line"><span class="keyword">val</span> result = lock(lock) &#123;</span><br><span class="line">    sharedResource.operation()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>::toBeSynchronized 即为对函数 toBeSynchronized() 的引用。</p>
</blockquote>
<p><strong>自定义高阶函数</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义高阶函数</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">calculation</span><span class="params">(num1: <span class="type">Int</span>, num2: <span class="type">Int</span>, result: (<span class="type">Int</span>, <span class="type">Int</span>) -&gt; <span class="type">Int</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> result(num1, num2)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试调用</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">test</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> result1 = calculation(<span class="number">1</span>, <span class="number">2</span>) &#123; num1, num2 -&gt;</span><br><span class="line">        num1 + num2</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> result2 = calculation(<span class="number">10</span>, <span class="number">20</span>) &#123; num1, num2 -&gt;</span><br><span class="line">        num1 * num2</span><br><span class="line">    &#125;</span><br><span class="line">    println(<span class="string">&quot;result1 = <span class="variable">$result1</span>&quot;</span>) <span class="comment">// 输出：3</span></span><br><span class="line">    println(<span class="string">&quot;result2 = <span class="variable">$result2</span>&quot;</span>) <span class="comment">// 输出：200</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>开发中常用的一个例子</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ParamView</span> <span class="meta">@JvmOverloads</span> <span class="keyword">constructor</span>(context: Context, attrs: AttributeSet? = <span class="literal">null</span>, defStyleAttr: <span class="built_in">Int</span> = <span class="number">0</span>) : LinearLayout(context, attrs, defStyleAttr) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> onParamValueClickListener: (() -&gt; <span class="built_in">Unit</span>)? = <span class="literal">null</span> <span class="comment">// 定义一个点击事件，给外部处理</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        tvParamValue?.setOnClickListener &#123;</span><br><span class="line">            onParamValueClickListener?.invoke()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 外部 ParamView 控件处理点击事件</span></span><br><span class="line">paramView?.onParamValueClickListener = &#123;</span><br><span class="line">    <span class="comment">// 处理业务逻辑...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="标准高阶函数"><a href="#标准高阶函数" class="headerlink" title="标准高阶函数"></a>标准高阶函数</h4><p>Standard.kt 文件中提供了一系列标准的高阶函数。</p>
<p><strong>函数特点汇总</strong></p>
<table>
<thead>
<tr>
<th align="left">函数</th>
<th align="left">接收者（this）</th>
<th align="left">传参（it）</th>
<th align="left">返回值（result）</th>
</tr>
</thead>
<tbody><tr>
<td align="left">run()</td>
<td align="left">当前类</td>
<td align="left">编译错误</td>
<td align="left">作用域中的最后一个对象</td>
</tr>
<tr>
<td align="left">T.run()</td>
<td align="left">类T</td>
<td align="left">编译错误</td>
<td align="left">作用域中的最后一个对象</td>
</tr>
<tr>
<td align="left">with()</td>
<td align="left">类T</td>
<td align="left">编译错误</td>
<td align="left">作用域中的最后一个对象</td>
</tr>
<tr>
<td align="left">T.let()</td>
<td align="left">当前类</td>
<td align="left">类T</td>
<td align="left">作用域中的最后一个对象</td>
</tr>
<tr>
<td align="left">T.also()</td>
<td align="left">当前类</td>
<td align="left">类T</td>
<td align="left">类T</td>
</tr>
<tr>
<td align="left">T.apply()</td>
<td align="left">类T</td>
<td align="left">编译错误</td>
<td align="left">类T</td>
</tr>
</tbody></table>
<p>实际应用：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyStandard</span> &#123;</span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">val</span> TAG = <span class="string">&quot;MyStandard&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// run()</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">runDemo1</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">var</span> name = <span class="string">&quot;AA&quot;</span></span><br><span class="line">        run &#123;</span><br><span class="line">            <span class="keyword">val</span> name = <span class="string">&quot;BB&quot;</span></span><br><span class="line">            Log.e(TAG, name) <span class="comment">// BB</span></span><br><span class="line">        &#125;</span><br><span class="line">        Log.d(TAG, name) <span class="comment">// AA</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// T.run()</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">runDemo2</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> result = <span class="string">&quot;ABCDEF&quot;</span>.run &#123;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;字符串的长度为 <span class="variable">$length</span>&quot;</span>) <span class="comment">// 字符串的长度为 6</span></span><br><span class="line">            substring(<span class="number">2</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        Log.d(TAG, result) <span class="comment">// CDEF</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// with()</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">withDemo</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> result = with(<span class="string">&quot;ABCDEF&quot;</span>) &#123;</span><br><span class="line">            substring(<span class="number">2</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        Log.d(TAG, result) <span class="comment">// CDEF</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// T.let()</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">letDemo</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> result = <span class="string">&quot;ABCDEF&quot;</span>.let &#123;</span><br><span class="line">            it.substring(<span class="number">2</span>) <span class="comment">// it 代表 &quot;ABCDEF&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        Log.d(TAG, result) <span class="comment">// CDEF</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// T.also()</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">alsoDemo</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> result = <span class="string">&quot;ABCDEF&quot;</span>.also &#123;</span><br><span class="line">            it.substring(<span class="number">2</span>) <span class="comment">// it 代表 &quot;ABCDEF&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        Log.d(TAG, result) <span class="comment">// ABCDEF</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// T.apply()</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">applyDemo</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> result = <span class="string">&quot;ABCDEF&quot;</span>.apply &#123;</span><br><span class="line">            <span class="keyword">this</span>.substring(<span class="number">2</span>) <span class="comment">// this 代表 &quot;ABCDEF&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        Log.d(TAG, result) <span class="comment">// ABCDEF</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通常，T.run()、T.let()、T.also() 和 T.apply() 四个用的比较多，使用时可以通过简单的规则作出⼀些判断：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(需要返回自身)&#123;</span><br><span class="line">    <span class="keyword">if</span>(作用域中使用 <span class="keyword">this</span> 作为参数)&#123;</span><br><span class="line">        选择 apply</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(作用域中使用 it 作为参数)&#123;</span><br><span class="line">        选择 also</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(不需要返回自身)&#123;</span><br><span class="line">    <span class="keyword">if</span>(作用域中使用 <span class="keyword">this</span> 作为参数)&#123;</span><br><span class="line">        选择 run</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(作用域中使用 it 作为参数)&#123;</span><br><span class="line">        选择 let</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实化类型参数"><a href="#实化类型参数" class="headerlink" title="实化类型参数"></a>实化类型参数</h3><p><strong>泛型类型擦除</strong>：JVM 中的泛型一般是通过类型擦除实现的，也就是说泛型类实例的类型实参在编译时被擦除，在运行时是不会被保留的。基于这样实现的做法是有历史原因的，最大的原因之一是为了兼容 JDK1.5 之前的版本，当然泛型类型擦除也是有好处的，在运行时丢弃了一些类型实参的信息，对于内存占用也会减少很多。</p>
<p>正因为泛型类型擦除原因在业界 Java 的泛型又称伪泛型。因为编译后所有泛型的类型实参类型都会被替换成 Object 类型或者泛型类型形参指定上界约束类的类型。例如： List<Float>、List<String>、List<Student> 在 JVM 运行时 Float、String、Student 都被替换成 Object 类型，如果泛型定义是 List<T extends Student> 那么运行时 T 被替换成 Student 类型。</p>
<p>Kotlin 和 Java 都存在泛型类型擦除的问题，但 Kotlin 可以通过 <code>inline</code> 函数保证使得泛型类的类型实参在运行时能够保留，这样的操作 Kotlin 中把它称为<strong>实化</strong>，对应需要使用 <strong>reified</strong> 关键字。因此，我们可以通过配合 <code>inline + reified</code> 达到「真泛型」的效果。</p>
<p><strong>1、满足实化类型参数函数的必要条件</strong></p>
<ul>
<li>必须是 inline 内联函数，使用 inline 关键字修饰。</li>
<li>泛型类定义泛型形参时必须使用 reified 关键字修饰。</li>
</ul>
<p><strong>2、带实化类型参数的函数基本定义</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义</span></span><br><span class="line"><span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;<span class="keyword">reified</span> T&gt;</span> <span class="title">isInstanceOf</span><span class="params">(value: <span class="type">Any</span>)</span></span>: <span class="built_in">Boolean</span> = value <span class="keyword">is</span> T</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> obj = User()</span><br><span class="line"><span class="keyword">val</span> instanceOf = isInstanceOf&lt;User&gt;(obj) <span class="comment">// 调用</span></span><br></pre></td></tr></table></figure>

<p>对于以上例子，我们可以说类型形参 T 是泛型函数 isInstanceOf 的实化类型参数。</p>
<p><strong>3、原理描述</strong></p>
<p>编译器把实现内联函数的字节码动态插入到每次的调用点。那么实化的原理正是基于这个机制，<strong>每次调用带实化类型参数的函数时，编译器都知道此次调用中作为泛型类型实参的具体类型。所以编译器只要在每次调用时生成对应不同类型实参调用的字节码插入到调用点即可。</strong> 总之一句话很简单，就是带实化参数的函数每次调用都生成不同类型实参的字节码，动态插入到调用点。由于生成的字节码的类型实参引用了具体的类型，而不是类型参数所以不会存在擦除问题。</p>
<p><strong>4、实化类型参数函数不能在 Java 中调用</strong></p>
<p>Kotlin 的实化类型参数函数主要得益于 inline 函数的内联功能，虽然 Java 可以调用普通的内联函数但是失去了内联功能，失去内联功能也就意味实化操作也就化为泡影。</p>
<p><strong>5、实化类型参数函数的使用限制</strong></p>
<ul>
<li>不能使用非实化类型形参作为类型实参调用带实化类型参数的函数。</li>
<li>不能使用实化类型参数创建该类型参数的实例对象。</li>
<li>不能调用实化类型参数的伴生对象方法。</li>
<li>reified 关键字只能标记实化类型参数的内联函数，不能作用于类和属性。</li>
</ul>
<p><strong>6、实化类型参数函数使用例子</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;<span class="keyword">reified</span> T&gt;</span> <span class="title">create</span><span class="params">()</span></span>: T &#123;</span><br><span class="line">    <span class="keyword">return</span> RETROFIT.create(T::<span class="keyword">class</span>.java)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> api = create&lt;API&gt;() <span class="comment">// 调用</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;<span class="keyword">reified</span> T&gt;</span> Gson.<span class="title">fromJson</span><span class="params">(json: <span class="type">String</span>)</span></span> = fromJson(json, T::<span class="keyword">class</span>.java)</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> user = Gson().fromJson&lt;User&gt;(json) <span class="comment">// 调用</span></span><br></pre></td></tr></table></figure>

<h3 id="类与继承"><a href="#类与继承" class="headerlink" title="类与继承"></a>类与继承</h3><p>Kotlin 中也使用 class 关键字定义类，所有类都继承于 Any 类，类似于 Java 中 Object 类的概念。类实例化的形式也与 Java 一样，但是去掉了 new 关键字。</p>
<h4 id="构造器"><a href="#构造器" class="headerlink" title="构造器"></a>构造器</h4><p>类的构造器分为主构造器（primary constructor）和次级构造器（secondary constructor），前者只能有一个，而后者可以有多个。如果两者都未指定，则默认为无参数的主构造器。</p>
<p>主构造器是属于类头的一部分，用 constructor 关键字定义，如果没有被「可见性修饰符」或者「注解」标注，constructor 可省略。由于主构造器不能包含任何代码，初始化代码需要单独写在 init 代码块中，主构造器的参数只能在 init 代码块和变量初始化时使用。</p>
<p>次级构造器也是用 constructor 关键字定义，必须要直接或间接代理主构造器。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(name: String) &#123; <span class="comment">// 主构造器</span></span><br><span class="line">    <span class="keyword">var</span> id: <span class="built_in">Int</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> name: String = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>(id: <span class="built_in">Int</span>, name: String) : <span class="keyword">this</span>(name) &#123; <span class="comment">// 次级构造器</span></span><br><span class="line">        <span class="keyword">this</span>.id = id</span><br><span class="line">        <span class="keyword">this</span>.name = name</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主构造器中的参数加上 val 或者 var 修饰，那么参数就变成类的成员变量，如果参数和类原来的成员变量一样，那么对应原来的成员变量就要去掉。因此，以上代码一般可以简化为以下代码。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="keyword">val</span> id: <span class="built_in">Int</span>, <span class="keyword">val</span> name: String) &#123;</span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h4><p>类继承使用符号 “:” 表示，接口实现也一样，不做原本 Java 中的 extends 和 implement 关键字区分。Kotlin 中取消了 final 关键字，所有类默认都是被 final 修饰，不能被继承。Kotlin 中新增了 open 关键字，被 open 或者 abstract 修饰的类才可以被继承。</p>
<h4 id="单例与伴随对象"><a href="#单例与伴随对象" class="headerlink" title="单例与伴随对象"></a>单例与伴随对象</h4><p>Kotlin 使用关键词 object 定义单例类。这里需要注意，是全小写。单例类访问直接使用类名，无构造函数。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span> LogUtil &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">d</span><span class="params">(msg: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (BuildConfig.DEBUG) &#123;</span><br><span class="line">            Log.d(<span class="string">&quot;tag&quot;</span>, msg)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可通过 AS 工具栏 Tools –&gt; Kotlin –&gt; Show Kotlin Bytecode, 点击右侧的 Decompile 来把当前 Kotlin 代码转换为 Java 代码，来验证以上 object 对象是否转换成 Java 中的单例类。</p>
</blockquote>
<p>Java 中使用 static 标识一个类里的静态属性或方法。Kotlin 中没有 static 关键字，改为使用伴随对象，用 companion 修饰单例类 object, 来实现静态属性或方法功能。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LoginCache</span> &#123;</span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">val</span> USER_NAME = <span class="string">&quot;user_name&quot;</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">val</span> PASSWORD = <span class="string">&quot;password&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">saveLoginInfo</span><span class="params">(userName: <span class="type">String</span>, password: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">LoginCache.saveLoginInfo(<span class="string">&quot;ZhangSan&quot;</span>,<span class="string">&quot;123456&quot;</span>) <span class="comment">// 调用</span></span><br></pre></td></tr></table></figure>

<h4 id="内部类"><a href="#内部类" class="headerlink" title="内部类"></a>内部类</h4><p>在 Kotlin 中，内部类默认是静态内部类，通过 <code>inner</code> 关键字声明为嵌套内部类。</p>
<h4 id="匿名内部类"><a href="#匿名内部类" class="headerlink" title="匿名内部类"></a>匿名内部类</h4><p>形式：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span> : OnItemCLickListener &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>应用：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">btnLogin.setOnClickListener(<span class="keyword">object</span> :View.OnClickListener&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onClick</span><span class="params">(v: <span class="type">View</span>?)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 以上匿名内部类转换成的 lambda 表达式如下：</span></span><br><span class="line">btnLogin.setOnClickListener &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="const"><a href="#const" class="headerlink" title="const"></a>const</h3><ul>
<li>const 必须修饰 val。</li>
<li>const 只允许在 top-level 级别和 object 中声明。</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span> LogUtil &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">val</span> TAG: String = <span class="string">&quot;LogUtil&quot;</span></span><br><span class="line">    <span class="keyword">val</span> msg: String = <span class="string">&quot;msg&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上 Kotlin 代码转换成的 Java 代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 省略了部分不大相关代码</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">LogUtil</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;LogUtil&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String msg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getMsg</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> msg;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看出，const val 可见性为 public static final, 可以直接访问。val 可见性为 private static final, 并且 val 会生成对应属性的 getter 方法，通过方法调用访问。当定义常量时，出于效率考虑，应该使用 const val 方式，避免频繁函数调用。const 修饰的静态变量又称为<strong>编译器常量</strong>。</p>
<h3 id="声明抽象类-接口-枚举-注解"><a href="#声明抽象类-接口-枚举-注解" class="headerlink" title="声明抽象类&#x2F;接口&#x2F;枚举&#x2F;注解"></a>声明抽象类&#x2F;接口&#x2F;枚举&#x2F;注解</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声明抽象类</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span></span><br><span class="line"><span class="comment">// 声明接⼝</span></span><br><span class="line"><span class="keyword">interface</span></span><br><span class="line"><span class="comment">// 声明注解</span></span><br><span class="line"><span class="keyword">annotation</span> <span class="keyword">class</span></span><br><span class="line"><span class="comment">// 声明枚举</span></span><br><span class="line">enmu <span class="keyword">class</span></span><br></pre></td></tr></table></figure>

<h3 id="受检异常"><a href="#受检异常" class="headerlink" title="受检异常"></a>受检异常</h3><p>Kotlin 不需要使用 <code>try-catch</code> 强制捕获异常。</p>
<h3 id="获取-Class-对象"><a href="#获取-Class-对象" class="headerlink" title="获取 Class 对象"></a>获取 Class 对象</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">使用 [类名::<span class="keyword">class</span>] 获取的是 Kotlin 的类型 KClass</span><br><span class="line">使用 [类名::<span class="keyword">class</span>.java] 获取的是 Java 的类型</span><br><span class="line"></span><br><span class="line">startActivity(Intent(<span class="keyword">this</span>, MainActivity::<span class="keyword">class</span>.java))</span><br></pre></td></tr></table></figure>

<h3 id="setter-getter"><a href="#setter-getter" class="headerlink" title="setter&#x2F;getter"></a>setter&#x2F;getter</h3><p>在 Kotlin 声明属性的时候（没有使用 private 修饰），会自动生成一个私有属性和一对公开的 setter&#x2F;getter 方法。在写 setter&#x2F;getter 的时候使⽤ field 来代替内部的私有属性（防⽌递归栈溢出）。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> name: String = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">get</span>() = field <span class="comment">// 默认实现方式，可省略</span></span><br><span class="line">        <span class="keyword">set</span>(value) &#123; <span class="comment">// 默认实现方式，可省略</span></span><br><span class="line">            field = value</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">var</span> age: <span class="built_in">Int</span> = <span class="number">0</span></span><br><span class="line">        <span class="keyword">get</span>() = <span class="number">18</span> <span class="comment">// 获取的值一直都是 18，不会改变</span></span><br><span class="line">        <span class="keyword">set</span>(value) &#123;</span><br><span class="line">            field = <span class="keyword">if</span> (value &lt; <span class="number">0</span>) <span class="number">1</span> <span class="keyword">else</span> value</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="JvmXxx-相关注解"><a href="#JvmXxx-相关注解" class="headerlink" title="JvmXxx 相关注解"></a>JvmXxx 相关注解</h3><h4 id="JvmField"><a href="#JvmField" class="headerlink" title="JvmField"></a>JvmField</h4><p>通过 <code>@JvmField</code> 注解可以让编译器只生成一个 public 的成员属性，不生成对应的 setter&#x2F;getter 方法。</p>
<h4 id="JvmName"><a href="#JvmName" class="headerlink" title="JvmName"></a>JvmName</h4><p>顶层函数在文件中定义函数和属性，会直接生成静态的成员，在 Java 中通过「文件名Kt」来访问，同时可以通过 <code>@file:JvmName</code> 注解来修改这个类名。注解要写在包名前面才会起作用。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@file:JvmName</span>(<span class="string">&quot;AppCache&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.zch.kotlin.biz1</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> mToken: String? = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">saveToken</span><span class="params">(token: <span class="type">String</span>?)</span></span> &#123;</span><br><span class="line">    mToken = token</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java 中访问方式</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">    AppCacheKt.saveToken(<span class="string">&quot;abc123&quot;</span>); <span class="comment">// 原来的访问方式</span></span><br><span class="line">    AppCache.saveToken(<span class="string">&quot;abc123&quot;</span>); <span class="comment">// 加了 @file:JvmName 注解后的访问方式</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="JvmStatic"><a href="#JvmStatic" class="headerlink" title="JvmStatic"></a>JvmStatic</h4><p>如果将命名对象或伴生对象中定义的函数注解为 <code>@JvmStatic</code> ，Kotlin 会为这些函数生成静态方法。</p>
<p><code>命名对象中的 @JvmStatic</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span> SizeUtil &#123;</span><br><span class="line">    <span class="meta">@JvmStatic</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">dp2px</span><span class="params">()</span></span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">sp2px</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java 方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSizeUtil</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 之前的访问方式</span></span><br><span class="line">    SizeUtil.INSTANCE.dp2px();</span><br><span class="line">    SizeUtil.INSTANCE.sp2px();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加了 @JvmStatic 注解后，dp2px 变成了静态方法</span></span><br><span class="line">    SizeUtil.dp2px();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>伴生对象中的 @JvmStatic</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Util</span> &#123;</span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="meta">@JvmStatic</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">sayYes</span><span class="params">()</span></span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">sayNo</span><span class="params">()</span></span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java 方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUtil</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">// 之前的访问方式</span></span><br><span class="line">    Util.Companion.sayYes();</span><br><span class="line">    Util.Companion.sayNo();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加了 <span class="doctag">@JvmStatic</span> 注解后，Util 生成了静态方法 sayYes，</span></span><br><span class="line"><span class="comment">     * 该静态方法直接访问 Companion 的 sayYes()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Util.sayYes();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>@JvmStatic</code> 注解也可以应用于对象或伴生对象的属性，使其 getter 和 setter 方法成为该对象或包含伴生对象的类的静态成员。</p>
</blockquote>
<h4 id="JvmOverloads"><a href="#JvmOverloads" class="headerlink" title="JvmOverloads"></a>JvmOverloads</h4><p>在 Kotlin 中调用默认参数值的方法或者构造函数是完全没问题的，Java 中调用相应 Kotlin 方法时，是必须输入所有参数的值的，Kotlin 中默认参数我们无法使用。而当加上 <code>@JvmOverloads</code>, Kotlin 编译器生成的字节码中有对应的重载方法，我们就可以通过 Java 的重载方式来使用 Kotlin 的代码了，不必要输入所有的参数。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ParamView</span> <span class="meta">@JvmOverloads</span> <span class="keyword">constructor</span>(context: Context, attrs: AttributeSet? = <span class="literal">null</span>, defStyleAttr: <span class="built_in">Int</span> = <span class="number">0</span>) : LinearLayout(context, attrs, defStyleAttr) &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上 Kotlin 的自定义控件加上 <code>@JvmOverloads</code> 后，相当于 Java 中的以下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ParamView</span> <span class="keyword">extends</span> <span class="title class_">LinearLayout</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ParamView</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(context, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ParamView</span><span class="params">(Context context, AttributeSet attrs)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(context, attrs, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ParamView</span><span class="params">(Context context, AttributeSet attrs, <span class="type">int</span> defStyleAttr)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context, attrs, defStyleAttr);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Kotlin 中构造函数、顶级函数、类中方法，静态方法（@Jvmstatic 修饰）均可采用 <code>@JvmOverloads</code> 生成对应重载方法。</p>
</blockquote>
<h3 id="注解使用处目标"><a href="#注解使用处目标" class="headerlink" title="注解使用处目标"></a>注解使用处目标</h3><p>当某个元素可能会包含多种内容（例如构造属性，成员属性），使用注解时可以通过「注解使⽤处⽬标」，让注解对⽬标发⽣作⽤，例如 @file: 、 @get: 、@set: 等。  </p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">App</span> : <span class="type">Application</span>() &#123;</span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="meta">@JvmStatic</span></span><br><span class="line">        <span class="meta">@get:JvmName</span>(<span class="string">&quot;instance&quot;</span>)</span><br><span class="line">        <span class="keyword">lateinit</span> <span class="keyword">var</span> instance: Application</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">set</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate()</span><br><span class="line">        instance = <span class="keyword">this</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">App.Companion.getInstance(); <span class="comment">// java 中原来调用方式</span></span><br><span class="line">App.instance(); <span class="comment">// java 中现在调用方式</span></span><br></pre></td></tr></table></figure>

<h3 id="Elvis-操作符"><a href="#Elvis-操作符" class="headerlink" title="Elvis 操作符"></a>Elvis 操作符</h3><p>可通过 <code>?:</code> 的操作来简化 <code>if null</code> 操作。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lesson.date 为空时使⽤默认值</span></span><br><span class="line"><span class="keyword">val</span> date = lesson.date?: <span class="string">&quot;⽇期待定&quot;</span></span><br><span class="line"><span class="comment">// lesson.state 为空时提前返回函数</span></span><br><span class="line"><span class="keyword">val</span> state = lesson.state?: <span class="keyword">return</span></span><br><span class="line"><span class="comment">// lesson.content 为空时抛出异常</span></span><br><span class="line"><span class="keyword">val</span> content = lesson.content ?: <span class="keyword">throw</span> IllegalArgumentException(<span class="string">&quot;content expected&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="空指针安全"><a href="#空指针安全" class="headerlink" title="空指针安全"></a>空指针安全</h3><p>Kotlin 中，当我们定义一个变量时，其默认就是非空类型。如果你直接尝试给他赋值为 null, 编译器会直接报错。Kotlin 中将符号 “?” 定义为安全调用操作符。变量类型后面跟 ? 号定义，表明这是一个可空类型。同样的，在调用子属性和函数时，也可以用字符 ? 进行安全调用。Kotlin 的编译器会在写代码时就检查非空情况。</p>
<p>Kotlin 还提供 “!!” 双感叹号操作符来强制调用对象的属性和方法，无视其是否非空。这是一个挺危险的操作符，除非有特殊需求，否则为了远离 NPE, 还是少用为妙。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> tvContent: TextView <span class="comment">// 非空类型</span></span><br><span class="line"><span class="keyword">var</span> tvContent: TextView? <span class="comment">// 可空类型</span></span><br><span class="line"></span><br><span class="line">!! <span class="comment">// 强行调用符</span></span><br><span class="line">? <span class="comment">// 安全调用符</span></span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> s1: String = <span class="string">&quot;abc&quot;</span></span><br><span class="line">s1 = <span class="literal">null</span> <span class="comment">// 这里编译器会报错</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> s2: String? = <span class="string">&quot;abc&quot;</span></span><br><span class="line">s2 = <span class="literal">null</span> <span class="comment">// 编译器不会报错</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> l1 = s1.length <span class="comment">// 可正常编译</span></span><br><span class="line"><span class="keyword">var</span> l2 = s2.length <span class="comment">// 没有做非空判断，编译器检查报错</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (s2 != <span class="literal">null</span>) s2.length <span class="comment">// Java 式的判空方案</span></span><br><span class="line">s2?.length <span class="comment">// Kotlin 的安全调用操作符 ?。当 s2 为 null 时，s2?.length 也为 null</span></span><br><span class="line"></span><br><span class="line">s2!!.length <span class="comment">// 可能会导致 NPE</span></span><br></pre></td></tr></table></figure>

<h3 id="lateinit-关键字"><a href="#lateinit-关键字" class="headerlink" title="lateinit 关键字"></a>lateinit 关键字</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1、lateinit 只能修饰 var 可读可写变量。</span></span><br><span class="line"><span class="comment"> * 2、lateinit 关键字声明的变量类型必须是不可空类型。</span></span><br><span class="line"><span class="comment"> * 3、lateinit 声明的变量不能有初始值。</span></span><br><span class="line"><span class="comment"> * 4、lateinit 声明的变量不能是基本数据类型。</span></span><br><span class="line"><span class="comment"> * 5、在构造器中初始化的属性不需要 lateinit 关键字。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> tvContent: TextView</span><br></pre></td></tr></table></figure>

<h3 id="data-class"><a href="#data-class" class="headerlink" title="data class"></a>data class</h3><p>数据类通常都是由多个属性和对应的 getter、setter 组成。当有大量多属性时，不仅这些类会因为大量的 getter 和 setter 方法而行数爆炸，也使整个工程方法数骤增。</p>
<p>Kotlin 中做了这层特性优化，提供了数据类的简单实现。不用再写 getter、setter 方法，这些都由编译器背后去做，你得到的是一个清爽干净的数据类。数据类用 <code>data class</code> 声明。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">Student</span>(</span><br><span class="line">    <span class="keyword">var</span> id: <span class="built_in">Int</span>,</span><br><span class="line">    <span class="keyword">var</span> name: String,</span><br><span class="line">    <span class="keyword">var</span> age: <span class="built_in">Int</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>把这个数据类反编译成 Java 代码可知，数据类除了为我们生成了 getter、setter（val 声明的变量不生成 setter 方法）、构造函数外，还有以下方法。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">equals() / hashCode()</span><br><span class="line">toString()</span><br><span class="line">componentN()...</span><br><span class="line">copy()</span><br></pre></td></tr></table></figure>

<p><code>copy 函数</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Student copy(int id, String name, int age) &#123;</span><br><span class="line">    <span class="keyword">return</span> new Student(id, name, age);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当要复制一个对象，只改变一些属性，但其余不变，copy() 就是为此而生。</p>
<p><code>componentN 函数-解构声明（Destructuring Declarations）</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> int component1() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.id;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> String component2() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> int component3() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译器为数据类（data class）自动声明 componentN() 函数，可直接用解构声明。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> student = Student(<span class="number">101</span>, <span class="string">&quot;ZhangSan&quot;</span>, <span class="number">30</span>)</span><br><span class="line"><span class="keyword">val</span> (id, name, age) = student <span class="comment">// 自动赋值给 id, name, age</span></span><br><span class="line">println(<span class="string">&quot;id=<span class="variable">$id</span>, name=<span class="variable">$name</span>, age=<span class="variable">$age</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="相等性"><a href="#相等性" class="headerlink" title="相等性"></a>相等性</h3><p><code>两个等号==和三个等号===</code></p>
<p>两个等号 <code>==</code>：比较的是<strong>对象的内容</strong>是否相同，相当于 Java 的 equals()。<code>==</code> 的否定形式为 <code>!=</code> 。</p>
<p>三个等号 <code>===</code>：比较的是<strong>对象的地址</strong>是否相同（即判断是否为同一对象），相当于 Java 的 &#x3D;&#x3D;。<code>===</code> 的否定形式为 <code>!==</code> 。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> student1 = Student(<span class="number">101</span>, <span class="string">&quot;ZhangSan&quot;</span>, <span class="number">30</span>)</span><br><span class="line"><span class="keyword">val</span> student2 = Student(<span class="number">101</span>, <span class="string">&quot;ZhangSan&quot;</span>, <span class="number">30</span>)</span><br><span class="line"><span class="keyword">if</span> (student1 == student2) &#123; <span class="comment">// true</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (student1 === student2) &#123; <span class="comment">// false</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="operator"><a href="#operator" class="headerlink" title="operator"></a>operator</h3><p>通过 operator 修饰「特定函数名」的函数，例如 plus 、get, 可以达到重载运算符的效果。</p>
<table>
<thead>
<tr>
<th>表达式</th>
<th>翻译为</th>
</tr>
</thead>
<tbody><tr>
<td>a + b</td>
<td>a.plus(b)</td>
</tr>
<tr>
<td>a - b</td>
<td>a.minus(b)</td>
</tr>
<tr>
<td>a * b</td>
<td>a.times(b)</td>
</tr>
<tr>
<td>a &#x2F; b</td>
<td>a.div(b)</td>
</tr>
</tbody></table>
<h3 id="委托"><a href="#委托" class="headerlink" title="委托"></a>委托</h3><p>委托，也就是委托模式，它是 23 种经典设计模式中的一种，又名<code>代理模式</code>，在委托模式中，有 2 个对象参与同一个请求的处理，接受请求的对象将请求委托给另一个对象来处理。委托模式中，有三个角色：约束、委托对象和被委托对象。Kotlin 直接支持委托模式，更加优雅，简洁。Kotlin 通过关键字 <code>by</code> 实现委托。</p>
<ul>
<li><strong>约束</strong>：约束是接口或者抽象类，它定义了通用的业务类型，也就是需要被代理的业务。</li>
<li><strong>被委托对象</strong>：具体的业务逻辑执行者。</li>
<li><strong>委托对象</strong>：负责对真正角色的应用，将约束类定义的业务委托给具体的委托对象。</li>
</ul>
<h4 id="类委托"><a href="#类委托" class="headerlink" title="类委托"></a>类委托</h4><p>类的委托即一个类中定义的方法实际是调用另一个类的对象的方法来实现的。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 约束类，我们约定的业务</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">IGamePlayer</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">play</span><span class="params">()</span></span> <span class="comment">// 打游戏</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 被委托对象，实现了我们约定的业务</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RealGamePlayer</span>(<span class="keyword">private</span> <span class="keyword">val</span> name: String) : IGamePlayer &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">play</span><span class="params">()</span></span> &#123;</span><br><span class="line">        println(<span class="string">&quot;<span class="subst">$&#123;name&#125;</span>开始打游戏&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 委托对象，通过关键字 by 建立委托类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DelegateGamePlayer</span>(<span class="keyword">private</span> <span class="keyword">val</span> player: IGamePlayer) : IGamePlayer <span class="keyword">by</span> player</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">(args: <span class="type">Array</span>&lt;<span class="type">String</span>&gt;)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> realGamePlayer = RealGamePlayer(<span class="string">&quot;张三&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> delegateGamePlayer = DelegateGamePlayer(realGamePlayer)</span><br><span class="line">    delegateGamePlayer.play() <span class="comment">// 输出：张三开始打游戏</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 DelegateGamePlayer 声明中，by 子句表示，将 player 保存在 DelegateGamePlayer 的对象实例内部，而且编译器将会生成继承自 IGamePlayer 接口的所有方法，并将调用转发给 player。</p>
<blockquote>
<p> 可以通过类委托的模式来减少继承。</p>
</blockquote>
<h4 id="属性委托"><a href="#属性委托" class="headerlink" title="属性委托"></a>属性委托</h4><p>属性委托指的是一个类的某个属性值不是在类中直接进行定义，而是将其托付给一个代理类，从而实现对该类的属性统一管理。</p>
<p>属性委托语法格式：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span>/<span class="keyword">var</span> &lt;属性名&gt;: &lt;类型&gt; <span class="keyword">by</span> &lt;表达式&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>var&#x2F;val：属性类型(可变&#x2F;只读)。</li>
<li>属性名：属性名称。</li>
<li>类型：属性的数据类型。</li>
<li>表达式：委托代理类。</li>
</ul>
<p>by 关键字之后的表达式就是委托，属性的 get() 方法（以及 set() 方法）将被委托给这个对象的 getValue() 和 setValue() 方法。属性委托不必实现任何接口，但必须提供 getValue() 函数（对于 var 属性，还需要 setValue() 函数）。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 被委托类（委托代理类）</span></span><br><span class="line"><span class="comment"> * 该类需要包含 getValue() 方法和 setValue() 方法，且参数 thisRef 为进行委托的类的对象，property 为进行委托的属性的对象。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Delegate</span> &#123;</span><br><span class="line">    <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="title">getValue</span><span class="params">(thisRef: <span class="type">Any</span>?, property: <span class="type">KProperty</span>&lt;*&gt;)</span></span>: String &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;<span class="variable">$thisRef</span>, 这里委托了 <span class="subst">$&#123;property.name&#125;</span> 属性&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="title">setValue</span><span class="params">(thisRef: <span class="type">Any</span>?, property: <span class="type">KProperty</span>&lt;*&gt;, value: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        println(<span class="string">&quot;<span class="variable">$thisRef</span> 的 <span class="subst">$&#123;property.name&#125;</span> 属性赋值为 <span class="variable">$value</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">(args: <span class="type">Array</span>&lt;<span class="type">String</span>&gt;)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> token: String <span class="keyword">by</span> Delegate()</span><br><span class="line">    println(token) <span class="comment">// 访问该属性，调用 getValue() 函数</span></span><br><span class="line"></span><br><span class="line">    token = <span class="string">&quot;xxx&quot;</span>   <span class="comment">// 调用 setValue() 函数</span></span><br><span class="line">    println(token)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中的参数解释如下：</p>
<ul>
<li><code>thisRef</code> —— 必须与属性所有者类型（对于扩展属性——指被扩展的类型）相同或者是它的超类型。</li>
<li><code>property</code> —— 必须是类型 <code>KProperty&lt;*&gt;</code> 或其超类型。</li>
<li><code>value</code> —— 必须与属性同类型或者是它的子类型。</li>
</ul>
<h4 id="属性委托的另一种实现方式"><a href="#属性委托的另一种实现方式" class="headerlink" title="属性委托的另一种实现方式"></a>属性委托的另一种实现方式</h4><p>Kotlin 标准库中声明了 2 个含所需 <code>operator</code> 方法的 <code>ReadOnlyProperty / ReadWriteProperty</code> 接口。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">ReadOnlyProperty</span>&lt;<span class="type">in R, out T</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="title">getValue</span><span class="params">(thisRef: <span class="type">R</span>, property: <span class="type">KProperty</span>&lt;*&gt;)</span></span>: T</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">ReadWriteProperty</span>&lt;<span class="type">in R, T</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="title">getValue</span><span class="params">(thisRef: <span class="type">R</span>, property: <span class="type">KProperty</span>&lt;*&gt;)</span></span>: T</span><br><span class="line">    <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="title">setValue</span><span class="params">(thisRef: <span class="type">R</span>, property: <span class="type">KProperty</span>&lt;*&gt;, value: <span class="type">T</span>)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>被委托类</code> 实现这两个接口其中之一就可以了，<code>val</code> 属性实现 <code>ReadOnlyProperty</code>, <code>var</code> 属性实现 <code>ReadWriteProperty</code>。 </p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Delegate2</span> : <span class="type">ReadWriteProperty</span>&lt;<span class="type">Any?, String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getValue</span><span class="params">(thisRef: <span class="type">Any</span>?, property: <span class="type">KProperty</span>&lt;*&gt;)</span></span>: String &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">setValue</span><span class="params">(thisRef: <span class="type">Any</span>?, property: <span class="type">KProperty</span>&lt;*&gt;, value: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> token2: String <span class="keyword">by</span> Delegate2()</span><br></pre></td></tr></table></figure>

<h4 id="标准库中提供的几个委托"><a href="#标准库中提供的几个委托" class="headerlink" title="标准库中提供的几个委托"></a>标准库中提供的几个委托</h4><ul>
<li>延迟属性（lazy）: 其值只在首次访问时计算。</li>
<li>可观察属性（observable）: 监听器会收到有关此属性变更的通知。</li>
<li>把多个属性储存在一个映射（map）中，而不是每个存在单独的字段中。</li>
</ul>
<p><strong>1、延迟属性 lazy</strong></p>
<p>lazy() 是一个函数，接受一个 Lambda 表达式作为参数，返回一个 Lazy <T> 实例的函数，返回的实例可以作为实现延迟属性的委托：第一次调用 get() 会执行已传递给 lazy() 的 lamda 表达式并记录结果，后续调用 get() 只是返回记录的结果。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> lazyValue: String <span class="keyword">by</span> lazy &#123;</span><br><span class="line">    println(<span class="string">&quot;computed!&quot;</span>) <span class="comment">// 第一次调用输出，第二次调用不执行</span></span><br><span class="line">    <span class="string">&quot;Hello&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">(args: <span class="type">Array</span>&lt;<span class="type">String</span>&gt;)</span></span> &#123;</span><br><span class="line">    println(lazyValue) <span class="comment">// 第一次执行，执行两次输出表达式</span></span><br><span class="line">    println(lazyValue) <span class="comment">// 第二次执行，只输出返回值</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行输出结果</span></span><br><span class="line">computed!</span><br><span class="line">Hello</span><br><span class="line">Hello</span><br></pre></td></tr></table></figure>

<p><strong>2、可观察属性 Observable</strong></p>
<p>observable 可以用于实现观察者模式。</p>
<p>Delegates.observable() 函数接受两个参数：第一个是初始化值，第二个是属性值被修改时的回调处理器 onChange。回调处理器有三个参数：被赋值的属性、旧值和新值：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlin.properties.Delegates</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> name: String <span class="keyword">by</span> Delegates.observable(<span class="string">&quot;A&quot;</span>) &#123; property, oldValue, newValue -&gt;</span><br><span class="line">        println(<span class="string">&quot;旧值：<span class="variable">$oldValue</span> -&gt; 新值：<span class="variable">$newValue</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">(args: <span class="type">Array</span>&lt;<span class="type">String</span>&gt;)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> user = User()</span><br><span class="line">    user.name = <span class="string">&quot;B&quot;</span></span><br><span class="line">    user.name = <span class="string">&quot;C&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行输出结果</span></span><br><span class="line">旧值：A -&gt; 新值：B</span><br><span class="line">旧值：B -&gt; 新值：C</span><br></pre></td></tr></table></figure>

<p><strong>vetoable 函数</strong>：<code>vetoable</code> 与 <code>observable</code> 一样，可以观察属性值的变化，不同的是，<code>vetoable</code> 可以通过<code>处理器函数来决定属性值是否生效</code>。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声明一个 Int 类型的属性 vetoableProp, 如果新的值比旧值大，则生效，否则不生效。</span></span><br><span class="line"><span class="keyword">var</span> vetoableProp: <span class="built_in">Int</span> <span class="keyword">by</span> Delegates.vetoable(<span class="number">0</span>)&#123; _, oldValue, newValue -&gt;</span><br><span class="line">    <span class="comment">// 如果新的值大于旧值，则生效</span></span><br><span class="line">    newValue &gt; oldValue</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3、把属性储存在映射中</strong></p>
<p>一个常见的用例是在一个映射（map）里存储属性的值。 这经常出现在像解析 JSON 或者做其他“动态”事情的应用中。 在这种情况下，你可以使用映射实例自身作为委托来实现委托属性。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="keyword">val</span> map: Map&lt;String, Any?&gt;) &#123;</span><br><span class="line">    <span class="keyword">val</span> name: String <span class="keyword">by</span> map</span><br><span class="line">    <span class="keyword">val</span> age: <span class="built_in">Int</span>  <span class="keyword">by</span> map</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">(args: <span class="type">Array</span>&lt;<span class="type">String</span>&gt;)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 构造函数接受一个映射参数</span></span><br><span class="line">    <span class="keyword">val</span> user = User(mapOf(</span><br><span class="line">        <span class="string">&quot;name&quot;</span> to <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">        <span class="string">&quot;age&quot;</span>  to <span class="number">18</span></span><br><span class="line">    ))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取映射值</span></span><br><span class="line">    println(user.name)</span><br><span class="line">    println(user.age)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="集合中函数式-API-操作符"><a href="#集合中函数式-API-操作符" class="headerlink" title="集合中函数式 API 操作符"></a>集合中函数式 API 操作符</h3><h4 id="筛选过滤类"><a href="#筛选过滤类" class="headerlink" title="筛选过滤类"></a>筛选过滤类</h4><h5 id="slice-系列"><a href="#slice-系列" class="headerlink" title="slice 系列"></a>slice 系列</h5><p>操作符可以取集合中一部分元素或者某个元素，最后组合成一个新元素。</p>
<ul>
<li><p>**<code>slice(indices: IntRange)</code>**：指定切片的起始位置和终止位置，将范围内的元素切出加入到新集合。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> list = listOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>).slice(IntRange(<span class="number">2</span>, <span class="number">4</span>))</span><br><span class="line">println(list)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line">[<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>slice(indices: Iterable&lt;Int&gt;)</code>**：指定下标分别切出对应的元素，放入新集合中。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> list = listOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>).slice(IntRange(<span class="number">2</span>, <span class="number">4</span>))</span><br><span class="line">println(list)</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> list2 = listOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>).slice(listOf(<span class="number">1</span>, <span class="number">3</span>))</span><br><span class="line">println(list2)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line">[<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line">[<span class="number">2</span>, <span class="number">4</span>]</span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="filter-系列"><a href="#filter-系列" class="headerlink" title="filter 系列"></a>filter 系列</h5><ul>
<li><p>**<code>filter(predicate: (T) -&gt; Boolean)</code>**：从一个集合筛选出符合条件的元素，并以一个新集合返回。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> list = listOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>).filter &#123; it % <span class="number">2</span> == <span class="number">0</span> &#125;</span><br><span class="line">println(list)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line">[<span class="number">2</span>, <span class="number">4</span>]</span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>filterTo(destination: C, predicate: (T) -&gt; Boolean)</code>**：从多个集合筛选出符合条件的元素，并最终用一个集合进行收集从每个集合筛选出的元素。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> numberList1 = listOf(<span class="number">3</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">12</span>, <span class="number">15</span>)</span><br><span class="line"><span class="keyword">val</span> numberList2 = listOf(<span class="number">5</span>, <span class="number">10</span>, <span class="number">15</span>, <span class="number">20</span>, <span class="number">25</span>)</span><br><span class="line"><span class="keyword">val</span> numberList3 = listOf(<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>, <span class="number">50</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// filterTo 的 destination 是一个可变集合类型，所以这里使用 mutableListOf 初始化</span></span><br><span class="line"><span class="keyword">val</span> newNumberList = mutableListOf&lt;<span class="built_in">Int</span>&gt;().apply &#123;</span><br><span class="line">    numberList1.filterTo(<span class="keyword">this</span>) &#123;</span><br><span class="line">        it % <span class="number">5</span> == <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    numberList2.filterTo(<span class="keyword">this</span>) &#123;</span><br><span class="line">        it % <span class="number">5</span> == <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    numberList3.filterTo(<span class="keyword">this</span>) &#123;</span><br><span class="line">        it % <span class="number">20</span> == <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">println(newNumberList)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line">[<span class="number">15</span>, <span class="number">5</span>, <span class="number">10</span>, <span class="number">15</span>, <span class="number">20</span>, <span class="number">25</span>, <span class="number">20</span>, <span class="number">40</span>]</span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>filterIndexed(predicate: (index: Int, T) -&gt; Boolean)</code>**：需要集合元素 <code>index</code> 参与筛选条件。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> result = listOf(<span class="number">3</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">12</span>, <span class="number">15</span>).filterIndexed &#123; index, item -&gt;</span><br><span class="line">    index &gt; <span class="number">2</span> &amp;&amp; item % <span class="number">2</span> == <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line">println(result)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line">[<span class="number">12</span>]</span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>filterIndexedTo(destination: C, predicate: (index: Int, T) -&gt; Boolean)</code>**：从多个集合筛选出符合条件的元素，筛选条件需要 <code>index</code>，并最终用一个集合进行收集从每个集合筛选出的元素。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> result = mutableListOf&lt;<span class="built_in">Int</span>&gt;()</span><br><span class="line">listOf(<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">12</span>, <span class="number">4</span>).filterIndexedTo(result) &#123; index, item -&gt;</span><br><span class="line">    index == item</span><br><span class="line">&#125;</span><br><span class="line">println(result)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line">[<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>]</span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>filterIsInstance()</code>**：一个抽象类集合中含有多种子类型的元素，可以很方便筛选对应子类型的元素，并组成一个集合返回。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> list = mutableListOf(<span class="number">1</span>, <span class="string">&quot;2&quot;</span>, <span class="number">3</span>, <span class="string">&quot;4&quot;</span>, <span class="number">5f</span>, <span class="number">6.0</span>, <span class="string">&quot;7&quot;</span>)</span><br><span class="line"><span class="keyword">val</span> result = list.filterIsInstance&lt;<span class="built_in">Int</span>&gt;()</span><br><span class="line">println(result)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line">[<span class="number">1</span>, <span class="number">3</span>]</span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>filterIsInstanceTo(destination: C)</code>**：适用于筛选多个集合的情况。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> list = mutableListOf(<span class="number">1</span>, <span class="string">&quot;2&quot;</span>, <span class="number">3</span>, <span class="string">&quot;4&quot;</span>, <span class="number">5f</span>, <span class="number">6.0</span>, <span class="string">&quot;7&quot;</span>)</span><br><span class="line"><span class="keyword">val</span> result = mutableListOf&lt;String&gt;()</span><br><span class="line">list.filterIsInstanceTo(result)</span><br><span class="line">println(result)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line">[<span class="number">2</span>, <span class="number">4</span>, <span class="number">7</span>]</span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>filterNot(predicate: (T) -&gt; Boolean)</code><strong>、</strong><code>filterNotTo(destination: C, predicate: (T) -&gt; Boolean)</code>**：从一个集合筛选出符合条件之外的元素，并以一个新集合返回。它是 filter 操作符取反操作。</p>
</li>
<li><p>**<code>filterNotNull()</code><strong>、</strong><code>filterNotNullTo(destination: C)</code>**：filterNotNull 操作符可以过滤集合中为 null 的元素。同理 filterNotNullTo 才是真正过滤操作，但是需要从外部传入一个可变集合。</p>
</li>
</ul>
<h5 id="drop-系列"><a href="#drop-系列" class="headerlink" title="drop 系列"></a>drop 系列</h5><ul>
<li><p>**<code>drop(n: Int)</code>**：把集合元素去除一部分，drop 是顺序地删除，n 则表示顺序删除几个元素，最后返回剩余元素集合。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">println(listOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>).drop(<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line">[<span class="number">4</span>, <span class="number">5</span>]</span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>dropLast(n: Int)</code>**：根据传入数值 n，表示从右到左倒序地删除 n 个集合中的元素，并返回集合中剩余的元素。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">println(listOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>).dropLast(<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>]</span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>dropWhile(predicate: (T) -&gt; Boolean)</code>**：从集合的第一项开始去掉满足条件元素，这样操作一直持续到出现第一个不满足条件元素出现为止，返回剩余元素（可能剩余元素有满足条件的元素）。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">println(listOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">32</span>, <span class="number">40</span>, <span class="number">5</span>).dropWhile &#123; it &lt; <span class="number">20</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line">[<span class="number">32</span>, <span class="number">40</span>, <span class="number">5</span>]</span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>dropLastWhile(predicate: (T) -&gt; Boolean)</code>**：从集合的最后一项开始去掉满足条件元素，这样操作一直持续到出现第一个不满足条件元素出现为止，返回剩余元素（可能剩余元素有满足条件的元素）。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> println(listOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">32</span>, <span class="number">40</span>, <span class="number">5</span>).dropLastWhile &#123; it &lt; <span class="number">20</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">32</span>, <span class="number">40</span>]</span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="take-系列"><a href="#take-系列" class="headerlink" title="take 系列"></a>take 系列</h5><ul>
<li><p>**<code>take(n: Int)</code>**：从原集合的第一项开始顺序取集合的元素，取 n 个元素，最后返回取出这些元素的集合。换句话说就是取集合前 n 个元素组成新的集合返回。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">println(listOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">32</span>, <span class="number">40</span>, <span class="number">5</span>).take(<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">32</span>]</span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>takeLast(n: Int)</code>**：从原集合的最后一项开始倒序取集合的元素，取 n 个元素，最后返回取出这些元素的集合。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">println(listOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">32</span>, <span class="number">40</span>, <span class="number">5</span>).takeLast(<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line">[<span class="number">32</span>, <span class="number">40</span>, <span class="number">5</span>]</span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>takeLastWhile(predicate: (T) -&gt; Boolean)</code>**：从集合的最后一项开始取出满足条件元素，这样操作一直持续到出现第一个不满足条件元素出现为止，暂停取元素，返回取出元素的集合。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">println(listOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">32</span>, <span class="number">40</span>, <span class="number">5</span>).takeLastWhile &#123; it &lt; <span class="number">20</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line">[<span class="number">5</span>]</span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>takeWhile(predicate: (T) -&gt; Boolean)</code>**：从集合的第一项开始取出满足条件元素，这样操作一直持续到出现第一个不满足条件元素出现为止，暂停取元素，返回取出元素的集合。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">println(listOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">32</span>, <span class="number">40</span>, <span class="number">5</span>).takeWhile &#123; it &lt; <span class="number">20</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>]</span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="distinct-系列"><a href="#distinct-系列" class="headerlink" title="distinct 系列"></a>distinct 系列</h5><ul>
<li><p><code>distinct</code>：去除集合中的重复元素。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">println(listOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">3</span>).distinct())</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>distinctBy(selector: (T) -&gt; K)</code>**：根据操作元素后的结果去除重复元素。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">println(listOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">6</span>).distinctBy &#123; it % <span class="number">2</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>]</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="并集类操作符"><a href="#并集类操作符" class="headerlink" title="并集类操作符"></a>并集类操作符</h4><h5 id="any、all、count、none-系列"><a href="#any、all、count、none-系列" class="headerlink" title="any、all、count、none 系列"></a>any、all、count、none 系列</h5><ul>
<li><p>**<code>any()</code>**：判断是不是一个集合，若是，则再判断集合是否为空。若为空则返回 false，反之返回 true。若不是集合，则返回 hasNext。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">println(listOf(<span class="number">1</span>, <span class="number">2</span>).any())</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>any(predicate: (T) -&gt; Boolean)</code>**：判断集合中是否存在满足条件的元素。若存在则返回 true，反之返回 false。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">println(listOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">32</span>, <span class="number">40</span>, <span class="number">5</span>).any &#123; it &gt; <span class="number">30</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>all(predicate: (T) -&gt; Boolean)</code>**：判断集合中的所有元素是否都满足条件。若是则返回 true，反之则返回 false。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">println(listOf(<span class="number">0</span>, <span class="number">2</span>, <span class="number">32</span>, <span class="number">40</span>, <span class="number">50</span>).all &#123; it % <span class="number">2</span> == <span class="number">0</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>count()</code><strong>、</strong><code>count(predicate: (T) -&gt; Boolean)</code>**：返回集合中的元素个数或查询集合中满足条件的元素个数。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">println(listOf(<span class="number">0</span>, <span class="number">2</span>, <span class="number">32</span>, <span class="number">40</span>, <span class="number">50</span>).count())</span><br><span class="line">println(listOf(<span class="number">0</span>, <span class="number">2</span>, <span class="number">32</span>, <span class="number">40</span>, <span class="number">50</span>).count &#123; it &gt; <span class="number">10</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">3</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>none()</code><strong>、</strong><code>none(predicate: (T) -&gt; Boolean)</code>**：如果一个集合是空集合，返回 true 或者集合中没有满足条件的元素，则返回 true。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">println(listOf(<span class="number">0</span>, <span class="number">2</span>, <span class="number">32</span>, <span class="number">40</span>, <span class="number">50</span>).none()) </span><br><span class="line">println(listOf(<span class="number">0</span>, <span class="number">2</span>, <span class="number">32</span>, <span class="number">40</span>, <span class="number">50</span>).none &#123; it &gt; <span class="number">50</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line"><span class="literal">false</span></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="fold-系列"><a href="#fold-系列" class="headerlink" title="fold 系列"></a>fold 系列</h5><ul>
<li><p>**<code>fold(initial: R, operation: (acc: R, T) -&gt; R)</code>**：在一个初始值的基础上，从第一项到最后一项通过一个函数累计所有的元素。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">println(listOf(<span class="number">0</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>).fold(<span class="number">10</span>) &#123; result, element -&gt;</span><br><span class="line">    result + element</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line"><span class="number">22</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>foldIndexed(initial: R, operation: (index: Int, acc: R, T) -&gt; R)</code>**：在一个初始值的基础上，从第一项到最后一项通过一个函数累计所有的元素，该函数的参数可以包含元素索引。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">println(listOf(<span class="string">&quot;h&quot;</span>, <span class="string">&quot;e&quot;</span>, <span class="string">&quot;l&quot;</span>, <span class="string">&quot;l&quot;</span>, <span class="string">&quot;o&quot;</span>).foldIndexed(<span class="string">&quot;Say&quot;</span>) &#123; index, result, element -&gt;</span><br><span class="line">    <span class="string">&quot;<span class="variable">$result</span> <span class="variable">$element</span><span class="variable">$index</span>&quot;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line">Say h0 e1 l2 l3 o4</span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>foldRight(initial: R, operation: (T, acc: R) -&gt; R)</code>**：在一个初始值的基础上，从最后项到第一项通过一个函数累计所有的元素，与 fold 类似，不过是从最后一项开始累计。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">println(listOf(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;2&quot;</span>, <span class="string">&quot;3&quot;</span>).foldRight(<span class="string">&quot;Say&quot;</span>) &#123; element, result -&gt;</span><br><span class="line">    <span class="string">&quot;<span class="variable">$result</span> <span class="variable">$element</span>&quot;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line">Say <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>foldRightIndexed(initial: R, operation: (index: Int, T, acc: R) -&gt; R)</code>**：在一个初始值的基础上，从最后一项到第一项通过一个函数累计所有的元素，该函数的参数可以包含元素索引。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">println(listOf(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;2&quot;</span>, <span class="string">&quot;3&quot;</span>).foldRightIndexed(<span class="string">&quot;Say&quot;</span>) &#123; index, element, result -&gt;</span><br><span class="line">    <span class="string">&quot;<span class="variable">$result</span> <span class="variable">$element</span>-<span class="variable">$index</span>&quot;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line">Say <span class="number">3</span>-<span class="number">2</span> <span class="number">2</span>-<span class="number">1</span> <span class="number">1</span>-<span class="number">0</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="forEach-系列"><a href="#forEach-系列" class="headerlink" title="forEach 系列"></a>forEach 系列</h5><ul>
<li><p>**<code>forEach(action: (T) -&gt; Unit)</code>**：集合元素的遍历操作符。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">listOf(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;2&quot;</span>, <span class="string">&quot;3&quot;</span>).forEach &#123;</span><br><span class="line">    print(it)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line"><span class="number">123</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>forEachIndexed(action: (index: Int, T) -&gt; Unit)</code>**：集合中带元素下标的遍历操作。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">listOf(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;2&quot;</span>, <span class="string">&quot;3&quot;</span>).forEachIndexed &#123; index, s -&gt;</span><br><span class="line">    print(<span class="string">&quot;<span class="variable">$index</span>-<span class="variable">$s</span> &quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line"><span class="number">0</span>-<span class="number">1</span> <span class="number">1</span>-<span class="number">2</span> <span class="number">2</span>-<span class="number">3</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="max、min-系列"><a href="#max、min-系列" class="headerlink" title="max、min 系列"></a>max、min 系列</h5><ul>
<li><p>**<code>maxOrNull()</code>**：获取集合中最大的元素，若为空元素集合，则返回 null。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">println(listOf(<span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;A&quot;</span>).maxOrNull())</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line">C</span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>maxByOrNull(selector: (T) -&gt; R)</code>**：根据给定的函数返回最大的一项，如果没有则返回 null。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">println(listOf(-<span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>).maxByOrNull &#123;</span><br><span class="line">    it * -<span class="number">3</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line">-<span class="number">2</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>maxWithOrNull(comparator: Comparator&lt;in T&gt;)</code>**：接受一个 Comparator 对象并且根据此 Comparator 对象返回最大元素。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">println(listOf(<span class="string">&quot;-20&quot;</span>, <span class="string">&quot;-102&quot;</span>, <span class="string">&quot;0&quot;</span>).maxWithOrNull(compareBy &#123;</span><br><span class="line">    it.length</span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line">-<span class="number">102</span></span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>min 操作符作用与 max 相反，包括 minBy 和 minWith。</p>
</blockquote>
<h5 id="reduce-系列"><a href="#reduce-系列" class="headerlink" title="reduce 系列"></a>reduce 系列</h5><ul>
<li><p>**<code>reduce(operation: (acc: S, T) -&gt; S)</code>**：从集合中的第一项到最后一项的累计操作，与 fold 操作符的区别是没有初始值。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">println(listOf(<span class="string">&quot;Nice&quot;</span>, <span class="string">&quot;to&quot;</span>, <span class="string">&quot;meet&quot;</span>, <span class="string">&quot;you&quot;</span>).reduce &#123; result, element -&gt;</span><br><span class="line">    <span class="string">&quot;<span class="variable">$result</span> <span class="variable">$element</span>&quot;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line">Nice to meet you</span><br></pre></td></tr></table></figure>

<blockquote>
<p>其中 reduceIndexed，reduceRight，reduceRightIndexed 操作符都与前述的 fold 相关操作符类似，只是没有初始值。</p>
</blockquote>
</li>
<li><p>**<code>reduceOrNull(operation: (acc: S, T) -&gt; S)</code>**：从集合中的第一项到最后一项的累计操作，如果集合为空，返回 null。</p>
<blockquote>
<p>reduceRightOrNull 操作符作用等价于 reduceRight，不同的是当集合为空，返回 null。</p>
</blockquote>
</li>
</ul>
<h5 id="sum-系列"><a href="#sum-系列" class="headerlink" title="sum 系列"></a>sum 系列</h5><ul>
<li><p>**<code>sum()</code>**：计算集合中所有元素累加的结果。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">println(listOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>).sum())</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line"><span class="number">6</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>sumOf(selector: (T) -&gt; Int)</code>**：计算集合所有元素通过某个函数转换后数据之和。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">println(listOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>).sumOf &#123; it * <span class="number">2</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line"><span class="number">12</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="映射类操作符"><a href="#映射类操作符" class="headerlink" title="映射类操作符"></a>映射类操作符</h4><h5 id="flatMap-系列"><a href="#flatMap-系列" class="headerlink" title="flatMap 系列"></a>flatMap 系列</h5><ul>
<li><p>**<code>flatMap(transform: (T) -&gt; Iterable&lt;R&gt;)</code>**：根据条件合并两个集合，组成一个新的集合。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> strList = listOf(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>)</span><br><span class="line">println(strList.flatMap &#123; listOf(it.plus(<span class="string">&quot;1&quot;</span>)) &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line">[A1, B1, C1]</span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>flatMapTo(destination: C, transform: (T) -&gt; Iterable&lt;R&gt;)</code>**：多个集合的条件合并。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> strList = listOf(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>)</span><br><span class="line"><span class="keyword">val</span> strList2 = listOf(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>)</span><br><span class="line"><span class="keyword">val</span> resultList = mutableListOf&lt;String&gt;().apply &#123;</span><br><span class="line">    strList.flatMapTo(<span class="keyword">this</span>) &#123;</span><br><span class="line">        listOf(it.plus(<span class="string">&quot;1&quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    strList2.flatMapTo(<span class="keyword">this</span>) &#123;</span><br><span class="line">        listOf(it.plus(<span class="string">&quot;2&quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">println(resultList)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line">[A1, B1, C1, a2, b2, c2]</span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="group-系列"><a href="#group-系列" class="headerlink" title="group 系列"></a>group 系列</h5><ul>
<li><p>**<code>groupBy(keySelector: (T) -&gt; K)</code>**：分组操作符，根据条件将集合拆分为一个 Map 类型集合。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> strList = listOf(<span class="string">&quot;Java&quot;</span>, <span class="string">&quot;Kotlin&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;C++&quot;</span>, <span class="string">&quot;JavaScript&quot;</span>)</span><br><span class="line">println(strList.groupBy &#123; <span class="keyword">if</span> (it.startsWith(<span class="string">&quot;Java&quot;</span>)) <span class="string">&quot;MyJava&quot;</span> <span class="keyword">else</span> <span class="string">&quot;MyKotlin&quot;</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line">&#123;MyJava=[Java, JavaScript], MyKotlin=[Kotlin, C, C++]&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>groupByTo(destination: M, keySelector: (T) -&gt; K)</code>**：分组操作，适用于多个集合的分组操作。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> strList = listOf(<span class="string">&quot;Java&quot;</span>, <span class="string">&quot;Kotlin&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;C++&quot;</span>, <span class="string">&quot;JavaScript&quot;</span>)</span><br><span class="line"><span class="keyword">val</span> strList2 = listOf(<span class="string">&quot;15&quot;</span>, <span class="string">&quot;223&quot;</span>, <span class="string">&quot;45&quot;</span>, <span class="string">&quot;520&quot;</span>, <span class="string">&quot;18&quot;</span>)</span><br><span class="line"><span class="keyword">val</span> mutableMap = mutableMapOf&lt;String, MutableList&lt;String&gt;&gt;().apply &#123;</span><br><span class="line">    strList.groupByTo(<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (it.startsWith(<span class="string">&quot;Java&quot;</span>)) <span class="string">&quot;Java&quot;</span> <span class="keyword">else</span> <span class="string">&quot;Not Java&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    strList2.groupByTo(<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (it.contains(<span class="string">&quot;2&quot;</span>)) <span class="string">&quot;2&quot;</span> <span class="keyword">else</span> <span class="string">&quot;Not 2&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">println(mutableMap)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line">&#123;Java=[Java, JavaScript], Not Java=[Kotlin, C, C++], Not <span class="number">2</span>=[<span class="number">15</span>, <span class="number">45</span>, <span class="number">18</span>], <span class="number">2</span>=[<span class="number">223</span>, <span class="number">520</span>]&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>groupingBy(crossinline keySelector: (T) -&gt; K)</code>**：对元素进行分组，然后一次将操作应用于所有分组。适用于对集合复杂分组的情况。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> strList = listOf(<span class="string">&quot;Java&quot;</span>, <span class="string">&quot;Kotlin&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;C++&quot;</span>, <span class="string">&quot;JavaScript&quot;</span>)</span><br><span class="line">println(strList.groupingBy &#123; it.startsWith(<span class="string">&quot;Java&quot;</span>) &#125;.eachCount())</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line">&#123;<span class="literal">true</span>=<span class="number">2</span>, <span class="literal">false</span>=<span class="number">3</span>&#125;</span><br></pre></td></tr></table></figure>

<p><code>Grouping</code> 支持以下操作：</p>
<ul>
<li>eachCount() 计算每个组中的元素。</li>
<li>fold() 与 reduce() 对每个组分别执行 fold 与 reduce 操作，作为一个单独的集合并返回结果。</li>
<li>aggregate() 随后将给定操作应用于每个组中的所有元素并返回结果。 这是对 <code>Grouping</code> 执行任何操作的通用方法。当折叠或缩小不够时，可使用它来实现自定义操作。</li>
</ul>
</li>
</ul>
<h5 id="map-系列"><a href="#map-系列" class="headerlink" title="map 系列"></a>map 系列</h5><ul>
<li><p>**<code>map(transform: (T) -&gt; R)</code>**：集合变换，遍历每个元素并执行给定表达式，最终形成新的集合。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> strList = listOf(<span class="string">&quot;Java&quot;</span>, <span class="string">&quot;Kotlin&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;C++&quot;</span>, <span class="string">&quot;JavaScript&quot;</span>)</span><br><span class="line">println(strList.map &#123; it.plus(<span class="string">&quot;-1&quot;</span>) &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line">[Java-<span class="number">1</span>, Kotlin-<span class="number">1</span>, C-<span class="number">1</span>, C++-<span class="number">1</span>, JavaScript-<span class="number">1</span>]</span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>mapTo(destination: C, transform: (T) -&gt; R)</code>**：多个集合的元素转换。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> strList = listOf(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>)</span><br><span class="line"><span class="keyword">val</span> strList2 = listOf(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>)</span><br><span class="line">println(mutableListOf&lt;String&gt;().apply &#123;</span><br><span class="line">    strList.mapTo(<span class="keyword">this</span>) &#123; it.plus(<span class="string">&quot;-1&quot;</span>) &#125;</span><br><span class="line">    strList2.mapTo(<span class="keyword">this</span>) &#123; it.plus(<span class="string">&quot;-2&quot;</span>) &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line">[A-<span class="number">1</span>, B-<span class="number">1</span>, C-<span class="number">1</span>, a-<span class="number">2</span>, b-<span class="number">2</span>, c-<span class="number">2</span>]</span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>mapIndexed(transform: (index: Int, T) -&gt; R)</code>**：带有元素下标的集合转换。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> strList = listOf(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>)</span><br><span class="line">println(strList.mapIndexed &#123; index, s -&gt; <span class="string">&quot;<span class="variable">$index</span>-<span class="variable">$s</span>&quot;</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line">[<span class="number">0</span>-A, <span class="number">1</span>-B, <span class="number">2</span>-C]</span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>mapIndexedTo(destination: C, transform: (index: Int, T) -&gt; R)</code>**：带有元素下标的多个集合转换。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> strList = listOf(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>)</span><br><span class="line"><span class="keyword">val</span> strList2 = listOf(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>)</span><br><span class="line">println(mutableListOf&lt;String&gt;().apply &#123;</span><br><span class="line">    strList.mapIndexedTo(<span class="keyword">this</span>) &#123; index, s -&gt; <span class="string">&quot;<span class="variable">$index</span>-<span class="variable">$s</span>&quot;</span> &#125;</span><br><span class="line">    strList2.mapIndexedTo(<span class="keyword">this</span>) &#123; index, s -&gt; <span class="string">&quot;<span class="variable">$index</span>-<span class="variable">$s</span>&quot;</span> &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line">[<span class="number">0</span>-A, <span class="number">1</span>-B, <span class="number">2</span>-C, <span class="number">0</span>-a, <span class="number">1</span>-b, <span class="number">2</span>-c]</span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>mapNotNull(transform: (T) -&gt; R?)</code>**：同 <code>map</code> 函数的作用相同，不过其过滤了集合转换后为 null 的元素。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> strList = listOf(<span class="string">&quot;Java&quot;</span>, <span class="string">&quot;Kotlin&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;C++&quot;</span>, <span class="string">&quot;JavaScript&quot;</span>)</span><br><span class="line">println(strList.mapNotNull &#123; <span class="keyword">if</span> (it.startsWith(<span class="string">&quot;Java&quot;</span>)) <span class="literal">null</span> <span class="keyword">else</span> it &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line">[Kotlin, C, C++]</span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>mapNotNullTo(destination: C, transform: (T) -&gt; R?)</code>**：同 mapNotNull 函数的作用相同，它适用于多集合操作场景。</p>
</li>
<li><p>**<code>mapIndexedNotNull</code> 和 <code>mapIndexedNotNullTo</code>**：同理。</p>
</li>
</ul>
<h4 id="元素类操作符"><a href="#元素类操作符" class="headerlink" title="元素类操作符"></a>元素类操作符</h4><h5 id="element-系列"><a href="#element-系列" class="headerlink" title="element 系列"></a>element 系列</h5><ul>
<li><p>**<code>elementAt(index: Int)</code>**：获取集合指定下标的元素。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> strList = listOf(<span class="string">&quot;Java&quot;</span>, <span class="string">&quot;Kotlin&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;C++&quot;</span>, <span class="string">&quot;JavaScript&quot;</span>)</span><br><span class="line">println(strList.elementAt(<span class="number">1</span>)) <span class="comment">// 打印：Kotlin</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>elementAtOrElse(index: Int, defaultValue: (Int) -&gt; T)</code>**：获取对应下标的集合元素。若下标越界，返回默认值。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> strList = listOf(<span class="string">&quot;Java&quot;</span>, <span class="string">&quot;Kotlin&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;C++&quot;</span>, <span class="string">&quot;JavaScript&quot;</span>)</span><br><span class="line">println(strList.elementAtOrElse(<span class="number">10</span>) &#123; <span class="string">&quot;unknown&quot;</span> &#125;) <span class="comment">// 打印：unknown</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>elementAtOrNull(index: Int)</code>**：获取对应下标的集合元素。若下标越界，返回 null。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> strList = listOf(<span class="string">&quot;Java&quot;</span>, <span class="string">&quot;Kotlin&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;C++&quot;</span>, <span class="string">&quot;JavaScript&quot;</span>)</span><br><span class="line">println(strList.elementAtOrNull(<span class="number">10</span>)) <span class="comment">// 打印：null</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="first、last-系列"><a href="#first、last-系列" class="headerlink" title="first、last 系列"></a>first、last 系列</h5><ul>
<li><p>**<code>first()</code>**：获取集合第一个元素，若集合为空集合，这会抛出 NoSuchElementException 异常。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> strList = listOf(<span class="string">&quot;Java&quot;</span>, <span class="string">&quot;Kotlin&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;C++&quot;</span>, <span class="string">&quot;JavaScript&quot;</span>)</span><br><span class="line">println(strList.first()) <span class="comment">// 打印：Java</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>first(predicate: (T) -&gt; Boolean)</code>**：获取集合中指定条件的第一个元素。若不满足条件，抛异常。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> strList = listOf(<span class="string">&quot;Java&quot;</span>, <span class="string">&quot;Kotlin&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;C++&quot;</span>, <span class="string">&quot;JavaScript&quot;</span>)</span><br><span class="line">println(strList.first &#123; it.length &gt; <span class="number">5</span> &#125;) <span class="comment">// 打印：Kotlin</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>firstOrNull()</code>**：获取集合第一个元素，若集合为空集合，返回 null。</p>
</li>
<li><p>**<code>firstOrNull&#123;&#125;</code>**：获取集合满足条件的首个元素，若无则返回 null。</p>
</li>
</ul>
<blockquote>
<p>与 <code>first</code> 等操作符对应的是 <code>last</code> 等相关操作符，即取集合最后一个元素等。</p>
</blockquote>
<h5 id="find-系列"><a href="#find-系列" class="headerlink" title="find 系列"></a>find 系列</h5><ul>
<li><p>**<code>find(predicate: (T) -&gt; Boolean)</code>**：获取集合满足条件的首个元素，若无则返回 null，其实就是 firstOrNull{}。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> strList = listOf(<span class="string">&quot;Java&quot;</span>, <span class="string">&quot;Kotlin&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;C++&quot;</span>, <span class="string">&quot;JavaScript&quot;</span>)</span><br><span class="line">println(strList.find &#123; it.length &gt; <span class="number">5</span> &#125;) <span class="comment">// 打印：Kotlin</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>findLast(predicate: (T) -&gt; Boolean)</code>**：获取集合满足条件的最后一个元素，若无则返回 null，其实就是 lastOrNull{}。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> strList = listOf(<span class="string">&quot;Java&quot;</span>, <span class="string">&quot;Kotlin&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;C++&quot;</span>, <span class="string">&quot;JavaScript&quot;</span>)</span><br><span class="line">println(strList.findLast &#123; it.length &gt; <span class="number">5</span> &#125;) <span class="comment">// 打印：JavaScript</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="single-系列"><a href="#single-系列" class="headerlink" title="single 系列"></a>single 系列</h5><ul>
<li><p>**<code>single()</code>**：当集合中只有一个元素时，返回该元素，否则抛异常。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> strList = listOf(<span class="string">&quot;Java&quot;</span>, <span class="string">&quot;Kotlin&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;C++&quot;</span>, <span class="string">&quot;JavaScript&quot;</span>)</span><br><span class="line">println(strList.single()) <span class="comment">// 打印：java.lang.IllegalArgumentException: List has more than one element.</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>single(predicate: (T) -&gt; Boolean)</code>**：找到集合中满足条件的元素，若只有单个元素满足条件，则返回该元素，否则抛异常。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> strList = listOf(<span class="string">&quot;Java&quot;</span>, <span class="string">&quot;Kotlin&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;C++&quot;</span>, <span class="string">&quot;JavaScript&quot;</span>)</span><br><span class="line">println(strList.single &#123; it.startsWith(<span class="string">&quot;K&quot;</span>) &#125;) <span class="comment">// 打印：Kotlin</span></span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p><strong><code>singleOrNull</code> 或 <code>singleOrNull&#123;&#125;</code> 操作符</strong> 只是将前述的抛异常改为返回 null。</p>
</blockquote>
<h5 id="component-系列"><a href="#component-系列" class="headerlink" title="component 系列"></a>component 系列</h5><ul>
<li><p>**<code>component1()</code> … <code>component5()</code>**：用于获取第 1 到第 5 个元素。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> strList = listOf(<span class="string">&quot;Java&quot;</span>, <span class="string">&quot;Kotlin&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;C++&quot;</span>, <span class="string">&quot;JavaScript&quot;</span>)</span><br><span class="line">println(strList.component3()) <span class="comment">// 打印：C</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="indexOf-系列"><a href="#indexOf-系列" class="headerlink" title="indexOf 系列"></a>indexOf 系列</h5><ul>
<li><p>**<code>indexOf(element: T)</code>**：返回指定元素的下标，若不存在，则返回 -1。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> strList = listOf(<span class="string">&quot;Java&quot;</span>, <span class="string">&quot;Kotlin&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;C++&quot;</span>, <span class="string">&quot;JavaScript&quot;</span>)</span><br><span class="line">println(strList.indexOf(<span class="string">&quot;C&quot;</span>)) <span class="comment">// 打印：2</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>indexOfFirst(predicate: (T) -&gt; Boolean)</code>**：返回满足条件的第一个元素的下标，若不存在，则返回 -1。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> strList = listOf(<span class="string">&quot;Java&quot;</span>, <span class="string">&quot;Kotlin&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;C++&quot;</span>, <span class="string">&quot;JavaScript&quot;</span>)</span><br><span class="line">println(strList.indexOfFirst &#123; it.length &gt; <span class="number">5</span> &#125;) <span class="comment">// 打印：1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>indexOfLast(predicate: (T) -&gt; Boolean)</code>**：返回满足条件的最后一个元素的下标，若不存在，则返回 -1。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> strList = listOf(<span class="string">&quot;Java&quot;</span>, <span class="string">&quot;Kotlin&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;C++&quot;</span>, <span class="string">&quot;JavaScript&quot;</span>)</span><br><span class="line">println(strList.indexOfLast &#123; it.length &gt; <span class="number">5</span> &#125;) <span class="comment">// 打印：4</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="排序类操作符"><a href="#排序类操作符" class="headerlink" title="排序类操作符"></a>排序类操作符</h4><h5 id="reverse-系列"><a href="#reverse-系列" class="headerlink" title="reverse 系列"></a>reverse 系列</h5><ul>
<li><p>**<code>reversed()</code>**：反转集合元素。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> strList = listOf(<span class="string">&quot;Java&quot;</span>, <span class="string">&quot;Kotlin&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;C++&quot;</span>, <span class="string">&quot;JavaScript&quot;</span>)</span><br><span class="line">println(strList.reversed()) <span class="comment">// 打印：[JavaScript, C++, C, Kotlin, Java]</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="sort-系列"><a href="#sort-系列" class="headerlink" title="sort 系列"></a>sort 系列</h5><ul>
<li><p>**<code>sorted()</code>**：对集合中的元素自然升序排序。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> strList = listOf(<span class="string">&quot;Java&quot;</span>, <span class="string">&quot;Kotlin&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;C++&quot;</span>, <span class="string">&quot;JavaScript&quot;</span>)</span><br><span class="line">println(strList.sorted()) <span class="comment">// 打印：[C, C++, Java, JavaScript, Kotlin]</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>sortedDescending()</code>**：与 sorted 操作符相反，为倒序。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> strList = listOf(<span class="string">&quot;Java&quot;</span>, <span class="string">&quot;Kotlin&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;C++&quot;</span>, <span class="string">&quot;JavaScript&quot;</span>)</span><br><span class="line">println(strList.sortedDescending()) <span class="comment">// 打印：[Kotlin, JavaScript, Java, C++, C]</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>sortedBy(crossinline selector: (T) -&gt; R?)</code>**：根据条件升序，即把不满足条件的放在前面，满足条件的放在后面。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> strList = listOf(<span class="string">&quot;Java&quot;</span>, <span class="string">&quot;Kotlin&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;C++&quot;</span>, <span class="string">&quot;JavaScript&quot;</span>)</span><br><span class="line">println(strList.sortedBy &#123; it.length &#125;) <span class="comment">// 打印：[C, C++, Java, Kotlin, JavaScript]</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>sortedByDescending(crossinline selector: (T) -&gt; R?)</code>**：与 sortedBy 操作符相反，为倒序。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> strList = listOf(<span class="string">&quot;Java&quot;</span>, <span class="string">&quot;Kotlin&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;C++&quot;</span>, <span class="string">&quot;JavaScript&quot;</span>)</span><br><span class="line">println(strList.sortedByDescending &#123; it.length &#125;) <span class="comment">// 打印：[JavaScript, Kotlin, Java, C++, C]</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="生成类操作符"><a href="#生成类操作符" class="headerlink" title="生成类操作符"></a>生成类操作符</h4><h5 id="partition-系列"><a href="#partition-系列" class="headerlink" title="partition 系列"></a>partition 系列</h5><ul>
<li><p>**<code>partition(predicate: (T) -&gt; Boolean)</code>**：将一个集合按条件拆分为两个 pair 组成的新集合。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> strList = listOf(<span class="string">&quot;Java&quot;</span>, <span class="string">&quot;Kotlin&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;C++&quot;</span>, <span class="string">&quot;JavaScript&quot;</span>)</span><br><span class="line">println(strList.partition &#123; it.startsWith(<span class="string">&quot;Java&quot;</span>) &#125;) <span class="comment">// 打印：([Java, JavaScript], [Kotlin, C, C++])</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="plus-系列"><a href="#plus-系列" class="headerlink" title="plus 系列"></a>plus 系列</h5><ul>
<li><p>**<code>plus(element: T)</code>**：合并两个集合中的元素，组成一个新的集合。也可以使用符号 <code>+</code>。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> strList = listOf(<span class="string">&quot;Java&quot;</span>, <span class="string">&quot;Kotlin&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;C++&quot;</span>, <span class="string">&quot;JavaScript&quot;</span>)</span><br><span class="line">println(strList.plus(listOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>))) <span class="comment">// 打印：[Java, Kotlin, C, C++, JavaScript, 1, 2, 3]</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>plusElement(element: T)</code>**：往集合中添加一个元素。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> strList = listOf(<span class="string">&quot;Java&quot;</span>, <span class="string">&quot;Kotlin&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;C++&quot;</span>, <span class="string">&quot;JavaScript&quot;</span>)</span><br><span class="line">println(strList.plusElement(<span class="string">&quot;CSS&quot;</span>)) <span class="comment">// 打印：[Java, Kotlin, C, C++, JavaScript, CSS]</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="zip-系列"><a href="#zip-系列" class="headerlink" title="zip 系列"></a>zip 系列</h5><ul>
<li><p>**<code>zip(other: Array&lt;out R&gt;)</code>**：由两个集合按照相同的下标组成一个新集合。该新集合的类型是：<code>List&lt;Pair&gt;</code>。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> strList = listOf(<span class="string">&quot;Java&quot;</span>, <span class="string">&quot;Kotlin&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;C++&quot;</span>, <span class="string">&quot;JavaScript&quot;</span>)</span><br><span class="line">println(strList.zip(listOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>))) <span class="comment">// 打印：[(Java, 1), (Kotlin, 2), (C, 3)]</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>**<code>zipWithNext(transform: (a: T, b: T) -&gt; R)</code>**：集合中相邻元素组成 <code>pairs</code>。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> strList = listOf(<span class="string">&quot;Java&quot;</span>, <span class="string">&quot;Kotlin&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;C++&quot;</span>, <span class="string">&quot;JavaScript&quot;</span>)</span><br><span class="line">println(strList.zipWithNext()) <span class="comment">// 打印：[(Java, Kotlin), (Kotlin, C), (C, C++), (C++, JavaScript)]</span></span><br></pre></td></tr></table></figure></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zhich.github.io/2020/12/30/Dart-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="明年今日">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="明年今日">
      <meta itemprop="description" content="终身学习者。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 明年今日">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/12/30/Dart-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">Dart 学习笔记</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-30 15:56:00" itemprop="dateCreated datePublished" datetime="2020-12-30T15:56:00+08:00">2020-12-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-06-03 22:53:51" itemprop="dateModified" datetime="2024-06-03T22:53:51+08:00">2024-06-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Dart/" itemprop="url" rel="index"><span itemprop="name">Dart</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <meta name="referrer" content="no-referrer">





<blockquote>
<p>本笔记整理自大地老师的 Dart 笔记，同时加入了自己写的一些测试例子。</p>
</blockquote>
<h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>要在我们本地开发 Dart 程序的话首先需要安装 Dart SDK</p>
<p>官方文档：<span class="exturl" data-url="aHR0cHM6Ly9kYXJ0LmRldi9nZXQtZGFydA==">https://dart.dev/get-dart<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">windows(推荐):</span><br><span class="line"></span><br><span class="line">  http:<span class="comment">//www.gekorm.com/dart-windows/</span></span><br><span class="line"></span><br><span class="line">mac：</span><br><span class="line"></span><br><span class="line">  如果 mac 电脑没有安装 brew 这个工具首先第一步需要安装它： https:<span class="comment">//brew.sh/</span></span><br><span class="line"></span><br><span class="line">  brew tap dart-lang/dart</span><br><span class="line">    </span><br><span class="line">  brew install dart</span><br></pre></td></tr></table></figure>

<h3 id="开发工具"><a href="#开发工具" class="headerlink" title="开发工具"></a>开发工具</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Dart 的开发工具有很多： IntelliJ IDEA  、 WebStorm、 Atom、Vscode 等</span><br><span class="line"></span><br><span class="line">这里我们主要给大家讲解的是如果在 vscode 中配置 Dart。</span><br><span class="line">    </span><br><span class="line"><span class="number">1</span>、找到 vscode 插件安装 Dart</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、找到 vscode 插件安装 code runner, Code Runner 可以运行我们的文件</span><br></pre></td></tr></table></figure>

<h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><p>Dart 中定义变量可以使用具体的类型（int、double、String、bool 等）申明 ，也可以通过 var 关键字来申明变量。</p>
<h3 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h3><blockquote>
<p>final 和 const 修饰符都可以表示常量。</p>
</blockquote>
<ul>
<li>const 值不变，一开始就得赋值。</li>
<li>final 可以开始不赋值，只能赋一次。而 final 不仅有 const 的编译时常量的特性，最重要的它是运行时常量，并且 final 是惰性初始化，即在运行时第一次使用前才初始化。</li>
<li>注意：永远不改变的量，请使用 final 或 const 修饰它，而不是使用 var 或其他变量类型。<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">main() &#123;</span><br><span class="line">  <span class="keyword">const</span> PI = <span class="number">3.14159</span>;</span><br><span class="line">  <span class="comment">// PI = 3.14; // 报错</span></span><br><span class="line">  <span class="built_in">print</span>(PI);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// const x = new DateTime.now(); // 报错</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> a = <span class="number">1</span>;</span><br><span class="line">  <span class="comment">// a = 2; // 报错</span></span><br><span class="line">  <span class="built_in">print</span>(a);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> time = <span class="keyword">new</span> <span class="built_in">DateTime</span>.now();</span><br><span class="line">  <span class="built_in">print</span>(time);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="常用数据类型"><a href="#常用数据类型" class="headerlink" title="常用数据类型"></a>常用数据类型</h3><p>Dart 中支持以下常用数据类型：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Numbers（数值）</span><br><span class="line">    <span class="built_in">int</span></span><br><span class="line">    <span class="built_in">double</span></span><br><span class="line">Strings（字符串）</span><br><span class="line">    <span class="built_in">String</span></span><br><span class="line">Booleans(布尔)</span><br><span class="line">    <span class="built_in">bool</span></span><br><span class="line"><span class="built_in">List</span>（数组）</span><br><span class="line">    在 Dart 中，数组是列表对象，所以大多数人只是称它们为列表</span><br><span class="line">Maps（字典）</span><br><span class="line">    通常来说，<span class="built_in">Map</span> 是一个键值对相关的对象。键和值可以是任何类型的对象。每个键只出现一次，而一个值则可以出现多次</span><br></pre></td></tr></table></figure>

<p>基本使用：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">main() &#123;</span><br><span class="line">  <span class="comment"><span class="language-markdown">/**</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 1、字符串类型（String）</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">   <span class="emphasis">*/</span></span></span></span><br><span class="line">  <span class="keyword">var</span> str1 = <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">  <span class="built_in">String</span> str2 = <span class="string">&quot;World&quot;</span>;</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;<span class="subst">$str1</span> <span class="subst">$str2</span>&quot;</span>); <span class="comment">// 字符串拼接</span></span><br><span class="line">  <span class="built_in">print</span>(str1 + <span class="string">&quot; &quot;</span> + str2); <span class="comment">// 字符串拼接</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 三个单引号或三个双引号，让字符串原样输出</span></span><br><span class="line">  <span class="keyword">var</span> str3 = <span class="string">&#x27;&#x27;&#x27;Hello</span></span><br><span class="line"><span class="string">                World&#x27;&#x27;&#x27;</span>;</span><br><span class="line">  <span class="built_in">print</span>(str3);</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="language-markdown"><span class="emphasis">/*</span>*</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 2、数值类型（int、double）</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">   <span class="emphasis">*/</span></span></span></span><br><span class="line">  <span class="built_in">int</span> x = <span class="number">1</span>; <span class="comment">// 必须为整型</span></span><br><span class="line">  x = <span class="number">20</span>;</span><br><span class="line">  <span class="built_in">print</span>(x);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">double</span> d = <span class="number">99.9</span>; <span class="comment">// 整型或浮点型</span></span><br><span class="line">  d = <span class="number">100</span>;</span><br><span class="line">  <span class="built_in">print</span>(d);</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="language-markdown"><span class="emphasis">/*</span>*</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 3、布尔类型（bool）</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">   <span class="emphasis">*/</span></span></span></span><br><span class="line">  <span class="built_in">bool</span> flag = <span class="keyword">true</span>;</span><br><span class="line">  <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;真&#x27;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;假&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="language-markdown"><span class="emphasis">/*</span>*</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 4、List（数组/集合）</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">   <span class="emphasis">*/</span></span></span></span><br><span class="line">  <span class="comment">// 第一种定义方式</span></span><br><span class="line">  <span class="keyword">var</span> list1 = [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>];</span><br><span class="line">  <span class="built_in">print</span>(list1);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 第二种定义方式</span></span><br><span class="line">  <span class="keyword">var</span> list2 = <span class="keyword">new</span> <span class="built_in">List</span>();</span><br><span class="line">  list2.add(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">  list2.add(<span class="string">&#x27;b&#x27;</span>);</span><br><span class="line">  list2.add(<span class="string">&#x27;c&#x27;</span>);</span><br><span class="line">  <span class="built_in">print</span>(list2);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 定义 List 时指定类型</span></span><br><span class="line">  <span class="keyword">var</span> list3 = <span class="keyword">new</span> <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt;();</span><br><span class="line">  <span class="comment">// list3.add(1); // 错误</span></span><br><span class="line">  list3.add(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">  <span class="built_in">print</span>(list3);</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="language-markdown"><span class="emphasis">/*</span>*</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 5、Maps（字典）</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">   <span class="emphasis">*/</span></span></span></span><br><span class="line">  <span class="comment">// 第一种定义方式</span></span><br><span class="line">  <span class="keyword">var</span> person1 = &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">    <span class="string">&quot;age&quot;</span>: <span class="number">20</span>,</span><br><span class="line">    <span class="string">&quot;work&quot;</span>: [<span class="string">&quot;程序员&quot;</span>, <span class="string">&quot;送外卖&quot;</span>]</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="built_in">print</span>(person1);</span><br><span class="line">  <span class="built_in">print</span>(person1[<span class="string">&quot;name&quot;</span>]);</span><br><span class="line">  <span class="built_in">print</span>(person1[<span class="string">&quot;work&quot;</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 第二种定义方式</span></span><br><span class="line">  <span class="keyword">var</span> person2 = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">  person2[<span class="string">&quot;name&quot;</span>] = <span class="string">&quot;李四&quot;</span>;</span><br><span class="line">  person2[<span class="string">&quot;age&quot;</span>] = <span class="number">21</span>;</span><br><span class="line">  person2[<span class="string">&quot;work&quot;</span>] = [<span class="string">&quot;程序员&quot;</span>, <span class="string">&quot;送外卖&quot;</span>];</span><br><span class="line">  <span class="built_in">print</span>(person2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 <code>is</code> 关键词来判断类型</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">main() &#123;</span><br><span class="line">  <span class="keyword">var</span> x = <span class="number">123</span>;</span><br><span class="line">  <span class="keyword">if</span> (x <span class="keyword">is</span> <span class="built_in">String</span>) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;是 String 类型&#x27;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (x <span class="keyword">is</span> <span class="built_in">int</span>) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;是 int 类型&#x27;</span>); <span class="comment">// 执行这里</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;是其他类型&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h3><p>Dart 运算符</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">算术运算符</span><br><span class="line"></span><br><span class="line">    +    -    *    /     ~/ (取整)     %（取余）</span><br><span class="line">    </span><br><span class="line">关系运算符</span><br><span class="line"></span><br><span class="line">    ==    ！=   &gt;    &lt;    &gt;=    &lt;=</span><br><span class="line"></span><br><span class="line">逻辑运算符</span><br><span class="line"></span><br><span class="line">    !  &amp;&amp;   ||</span><br><span class="line"></span><br><span class="line">赋值运算符</span><br><span class="line"></span><br><span class="line">    基础赋值运算符   =   ??=</span><br><span class="line">    复合赋值运算符   +=  -=  *=   /=   %=  ~/=</span><br></pre></td></tr></table></figure>

<p>基本使用：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">main() &#123;</span><br><span class="line">  <span class="comment"><span class="language-markdown">/**</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 1、算术运算符</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">   <span class="emphasis">*/</span></span></span></span><br><span class="line">  <span class="keyword">var</span> x = <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">var</span> y = <span class="number">3</span>;</span><br><span class="line">  <span class="built_in">print</span>(x / y); <span class="comment">// 3.3333333333333335</span></span><br><span class="line">  <span class="built_in">print</span>(x ~/ y); <span class="comment">// 3</span></span><br><span class="line">  <span class="built_in">print</span>(x % y); <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="language-markdown"><span class="emphasis">/*</span>*</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 2、关系运算符</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">   <span class="emphasis">*/</span></span></span></span><br><span class="line">  <span class="keyword">var</span> a = <span class="number">123</span>;</span><br><span class="line">  <span class="keyword">var</span> b = <span class="number">123</span>;</span><br><span class="line">  <span class="keyword">var</span> c = <span class="string">&quot;123&quot;</span>;</span><br><span class="line">  <span class="keyword">var</span> d = <span class="number">123.0</span>;</span><br><span class="line">  <span class="keyword">if</span> (a == b) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;a 等于 b&#x27;</span>); <span class="comment">// 执行</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (a == c) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;a 等于 c&#x27;</span>); <span class="comment">// 不执行</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (a == d) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;a 等于 d&#x27;</span>); <span class="comment">// 执行</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="language-markdown"><span class="emphasis">/*</span>*</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 3、逻辑运算符</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">   <span class="emphasis">*/</span></span></span></span><br><span class="line">  <span class="built_in">bool</span> flag = <span class="keyword">false</span>;</span><br><span class="line">  <span class="built_in">print</span>(!flag); <span class="comment">// true（取反）</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="language-markdown"><span class="emphasis">/*</span>*</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 4、基础赋值运算符（=   ??=）</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">   <span class="emphasis">*/</span></span></span></span><br><span class="line">  <span class="built_in">int</span> aa = <span class="number">10</span>;</span><br><span class="line">  <span class="built_in">int</span> bb;</span><br><span class="line">  aa ??= <span class="number">100</span>;</span><br><span class="line">  bb ??= <span class="number">200</span>; <span class="comment">// 因为 b 为空，所以重新赋值</span></span><br><span class="line">  <span class="built_in">print</span>(aa); <span class="comment">// 10</span></span><br><span class="line">  <span class="built_in">print</span>(bb); <span class="comment">// 200</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="language-markdown"><span class="emphasis">/*</span>*</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 5、复合赋值运算符   +=  -=  <span class="emphasis">*=   /=   %=  ~/=</span></span></span></span><br><span class="line"><span class="emphasis"><span class="language-markdown"><span class="comment">   *</span>/</span></span></span><br><span class="line">  <span class="built_in">int</span> xx = <span class="number">10</span>;</span><br><span class="line">  xx += <span class="number">10</span>;</span><br><span class="line">  <span class="built_in">print</span>(xx); <span class="comment">// 20</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="条件表达式"><a href="#条件表达式" class="headerlink" title="条件表达式"></a>条件表达式</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">main() &#123;</span><br><span class="line">  <span class="comment"><span class="language-markdown">/**</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 1、if else / switch case</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">   <span class="emphasis">*/</span></span></span></span><br><span class="line">  <span class="built_in">bool</span> flag = <span class="keyword">true</span>;</span><br><span class="line">  <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;true&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;false&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">String</span> sex = <span class="string">&quot;女&quot;</span>;</span><br><span class="line">  <span class="keyword">switch</span> (sex) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;男&quot;</span>:</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;男&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;女&quot;</span>:</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;女&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;不男不女&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="language-markdown"><span class="emphasis">/*</span>*</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 2、三目运算符</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">   <span class="emphasis">*/</span></span></span></span><br><span class="line">  <span class="built_in">String</span> s = flag ? <span class="string">&quot;我是 true&quot;</span> : <span class="string">&quot;我是 false&quot;</span>;</span><br><span class="line">  <span class="built_in">print</span>(s);</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="language-markdown"><span class="emphasis">/*</span>*</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 3、?? 运算符</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">   <span class="emphasis">*/</span></span></span></span><br><span class="line">  <span class="keyword">var</span> a = <span class="number">20</span>;</span><br><span class="line">  <span class="keyword">var</span> b = a ?? <span class="number">30</span>;</span><br><span class="line">  <span class="built_in">print</span>(b); <span class="comment">// 20</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="类型转换"><a href="#类型转换" class="headerlink" title="类型转换"></a>类型转换</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">main() &#123;</span><br><span class="line">  <span class="comment"><span class="language-markdown">/**</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 1、Number 与 String 类型之间的转换</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">   <span class="emphasis">*/</span></span></span></span><br><span class="line">  <span class="built_in">int</span> <span class="built_in">num</span> = <span class="number">20</span>;</span><br><span class="line">  <span class="built_in">double</span> d = <span class="number">30.0</span>;</span><br><span class="line">  <span class="built_in">String</span> str = <span class="string">&quot;50&quot;</span>;</span><br><span class="line">  <span class="built_in">print</span>(<span class="built_in">num</span>.toString()); <span class="comment">// 20</span></span><br><span class="line">  <span class="built_in">print</span>(d.toString()); <span class="comment">// 30.0</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="built_in">int</span>.parse(str)); <span class="comment">// 50</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="built_in">double</span>.parse(str)); <span class="comment">// 50.0</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="built_in">int</span>.tryParse(<span class="string">&quot;100a&quot;</span>)); <span class="comment">// null</span></span><br><span class="line">  <span class="comment">// print(int.parse(&quot;100a&quot;)); // 报错</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> myNum = <span class="built_in">double</span>.parse(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="built_in">print</span>(myNum);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="built_in">print</span>(err); <span class="comment">// FormatException: Invalid double</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="language-markdown"><span class="emphasis">/*</span>*</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 2、其他类型转换成 Booleans 类型</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">   <span class="emphasis">*/</span></span></span></span><br><span class="line">  <span class="keyword">var</span> myStr = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="keyword">if</span> (myStr.isEmpty) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;myStr 为空&#x27;</span>); <span class="comment">// 执行</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;myStr 不为空&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> myStr2;</span><br><span class="line">  <span class="keyword">if</span> (myStr2 == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;myStr2 为空&#x27;</span>); <span class="comment">// 执行</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;myStr2 不为空&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> x = <span class="number">0</span> / <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">print</span>(x); <span class="comment">// NaN</span></span><br><span class="line">  <span class="keyword">if</span> (x.isNaN) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;x is NaN&quot;</span>); <span class="comment">// 执行</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="循环语句"><a href="#循环语句" class="headerlink" title="循环语句"></a>循环语句</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">main() &#123;</span><br><span class="line">  <span class="comment"><span class="language-markdown">/**</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 1、++  --   表示自增 自减 1</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 在赋值运算里面，如果 ++ -- 写在前面，先运算后赋值，如果 ++ -- 写在后面，先赋值后运算</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">   <span class="emphasis">*/</span></span></span></span><br><span class="line">  <span class="keyword">var</span> a = <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">var</span> b = a--;</span><br><span class="line">  <span class="built_in">print</span>(a); <span class="comment">// 9</span></span><br><span class="line">  <span class="built_in">print</span>(b); <span class="comment">// 10</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> aa = <span class="number">100</span>;</span><br><span class="line">  <span class="keyword">var</span> bb = --aa;</span><br><span class="line">  <span class="built_in">print</span>(aa); <span class="comment">// 99</span></span><br><span class="line">  <span class="built_in">print</span>(bb); <span class="comment">// 99</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="language-markdown"><span class="emphasis">/*</span>*</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 2、for 语句</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">   <span class="emphasis">*/</span></span></span></span><br><span class="line">  <span class="keyword">var</span> list = [<span class="string">&#x27;新闻0&#x27;</span>, <span class="string">&#x27;新闻1&#x27;</span>, <span class="string">&#x27;新闻2&#x27;</span>, <span class="string">&#x27;新闻3&#x27;</span>, <span class="string">&#x27;新闻4&#x27;</span>];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; list.length; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">print</span>(list[i]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="language-markdown"><span class="emphasis">/*</span>*</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 3、while / do while</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">   <span class="emphasis">*/</span></span></span></span><br><span class="line">  <span class="keyword">var</span> i = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">var</span> sum = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (i &lt;= <span class="number">100</span>) &#123;</span><br><span class="line">    sum += i;</span><br><span class="line">    i++;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">print</span>(sum); <span class="comment">// 5050</span></span><br><span class="line"></span><br><span class="line">  i = <span class="number">1</span>;</span><br><span class="line">  sum = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    sum += i;</span><br><span class="line">    i++;</span><br><span class="line">  &#125; <span class="keyword">while</span> (i &lt;= <span class="number">100</span>);</span><br><span class="line">  <span class="built_in">print</span>(sum); <span class="comment">// 5050</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="language-markdown"><span class="emphasis">/*</span>*</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 4、break / continue</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">   <span class="emphasis">*/</span></span></span></span><br><span class="line">  sum = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i &gt; <span class="number">3</span>) &#123;</span><br><span class="line">      <span class="keyword">break</span>; <span class="comment">// 结束当前循环体</span></span><br><span class="line">    &#125;</span><br><span class="line">    sum += i;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">print</span>(sum); <span class="comment">// 1 + 2 + 3 = 6</span></span><br><span class="line"></span><br><span class="line">  sum = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">continue</span>; <span class="comment">// 本次循环跳过下面代码</span></span><br><span class="line">    &#125;</span><br><span class="line">    sum += i;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">print</span>(sum); <span class="comment">// 1 + 3 = 4</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="集合类型"><a href="#集合类型" class="headerlink" title="集合类型"></a>集合类型</h3><h4 id="List"><a href="#List" class="headerlink" title="List"></a>List</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">main() &#123;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    List 里面常用的属性和方法：</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    常用属性：</span></span><br><span class="line"><span class="comment">        length          长度</span></span><br><span class="line"><span class="comment">        reversed        翻转</span></span><br><span class="line"><span class="comment">        isEmpty         是否为空</span></span><br><span class="line"><span class="comment">        isNotEmpty      是否不为空</span></span><br><span class="line"><span class="comment">    常用方法：  </span></span><br><span class="line"><span class="comment">        add         增加</span></span><br><span class="line"><span class="comment">        addAll      拼接数组</span></span><br><span class="line"><span class="comment">        indexOf     查找  传入具体值</span></span><br><span class="line"><span class="comment">        remove      删除  传入具体值</span></span><br><span class="line"><span class="comment">        removeAt    删除  传入索引值</span></span><br><span class="line"><span class="comment">        fillRange   修改   </span></span><br><span class="line"><span class="comment">        insert(index,value);            指定位置插入    </span></span><br><span class="line"><span class="comment">        insertAll(index,list)           指定位置插入 List</span></span><br><span class="line"><span class="comment">        toList()    其他类型转换成 List</span></span><br><span class="line"><span class="comment">        join()      List 转换成字符串</span></span><br><span class="line"><span class="comment">        split()     字符串转化成 List</span></span><br><span class="line"><span class="comment">        forEach   </span></span><br><span class="line"><span class="comment">        map</span></span><br><span class="line"><span class="comment">        where</span></span><br><span class="line"><span class="comment">        any</span></span><br><span class="line"><span class="comment">        every</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="built_in">List</span> myList = [<span class="string">&#x27;AA&#x27;</span>, <span class="string">&#x27;BB&#x27;</span>, <span class="string">&#x27;CC&#x27;</span>];</span><br><span class="line">  myList.add(<span class="string">&#x27;DD&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> newList = myList.reversed.toList();</span><br><span class="line">  <span class="built_in">print</span>(newList); <span class="comment">// [DD, CC, BB, AA]</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// myList.fillRange(1, 3, &#x27;aaa&#x27;);</span></span><br><span class="line">  <span class="comment">// print(myList); // [AA, aaa, aaa, DD]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> str = myList.join(<span class="string">&#x27;-&#x27;</span>);</span><br><span class="line">  <span class="built_in">print</span>(str); <span class="comment">// AA-BB-CC-DD</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">main() &#123;</span><br><span class="line">  <span class="comment"><span class="language-markdown">/**</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> Set</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 1、用它最主要的功能就是去除数组重复内容；</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 2、Set 是没有顺序且不能重复的集合，所以不能通过索引去获取值；</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">   <span class="emphasis">*/</span></span></span></span><br><span class="line">  <span class="keyword">var</span> <span class="keyword">set</span> = <span class="keyword">new</span> <span class="built_in">Set</span>();</span><br><span class="line">  <span class="keyword">set</span>.add(<span class="string">&#x27;AA&#x27;</span>);</span><br><span class="line">  <span class="keyword">set</span>.add(<span class="string">&#x27;BB&#x27;</span>);</span><br><span class="line">  <span class="keyword">set</span>.add(<span class="string">&#x27;AA&#x27;</span>);</span><br><span class="line">  <span class="built_in">print</span>(<span class="keyword">set</span>); <span class="comment">// &#123;AA, BB&#125;</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="keyword">set</span>.toList()); <span class="comment">// [AA, BB]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> myList = [<span class="string">&#x27;AA&#x27;</span>, <span class="string">&#x27;BB&#x27;</span>, <span class="string">&#x27;AA&#x27;</span>, <span class="string">&#x27;CC&#x27;</span>, <span class="string">&#x27;AA&#x27;</span>, <span class="string">&#x27;BB&#x27;</span>];</span><br><span class="line">  <span class="keyword">var</span> mySet = <span class="keyword">new</span> <span class="built_in">Set</span>();</span><br><span class="line">  mySet.addAll(myList);</span><br><span class="line">  <span class="built_in">print</span>(mySet); <span class="comment">// &#123;AA, BB, CC&#125;</span></span><br><span class="line">  <span class="built_in">print</span>(mySet.toList()); <span class="comment">// [AA, BB, CC]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">main() &#123;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    映射（Maps）是无序的键值对：</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    常用属性：</span></span><br><span class="line"><span class="comment">        keys            获取所有的 key 值</span></span><br><span class="line"><span class="comment">        values          获取所有的 value 值</span></span><br><span class="line"><span class="comment">        isEmpty         是否为空</span></span><br><span class="line"><span class="comment">        isNotEmpty      是否不为空</span></span><br><span class="line"><span class="comment">    常用方法:</span></span><br><span class="line"><span class="comment">        remove(key)     删除指定 key 的数据</span></span><br><span class="line"><span class="comment">        addAll(&#123;...&#125;)   合并映射  给映射内增加属性</span></span><br><span class="line"><span class="comment">        containsValue   查看映射内的值  返回 true/false</span></span><br><span class="line"><span class="comment">        forEach   </span></span><br><span class="line"><span class="comment">        map</span></span><br><span class="line"><span class="comment">        where</span></span><br><span class="line"><span class="comment">        any</span></span><br><span class="line"><span class="comment">        every</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="built_in">Map</span> zhangSan = &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;张三&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">20</span>&#125;;</span><br><span class="line">  <span class="keyword">var</span> liSi = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">  liSi[<span class="string">&quot;name&quot;</span>] = <span class="string">&quot;李四&quot;</span>;</span><br><span class="line">  liSi[<span class="string">&quot;age&quot;</span>] = <span class="number">21</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span>(zhangSan.keys.toList()); <span class="comment">// [name, age]</span></span><br><span class="line">  <span class="built_in">print</span>(zhangSan.values.toList()); <span class="comment">// [张三, 20]</span></span><br><span class="line"></span><br><span class="line">  zhangSan.addAll(&#123;</span><br><span class="line">    <span class="string">&quot;sex&quot;</span>: <span class="string">&quot;男&quot;</span>,</span><br><span class="line">    <span class="string">&quot;work&quot;</span>: [<span class="string">&#x27;敲代码&#x27;</span>, <span class="string">&#x27;送外卖&#x27;</span>]</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="built_in">print</span>(zhangSan); <span class="comment">// &#123;name: 张三, age: 20, sex: 男, work: [敲代码, 送外卖]&#125;</span></span><br><span class="line"></span><br><span class="line">  zhangSan.remove(<span class="string">&quot;sex&quot;</span>);</span><br><span class="line">  <span class="built_in">print</span>(zhangSan); <span class="comment">// &#123;name: 张三, age: 20, work: [敲代码, 送外卖]&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="集合的-forEach、map、where、any、every-方法使用"><a href="#集合的-forEach、map、where、any、every-方法使用" class="headerlink" title="集合的 forEach、map、where、any、every 方法使用"></a>集合的 forEach、map、where、any、every 方法使用</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">main() &#123;</span><br><span class="line">  <span class="comment"><span class="language-markdown">/**</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> List</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">   <span class="emphasis">*/</span></span></span></span><br><span class="line">  <span class="keyword">var</span> list = [<span class="string">&#x27;AA&#x27;</span>, <span class="string">&#x27;BB&#x27;</span>, <span class="string">&#x27;CC&#x27;</span>];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; list.length; i++) &#123;</span><br><span class="line">    <span class="built_in">print</span>(list[i]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> item <span class="keyword">in</span> list) &#123;</span><br><span class="line">    <span class="built_in">print</span>(item);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  list.forEach((element) &#123;</span><br><span class="line">    <span class="built_in">print</span>(element);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> myList = [<span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>];</span><br><span class="line">  <span class="keyword">var</span> newList = myList.map((e) &#123;</span><br><span class="line">    <span class="keyword">return</span> e * <span class="number">2</span>;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="built_in">print</span>(newList.toList()); <span class="comment">// [2, 6, 8]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> newList2 = myList.where((element) &#123;</span><br><span class="line">    <span class="keyword">return</span> element &gt; <span class="number">1</span>;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="built_in">print</span>(newList2.toList()); <span class="comment">// [3, 4]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> f = myList.any((element) &#123;</span><br><span class="line">    <span class="comment">// 只要集合里面有满足条件的就返回 true</span></span><br><span class="line">    <span class="keyword">return</span> element &gt; <span class="number">3</span>;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="built_in">print</span>(f); <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> g = myList.every((element) &#123;</span><br><span class="line">    <span class="comment">// 每一个都满足条件返回 true, 否则返回 false</span></span><br><span class="line">    <span class="keyword">return</span> element &gt; <span class="number">1</span>;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="built_in">print</span>(g); <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="language-markdown"><span class="emphasis">/*</span>*</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> Set</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">   <span class="emphasis">*/</span></span></span></span><br><span class="line">  <span class="keyword">var</span> <span class="keyword">set</span> = <span class="keyword">new</span> <span class="built_in">Set</span>();</span><br><span class="line">  <span class="keyword">set</span>.addAll([<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>]);</span><br><span class="line">  <span class="keyword">set</span>.forEach((element) =&gt; <span class="built_in">print</span>(element));</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="language-markdown"><span class="emphasis">/*</span>*</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> Map</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">   <span class="emphasis">*/</span></span></span></span><br><span class="line">  <span class="keyword">var</span> zhangSan = &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;张三&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">20</span>&#125;;</span><br><span class="line">  zhangSan.forEach((key, value) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;<span class="subst">$key</span>---<span class="subst">$value</span>&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><h4 id="函数定义、作用域"><a href="#函数定义、作用域" class="headerlink" title="函数定义、作用域"></a>函数定义、作用域</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">main() &#123;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  内置方法/函数：</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      print();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  自定义方法：</span></span><br><span class="line"><span class="comment">      自定义方法的基本格式：</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      返回类型  方法名称（参数1，参数2,...）&#123;</span></span><br><span class="line"><span class="comment">        方法体</span></span><br><span class="line"><span class="comment">        return 返回值;</span></span><br><span class="line"><span class="comment">      &#125;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  printInfo(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line">  <span class="built_in">int</span> sum = getSum(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">  <span class="built_in">print</span>(sum);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 演示方法的作用域</span></span><br><span class="line">  <span class="keyword">void</span> exec() &#123;</span><br><span class="line">    <span class="keyword">void</span> sayHello() &#123;</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sayHello();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  exec(); <span class="comment">// 调用方法</span></span><br><span class="line">  <span class="comment">// sayHello(); // 错误写法</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> printInfo(<span class="built_in">String</span> info) &#123;</span><br><span class="line">  <span class="built_in">print</span>(info);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">int</span> getSum(<span class="built_in">int</span> a, <span class="built_in">int</span> b) &#123;</span><br><span class="line">  <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="函数传参、默认参数、可选参数、命名参数"><a href="#函数传参、默认参数、可选参数、命名参数" class="headerlink" title="函数传参、默认参数、可选参数、命名参数"></a>函数传参、默认参数、可选参数、命名参数</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">main() &#123;</span><br><span class="line">  <span class="comment"><span class="language-markdown">/**</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 1、基本传参</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">   <span class="emphasis">*/</span></span></span></span><br><span class="line">  <span class="keyword">var</span> sum = getSum(<span class="number">10</span>);</span><br><span class="line">  <span class="built_in">print</span>(sum); <span class="comment">// 55</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="language-markdown"><span class="emphasis">/*</span>*</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 2、可选参数</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">   <span class="emphasis">*/</span></span></span></span><br><span class="line">  printUserInfo(<span class="string">&quot;张三&quot;</span>, <span class="number">20</span>);</span><br><span class="line">  printUserInfo(<span class="string">&quot;李四&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="language-markdown"><span class="emphasis">/*</span>*</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 3、默认参数</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">   <span class="emphasis">*/</span></span></span></span><br><span class="line">  printUserInfo2(<span class="string">&quot;张三&quot;</span>, <span class="string">&quot;女&quot;</span>, <span class="number">20</span>);</span><br><span class="line">  printUserInfo2(<span class="string">&quot;李四&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="language-markdown"><span class="emphasis">/*</span>*</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 4、命名参数</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">   <span class="emphasis">*/</span></span></span></span><br><span class="line">  printUserInfo3(<span class="string">&quot;王五&quot;</span>, sex: <span class="string">&quot;未知&quot;</span>, age: <span class="number">22</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="language-markdown"><span class="emphasis">/*</span>*</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 5、把方法当参数的方法</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">   <span class="emphasis">*/</span></span></span></span><br><span class="line">  fun2(fun1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">int</span> getSum(<span class="built_in">int</span> n) &#123;</span><br><span class="line">  <span class="keyword">var</span> sum = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">    sum += i;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="language-markdown"><span class="emphasis">/*</span>*</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> 带可选参数</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"> <span class="emphasis">*/</span></span></span></span><br><span class="line"><span class="keyword">void</span> printUserInfo(<span class="built_in">String</span> name, [<span class="built_in">int</span> age]) &#123;</span><br><span class="line">  <span class="keyword">if</span> (age == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;姓名：<span class="subst">$name</span>---年龄保密&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;姓名：<span class="subst">$name</span>---年龄：<span class="subst">$age</span>&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="language-markdown"><span class="emphasis">/*</span>*</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> 带默认参数</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"> <span class="emphasis">*/</span></span></span></span><br><span class="line"><span class="keyword">void</span> printUserInfo2(<span class="built_in">String</span> name, [<span class="built_in">String</span> sex = <span class="string">&#x27;男&#x27;</span>, <span class="built_in">int</span> age]) &#123;</span><br><span class="line">  <span class="keyword">if</span> (age == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;姓名：<span class="subst">$name</span>---性别：<span class="subst">$sex</span>---年龄保密&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;姓名：<span class="subst">$name</span>---性别：<span class="subst">$sex</span>---年龄：<span class="subst">$age</span>&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="language-markdown"><span class="emphasis">/*</span>*</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> 带命名参数</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"> <span class="emphasis">*/</span></span></span></span><br><span class="line"><span class="keyword">void</span> printUserInfo3(<span class="built_in">String</span> name, &#123;<span class="built_in">String</span> sex = <span class="string">&#x27;男&#x27;</span>, <span class="built_in">int</span> age&#125;) &#123;</span><br><span class="line">  <span class="keyword">if</span> (age == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;姓名：<span class="subst">$name</span>---性别：<span class="subst">$sex</span>---年龄保密&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;姓名：<span class="subst">$name</span>---性别：<span class="subst">$sex</span>---年龄：<span class="subst">$age</span>&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fun1() &#123;</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;fun1&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fun2(fn) &#123;</span><br><span class="line">  fn();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="箭头函数、匿名函数、自执行方法、方法递归"><a href="#箭头函数、匿名函数、自执行方法、方法递归" class="headerlink" title="箭头函数、匿名函数、自执行方法、方法递归"></a>箭头函数、匿名函数、自执行方法、方法递归</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">main() &#123;</span><br><span class="line">  <span class="comment"><span class="language-markdown">/**</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 1、箭头函数</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 只能写一行，不能多行。</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">   <span class="emphasis">*/</span></span></span></span><br><span class="line">  <span class="built_in">List</span> myList = [<span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>];</span><br><span class="line">  myList.forEach((element) =&gt; <span class="built_in">print</span>(element));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> newList = myList.map((e) =&gt; e &gt; <span class="number">2</span> ? e * <span class="number">2</span> : e);</span><br><span class="line">  <span class="built_in">print</span>(newList.toList()); <span class="comment">// [1, 6, 8]</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="language-markdown"><span class="emphasis">/*</span>*</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 2、匿名函数</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">   <span class="emphasis">*/</span></span></span></span><br><span class="line">  <span class="keyword">var</span> myNum = () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="built_in">print</span>(myNum()); <span class="comment">// 10</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="language-markdown"><span class="emphasis">/*</span>*</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 3、自执行方法</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">   <span class="emphasis">*/</span></span></span></span><br><span class="line">  ((<span class="built_in">int</span> n) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;我是自执行方法&quot;</span>);</span><br><span class="line">    <span class="built_in">print</span>(n * <span class="number">10</span>); <span class="comment">// 180</span></span><br><span class="line">  &#125;)(<span class="number">18</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="language-markdown"><span class="emphasis">/*</span>*</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 4、方法递归</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">   <span class="emphasis">*/</span></span></span></span><br><span class="line">  <span class="keyword">var</span> sum = fn(<span class="number">100</span>);</span><br><span class="line">  <span class="built_in">print</span>(sum); <span class="comment">// 5050</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">int</span> fn(<span class="built_in">int</span> n) &#123;</span><br><span class="line">  <span class="keyword">if</span> (n == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> n + fn(n - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">main() &#123;</span><br><span class="line">  <span class="comment"><span class="language-markdown">/**</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 全局变量特点：全局变量常驻内存、全局变量污染全局；</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 局部变量的特点：不常驻内存会被垃圾机制回收、不会污染全局；</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> </span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">   * 闭包：</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 1、可以常驻内存，不污染全局；</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 2、函数嵌套函数，内部函数会调用外部函数的变量或参数，变量或参数不会被系统回收(不会释放内存)；</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet">   *</span> 3、写法：函数嵌套函数，并 return 里面的函数，这样就形成了闭包；</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">   <span class="emphasis">*/</span></span></span></span><br><span class="line">  <span class="keyword">var</span> f = fn();</span><br><span class="line">  f(); <span class="comment">// 2</span></span><br><span class="line">  f(); <span class="comment">// 3</span></span><br><span class="line">  f(); <span class="comment">// 4</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fn() &#123;</span><br><span class="line">  <span class="keyword">var</span> x = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> () &#123;</span><br><span class="line">    x++;</span><br><span class="line">    <span class="built_in">print</span>(x);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="类与对象"><a href="#类与对象" class="headerlink" title="类与对象"></a>类与对象</h3><h4 id="面向对象的介绍"><a href="#面向对象的介绍" class="headerlink" title="面向对象的介绍"></a>面向对象的介绍</h4><p>面向对象编程(OOP)的三个基本特征是：封装、继承、多态</p>
<ul>
<li><strong>封装</strong>：封装是对象和类概念的主要特性。封装，把客观事物封装成抽象的类，并且把自己的部分属性和方法提供给其他对象调用, 而一部分属性和方法则隐藏。</li>
<li><strong>继承</strong>：面向对象编程 (OOP) 语言的一个主要功能就是“继承”。继承是指这样一种能力：它可以使用现有类的功能，并在无需重新编写原来的类的情况下对这些功能进行扩展。</li>
<li><strong>多态</strong>：允许将子类类型的指针赋值给父类类型的指针, 同一个函数调用会有不同的执行效果 。</li>
</ul>
<p>Dart 所有的东西都是对象，所有的对象都继承自 Object 类。</p>
<p>Dart 是一门使用类和<strong>单继承</strong>的面向对象语言，所有的对象都是类的实例，并且所有的类都是 Object 的子类</p>
<p>一个类通常由属性和方法组成。</p>
<blockquote>
<p>Dart 和其他面向对象语言不一样，Dart 中没有 public、private、protected 这些访问修饰符，但是我们可以使用 <code>_</code> 把一个属性或者方法定义成私有。</p>
</blockquote>
<h4 id="类与对象的基本使用"><a href="#类与对象的基本使用" class="headerlink" title="类与对象的基本使用"></a>类与对象的基本使用</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  <span class="built_in">String</span> _name; <span class="comment">// 加了下划线表示私有属性</span></span><br><span class="line">  <span class="built_in">int</span> age;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 默认构造函数的简写</span></span><br><span class="line">  Person(<span class="keyword">this</span>._name, <span class="keyword">this</span>.age);</span><br><span class="line"></span><br><span class="line">  Person.now() &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;我是命名构造函数&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Person.setInfo(<span class="built_in">String</span> name, <span class="built_in">int</span> age) &#123;</span><br><span class="line">    <span class="keyword">this</span>._name = name;</span><br><span class="line">    <span class="keyword">this</span>.age = age;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> printInfo() &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;<span class="subst">$&#123;<span class="keyword">this</span>._name&#125;</span>---<span class="subst">$&#123;<span class="keyword">this</span>.age&#125;</span>&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> _sayHello() &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;_sayHello 是一个私有方法&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  execRun() &#123;</span><br><span class="line">    <span class="keyword">this</span>._sayHello();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rect</span> </span>&#123;</span><br><span class="line">  <span class="built_in">int</span> width;</span><br><span class="line">  <span class="built_in">int</span> height;</span><br><span class="line"></span><br><span class="line">  Rect(<span class="keyword">this</span>.width, <span class="keyword">this</span>.height);</span><br><span class="line"></span><br><span class="line">  getArea() &#123;</span><br><span class="line">    <span class="comment">// 通过方法获取面积</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.width * <span class="keyword">this</span>.height;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span> area &#123;</span><br><span class="line">    <span class="comment">// 通过属性获取面积</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.width * <span class="keyword">this</span>.height;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">set</span> areaHeight(height) &#123;</span><br><span class="line">    <span class="keyword">this</span>.height = height;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;Person.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;Rect.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line">main() &#123;</span><br><span class="line">  Person p = <span class="keyword">new</span> Person(<span class="string">&quot;张三&quot;</span>, <span class="number">20</span>);</span><br><span class="line">  p.printInfo();</span><br><span class="line">  p.execRun();</span><br><span class="line"></span><br><span class="line">  Person p2 = Person.now();</span><br><span class="line"></span><br><span class="line">  Person p3 = Person.setInfo(<span class="string">&quot;李四&quot;</span>, <span class="number">21</span>);</span><br><span class="line">  p3.printInfo();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> r = Rect(<span class="number">10</span>, <span class="number">5</span>);</span><br><span class="line">  <span class="built_in">print</span>(r.getArea()); <span class="comment">// 50</span></span><br><span class="line">  <span class="built_in">print</span>(r.area); <span class="comment">// 50</span></span><br><span class="line"></span><br><span class="line">  r.areaHeight = <span class="number">10</span>;</span><br><span class="line">  <span class="built_in">print</span>(r.area); <span class="comment">// 100</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="类中的初始化列表"><a href="#类中的初始化列表" class="headerlink" title="类中的初始化列表"></a>类中的初始化列表</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rect</span> </span>&#123;</span><br><span class="line">  <span class="built_in">int</span> width;</span><br><span class="line">  <span class="built_in">int</span> height;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 在构造函数体运行之前初始化实例变量</span></span><br><span class="line">  Rect()</span><br><span class="line">      : width = <span class="number">3</span>,</span><br><span class="line">        height = <span class="number">2</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;<span class="subst">$&#123;<span class="keyword">this</span>.width&#125;</span>---<span class="subst">$&#123;<span class="keyword">this</span>.height&#125;</span>&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span> area &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.width * <span class="keyword">this</span>.height;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;Rect.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line">main() &#123;</span><br><span class="line">  <span class="keyword">var</span> r = Rect();</span><br><span class="line">  <span class="built_in">print</span>(r.area); <span class="comment">// 6</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="类的静态变量与静态函数"><a href="#类的静态变量与静态函数" class="headerlink" title="类的静态变量与静态函数"></a>类的静态变量与静态函数</h4><p>Dart 中的静态成员:</p>
<p>1、使用 static 关键字来实现类级别的变量和函数；</p>
<p>2、静态方法不能访问非静态成员，非静态方法可以访问静态成员；</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="built_in">String</span> name = <span class="string">&#x27;张三&#x27;</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">void</span> showName() &#123;</span><br><span class="line">    <span class="built_in">print</span>(name);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;Person.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line">main() &#123;</span><br><span class="line">  <span class="built_in">print</span>(Person.name);</span><br><span class="line">  Person.showName();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="对象操作符"><a href="#对象操作符" class="headerlink" title="对象操作符"></a>对象操作符</h4><p>Dart 中的对象操作符：</p>
<ul>
<li><code>?</code> 条件运算符</li>
<li><code>as</code> 类型转换</li>
<li><code>is</code> 类型判断</li>
<li><code>..</code> 级联操作（连缀）</li>
</ul>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  <span class="built_in">String</span> name;</span><br><span class="line">  <span class="built_in">num</span> age;</span><br><span class="line">  Person(<span class="keyword">this</span>.name, <span class="keyword">this</span>.age);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> printInfo() &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;<span class="subst">$&#123;<span class="keyword">this</span>.name&#125;</span>---<span class="subst">$&#123;<span class="keyword">this</span>.age&#125;</span>&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;Person.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line">main() &#123;</span><br><span class="line">  Person p = Person(<span class="string">&quot;张三&quot;</span>, <span class="number">20</span>);</span><br><span class="line">  p?.printInfo(); <span class="comment">// 张三---20</span></span><br><span class="line"></span><br><span class="line">  Person p2;</span><br><span class="line">  p2?.printInfo(); <span class="comment">// 无打印结果</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (p <span class="keyword">is</span> Person) &#123;</span><br><span class="line">    p.name = <span class="string">&#x27;李四&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  p.printInfo(); <span class="comment">// 李四---20</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span>(p <span class="keyword">is</span> <span class="built_in">Object</span>); <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> p3;</span><br><span class="line">  p3 = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  p3 = <span class="keyword">new</span> Person(<span class="string">&quot;王五&quot;</span>, <span class="number">22</span>);</span><br><span class="line">  p3.printInfo(); <span class="comment">// 王五---22</span></span><br><span class="line">  (p3 <span class="keyword">as</span> Person).printInfo(); <span class="comment">// 王五---22</span></span><br><span class="line"></span><br><span class="line">  Person p4 = <span class="keyword">new</span> Person(<span class="string">&quot;AA&quot;</span>, <span class="number">10</span>);</span><br><span class="line">  p4.printInfo(); <span class="comment">// AA---10</span></span><br><span class="line"></span><br><span class="line">  p4</span><br><span class="line">    ..name = <span class="string">&quot;BB&quot;</span></span><br><span class="line">    ..age = <span class="number">11</span></span><br><span class="line">    ..printInfo(); <span class="comment">// BB---11</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="类的继承"><a href="#类的继承" class="headerlink" title="类的继承"></a>类的继承</h4><blockquote>
<p>面向对象的三大特性：封装 、继承、多态</p>
</blockquote>
<p>Dart 中的类的继承：  </p>
<ul>
<li>子类使用 extends 关键词来继承父类；</li>
<li>子类会继承父类里面可见的属性和方法，但是不会继承构造函数；</li>
<li>子类能复写父类的方法；</li>
</ul>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  <span class="built_in">String</span> name;</span><br><span class="line">  <span class="built_in">num</span> age;</span><br><span class="line">  Person(<span class="keyword">this</span>.name, <span class="keyword">this</span>.age);</span><br><span class="line">  Person.xxx(<span class="keyword">this</span>.name, <span class="keyword">this</span>.age);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> printInfo() &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;<span class="subst">$&#123;<span class="keyword">this</span>.name&#125;</span>---<span class="subst">$&#123;<span class="keyword">this</span>.age&#125;</span>&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;Person.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Teacher</span> <span class="keyword">extends</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  <span class="built_in">String</span> sex;</span><br><span class="line">  Teacher(<span class="built_in">String</span> name, <span class="built_in">num</span> age, <span class="built_in">String</span> sex) : <span class="keyword">super</span>(name, age) &#123;</span><br><span class="line">    <span class="keyword">this</span>.sex = sex;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Teacher(String name, num age, String sex) : super.xxx(name, age) &#123;</span></span><br><span class="line">  <span class="comment">//   this.sex = sex;</span></span><br><span class="line">  <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> printInfo() &#123;</span><br><span class="line">    <span class="comment">// super.printInfo(); //自类调用父类的方法</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;<span class="subst">$&#123;<span class="keyword">this</span>.name&#125;</span>---<span class="subst">$&#123;<span class="keyword">this</span>.age&#125;</span>---<span class="subst">$&#123;<span class="keyword">this</span>.sex&#125;</span>&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  run() &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;<span class="subst">$&#123;<span class="keyword">this</span>.name&#125;</span>***<span class="subst">$&#123;<span class="keyword">this</span>.age&#125;</span>***<span class="subst">$&#123;<span class="keyword">this</span>.sex&#125;</span>&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;Teacher.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line">main() &#123;</span><br><span class="line">  Teacher t = <span class="keyword">new</span> Teacher(<span class="string">&#x27;张三&#x27;</span>, <span class="number">20</span>, <span class="string">&#x27;男&#x27;</span>);</span><br><span class="line">  t.printInfo(); <span class="comment">// 张三---20---男</span></span><br><span class="line">  t.run(); <span class="comment">// 张三***20***男</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="抽象类"><a href="#抽象类" class="headerlink" title="抽象类"></a>抽象类</h4><p>Dart 抽象类主要用于定义标准，子类可以继承抽象类，也可以实现抽象类接口。</p>
<ul>
<li>抽象类通过 abstract 关键字来定义；</li>
<li>抽象方法不能用 abstract 声明，Dart 中没有方法体的方法我们称为抽象方法；</li>
<li>如果子类继承抽象类必须得实现里面的抽象方法；</li>
<li>如果把抽象类当做接口实现的话，必须得实现抽象类里面定义的所有属性和方法；</li>
<li>抽象类不能被实例化，只有继承它的子类可以；</li>
</ul>
<p><strong>extends 抽象类和 implements 的区别：</strong></p>
<ul>
<li>如果要复用抽象类里面的方法，并且要用抽象方法约束自类的话，我们就用 extends 继承抽象类；</li>
<li>如果只是把抽象类当做标准的话，我们就用 implements 实现抽象类；</li>
</ul>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Animal</span> </span>&#123;</span><br><span class="line">  eat(); <span class="comment">// 抽象方法</span></span><br><span class="line">  run(); <span class="comment">// 抽象方法</span></span><br><span class="line"></span><br><span class="line">  printInfo() &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;我是一个抽象类里面的普通方法&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;Animal.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span> <span class="keyword">extends</span> <span class="title">Animal</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  eat() &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Dog eat ...&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  run() &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Dog run ...&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;Animal.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span> <span class="keyword">extends</span> <span class="title">Animal</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  eat() &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Cat eat ...&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  run() &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Cat run ...&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;Cat.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;Dog.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line">main() &#123;</span><br><span class="line">  Dog d = <span class="keyword">new</span> Dog();</span><br><span class="line">  d.eat(); <span class="comment">// Dog eat ...</span></span><br><span class="line">  d.printInfo(); <span class="comment">// 我是一个抽象类里面的普通方法</span></span><br><span class="line"></span><br><span class="line">  Cat c = <span class="keyword">new</span> Cat();</span><br><span class="line">  c.eat(); <span class="comment">// Cat eat ...</span></span><br><span class="line">  c.printInfo(); <span class="comment">// 我是一个抽象类里面的普通方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="多态"><a href="#多态" class="headerlink" title="多态"></a>多态</h4><ul>
<li>允许将子类类型的指针赋值给父类类型的指针，同一个函数调用会有不同的执行效果；</li>
<li>子类的实例赋值给父类的引用；</li>
<li>多态就是父类定义一个方法不去实现，让继承他的子类去实现，每个子类有不同的表现；</li>
</ul>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;Animal.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;Cat.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;Dog.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line">main() &#123;</span><br><span class="line">  Animal d = <span class="keyword">new</span> Dog();</span><br><span class="line">  d.eat(); <span class="comment">// Dog eat ...</span></span><br><span class="line"></span><br><span class="line">  Animal c = <span class="keyword">new</span> Cat();</span><br><span class="line">  c.eat(); <span class="comment">// Cat eat ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h3><p>和 Java 一样，Dart 也有接口，但是和 Java 还是有区别的：</p>
<ul>
<li>Dart 的接口没有 interface 关键字定义接口，而是普通类或抽象类都可以作为接口被实现；</li>
<li>同样使用 implements 关键字进行实现；</li>
<li>Dart 的接口有点奇怪，如果实现的类是普通类，需要将普通类中抽象的属性和方法全部覆写一遍；</li>
<li>因为抽象类可以定义抽象方法，普通类不可以，所以一般如果要实现像 Java 接口那样的方式，一般会使用抽象类；</li>
<li>建议使用抽象类定义接口；</li>
</ul>
<blockquote>
<p>一个类可以实现多个接口。</p>
</blockquote>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">DB</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 当做接口   接口：就是约定 、规范</span></span><br><span class="line">  <span class="built_in">String</span> uri;</span><br><span class="line">  insert(<span class="built_in">String</span> data);</span><br><span class="line">  delete(<span class="built_in">String</span> id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;DB.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySQL</span> <span class="keyword">implements</span> <span class="title">DB</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">String</span> uri;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  insert(<span class="built_in">String</span> data) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;MySQL insert&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  delete(<span class="built_in">String</span> id) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;MySQL delete&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;DB.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MsSQL</span> <span class="keyword">implements</span> <span class="title">DB</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">String</span> uri;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  insert(<span class="built_in">String</span> data) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;MsSQL insert&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  delete(<span class="built_in">String</span> id) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;MsSQL delete&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;DB.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;MySQL.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line">main() &#123;</span><br><span class="line">  DB db = <span class="keyword">new</span> MySQL();</span><br><span class="line">  db.insert(<span class="string">&#x27;123456&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="mixins"><a href="#mixins" class="headerlink" title="mixins"></a>mixins</h3><p>mixins 的中文意思是混入，就是在类中混入其他功能。</p>
<p>在 Dart 中可以使用 mixins 实现类似<strong>多继承</strong>的功能。</p>
<p>因为 mixins 使用的条件，随着 Dart 版本一直在变，这里讲的是 Dart 2.x 中使 用 mixins 的条件：</p>
<ul>
<li>作为 mixins 的类只能继承自 Object, 不能继承其他类；</li>
<li>作为 mixins 的类不能有构造函数；</li>
<li>一个类可以 mixins 多个 mixins 类；</li>
<li>mixins 绝不是继承，也不是接口，而是一种全新的特性；</li>
</ul>
<p>mixins 的实例类型就是其超类的子类型。mixins 使用 <code>with</code> 关键字实现其功能。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">  <span class="built_in">String</span> info = <span class="string">&quot;this is A&quot;</span>;</span><br><span class="line">  printA() &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">  printB() &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;B&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;A.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;B.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;Person.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> <span class="keyword">extends</span> <span class="title">Person</span> <span class="title">with</span> <span class="title">A</span>, <span class="title">B</span> </span>&#123;</span><br><span class="line">  C(<span class="built_in">String</span> name, <span class="built_in">num</span> age) : <span class="keyword">super</span>(name, age);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;A.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;B.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;C.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line">main() &#123;</span><br><span class="line">  <span class="keyword">var</span> c = <span class="keyword">new</span> C(<span class="string">&quot;张三&quot;</span>, <span class="number">20</span>);</span><br><span class="line">  c.printA(); <span class="comment">// A</span></span><br><span class="line">  c.printB(); <span class="comment">// B</span></span><br><span class="line">  <span class="built_in">print</span>(c.info); <span class="comment">// this is A</span></span><br><span class="line">  c.printInfo(); <span class="comment">// 张三---20</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span>(c <span class="keyword">is</span> C); <span class="comment">// true</span></span><br><span class="line">  <span class="built_in">print</span>(c <span class="keyword">is</span> A); <span class="comment">// true</span></span><br><span class="line">  <span class="built_in">print</span>(c <span class="keyword">is</span> B); <span class="comment">// true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="泛型"><a href="#泛型" class="headerlink" title="泛型"></a>泛型</h3><p>通俗理解：泛型就是解决类、接口、方法的复用性、以及对不特定数据类型的支持（类型校验）。</p>
<h4 id="泛型方法"><a href="#泛型方法" class="headerlink" title="泛型方法"></a>泛型方法</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">main() &#123;</span><br><span class="line">  <span class="built_in">print</span>(getData(<span class="number">1</span>)); <span class="comment">// A</span></span><br><span class="line">  <span class="built_in">print</span>(getData2(<span class="number">2</span>)); <span class="comment">// 2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">getData&lt;T&gt;(T value) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;A&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">T getData2&lt;T&gt;(T value) &#123;</span><br><span class="line">  <span class="comment">// return &quot;A&quot;; // 错误，只能返回 T 类型</span></span><br><span class="line">  <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="泛型类"><a href="#泛型类" class="headerlink" title="泛型类"></a>泛型类</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">main() &#123;</span><br><span class="line">  PrintClass p = <span class="keyword">new</span> PrintClass&lt;<span class="built_in">int</span>&gt;();</span><br><span class="line">  p.add(<span class="number">1</span>);</span><br><span class="line">  p.add(<span class="number">2</span>);</span><br><span class="line">  p.add(<span class="number">3</span>);</span><br><span class="line">  <span class="comment">// p.add(&quot;A&quot;); // 报错</span></span><br><span class="line">  p.printInfo();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PrintClass</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="built_in">List</span> list = <span class="keyword">new</span> <span class="built_in">List</span>&lt;T&gt;();</span><br><span class="line">  <span class="keyword">void</span> add(T value) &#123;</span><br><span class="line">    <span class="keyword">this</span>.list.add(value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> printInfo() &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.list.length; i++) &#123;</span><br><span class="line">      <span class="built_in">print</span>(<span class="keyword">this</span>.list[i]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="泛型接口"><a href="#泛型接口" class="headerlink" title="泛型接口"></a>泛型接口</h3><p>需求：实现数据缓存的功能。有文件缓存和内存缓存，内存缓存和文件缓存按照接口约束实现。</p>
<ol>
<li>定义一个泛型接口，约束实现它的子类必须有 getByKey(key) 和 setByKey(key,value)；</li>
<li>要求 setByKey 的时候的 value 的类型和实例化子类的时候指定的类型一致；</li>
</ol>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">main() &#123;</span><br><span class="line">  MemoryCache m = MemoryCache&lt;<span class="built_in">Map</span>&gt;();</span><br><span class="line">  m.setByKey(<span class="string">&quot;index&quot;</span>, &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;张三&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">20</span>&#125;); <span class="comment">// 我是内存缓存，把 key = index  value = &#123;name: 张三, age: 20&#125; 写入到了内存中</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Cache</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  getByKey(<span class="built_in">String</span> key);</span><br><span class="line">  <span class="keyword">void</span> setByKey(<span class="built_in">String</span> key, T value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MemoryCache</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Cache</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  getByKey(<span class="built_in">String</span> key) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> setByKey(<span class="built_in">String</span> key, T value) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;我是内存缓存，把 key = <span class="subst">$&#123;key&#125;</span>  value = <span class="subst">$&#123;value&#125;</span> 写入到了内存中&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileCache</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Cache</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  getByKey(<span class="built_in">String</span> key) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> setByKey(<span class="built_in">String</span> key, T value) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;我是文件缓存，把 key = <span class="subst">$&#123;key&#125;</span>  value = <span class="subst">$&#123;value&#125;</span> 写入到了文件中&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="库"><a href="#库" class="headerlink" title="库"></a>库</h3><p>在 Dart 中，库的使用是通过 <code>import</code> 关键字引入的。library 指令可以创建一个库，每个 Dart 文件都是一个库，即使没有使用 library 指令来指定。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Dart 中的库主要有三种：</span><br><span class="line"></span><br><span class="line">    <span class="number">1</span>、我们自定义的库     </span><br><span class="line">          <span class="keyword">import</span> <span class="string">&#x27;lib/xxx.dart&#x27;</span>;</span><br><span class="line">    <span class="number">2</span>、系统内置库       </span><br><span class="line">          <span class="keyword">import</span> <span class="string">&#x27;dart:math&#x27;</span>;    </span><br><span class="line">          <span class="keyword">import</span> <span class="string">&#x27;dart:io&#x27;</span>; </span><br><span class="line">          <span class="keyword">import</span> <span class="string">&#x27;dart:convert&#x27;</span>;</span><br><span class="line">    <span class="number">3</span>、pub 包管理系统中的库  </span><br><span class="line">        https:<span class="comment">//pub.dev/packages</span></span><br><span class="line">        https:<span class="comment">//pub.flutter-io.cn/packages</span></span><br><span class="line">        https:<span class="comment">//pub.dartlang.org/flutter/</span></span><br><span class="line"></span><br><span class="line">        <span class="number">1</span>、需要在自己项目根目录新建一个 pubspec.yaml</span><br><span class="line">        <span class="number">2</span>、在 pubspec.yaml 文件配置名称、描述、依赖等信息</span><br><span class="line">        <span class="number">3</span>、然后运行 pub <span class="keyword">get</span> 获取包下载到本地  </span><br><span class="line">        <span class="number">4</span>、项目中引入库 <span class="keyword">import</span> <span class="string">&#x27;package:http/http.dart&#x27;</span> <span class="keyword">as</span> http; 看文档使用</span><br></pre></td></tr></table></figure>

<h4 id="导入自己本地库"><a href="#导入自己本地库" class="headerlink" title="导入自己本地库"></a>导入自己本地库</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;Person.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line">main() &#123;</span><br><span class="line">  <span class="keyword">var</span> p = <span class="keyword">new</span> Person(<span class="string">&quot;张三&quot;</span>, <span class="number">20</span>);</span><br><span class="line">  p.printInfo(); <span class="comment">// 张三---20</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="导入系统内置库"><a href="#导入系统内置库" class="headerlink" title="导入系统内置库"></a>导入系统内置库</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;dart:math&#x27;</span>;</span><br><span class="line"></span><br><span class="line">main() &#123;</span><br><span class="line">  <span class="built_in">print</span>(max(<span class="number">10</span>, <span class="number">20</span>)); <span class="comment">// 20</span></span><br><span class="line">  <span class="built_in">print</span>(min(<span class="number">-1</span>, <span class="number">-2</span>)); <span class="comment">// -2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="导入系统内置库实现请求数据"><a href="#导入系统内置库实现请求数据" class="headerlink" title="导入系统内置库实现请求数据"></a>导入系统内置库实现请求数据</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;dart:convert&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;dart:io&#x27;</span>;</span><br><span class="line"></span><br><span class="line">main() <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="keyword">var</span> result = <span class="keyword">await</span> getDataFromZhihuAPI();</span><br><span class="line">  <span class="built_in">print</span>(result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// api 接口： http://news-at.zhihu.com/api/3/stories/latest</span></span><br><span class="line">getDataFromZhihuAPI() <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="comment">// 1、创建 HttpClient 对象</span></span><br><span class="line">  <span class="keyword">var</span> httpClient = <span class="keyword">new</span> HttpClient();</span><br><span class="line">  <span class="comment">// 2、创建 Uri 对象</span></span><br><span class="line">  <span class="keyword">var</span> uri = <span class="keyword">new</span> <span class="built_in">Uri</span>.http(<span class="string">&#x27;news-at.zhihu.com&#x27;</span>, <span class="string">&#x27;/api/3/stories/latest&#x27;</span>);</span><br><span class="line">  <span class="comment">// 3、发起请求，等待请求</span></span><br><span class="line">  <span class="keyword">var</span> request = <span class="keyword">await</span> httpClient.getUrl(uri);</span><br><span class="line">  <span class="comment">// 4、关闭请求，等待响应</span></span><br><span class="line">  <span class="keyword">var</span> response = <span class="keyword">await</span> request.close();</span><br><span class="line">  <span class="comment">// 5、解码响应的内容</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> response.transform(utf8.decoder).join();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="async-和-await"><a href="#async-和-await" class="headerlink" title="async 和 await"></a>async 和 await</h4><p>这两个关键字的使用只需要记住两点：①、只有 async 方法才能使用 await 关键字调用方法；②、如果调用别的 async 方法必须使用 await 关键字；</p>
<p>async 是让方法变成异步，await 是等待异步方法执行完成。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">main() <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="keyword">var</span> result = <span class="keyword">await</span> testAsync();</span><br><span class="line">  <span class="built_in">print</span>(result); <span class="comment">// testAsync</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">testAsync() <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;testAsync&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="导入-pub-包管理系统中的库"><a href="#导入-pub-包管理系统中的库" class="headerlink" title="导入 pub 包管理系统中的库"></a>导入 pub 包管理系统中的库</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pub 包管理系统：</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>、从下面网址找到要用的库</span><br><span class="line">        https:<span class="comment">//pub.dev/packages</span></span><br><span class="line">        https:<span class="comment">//pub.flutter-io.cn/packages</span></span><br><span class="line">        https:<span class="comment">//pub.dartlang.org/flutter/</span></span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、创建一个 pubspec.yaml 文件，内容如下</span><br><span class="line"></span><br><span class="line">    name: xxx</span><br><span class="line">    description: A <span class="keyword">new</span> flutter module project.</span><br><span class="line">    dependencies:  </span><br><span class="line">      date_format: ^<span class="number">1.0</span><span class="number">.9</span></span><br><span class="line"></span><br><span class="line"><span class="number">3</span>、配置 dependencies</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>、运行 pub <span class="keyword">get</span> 获取远程库</span><br><span class="line"></span><br><span class="line"><span class="number">5</span>、看文档引入库使用</span><br></pre></td></tr></table></figure>

<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:date_format/date_format.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line">main() &#123;</span><br><span class="line">  <span class="built_in">print</span>(formatDate(<span class="built_in">DateTime</span>(<span class="number">1989</span>, <span class="number">02</span>, <span class="number">21</span>), [yyyy, <span class="string">&#x27;-&#x27;</span>, mm, <span class="string">&#x27;-&#x27;</span>, dd])); <span class="comment">// 1989-02-21</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="库重命名与冲突解决"><a href="#库重命名与冲突解决" class="headerlink" title="库重命名与冲突解决"></a>库重命名与冲突解决</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">当引入两个库中有相同名称标识符的时候，如果是 Java, 通常我们通过写上完整的包名路径来指定使用的具体标识符，甚至不用 <span class="keyword">import</span> 都可以，</span><br><span class="line">但是 Dart 里面是必须 <span class="keyword">import</span> 的。当冲突的时候，可以使用 <span class="keyword">as</span> 关键字来指定库的前缀。如下例子所示：</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:lib1/lib1.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:lib2/lib2.dart&#x27;</span> <span class="keyword">as</span> lib2;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">Element</span> element1 = <span class="keyword">new</span> <span class="built_in">Element</span>();           <span class="comment">// Uses Element from lib1.</span></span><br><span class="line">lib2.<span class="built_in">Element</span> element2 = <span class="keyword">new</span> lib2.<span class="built_in">Element</span>(); <span class="comment">// Uses Element from lib2.</span></span><br></pre></td></tr></table></figure>

<h4 id="部分导入"><a href="#部分导入" class="headerlink" title="部分导入"></a>部分导入</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">如果只需要导入库的一部分，有两种模式：</span><br><span class="line"></span><br><span class="line">模式一：只导入需要的部分，使用 <span class="keyword">show</span> 关键字，如下例子所示：</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:lib1/lib1.dart&#x27;</span> <span class="keyword">show</span> foo;</span><br><span class="line"></span><br><span class="line">模式二：隐藏不需要的部分，使用 <span class="keyword">hide</span> 关键字，如下例子所示：</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:lib2/lib2.dart&#x27;</span> <span class="keyword">hide</span> foo;    </span><br></pre></td></tr></table></figure>

<p>MyMath.dart</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">getOne() &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;one&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">getTwo() &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;two&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;MyMath.dart&#x27;</span> <span class="keyword">show</span> getOne;</span><br><span class="line"></span><br><span class="line">main() &#123;</span><br><span class="line">  <span class="built_in">print</span>(getOne());</span><br><span class="line">  <span class="comment">// print(getTwo()); // 报错</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="延迟加载"><a href="#延迟加载" class="headerlink" title="延迟加载"></a>延迟加载</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">延迟加载也称为懒加载，可以在需要的时候再进行加载。</span><br><span class="line">懒加载的最大好处是可以减少 APP 的启动时间。</span><br><span class="line"></span><br><span class="line">懒加载使用 <span class="keyword">deferred</span> <span class="keyword">as</span> 关键字来指定，如下例子所示：</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:deferred/hello.dart&#x27;</span> <span class="keyword">deferred</span> <span class="keyword">as</span> hello;</span><br><span class="line"></span><br><span class="line">当需要使用的时候，需要使用 loadLibrary() 方法来加载：</span><br><span class="line"></span><br><span class="line">greet() <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> hello.loadLibrary();</span><br><span class="line">    hello.printGreeting();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-13-之后的一些新特性"><a href="#2-13-之后的一些新特性" class="headerlink" title="2.13 之后的一些新特性"></a>2.13 之后的一些新特性</h3><h4 id="Null-safety"><a href="#Null-safety" class="headerlink" title="Null safety"></a>Null safety</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="language-markdown">/**</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">  Null safety 翻译成中文的意思是空安全。</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"></span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">  null safety 可以帮助开发者避免一些日常开发中很难被发现的错误，并且额外的好处是可以改善性能。</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"></span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">  Flutter2.2.0（2021 年 5 月 19 日发布）之后的版本都要求使用 null safety。</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"></span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">  1、? 可空类型</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">  2、! 类型断言</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="emphasis">*/</span></span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">String?</span> getData(apiUrl) &#123;</span><br><span class="line">  <span class="keyword">if</span> (apiUrl != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;this is server data&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> printLength(<span class="built_in">String?</span> str) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(str!.length);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;str is null&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  <span class="comment">// 1、? 可空类型</span></span><br><span class="line">  <span class="built_in">String?</span> str = <span class="string">&quot;abc&quot;</span>; <span class="comment">// String?  表示 str 是一个可空类型</span></span><br><span class="line">  str = <span class="keyword">null</span>; <span class="comment">// 允许设置为 null</span></span><br><span class="line">  <span class="built_in">print</span>(str);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span>(getData(<span class="string">&quot;http://www.baidu.com&quot;</span>));</span><br><span class="line">  <span class="built_in">print</span>(getData(<span class="keyword">null</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2、! 类型断言</span></span><br><span class="line">  <span class="built_in">String?</span> str2 = <span class="string">&quot;this is str&quot;</span>;</span><br><span class="line">  <span class="comment">// str2 = null;</span></span><br><span class="line">  <span class="comment">// 如果 str2 不等于 null 会打印 str2 的长度，如果等于 null 会抛出异常</span></span><br><span class="line">  <span class="built_in">print</span>(str2!.length);</span><br><span class="line"></span><br><span class="line">  printLength(<span class="string">&quot;str&quot;</span>);</span><br><span class="line">  printLength(<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="late-关键字"><a href="#late-关键字" class="headerlink" title="late 关键字"></a>late 关键字</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="language-markdown">/**</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> late 关键字主要用于延迟初始化。</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"> <span class="emphasis">*/</span></span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  <span class="keyword">late</span> <span class="built_in">String</span> name;</span><br><span class="line">  <span class="keyword">late</span> <span class="built_in">int</span> age;</span><br><span class="line">  <span class="keyword">void</span> setInfo(<span class="built_in">String</span> name, <span class="built_in">int</span> age) &#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">    <span class="keyword">this</span>.age = age;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">String</span> getInfo() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;<span class="subst">$&#123;<span class="keyword">this</span>.name&#125;</span>---<span class="subst">$&#123;<span class="keyword">this</span>.age&#125;</span>&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> main(args) &#123;</span><br><span class="line">  Person p = <span class="keyword">new</span> Person();</span><br><span class="line">  p.setInfo(<span class="string">&quot;张三&quot;</span>, <span class="number">20</span>);</span><br><span class="line">  <span class="built_in">print</span>(p.getInfo());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="required-关键字"><a href="#required-关键字" class="headerlink" title="required 关键字"></a>required 关键字</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="language-markdown">/**</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> required 翻译成中文的意思是需要、依赖</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> </span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"> * 最开始 @required 是注解，现在它已经作为内置修饰符，主要用于允许根据需要标记任何命名参数（函数或类），</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> 使得它们不为空。因为可选参数中必须有个 required 参数或者该参数有个默认值。</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"> <span class="emphasis">*/</span></span></span></span><br><span class="line"><span class="built_in">String</span> printInfo(<span class="built_in">String</span> username, &#123;<span class="built_in">int</span> age = <span class="number">10</span>, <span class="built_in">String</span> sex = <span class="string">&quot;男&quot;</span>&#125;) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;姓名:<span class="subst">$username</span>---性别:<span class="subst">$sex</span>--年龄:<span class="subst">$age</span>&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">String</span> printInfo2(<span class="built_in">String</span> username, &#123;<span class="keyword">required</span> <span class="built_in">int</span> age, <span class="keyword">required</span> <span class="built_in">String</span> sex&#125;) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;姓名:<span class="subst">$username</span>---性别:<span class="subst">$sex</span>--年龄:<span class="subst">$age</span>&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> main(args) &#123;</span><br><span class="line">  <span class="built_in">print</span>(printInfo(<span class="string">&#x27;张三&#x27;</span>));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span>(printInfo(<span class="string">&#x27;张三&#x27;</span>, age: <span class="number">20</span>, sex: <span class="string">&quot;女&quot;</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// age 和 sex 必须传入</span></span><br><span class="line">  <span class="built_in">print</span>(printInfo2(<span class="string">&#x27;张三&#x27;</span>, age: <span class="number">22</span>, sex: <span class="string">&quot;女&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="language-markdown">/**</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> name 可以传入也可以不传入，age 必须传入</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"> <span class="emphasis">*/</span></span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  <span class="built_in">String?</span> name; <span class="comment">// 可空属性</span></span><br><span class="line">  <span class="built_in">int</span> age;</span><br><span class="line">  Person(&#123;<span class="keyword">this</span>.name, <span class="keyword">required</span> <span class="keyword">this</span>.age&#125;); <span class="comment">// age 必须传入</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">String</span> getInfo() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;<span class="subst">$&#123;<span class="keyword">this</span>.name&#125;</span>---<span class="subst">$&#123;<span class="keyword">this</span>.age&#125;</span>&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> main(args) &#123;</span><br><span class="line">  Person p = <span class="keyword">new</span> Person(name: <span class="string">&quot;张三&quot;</span>, age: <span class="number">20</span>);</span><br><span class="line">  <span class="built_in">print</span>(p.getInfo()); <span class="comment">// 张三---20</span></span><br><span class="line"></span><br><span class="line">  Person p1 = <span class="keyword">new</span> Person(age: <span class="number">20</span>);</span><br><span class="line">  <span class="built_in">print</span>(p1.getInfo()); <span class="comment">// null---20</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h3><h4 id="回顾-Dart-常量"><a href="#回顾-Dart-常量" class="headerlink" title="回顾 Dart 常量"></a>回顾 Dart 常量</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="language-markdown">/**</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">Dart 常量: final 和 const 修饰符。</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">  1、const 声明的常量是在编译时确定的，永远不会改变；</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">  2、final 声明的常量允许声明后再赋值，赋值后不可改变，final 声明的变量是在运行时确定的；</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">  3、final 不仅有 const 的编译时常量的特性，最重要的它是运行时常量，并且 final 是惰性初始化，即在运行时第一次使用前才初始化。</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="emphasis">*/</span></span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  <span class="comment">// const 常量</span></span><br><span class="line">  <span class="comment">// const PI = 3.14;</span></span><br><span class="line">  <span class="comment">// PI = 3.14159; // const 定义的常量没法改变</span></span><br><span class="line">  <span class="comment">// print(PI);</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// final 常量</span></span><br><span class="line">  <span class="comment">// final PI = 3.14;</span></span><br><span class="line">  <span class="comment">// print(PI);</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> a;</span><br><span class="line">  a = <span class="number">13</span>;</span><br><span class="line">  <span class="comment">// a = 14;</span></span><br><span class="line">  <span class="built_in">print</span>(a);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> d = <span class="keyword">new</span> <span class="built_in">DateTime</span>.now();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="const、identical-函数"><a href="#const、identical-函数" class="headerlink" title="const、identical 函数"></a>const、identical 函数</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="language-markdown">/**</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"> dart:core 库中 identical 函数的用法介绍如下：</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"></span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">用法:</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">bool identical(</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">   Object? a,    </span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">   Object? b   </span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">)</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment">检查两个引用是否指向同一个对象。</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"> <span class="emphasis">*/</span></span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  <span class="comment">// var o1 = new Object();</span></span><br><span class="line">  <span class="comment">// var o2 = new Object();</span></span><br><span class="line">  <span class="comment">// print(identical(o1, o2)); // false，不共享存储空间</span></span><br><span class="line">  <span class="comment">// print(identical(o1, o1)); // true，共享存储空间</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// var o1 = Object();</span></span><br><span class="line">  <span class="comment">// var o2 = Object();</span></span><br><span class="line">  <span class="comment">// print(identical(o1, o2)); // false</span></span><br><span class="line">  <span class="comment">// print(identical(o1, o1)); // true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 表示实例化常量构造函数</span></span><br><span class="line">  <span class="comment">// o1 和 o2 共享了存储空间</span></span><br><span class="line">  <span class="comment">// var o1 = const Object();</span></span><br><span class="line">  <span class="comment">// var o2 = const Object();</span></span><br><span class="line">  <span class="comment">// print(identical(o1, o2)); // true，共享存储空间</span></span><br><span class="line">  <span class="comment">// print(identical(o1, o1)); // true，共享存储空间</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// print(identical([2], [2])); // false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// var a = [2];</span></span><br><span class="line">  <span class="comment">// var b = [2];</span></span><br><span class="line">  <span class="comment">// print(identical(a, b)); // false，不共享存储空间</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> c = [<span class="number">2</span>];</span><br><span class="line">  <span class="keyword">const</span> d = [<span class="number">3</span>];</span><br><span class="line">  <span class="built_in">print</span>(identical(c, d)); <span class="comment">// false，不共享存储空间</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 发现：const 关键词在多个地方创建相同的对象的时候，内存中只保留了一个对象。</span></span><br><span class="line">  <span class="comment">// 共享存储空间条件：1、常量   2、值相等。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="普通构造函数"><a href="#普通构造函数" class="headerlink" title="普通构造函数"></a>普通构造函数</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Container</span> </span>&#123;</span><br><span class="line">  <span class="built_in">int</span> width;</span><br><span class="line">  <span class="built_in">int</span> height;</span><br><span class="line">  Container(&#123;<span class="keyword">required</span> <span class="keyword">this</span>.width, <span class="keyword">required</span> <span class="keyword">this</span>.height&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  <span class="keyword">var</span> c1 = <span class="keyword">new</span> Container(width: <span class="number">100</span>, height: <span class="number">100</span>);</span><br><span class="line">  <span class="keyword">var</span> c2 = <span class="keyword">new</span> Container(width: <span class="number">100</span>, height: <span class="number">100</span>);</span><br><span class="line">  <span class="built_in">print</span>(identical(c1, c2)); <span class="comment">// false，c1 和 c2 在内存中存储了 2 份</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="常量构造函数"><a href="#常量构造函数" class="headerlink" title="常量构造函数"></a>常量构造函数</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">常量构造函数总结如下几点：</span></span><br><span class="line"><span class="comment">  1、常量构造函数需以 const 关键字修饰；</span></span><br><span class="line"><span class="comment">  2、const 构造函数必须用于成员变量都是 final 的类；</span></span><br><span class="line"><span class="comment">  3、如果实例化时不加 const 修饰符，即使调用的是常量构造函数，实例化的对象也不是常量实例；</span></span><br><span class="line"><span class="comment">  4、实例化常量构造函数的时候，多个地方创建这个对象，如果传入的值相同，只会保留一个对象；</span></span><br><span class="line"><span class="comment">  5、Flutter 中 const 修饰不仅仅是节省组件构建时的内存开销，Flutter 在需要重新构建组件的时候，由于这个组件是不应该改变的，重新构建没有任何意义，因此 Flutter 不会重新构建 const 组件。 </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 常量构造函数</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Container</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">int</span> width;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">int</span> height;</span><br><span class="line">  <span class="keyword">const</span> Container(&#123;<span class="keyword">required</span> <span class="keyword">this</span>.width, <span class="keyword">required</span> <span class="keyword">this</span>.height&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  <span class="keyword">var</span> c1 = Container(width: <span class="number">100</span>, height: <span class="number">100</span>);</span><br><span class="line">  <span class="keyword">var</span> c2 = Container(width: <span class="number">100</span>, height: <span class="number">100</span>);</span><br><span class="line">  <span class="built_in">print</span>(identical(c1, c2)); <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> c3 = <span class="keyword">const</span> Container(width: <span class="number">100</span>, height: <span class="number">100</span>);</span><br><span class="line">  <span class="keyword">var</span> c4 = <span class="keyword">const</span> Container(width: <span class="number">100</span>, height: <span class="number">100</span>);</span><br><span class="line">  <span class="built_in">print</span>(identical(c3, c4)); <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> c5 = <span class="keyword">const</span> Container(width: <span class="number">100</span>, height: <span class="number">110</span>);</span><br><span class="line">  <span class="keyword">var</span> c6 = <span class="keyword">const</span> Container(width: <span class="number">120</span>, height: <span class="number">100</span>);</span><br><span class="line">  <span class="built_in">print</span>(identical(c5, c6)); <span class="comment">// false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 实例化常量构造函数的时候，多个地方创建这个对象，如果传入的值相同，只会保留一个对象。</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zhich.github.io/2020/04/12/Android-Jetpack-%E4%B9%8B-WorkManager/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="明年今日">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="明年今日">
      <meta itemprop="description" content="终身学习者。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 明年今日">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/04/12/Android-Jetpack-%E4%B9%8B-WorkManager/" class="post-title-link" itemprop="url">Android Jetpack 之 WorkManager</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-04-12 16:13:00" itemprop="dateCreated datePublished" datetime="2020-04-12T16:13:00+08:00">2020-04-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-06-03 22:53:51" itemprop="dateModified" datetime="2024-06-03T22:53:51+08:00">2024-06-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <meta name="referrer" content="no-referrer" />






<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>Android 在处理后台任务上，根据不同的需求给我们提供了 Service、JobScheduler、Loader 等。然而，大量的后台任务势必会过度消耗设备的电量。为了在设备电量和用户体验之间达到一个比较好的平衡，谷歌推出了 WorkManager。</p>
<p>WorkManager 是一个 Android 库，它在工作的触发器（如适当的网络状态和电池条件）满足时, 优雅地运行可推迟的后台工作。WorkManager 尽可能使用框架 JobScheduler , 以帮助优化电池寿命和批处理作业。在 Android 6.0（API 级 23）下面的设备上, 如果 WorkManager 已经包含了应用程序的依赖项，则尝试使用 Firebase JobDispatcher。否则，WorkManager 返回到自定义 AlarmManager 实现，以优雅地处理您的后台工作。</p>
<h3 id="主要功能"><a href="#主要功能" class="headerlink" title="主要功能"></a>主要功能</h3><ul>
<li>最高向后兼容到 API 14<ul>
<li>在运行 API 23 及以上级别的设备上使用 JobScheduler</li>
<li>在运行 API 14-22 的设备上结合使用 BroadcastReceiver 和 AlarmManager</li>
</ul>
</li>
<li>添加网络可用性或充电状态等工作约束</li>
<li>调度一次性或周期性异步任务</li>
<li>监控和管理计划任务</li>
<li>将任务链接起来</li>
<li>确保任务执行，即使应用或设备重启也同样执行任务</li>
<li>遵循低电耗模式等省电功能</li>
</ul>
<h3 id="重要特点"><a href="#重要特点" class="headerlink" title="重要特点"></a>重要特点</h3><ul>
<li><strong>针对不需要立即执行的任务</strong>：比如向后端服务发送日志或分析数据，定期将应用数据与服务器同步等。从业务角度看，这些任务不需要立即执行。</li>
<li><strong>保证任务一定会被执行</strong>：即使应用程序当前不在运行中，哪怕彻底退出，或者设备重新启动，任务仍然会在适当的时候执行。这是因 WorkManager 有自己的数据库，关于任务的所有信息和数据都保存在这个数据库中。</li>
</ul>
<p>WorkManager 不适用于应用进程结束时能够安全终止的运行中后台工作，也不适用于需要立即执行的任务。请查看<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vZ3VpZGUvYmFja2dyb3VuZD9obD16aC1jbg==">后台处理指南<i class="fa fa-external-link-alt"></i></span>，了解哪种解决方案符合您的需求。</p>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><h4 id="添加相关依赖"><a href="#添加相关依赖" class="headerlink" title="添加相关依赖"></a>添加相关依赖</h4><p>使用 Java 或 Kotlin 语言将 WorkManager 依赖项添加到您的 Android 项目中。<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vamV0cGFjay9hbmRyb2lkeC9yZWxlYXNlcy93b3JrP2hsPXpoLWNuI2RlY2xhcmluZ19kZXBlbmRlbmNpZXM=">依赖链接<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">   def work_version = <span class="string">&quot;2.3.1&quot;</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// (Java only)</span></span><br><span class="line">   implementation <span class="string">&quot;androidx.work:work-runtime:<span class="variable">$work_version</span>&quot;</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// Kotlin + coroutines</span></span><br><span class="line">   implementation <span class="string">&quot;androidx.work:work-runtime-ktx:<span class="variable">$work_version</span>&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使用-Worker-定义任务"><a href="#使用-Worker-定义任务" class="headerlink" title="使用 Worker 定义任务"></a>使用 Worker 定义任务</h4><p>Worker 是一个抽象类，用来指定需要执行的具体任务。我们需要继承 Worker 类，并实现它的 doWork 方法，所有需要在任务中执行的代码都在该方法中编写。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UploadLogWorker</span>(context: Context, workerParams: WorkerParameters) : Worker(context, workerParams) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">doWork</span><span class="params">()</span></span>: Result &#123;</span><br><span class="line">        LogUtil.d(<span class="string">&quot;UploadLogWorker&quot;</span>, <span class="string">&quot;doWork()&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> Result.success()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onStopped</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onStopped()</span><br><span class="line">        <span class="comment">// 当任务结束时会回调这里</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>doWork 方法最后返回一个 Result，这个 Result 是一个枚举，它有几个固定的值：</p>
<ul>
<li><strong>Result.success()</strong> 任务成功。</li>
<li><strong>Result.Failure()</strong> 任务失败。</li>
<li><strong>Result.Retry()</strong> 遇到暂时性失败，此时可使用 WorkRequest.Builder.setBackoffCriteria(BackoffPolicy, long, TimeUnit) 来重试。</li>
</ul>
<h4 id="使用-WorkRequest-配置任务"><a href="#使用-WorkRequest-配置任务" class="headerlink" title="使用 WorkRequest 配置任务"></a>使用 WorkRequest 配置任务</h4><p>通过 WorkRequest 配置我们的任务<strong>何时运行</strong>以及<strong>如何运行</strong>。</p>
<ul>
<li><p><strong>设置任务触发条件</strong> 。比如，我们可以设置设备处于充电中，网络已连接，并且电量充足的情况下才执行我们的任务（完整的触发条件列表，请参阅 <span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vcmVmZXJlbmNlL2FuZHJvaWR4L3dvcmsvQ29uc3RyYWludHMuQnVpbGRlcj9obD16aC1jbg==">Constraints.Builder 参考文档<i class="fa fa-external-link-alt"></i></span>）。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> constraints = Constraints.Builder()</span><br><span class="line">      .setRequiresCharging(<span class="literal">true</span>) <span class="comment">// 充电中</span></span><br><span class="line">      .setRequiredNetworkType(NetworkType.CONNECTED) <span class="comment">// 网络已连接</span></span><br><span class="line">      .setRequiresBatteryNotLow(<span class="literal">true</span>) <span class="comment">// 电量充足</span></span><br><span class="line">      .build()</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>将 constraints 设置到 WorkRequest 中</strong>。WorkRequest 是抽象类，它有两个子类，OneTimeWorkRequest 和 PeriodicWorkRequest，分别对应一次性任务和周期性任务。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> oneTimeWorkRequest = OneTimeWorkRequest.Builder(UploadLogWorker::<span class="keyword">class</span>.java)</span><br><span class="line">        .setConstraints(constraints) <span class="comment">// 设置触发条件</span></span><br><span class="line">        .build()</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>设置延迟执行任务</strong>。如果任务没有设置触发条件，或者所有触发条件都符合了，系统可能立刻执行任务，如果你希望再延后执行，则可以使用 setInitialDelay 方法。以下示例设置符合触发条件后，<strong>至少</strong>经过 5 分钟后再执行。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> oneTimeWorkRequest = OneTimeWorkRequest.Builder(UploadLogWorker::<span class="keyword">class</span>.java)</span><br><span class="line">      .setConstraints(constraints)</span><br><span class="line">      .setInitialDelay(<span class="number">5</span>, TimeUnit.MINUTES) <span class="comment">// 符合触发条件后，至少经过 5 分钟后再执行</span></span><br><span class="line">      .build()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>任务执行的确切时间还取决于 WorkRequest 中使用的触发条件和系统优化。WorkManager 经过设计，能够在满足这些触发条件的情况下提供可能的最佳行为。</p>
</blockquote>
</li>
<li><p><strong>设置指数退避策略</strong>。如果需要 WorkManager 重新尝试执行任务，可以让 Worker 的 doWork 方法返回 Result.retry()。系统有默认的指数退避策略来帮助我们重新执行任务，我们也可以使用 setBackoffCriteria 方法来自定义指数退避策略。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> oneTimeWorkRequest = OneTimeWorkRequest.Builder(UploadLogWorker::<span class="keyword">class</span>.java)</span><br><span class="line">      .setBackoffCriteria(BackoffPolicy.LINEAR, OneTimeWorkRequest.MIN_BACKOFF_MILLIS, TimeUnit.MILLISECONDS)</span><br><span class="line">      .build()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>比如 Worker 线程的执行出现异常，比如服务器宕机，那么我们可能就希望过一段时间再重新执行任务。</p>
</blockquote>
</li>
<li><p><strong>任务的输入&#x2F;输出</strong>。输入和输出值以键值对的形式存储在 Data 对象中。</p>
<p>在 WorkRequest 中设置输入数据。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> inputData = workDataOf(<span class="string">&quot;name&quot;</span> to <span class="string">&quot;张三&quot;</span>, <span class="string">&quot;id&quot;</span> to <span class="number">112134</span>)</span><br><span class="line"><span class="keyword">val</span> uploadLogRequest = OneTimeWorkRequest.Builder(UploadLogWorker::<span class="keyword">class</span>.java)</span><br><span class="line">      .setInputData(inputData)</span><br><span class="line">      .build()</span><br></pre></td></tr></table></figure>

<p>在 Worker 的 doWork 方法中取出输入数据。类似地，Data 类可用于输出返回值。要返回 Data 对象，请将它包含到 Result 的 Result.success() 或 Result.failure() 中。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UploadLogWorker</span>(context: Context, workerParams: WorkerParameters) : Worker(context, workerParams) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">doWork</span><span class="params">()</span></span>: Result &#123;</span><br><span class="line">        <span class="keyword">val</span> name = inputData.getString(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">        <span class="keyword">val</span> id = inputData.getInt(<span class="string">&quot;id&quot;</span>, <span class="number">0</span>)</span><br><span class="line">        LogUtil.d(<span class="string">&quot;name--&gt;<span class="variable">$name</span>, id---&gt;<span class="variable">$id</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> outputData = workDataOf(<span class="string">&quot;name&quot;</span> to name, <span class="string">&quot;id&quot;</span> to id)</span><br><span class="line">        <span class="keyword">return</span> Result.success(outputData)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>按照设计，Data 对象应该很小，值可以是字符串、基元类型或数组变体。如果需要将更多数据传入和传出工作器，应该将数据放在其它位置，例如 Room 数据库。Data 对象的大小上限为 10KB。</p>
</blockquote>
</li>
<li><p><strong>为任务设置标签</strong>。</p>
<p>设置了 Tag 后，可以通过 WorkManager.cancelAllWorkByTag(String) 取消使用特定 Tag 的所有任务，通过 WorkManager.getWorkInfosByTagLiveData(String) 返回 LiveData 和具有该 Tag 的所有任务的状态列表。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> oneTimeWorkRequest1 = OneTimeWorkRequest.Builder(UploadLogWorker::<span class="keyword">class</span>.java)</span><br><span class="line">      .addTag(<span class="string">&quot;A&quot;</span>)</span><br><span class="line">      .build()</span><br><span class="line"><span class="keyword">val</span> oneTimeWorkRequest2 = OneTimeWorkRequest.Builder(UploadLogWorker::<span class="keyword">class</span>.java)</span><br><span class="line">      .addTag(<span class="string">&quot;A&quot;</span>)</span><br><span class="line">      .build()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>以上两个任务的 Tag 都设置为 A , 使这两个任务成为了一个组：A 组，这样的好处是以后可以操作整个组。</p>
</blockquote>
</li>
</ul>
<h4 id="将-WorkRequest-提交给系统"><a href="#将-WorkRequest-提交给系统" class="headerlink" title="将 WorkRequest 提交给系统"></a>将 WorkRequest 提交给系统</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WorkManager.getInstance(applicationContext).enqueue(uploadLogRequest)</span><br></pre></td></tr></table></figure>

<h4 id="观察任务的状态"><a href="#观察任务的状态" class="headerlink" title="观察任务的状态"></a>观察任务的状态</h4><p>将任务提交给系统后，可通过 <code>WorkInfo</code> 获知任务的状态，WorkInfo 包含了任务的 id、tag、Worker 对象传递过来的 outputData，以及当前的状态。以下三种方式可以得到 WorkInfo 对象。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">WorkManager.getInstance(applicationContext).getWorkInfosByTag()</span><br><span class="line">WorkManager.getInstance(applicationContext).getWorkInfoById()</span><br><span class="line">WorkManager.getInstance(applicationContext).getWorkInfosForUniqueWork()</span><br></pre></td></tr></table></figure>

<p>如果希望实时获知任务的状态，上面三个方法还有对于的 LiveData 方法。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">WorkManager.getInstance(applicationContext).getWorkInfosByTagLiveData()</span><br><span class="line">WorkManager.getInstance(applicationContext).getWorkInfoByIdLiveData()</span><br><span class="line">WorkManager.getInstance(applicationContext).getWorkInfosForUniqueWorkLiveData()</span><br></pre></td></tr></table></figure>

<p>通过 LiveData，我们便可在任务状态发生变化的时候收到通知。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">WorkManager.getInstance(applicationContext).getWorkInfoByIdLiveData(uploadLogRequest.id).observe(<span class="keyword">this</span>, Observer &#123; workInfo -&gt;</span><br><span class="line">    <span class="keyword">if</span> (workInfo != <span class="literal">null</span> &amp;&amp; workInfo.state == WorkInfo.State.SUCCEEDED) &#123;</span><br><span class="line">        <span class="keyword">val</span> name = workInfo.outputData.getString(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">        <span class="keyword">val</span> id = workInfo.outputData.getInt(<span class="string">&quot;id&quot;</span>, <span class="number">0</span>)</span><br><span class="line">        LogUtil.d(<span class="string">&quot;name--&gt;<span class="variable">$name</span>, id--&gt;<span class="variable">$id</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="取消任务"><a href="#取消任务" class="headerlink" title="取消任务"></a>取消任务</h4><p>可根据 tag、id 取消任务，也可以取消全部任务。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">WorkManager.getInstance(applicationContext).cancelAllWorkByTag()</span><br><span class="line">WorkManager.getInstance(applicationContext).cancelWorkById()</span><br><span class="line">WorkManager.getInstance(applicationContext).cancelUniqueWork()</span><br><span class="line">WorkManager.getInstance(applicationContext).cancelAllWork()</span><br></pre></td></tr></table></figure>

<h4 id="周期任务-PeriodicWorkRequest"><a href="#周期任务-PeriodicWorkRequest" class="headerlink" title="周期任务 PeriodicWorkRequest"></a>周期任务 PeriodicWorkRequest</h4><p>WorkRequest 有两种实现，OneTimeWorkRequest（一次性任务）和 PeriodicWorkRequest（周期性任务）。OneTimeWorkRequest 在任务成功完成后就结束了，而 PeriodicWorkRequest 会按设定的时间周期执行。二者使用起来无太大差别。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> uploadWorkRequest = PeriodicWorkRequest.Builder(UploadLogWorker::<span class="keyword">class</span>.java, <span class="number">15</span>, TimeUnit.MINUTES)</span><br><span class="line">        .setConstraints(constraints)</span><br><span class="line">        .build()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>周期性任务的时间间隔不能少于 <strong>15 分钟</strong>。</p>
</blockquote>
<h4 id="任务链"><a href="#任务链" class="headerlink" title="任务链"></a>任务链</h4><ul>
<li><p><strong>并发任务</strong>。使用 **WorkManager.getInstance().beginWith(…).enqueue()**。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// request1，request2 同时执行</span></span><br><span class="line">WorkManager.getInstance(applicationContext).beginWith(request1,request2).enqueue()</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>串发任务</strong>。使用 **WorkManager.getInstance().beginWith().then().then()…enqueue()**。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 先执行 request1，然后执行 request2</span></span><br><span class="line">WorkManager.getInstance(applicationContext).beginWith(request1).then(request2).enqueue()</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>组合任务</strong>。使用 <strong>WorkContinuation.combine()</strong> 方法。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AB 串发，CD 串发，这两个串之间并发执行后，把汇总结果给到 E</span></span><br><span class="line"><span class="keyword">val</span> chuan1 = WorkManager.getInstance(applicationContext)</span><br><span class="line">      .beginWith(A)</span><br><span class="line">      .then(B)</span><br><span class="line"><span class="keyword">val</span> chuan2 = WorkManager.getInstance(applicationContext)</span><br><span class="line">      .beginWith(C)</span><br><span class="line">      .then(D)</span><br><span class="line">WorkContinuation.combine(listOf(chuan1, chuan2))</span><br><span class="line">      .then(E)</span><br><span class="line">      .enqueue()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h3><ul>
<li>WorkManager 是根据系统版本决定用 JobScheduler 或者 BroadcastReceiver + AlarmManager 的组合，如果某个系统不允许 AlarmManager 自动唤起，那么 WorkManager 就可能无法正常工作。</li>
<li>实际操作中，周期任务的执行与所设定的时间可能有差别，执行时间可能也没有太明显的规律。</li>
</ul>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3poaWNoL0FuZHJvaWRKZXRwYWNrRGVtbw==">文中 Demo GitHub 地址<i class="fa fa-external-link-alt"></i></span></p>
<p>参考资料：</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vdG9waWMvbGlicmFyaWVzL2FyY2hpdGVjdHVyZS93b3JrbWFuYWdlcj9obD16aC1jbg==">Android Developers<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC83ODU5OTM5NA==">WorkManager的基本使用<i class="fa fa-external-link-alt"></i></span></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zhich.github.io/2019/06/25/%E4%BD%8D%E8%BF%90%E7%AE%97%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="明年今日">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="明年今日">
      <meta itemprop="description" content="终身学习者。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 明年今日">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/06/25/%E4%BD%8D%E8%BF%90%E7%AE%97%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">位运算总结</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-06-25 11:06:00" itemprop="dateCreated datePublished" datetime="2019-06-25T11:06:00+08:00">2019-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-06-03 22:53:51" itemprop="dateModified" datetime="2024-06-03T22:53:51+08:00">2024-06-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%BD%8D%E8%BF%90%E7%AE%97/" itemprop="url" rel="index"><span itemprop="name">位运算</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <meta name="referrer" content="no-referrer">





<h3 id="二进制的一些概念"><a href="#二进制的一些概念" class="headerlink" title="二进制的一些概念"></a>二进制的一些概念</h3><p>在二进制数里，最高位 0 表示正数，1 表示负数。</p>
<h4 id="原码"><a href="#原码" class="headerlink" title="原码"></a>原码</h4><p>一个正数，按照绝对值大小转换成的二进制数；一个负数按照绝对值大小转换成的二进制数，然后最高位补 1，称为原码。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> 5 的原码是：00000000 00000000 00000000 00000101</span><br><span class="line">-5 的原码是：10000000 00000000 00000000 00000101</span><br></pre></td></tr></table></figure>

<h4 id="反码"><a href="#反码" class="headerlink" title="反码"></a>反码</h4><p>正数的反码与原码相同，负数的反码为对该数的原码<strong>除符号位</strong>外各位<strong>取反</strong>（即 0 变 1，1 变 0）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">正数 00000000 00000000 00000000 00000101 的反码还是 00000000 00000000 00000000 00000101</span><br><span class="line">负数 10000000 00000000 00000000 00000101 的反码却是 11111111 11111111 11111111 11111010</span><br></pre></td></tr></table></figure>

<h4 id="补码"><a href="#补码" class="headerlink" title="补码"></a>补码</h4><p>正数的补码与原码相同，负数的补码为该数的反码加 1。</p>
<p>负数 10000000 00000000 00000000 00000101 的反码是 11111111 11111111 11111111 11111010，那么补码为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">11111111 11111111 11111111 11111010 + 1 = 11111111 11111111 11111111 11111011</span><br></pre></td></tr></table></figure>

<h3 id="位运算基础"><a href="#位运算基础" class="headerlink" title="位运算基础"></a>位运算基础</h3><p>基本的位操作符有与、或、异或、取反、左移、右移这 6 种，它们的运算规则如下所示：</p>
<table>
<thead>
<tr>
<th align="center">符号</th>
<th align="center">描述</th>
<th align="left">运算规则</th>
</tr>
</thead>
<tbody><tr>
<td align="center">&amp;</td>
<td align="center">与</td>
<td align="left">两个位都为 1 时，结果才为 1</td>
</tr>
<tr>
<td align="center">&#124;</td>
<td align="center">或</td>
<td align="left">两个位只要有一位为 1，结果都为 1</td>
</tr>
<tr>
<td align="center">^</td>
<td align="center">异或</td>
<td align="left">两个位相同为 0，不同为 1</td>
</tr>
<tr>
<td align="center">~</td>
<td align="center">取反</td>
<td align="left">0 变 1，1 变 0</td>
</tr>
<tr>
<td align="center">&lt;&lt;</td>
<td align="center">左移</td>
<td align="left">各二进位全部左移若干位，高位丢弃，低位补 0</td>
</tr>
<tr>
<td align="center">&gt;&gt;</td>
<td align="center">右移</td>
<td align="left">各二进位全部右移若干位，对无符号数，高位补 0，有符号数，各编译器处理方法不一样，有的补符号位（算术右移），有的补 0（逻辑右移）</td>
</tr>
</tbody></table>
<p><strong>注意</strong></p>
<ol>
<li><p>在这 6 种操作符，只有 <strong>~</strong> 取反是单目操作符，其它 5 种都是双目操作符。</p>
</li>
<li><p>位操作只能用于整型数据，对 float 和 double 类型进行位操作会被编译器报错。</p>
</li>
<li><p>对于移位操作，在微软的 VC6.0 和 VS2008 编译器都是采取算术称位即算术移位操作，算术移位是相对于逻辑移位，它们在左移操作中都一样，低位补 0 即可，但在右移中逻辑移位的高位补 0 而算术移位的高位是补符号位。如下面代码会输出 -4 和 3。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">System.out.println((<span class="number">15</span>) &gt;&gt; <span class="number">2</span>); <span class="comment">// 3</span></span><br><span class="line">System.out.println((-<span class="number">15</span>) &gt;&gt; <span class="number">2</span>); <span class="comment">// -4</span></span><br></pre></td></tr></table></figure>
<p>15 &#x3D; 00000000 00000000 00000000 00001111（二进制），右移二位，高位补 0，得到</p>
<p>00000000 00000000 00000000 00000011 即 3。</p>
<p>-15 &#x3D; 11111111 11111111 11111111 11110001（二进制），右移二位，最高位由符号位填充，得到</p>
<p>11111111 11111111 11111111 11111100 即 -4。</p>
</li>
<li><p>位操作符的运算优先级比较低，因此应尽量使用括号来确保运算顺序。</p>
</li>
<li><p>位操作还有一些复合操作符，如 &amp;&#x3D;、|&#x3D;、 ^&#x3D;、&lt;&lt;&#x3D;、&gt;&gt;&#x3D;。</p>
</li>
</ol>
<h3 id="常用的位运算技巧"><a href="#常用的位运算技巧" class="headerlink" title="常用的位运算技巧"></a>常用的位运算技巧</h3><h4 id="判断奇偶数"><a href="#判断奇偶数" class="headerlink" title="判断奇偶数"></a>判断奇偶数</h4><p>一个二进制数 x 的末位为 0 则该数为偶数，为 1 则为奇数，因此可以使用 (x &amp; 1) 的结果来判断 x 的奇偶性，结果为 0，则 x 为偶数，结果为 1，则 x 为奇数。</p>
<p>如要求输出 0 到 10 之间的所有偶数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> ((i &amp; <span class="number">1</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        System.out.println(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="交换两数"><a href="#交换两数" class="headerlink" title="交换两数"></a>交换两数</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> <span class="number">20</span>;</span><br><span class="line">a ^= b;</span><br><span class="line">b ^= a;</span><br><span class="line">a ^= b;</span><br><span class="line">System.out.println(<span class="string">&quot;a=&quot;</span> + a); <span class="comment">// a=20</span></span><br><span class="line">System.out.println(<span class="string">&quot;b=&quot;</span> + b); <span class="comment">// b=10</span></span><br></pre></td></tr></table></figure>

<p><strong>分析：</strong></p>
<p>第一步，a &#x3D; a ^ b ①；</p>
<p>第二步，b &#x3D; b ^ a，把 ① 代入得，b &#x3D; b ^ (a ^ b)，由于 <strong>^ 满足交换律</strong>，所以 b &#x3D; b ^ b ^ a，根据「一个数和自己异或为 0，而 0 和任何数异或结果还是保持不变」的原理得，b &#x3D; a ②；</p>
<p>第三步，a &#x3D; a ^ b，将 ①、② 代入得，a &#x3D; (a ^ b) ^ a 即 a &#x3D; b ③。</p>
<p>从 ②、③ 得知，a 和 b 的值已经得到了交换。</p>
<h4 id="变换符号"><a href="#变换符号" class="headerlink" title="变换符号"></a>变换符号</h4><p>一个数 x <strong>取反加 1</strong> 后就会变成 -x，即正数变为负数，负数变为正数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> -<span class="number">5</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">a = ~a + <span class="number">1</span>;</span><br><span class="line">b = ~b + <span class="number">1</span>;</span><br><span class="line">System.out.println(<span class="string">&quot;a=&quot;</span> + a); <span class="comment">// a=5</span></span><br><span class="line">System.out.println(<span class="string">&quot;b=&quot;</span> + b); <span class="comment">// b=-10</span></span><br></pre></td></tr></table></figure>

<p><strong>分析：</strong></p>
<p>-5 &#x3D; 11111111 11111111 11111111 11111011（二进制），取反再加 1 后变为：</p>
<p>00000000 00000000 00000000 00000101 &#x3D; 5</p>
<blockquote>
<p>注意：这里负数的取反是包括符号位的，不要和负数的反码混淆。</p>
</blockquote>
<h4 id="求绝对值"><a href="#求绝对值" class="headerlink" title="求绝对值"></a>求绝对值</h4><p>对于正数，绝对值就是它本身，对于负数，直接取反加 1 就得到正数了，所以先判断一个整数的符号再做处理。对于整数 a，它的最高位为 0 代表正数，为 1 代表负数，我们对 a 右移 31 位得到一个整数 i（i &#x3D; a &gt;&gt; 31），i 值为 0 代表 a 为正数，为 -1 代表 a 为负数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">abs</span><span class="params">(<span class="type">int</span> a)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> a &gt;&gt; <span class="number">31</span>;</span><br><span class="line">    <span class="keyword">return</span> i == <span class="number">0</span> ? a : (~a + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进一步分析，对于任意整数 a，和 0（32 个 0）异或都保持不变，和 -1（32 个 1）异或相当于取反，所以上面的返回值可以转换为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> i == <span class="number">0</span> ? (a ^ i) : ((a ^ i) + <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>上面返回值再变换下得：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> i == <span class="number">0</span> ? ((a ^ i) - <span class="number">0</span>) : ((a ^ i) + <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>由于 i 的值非 0 即 -1，因此上面返回值可以精简为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> (a ^ i) - i;</span><br></pre></td></tr></table></figure>

<p>通过上面的分析，我们得出求一个整数的绝对值的精简方式，这种方式不需任何判断。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">abs</span><span class="params">(<span class="type">int</span> a)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> a &gt;&gt; <span class="number">31</span>;</span><br><span class="line">    <span class="keyword">return</span> (a ^ i) - i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="位操作与空间压缩"><a href="#位操作与空间压缩" class="headerlink" title="位操作与空间压缩"></a>位操作与空间压缩</h3><p>当我们要标记一个布尔型数组的状态为 true|false 时，我们通常的做法是这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span>[] flag = <span class="keyword">new</span> <span class="title class_">boolean</span>[<span class="number">100</span>];</span><br></pre></td></tr></table></figure>

<p>由于数组在内存上也是连续分配的一段空间，我们可以「认为」它是一个很长的整数，因此我们仅需用一个长度为 4（100 &#x2F; 32 + 1）的整型数组即可完成上面的状态标记。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span>[] b = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">4</span>]; <span class="comment">// 每个 int 值有 32 位，各个位上为 0 代表 false，为 1 代表 true</span></span><br></pre></td></tr></table></figure>

<p>由于 boolean 占 1 个字节，int 占 4 个字节，因此，用第二种方式所使用的空间仅为第一种的 1&#x2F;6 左右。</p>
<p>以下是用筛素数法计算 100 以内的素数的示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">printPrime</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">max</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">    <span class="type">boolean</span>[] flag = <span class="keyword">new</span> <span class="title class_">boolean</span>[max];</span><br><span class="line">    <span class="type">int</span>[] primes = <span class="keyword">new</span> <span class="title class_">int</span>[max / <span class="number">3</span> + <span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">2</span>; i &lt; max; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!flag[i]) &#123;</span><br><span class="line">            primes[index++] = i;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i; j &lt; max; j += i) &#123; <span class="comment">// 素数的倍数必然不是素数</span></span><br><span class="line">                flag[j] = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输出 100 以内所有素数</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; index; i++) &#123;</span><br><span class="line">        System.out.print(primes[i] + <span class="string">&quot; &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">输出：<span class="number">2</span> <span class="number">3</span> <span class="number">5</span> <span class="number">7</span> <span class="number">11</span> <span class="number">13</span> <span class="number">17</span> <span class="number">19</span> <span class="number">23</span> <span class="number">29</span> <span class="number">31</span> <span class="number">37</span> <span class="number">41</span> <span class="number">43</span> <span class="number">47</span> <span class="number">53</span> <span class="number">59</span> <span class="number">61</span> <span class="number">67</span> <span class="number">71</span> <span class="number">73</span> <span class="number">79</span> <span class="number">83</span> <span class="number">89</span> <span class="number">97</span></span><br></pre></td></tr></table></figure>

<p>如果是用长度为 4 的整型数组 b 来替代 flag 布尔型数组怎么做？两个关键点，第一，如何将一个整数的指定位上置为 1？第二，如何判断一个整数指定位上是 0 还是 1？</p>
<p>将整数 j 指定位上置为 1：</p>
<blockquote>
<p>将 1 向左移位后和其相或来达到在指定位上置 1 的效果</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setOne</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println();</span><br><span class="line">    <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    j |= (<span class="number">1</span> &lt;&lt; <span class="number">10</span>);</span><br><span class="line">    System.out.println(Integer.toBinaryString(j));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 输出：10000000000</span></span><br></pre></td></tr></table></figure>

<p>判断整数 j 指定位上是否为 1：</p>
<blockquote>
<p>将 1 向左移位后和原数相与来判断指定位上是 0 还是 1（也可以将原数右移若干位再和 1 相与）</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">isOne</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span> &lt;&lt; <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">if</span> ((j &amp; (<span class="number">1</span> &lt;&lt; <span class="number">10</span>)) != <span class="number">0</span>) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;指定位上为 1&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;指定位上为 0&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 输出：指定位上为 1</span></span><br></pre></td></tr></table></figure>

<p>再把这种思路扩展到一个整型数组上：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setOne2</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">max</span> <span class="operator">=</span> <span class="number">40</span>;</span><br><span class="line">    <span class="type">int</span>[] b = <span class="keyword">new</span> <span class="title class_">int</span>[max / <span class="number">32</span> + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; max; i += <span class="number">3</span>) &#123;</span><br><span class="line">        b[i / <span class="number">32</span>] |= (<span class="number">1</span> &lt;&lt; (i % <span class="number">32</span>)); <span class="comment">// 每 3 个位设置为 1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; max; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (((b[i / <span class="number">32</span>] &gt;&gt; i) &amp; <span class="number">1</span>) == <span class="number">1</span>) &#123; <span class="comment">// 判断是否为 1</span></span><br><span class="line">            System.out.print(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.print(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 输出：1001001001001001001001001001001001001001</span></span><br></pre></td></tr></table></figure>

<p>现在可以将上面的筛素数法改成使用位操作压缩后的筛素数法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">printPrime2</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">max</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">    <span class="type">int</span>[] b = <span class="keyword">new</span> <span class="title class_">int</span>[max / <span class="number">32</span> + <span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span>[] primes = <span class="keyword">new</span> <span class="title class_">int</span>[max / <span class="number">3</span> + <span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">2</span>; i &lt; max; i++) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> b[i / <span class="number">32</span>] &gt;&gt; (i % <span class="number">32</span>); <span class="comment">// 通过右移，逐位判断是 0 还是 1</span></span><br><span class="line">        <span class="keyword">if</span> ((x &amp; <span class="number">1</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            primes[index++] = i;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i; j &lt; max; j += i) &#123;</span><br><span class="line">                b[j / <span class="number">32</span>] |= (<span class="number">1</span> &lt;&lt; (j % <span class="number">32</span>)); <span class="comment">// 将指定位上设置为 1</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 输出 100 以内所有素数</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; index; i++) &#123;</span><br><span class="line">        System.out.print(primes[i] + <span class="string">&quot; &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">输出：<span class="number">2</span> <span class="number">3</span> <span class="number">5</span> <span class="number">7</span> <span class="number">11</span> <span class="number">13</span> <span class="number">17</span> <span class="number">19</span> <span class="number">23</span> <span class="number">29</span> <span class="number">31</span> <span class="number">37</span> <span class="number">41</span> <span class="number">43</span> <span class="number">47</span> <span class="number">53</span> <span class="number">59</span> <span class="number">61</span> <span class="number">67</span> <span class="number">71</span> <span class="number">73</span> <span class="number">79</span> <span class="number">83</span> <span class="number">89</span> <span class="number">97</span></span><br></pre></td></tr></table></figure>



      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zhich.github.io/2019/03/27/Kotlin-%E6%B3%9B%E5%9E%8B%E4%B8%AD%E7%9A%84-in-%E5%92%8C-out/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="明年今日">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="明年今日">
      <meta itemprop="description" content="终身学习者。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 明年今日">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/03/27/Kotlin-%E6%B3%9B%E5%9E%8B%E4%B8%AD%E7%9A%84-in-%E5%92%8C-out/" class="post-title-link" itemprop="url">Kotlin 泛型中的 in 和 out</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-03-27 11:15:00" itemprop="dateCreated datePublished" datetime="2019-03-27T11:15:00+08:00">2019-03-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-06-03 22:53:51" itemprop="dateModified" datetime="2024-06-03T22:53:51+08:00">2024-06-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Kotlin/" itemprop="url" rel="index"><span itemprop="name">Kotlin</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <meta name="referrer" content="no-referrer" />





<p>当我们在 Kotlin 中定义泛型时，我们会发现它需要使用到 <code>in</code> 和 <code>out</code> 两个关键字来定义。从形式上来讲，这是一种定义「逆变」和「协变」的方式。</p>
<p>那啥叫逆变？啥叫协变？可以参考下维基百科的定义：<span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU1JThEJThGJUU1JThGJTk4JUU0JUI4JThFJUU5JTgwJTg2JUU1JThGJTk4">协变与逆变<i class="fa fa-external-link-alt"></i></span></p>
<h3 id="in-out-怎么记？"><a href="#in-out-怎么记？" class="headerlink" title="in &amp; out 怎么记？"></a>in &amp; out 怎么记？</h3><p><strong>out（协变）</strong></p>
<p>如果泛型类<strong>只将</strong>泛型类型作为函数的返回（输出），那么使用 out：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Production</span>&lt;<span class="type">out T</span>&gt; &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">produce</span><span class="params">()</span></span>: T</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以称之为生产类&#x2F;接口，因为它主要是用来生产（produce）指定的泛型对象。因此，我们可以简单地这样记忆：</p>
<p><strong>produce &#x3D; output &#x3D; out</strong></p>
<p><strong>in（逆变）</strong></p>
<p>如果泛型类<strong>只将</strong>泛型类型作为函数的入参（输入），那么使用 in：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Consumer</span>&lt;<span class="type">in T</span>&gt; &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">consume</span><span class="params">(item: <span class="type">T</span>)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以称之为消费者类&#x2F;接口，因为它主要是用来消费（consume）指定的泛型对象。因此我们可以简单地这样记忆：</p>
<p><strong>consume &#x3D; input &#x3D; in</strong></p>
<p><strong>invariant（不变）</strong></p>
<p>如果泛型类既将泛型类型作为函数参数，又将泛型类型作为函数的输出，那么既不用 out 也不用 in：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">ProductionConsumer</span>&lt;<span class="type">T</span>&gt; &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">produce</span><span class="params">()</span></span>: T</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">consume</span><span class="params">(item: <span class="type">T</span>)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="为啥要使用-in-out-？"><a href="#为啥要使用-in-out-？" class="headerlink" title="为啥要使用 in &amp; out ？"></a>为啥要使用 in &amp; out ？</h3><p>举个例子，我们定义下汉堡类对象，它是一种快餐，也是一种食物。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="keyword">class</span> <span class="title class_">Food</span></span><br><span class="line"><span class="keyword">open</span> <span class="keyword">class</span> <span class="title class_">FastFood</span> : <span class="type">Food</span>() </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Burger</span> : <span class="type">FastFood</span>()</span><br></pre></td></tr></table></figure>

<h4 id="汉堡生产者"><a href="#汉堡生产者" class="headerlink" title="汉堡生产者"></a>汉堡生产者</h4><p>根据上面定义的生产（Production）接口，我们可以进一步扩展它们来生产食物、快餐和汉堡：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FoodStore</span> : <span class="type">Production</span>&lt;<span class="type">Food</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">produce</span><span class="params">()</span></span>: Food &#123;</span><br><span class="line">        println(<span class="string">&quot;Produce food&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> Food()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FastFoodStore</span> : <span class="type">Production</span>&lt;<span class="type">FastFood</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">produce</span><span class="params">()</span></span>: FastFood &#123;</span><br><span class="line">        println(<span class="string">&quot;Produce fast food&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> FastFood()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">InOutBurger</span> : <span class="type">Production</span>&lt;<span class="type">Burger</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">produce</span><span class="params">()</span></span>: Burger &#123;</span><br><span class="line">        println(<span class="string">&quot;Produce burger&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> Burger()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在，我们可以这样赋值：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> production1 : Production&lt;Food&gt; = FoodStore()</span><br><span class="line"><span class="keyword">val</span> production2 : Production&lt;Food&gt; = FastFoodStore()</span><br><span class="line"><span class="keyword">val</span> production3 : Production&lt;Food&gt; = InOutBurger()</span><br></pre></td></tr></table></figure>

<p>显然，汉堡商店属于快餐商店，也属于食物商店。</p>
<blockquote>
<p><strong>因此，对于 out 类型，我们能够将使用子类泛型的对象赋值给使用父类泛型的对象。</strong></p>
</blockquote>
<p>如果我们修改如下，那么就会出错了，因为食物或快餐商店是可以生产汉堡，但不一定仅仅生产汉堡：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> production1 : Production&lt;Burger&gt; = FoodStore()  <span class="comment">// Error</span></span><br><span class="line"><span class="keyword">val</span> production2 : Production&lt;Burger&gt; = FastFoodStore()  <span class="comment">// Error</span></span><br><span class="line"><span class="keyword">val</span> production3 : Production&lt;Burger&gt; = InOutBurger()</span><br></pre></td></tr></table></figure>

<h4 id="汉堡消费者"><a href="#汉堡消费者" class="headerlink" title="汉堡消费者"></a>汉堡消费者</h4><p>根据上面定义的消费（Consumer）接口，我们可以进一步扩展它们来消费食物、快餐和汉堡：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Everybody</span> : <span class="type">Consumer</span>&lt;<span class="type">Food</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">consume</span><span class="params">(item: <span class="type">Food</span>)</span></span> &#123;</span><br><span class="line">        println(<span class="string">&quot;Eat food&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ModernPeople</span> : <span class="type">Consumer</span>&lt;<span class="type">FastFood</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">consume</span><span class="params">(item: <span class="type">FastFood</span>)</span></span> &#123;</span><br><span class="line">        println(<span class="string">&quot;Eat fast food&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">American</span> : <span class="type">Consumer</span>&lt;<span class="type">Burger</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">consume</span><span class="params">(item: <span class="type">Burger</span>)</span></span> &#123;</span><br><span class="line">        println(<span class="string">&quot;Eat burger&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以将人类、现代人、美国人指定为汉堡消费者，所以可以这样赋值：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> consumer1 : Consumer&lt;Burger&gt; = Everybody()</span><br><span class="line"><span class="keyword">val</span> consumer2 : Consumer&lt;Burger&gt; = ModernPeople()</span><br><span class="line"><span class="keyword">val</span> consumer3 : Consumer&lt;Burger&gt; = American()</span><br></pre></td></tr></table></figure>

<p>不难理解，汉堡的消费者可以是美国人，也可以是现代人，更可以是人类。</p>
<blockquote>
<p><strong>因此，对于 in 泛型，我们能够将使用父类泛型的对象赋值给使用子类泛型的对象。</strong></p>
</blockquote>
<p>反之，如果我们修改如下，就会出现错误，因为汉堡的消费者不仅仅是美国人或现代人。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> consumer1 : Consumer&lt;Food&gt; = Everybody()</span><br><span class="line"><span class="keyword">val</span> consumer2 : Consumer&lt;Food&gt; = ModernPeople()  <span class="comment">// Error</span></span><br><span class="line"><span class="keyword">val</span> consumer3 : Consumer&lt;Food&gt; = American()  <span class="comment">// Error</span></span><br></pre></td></tr></table></figure>

<h3 id="记住-in-out-的另一种方式"><a href="#记住-in-out-的另一种方式" class="headerlink" title="记住 in &amp; out 的另一种方式"></a>记住 in &amp; out 的另一种方式</h3><ul>
<li>父类泛型对象可以赋值给子类泛型对象，用 in；</li>
<li>子类泛型对象可以赋值给父类泛型对象，用 out。</li>
</ul>
<p>参考资料：</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9tZWRpdW0uY29tL0BlbHllLnByb2plY3QvaW4tYW5kLW91dC10eXBlLXZhcmlhbnQtb2Yta290bGluLTU4N2U0ZmEyOTQ0Yw==">In and out type variant of Kotlin<i class="fa fa-external-link-alt"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zMjU4MzMxMA==">Kotlin 泛型中的 in 和 out<i class="fa fa-external-link-alt"></i></span></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zhich.github.io/2019/01/30/Pair-%E4%BA%86%E8%A7%A3%E4%B8%80%E4%B8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="明年今日">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="明年今日">
      <meta itemprop="description" content="终身学习者。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 明年今日">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/01/30/Pair-%E4%BA%86%E8%A7%A3%E4%B8%80%E4%B8%8B/" class="post-title-link" itemprop="url">Pair 了解一下</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-01-30 11:05:00" itemprop="dateCreated datePublished" datetime="2019-01-30T11:05:00+08:00">2019-01-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-06-03 22:53:51" itemprop="dateModified" datetime="2024-06-03T22:53:51+08:00">2024-06-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <meta name="referrer" content="no-referrer">





<h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p><strong>Pair</strong> 的字面意思是“一对”、“一双”，瞄一眼它的源码，果不其然，里面只有两个字段 <code>first</code> 与 <code>second</code> .</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Pair</span>&lt;F, S&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> F first;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> S second;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Pair</span><span class="params">(F first, S second)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.first = first;</span><br><span class="line">        <span class="built_in">this</span>.second = second;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> Pair)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Pair&lt;?, ?&gt; p = (Pair&lt;?, ?&gt;) o;</span><br><span class="line">        <span class="keyword">return</span> Objects.equals(p.first, first) &amp;&amp; Objects.equals(p.second, second);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;A, B&gt; Pair &lt;A, B&gt; create(A a, B b) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Pair</span>&lt;A, B&gt;(a, b);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h3><p>它的使用也是非常简单的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 两种方式都可以创建 Pair 实例，而第二种方式内部实际上也是使用第一种方式创建</span></span><br><span class="line"><span class="type">Pair</span> <span class="variable">pair1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Pair</span>&lt;Integer, String&gt;(<span class="number">1</span>, <span class="string">&quot;111&quot;</span>); <span class="comment">// 第一种方式创建</span></span><br><span class="line"><span class="type">Pair</span> <span class="variable">pair2</span> <span class="operator">=</span> Pair.create(<span class="number">1</span>, <span class="number">111</span>); <span class="comment">// 第二种方式创建</span></span><br><span class="line"><span class="type">Pair</span> <span class="variable">pair3</span> <span class="operator">=</span> Pair.create(<span class="number">1</span>, <span class="number">111</span>);</span><br><span class="line"></span><br><span class="line">Log.e(TAG, pair1.first.toString()); <span class="comment">// 1</span></span><br><span class="line">Log.e(TAG, pair1.second.toString()); <span class="comment">// 111</span></span><br><span class="line">Log.e(TAG, pair1.second.equals(<span class="string">&quot;111&quot;</span>) + <span class="string">&quot;&quot;</span>); <span class="comment">// true</span></span><br><span class="line">Log.e(TAG, pair1.second.equals(<span class="number">111</span>) + <span class="string">&quot;&quot;</span>); <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line">Log.e(TAG, pair1.equals(pair2) + <span class="string">&quot;&quot;</span>); <span class="comment">// false</span></span><br><span class="line">Log.e(TAG, pair2.equals(pair3) + <span class="string">&quot;&quot;</span>); <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p>从以上示例可知：</p>
<ul>
<li>Pair 的 first 获取的是第一个位置的数据，second 获取的是第二个位置的数据；</li>
<li>Pair 的 equals 比较的是 first 与 second 值是否同时 equals .</li>
</ul>
<p>说到 <code>equals</code> , 上面的源码只是 android.util 包下 Pair 类的 equals 方法，由于 android.support.v4.util 包下也有 Pair 类，通过比较，两个包下的 Pair 类只有 equals 方法有所不同，其它方法无异。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// android.util 包下</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> Pair)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Pair&lt;?, ?&gt; p = (Pair&lt;?, ?&gt;) o;</span><br><span class="line">    <span class="keyword">return</span> Objects.equals(p.first, first) &amp;&amp; Objects.equals(p.second, second);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// android.support.v4.util 包下</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> Pair)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Pair&lt;?, ?&gt; p = (Pair)o;</span><br><span class="line">        <span class="keyword">return</span> ObjectsCompat.equals(p.first, <span class="built_in">this</span>.first) &amp;&amp; ObjectsCompat.equals(p.second, <span class="built_in">this</span>.second);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ObjectsCompat 类里面的 equals 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(<span class="meta">@Nullable</span> Object a, <span class="meta">@Nullable</span> Object b)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (VERSION.SDK_INT &gt;= <span class="number">19</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Objects.equals(a, b);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> a == b || a != <span class="literal">null</span> &amp;&amp; a.equals(b);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Objects 是 Java7 以后才有的类，而 Android 是从 4.4 开始支持 JDK7 编译的，因此为了兼容 4.4 之前的版本，在 v4 中加入了一个不依赖 JDK7 的 Pair 类。</p>
<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><p>在<strong>既要以键值对的方式存储数据列表，同时在输出时保持顺序</strong>的情况下，我们可以使用 Pair 搭配 ArrayList 实现。</p>
<p><strong>场景一：</strong></p>
<p>假如我们需要生成 n 个按钮，而每个按钮都有 code 值、展示文本内容的 content 值，当我们点击其中一个按钮后就根据 code 值去做指定的事情（如网络请求）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ArrayList&lt;Pair&lt;String,String&gt;&gt; dataList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br></pre></td></tr></table></figure>

<p><strong>场景二：</strong></p>
<p>记录推送过来的消息，我们可以用 Pair 的 first 记录消息到达的时间戳，second 记录消息体。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ArrayList&lt;Pair&lt;Long,Message&gt;&gt; dataList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zhich.github.io/2018/11/22/Android-Jetpack-%E4%B9%8B-LiveData/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="明年今日">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="明年今日">
      <meta itemprop="description" content="终身学习者。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 明年今日">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/11/22/Android-Jetpack-%E4%B9%8B-LiveData/" class="post-title-link" itemprop="url">Android Jetpack 之 LiveData</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-11-22 08:28:00" itemprop="dateCreated datePublished" datetime="2018-11-22T08:28:00+08:00">2018-11-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-06-03 22:53:51" itemprop="dateModified" datetime="2024-06-03T22:53:51+08:00">2024-06-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <meta name="referrer" content="no-referrer" />






<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><ul>
<li>LiveData 是一个持有数据的类，它持有的数据是可以被观察者订阅的，当数据被修改时就会通知观察者。观察者可以是 Activity、Fragment、Service 等。</li>
<li>LiveData 能够感知观察者的生命周期，只有当观察者处于激活状态（STARTED、RESUMED）才会接收到数据更新的通知，在未激活时会自动解注册观察者，以减少内存泄漏。</li>
<li>使用 LiveData 保存数据时，由于数据和组件是分离的，当组件重建时可以保证数据不会丢失。</li>
</ul>
<h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ul>
<li>确保 UI 界面始终和数据状态保持一致。</li>
<li>没有内存泄漏，观察者绑定到 Lifecycle 对象并在其相关生命周期 destroyed 后自行解除绑定。</li>
<li>不会因为 Activity 停止了而奔溃，如 Activity finish 了，它就不会收到任何 LiveData 事件了。</li>
<li>UI 组件只需观察相关数据，不需要停止或恢复观察，LiveData 会自动管理这些操作，因为 LiveData 可以感知生命周期状态的更改。</li>
<li>在生命周期从非激活状态变为激活状态，始终保持最新数据，如后台 Activity 在返回到前台后可以立即收到最新数据。</li>
<li>当配置发生更改（如屏幕旋转）而重建 Activity &#x2F; Fragment，它会立即收到最新的可用数据。</li>
<li>LiveData 很适合用于组件（Activity &#x2F; Fragment）之间的通信。</li>
</ul>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vdG9waWMvbGlicmFyaWVzL2FyY2hpdGVjdHVyZS9hZGRpbmctY29tcG9uZW50cw==">添加相关依赖<i class="fa fa-external-link-alt"></i></span></p>
<p>LiveData 有两种使用方式，结合 ViewModel 使用以及直接继承 LiveData 类。</p>
<p><strong>结合 ViewModel 使用</strong></p>
<p>以下代码场景：点击按钮提示一个名字。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyViewModel</span> : <span class="type">ViewModel</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个 String 类型的 LiveData</span></span><br><span class="line">    <span class="comment">// MutableLiveData 是抽象类 LiveData 的子类，我们一般使用的是 MutableLiveData</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> name: MutableLiveData&lt;String&gt;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getName</span><span class="params">()</span></span>: MutableLiveData&lt;String&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (!::name.isInitialized) &#123;</span><br><span class="line">            name = MutableLiveData()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> name</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LiveDataActivity</span> : <span class="type">AppCompatActivity</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> myViewModel: MyViewModel</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_live_data)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建并注册观察者</span></span><br><span class="line">        myViewModel = ViewModelProviders.of(<span class="keyword">this</span>).<span class="keyword">get</span>(MyViewModel::<span class="keyword">class</span>.java)</span><br><span class="line">        myViewModel.getName().observe(<span class="keyword">this</span>, Observer &#123;</span><br><span class="line">            <span class="comment">// LiveData 数据更新回调，it 代表被观察对象的数据，此处为 name</span></span><br><span class="line">            Toast.makeText(baseContext, it, Toast.LENGTH_SHORT).show()</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        btnSetName.setOnClickListener &#123;</span><br><span class="line">            <span class="comment">// 使用 setValue 的方式更新 LiveData 数据</span></span><br><span class="line">            myViewModel.getName().value = <span class="string">&quot;张三&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>让数据（name）和组件（LiveDataActivity）分离，当 Activity 重建时，数据（name）不会丢失。</p>
</blockquote>
<p><strong>直接继承 LiveData 类</strong></p>
<p>以下代码场景：在 Activity 中监听 Wifi 信号强度。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">WifiLiveData</span> <span class="keyword">private</span> <span class="keyword">constructor</span>(context: Context) : LiveData&lt;<span class="built_in">Int</span>&gt;() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mContext: WeakReference&lt;Context&gt; = WeakReference(context)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">var</span> instance: WifiLiveData? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">getInstance</span><span class="params">(context: <span class="type">Context</span>)</span></span>: WifiLiveData &#123;</span><br><span class="line">            <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">                instance = WifiLiveData(context)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> instance!!</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onActive</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onActive()</span><br><span class="line">        registerReceiver()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onInactive</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onInactive()</span><br><span class="line">        unregisterReceiver()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册广播，监听 Wifi 信号强度</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">registerReceiver</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> intentFilter = IntentFilter()</span><br><span class="line">        intentFilter.addAction(WifiManager.RSSI_CHANGED_ACTION)</span><br><span class="line">        mContext.<span class="keyword">get</span>()!!.registerReceiver(mReceiver, intentFilter)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注销广播</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">unregisterReceiver</span><span class="params">()</span></span> &#123;</span><br><span class="line">        mContext.<span class="keyword">get</span>()!!.unregisterReceiver(mReceiver)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> mReceiver = <span class="keyword">object</span> : BroadcastReceiver() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onReceive</span><span class="params">(context: <span class="type">Context</span>?, intent: <span class="type">Intent</span>)</span></span> &#123;</span><br><span class="line">            <span class="keyword">when</span> (intent.action) &#123;</span><br><span class="line">                WifiManager.RSSI_CHANGED_ACTION -&gt; getWifiLevel()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">getWifiLevel</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> wifiManager = mContext.<span class="keyword">get</span>()!!.applicationContext.getSystemService(android.content.Context.WIFI_SERVICE) <span class="keyword">as</span> WifiManager</span><br><span class="line">        <span class="keyword">val</span> wifiInfo = wifiManager.connectionInfo</span><br><span class="line">        <span class="keyword">val</span> level = wifiInfo.rssi</span><br><span class="line"></span><br><span class="line">        instance!!.value = level <span class="comment">// 发送 Wifi 的信号强度给观察者</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LiveDataActivity</span> : <span class="type">AppCompatActivity</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_live_data)</span><br><span class="line"></span><br><span class="line">        withExtendsLiveDataTest()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 直接继承 LiveData 类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">withExtendsLiveDataTest</span><span class="params">()</span></span> &#123;</span><br><span class="line">        WifiLiveData.getInstance(<span class="keyword">this</span>).observe(<span class="keyword">this</span>, Observer &#123;</span><br><span class="line">            Log.e(<span class="string">&quot;LiveDataActivity&quot;</span>, it.toString()) <span class="comment">// 观察者收到数据更新的通知，打印 Wifi 信号强度</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>当组件（Activity）处于激活状态（onActive）时注册广播，处于非激活状态（onInactive）时注销广播。</p>
</blockquote>
<h3 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h3><h4 id="observe-注册流程"><a href="#observe-注册流程" class="headerlink" title="observe 注册流程"></a>observe 注册流程</h4><p>LiveData 通过 observe() 方法将被观察者 LifecycleOwner (Activity &#x2F; Fragment) 和观察者 Observer 关联起来。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LiveData.observe(LifecycleOwner owner , Observer&lt;T&gt; observer)</span><br></pre></td></tr></table></figure>

<p>进入 LiveData 的 observe() 方法中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">observe</span><span class="params">(<span class="meta">@NonNull</span> LifecycleOwner owner, <span class="meta">@NonNull</span> Observer&lt;T&gt; observer)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (owner.getLifecycle().getCurrentState() == DESTROYED) &#123;</span><br><span class="line">        <span class="comment">// 若 LifecycleOwner 处于 DESTROYED 状态，则返回</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// LifecycleBoundObserver 把 LifecycleOwner 对象和 Observer 对象包装在一起</span></span><br><span class="line">    <span class="type">LifecycleBoundObserver</span> <span class="variable">wrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LifecycleBoundObserver</span>(owner, observer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// mObservers（类似 Map 的容器）的 putIfAbsent() 方法用于判断容器中的 observer（key）</span></span><br><span class="line">    <span class="comment">// 是否已有 wrapper（value）与之关联</span></span><br><span class="line">    <span class="comment">// 若已关联则直接返回关联值，否则关联后再返回 wrapper</span></span><br><span class="line">    <span class="type">ObserverWrapper</span> <span class="variable">existing</span> <span class="operator">=</span> mObservers.putIfAbsent(observer, wrapper);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (existing != <span class="literal">null</span> &amp;&amp; !existing.isAttachedTo(owner)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Cannot add the same observer&quot;</span></span><br><span class="line">                + <span class="string">&quot; with different lifecycles&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (existing != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 由于 LifecycleBoundObserver 实现了 GenericLifecycleObserver 接口，而 GenericLifecycleObserver 又</span></span><br><span class="line">    <span class="comment">// 继承了 LifecycleObserver，所以 LifecycleBoundObserver 本质是一个 LifecycleObserver</span></span><br><span class="line">    <span class="comment">// 此处属于注册过程， Lifecycle 添加观察者 LifecycleObserver</span></span><br><span class="line">    owner.getLifecycle().addObserver(wrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面的代码可知，observe() 方法最终是会调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LifecycleOwner.getLifecycle().addObserver(LifecycleObserver)</span><br></pre></td></tr></table></figure>

<p>因此 LiveData 是能够感知观察者的生命周期变化的。</p>
<h4 id="感知生命周期变化"><a href="#感知生命周期变化" class="headerlink" title="感知生命周期变化"></a>感知生命周期变化</h4><p>通过以上的分析，我们知道 LifecycleBoundObserver（LiveData 的内部类）是观察者，以下具体分析 LifecycleBoundObserver 的实现过程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LifecycleBoundObserver</span> <span class="keyword">extends</span> <span class="title class_">ObserverWrapper</span> <span class="keyword">implements</span> <span class="title class_">GenericLifecycleObserver</span> &#123;</span><br><span class="line">    <span class="meta">@NonNull</span> <span class="keyword">final</span> LifecycleOwner mOwner;</span><br><span class="line"></span><br><span class="line">    LifecycleBoundObserver(<span class="meta">@NonNull</span> LifecycleOwner owner, Observer&lt;T&gt; observer) &#123;</span><br><span class="line">        <span class="built_in">super</span>(observer); <span class="comment">// 保存 Observer</span></span><br><span class="line">        mOwner = owner;  <span class="comment">// 保存 LifecycleOwner</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">shouldBeActive</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 判断是否处于激活状态</span></span><br><span class="line">        <span class="keyword">return</span> mOwner.getLifecycle().getCurrentState().isAtLeast(STARTED);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStateChanged</span><span class="params">(LifecycleOwner source, Lifecycle.Event event)</span> &#123;</span><br><span class="line">        <span class="comment">// 若 Lifecycle 处于 DESTROYED 状态，则移除 Observer 对象</span></span><br><span class="line">        <span class="keyword">if</span> (mOwner.getLifecycle().getCurrentState() == DESTROYED) &#123;</span><br><span class="line">            <span class="comment">// 移除观察者，在这个方法中会移除生命周期监听并且回调 activeStateChanged() 方法</span></span><br><span class="line">            removeObserver(mObserver);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 若处于激活状态，则调用 activeStateChanged() 方法</span></span><br><span class="line">        activeStateChanged(shouldBeActive());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isAttachedTo</span><span class="params">(LifecycleOwner owner)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mOwner == owner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">detachObserver</span><span class="params">()</span> &#123;</span><br><span class="line">        mOwner.getLifecycle().removeObserver(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当组件（Activity &#x2F; Fragment）的生命周期发生改变时，onStateChanged() 方法将会被调用。若当前处于 DESTROYED 状态，则会移除观察者；若当前处于激活状态，则会调用 activeStateChanged() 方法。activeStateChanged() 方法位于父类 ObserverWrapper 中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">activeStateChanged</span><span class="params">(<span class="type">boolean</span> newActive)</span> &#123;</span><br><span class="line">    <span class="comment">// 若新旧状态一致，则返回</span></span><br><span class="line">    <span class="keyword">if</span> (newActive == mActive) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// immediately set active state, so we&#x27;d never dispatch anything to inactive owner</span></span><br><span class="line">    mActive = newActive;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">wasInactive</span> <span class="operator">=</span> LiveData.<span class="built_in">this</span>.mActiveCount == <span class="number">0</span>;</span><br><span class="line">    LiveData.<span class="built_in">this</span>.mActiveCount += mActive ? <span class="number">1</span> : -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (wasInactive &amp;&amp; mActive) &#123; <span class="comment">// 激活状态的 observer 个数从 0 到 1</span></span><br><span class="line">        onActive(); <span class="comment">// 空实现，一般让子类去重写</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (LiveData.<span class="built_in">this</span>.mActiveCount == <span class="number">0</span> &amp;&amp; !mActive) &#123; <span class="comment">// 激活状态的 observer 个数从 1 到 0</span></span><br><span class="line">        onInactive();  <span class="comment">// 空实现，一般让子类去重写</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mActive) &#123; <span class="comment">// 激活状态，向观察者发送 LiveData 的值</span></span><br><span class="line">        dispatchingValue(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再看看最终调用的 dispatchingValue() 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">dispatchingValue</span><span class="params">(<span class="meta">@Nullable</span> ObserverWrapper initiator)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        mDispatchInvalidated = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (initiator != <span class="literal">null</span>) &#123;</span><br><span class="line">            considerNotify(initiator);</span><br><span class="line">            initiator = <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 循环遍历 mObservers 这个 map , 向每一个观察者都发送新的数据</span></span><br><span class="line">            <span class="keyword">for</span> (Iterator&lt;Map.Entry&lt;Observer&lt;T&gt;, ObserverWrapper&gt;&gt; iterator =</span><br><span class="line">                    mObservers.iteratorWithAdditions(); iterator.hasNext(); ) &#123;</span><br><span class="line">                considerNotify(iterator.next().getValue());</span><br><span class="line">                <span class="keyword">if</span> (mDispatchInvalidated) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (mDispatchInvalidated);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到 dispatchingValue() 方法里面再通过 considerNotify() 方法将消息通知下去。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">considerNotify</span><span class="params">(ObserverWrapper observer)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    observer.mObserver.onChanged((T) mData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的 mObserver 正是我们调用 observe() 方法时传入的观察者。</p>
<p>总结上面的分析就是：<strong>调用 LiveData.observe(LifecycleOwner owner , Observer<T> observer) 进行注册后，当 LiveData 数据发生变化后，最终就会调用 Observer 对象的 onChanged() 方法，并把变化的数据作为参数回传。</strong></p>
<h4 id="通知观察者更新数据的方式"><a href="#通知观察者更新数据的方式" class="headerlink" title="通知观察者更新数据的方式"></a>通知观察者更新数据的方式</h4><p>LiveData 为我们提供了两种改变数据后，通知观察者更新数据的方式，一个是 setValue() 方法（<strong>必须在主线程调用</strong>），另一个是 postValue() 方法（<strong>必须在子线程调用</strong>）。</p>
<p><strong>setValue() 方法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(T value)</span> &#123;</span><br><span class="line">    assertMainThread(<span class="string">&quot;setValue&quot;</span>);</span><br><span class="line">    mVersion++;</span><br><span class="line">    mData = value;</span><br><span class="line">    dispatchingValue(<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>dispatchingValue() 方法会跑我们上面分析的流程，最终把改变的数据 value（对应上面的 mData）作为 onChanged() 方法的参数传给观察者。</p>
<p><strong>postValue() 方法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">postValue</span><span class="params">(T value)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> postTask;</span><br><span class="line">    <span class="keyword">synchronized</span> (mDataLock) &#123;</span><br><span class="line">        postTask = mPendingData == NOT_SET;</span><br><span class="line">        mPendingData = value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!postTask) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ArchTaskExecutor.getInstance().postToMainThread(mPostValueRunnable);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Runnable</span> <span class="variable">mPostValueRunnable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        Object newValue;</span><br><span class="line">        <span class="keyword">synchronized</span> (mDataLock) &#123;</span><br><span class="line">            newValue = mPendingData;</span><br><span class="line">            mPendingData = NOT_SET;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//noinspection unchecked</span></span><br><span class="line">        setValue((T) newValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>可以看出 postValue() 方法最终也会在主线程中调用 setValue() 方法。</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3poaWNoL0FuZHJvaWRKZXRwYWNrRGVtbw==">文中 Demo GitHub 地址<i class="fa fa-external-link-alt"></i></span></p>
<p>参考资料：</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1NFVV9DYWx2aW4vYXJ0aWNsZS9kZXRhaWxzLzgyMjU2Njkz">Android开发——架构组件LiveData源码解析<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vdG9waWMvbGlicmFyaWVzL2FyY2hpdGVjdHVyZS9saWZlY3ljbGU=">Android Developers<i class="fa fa-external-link-alt"></i></span></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zhich.github.io/2018/11/06/Android-Jetpack-%E4%B9%8B-LifeCycle/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="明年今日">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="明年今日">
      <meta itemprop="description" content="终身学习者。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 明年今日">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/11/06/Android-Jetpack-%E4%B9%8B-LifeCycle/" class="post-title-link" itemprop="url">Android Jetpack 之 Lifecycle</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-11-06 21:15:00" itemprop="dateCreated datePublished" datetime="2018-11-06T21:15:00+08:00">2018-11-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-06-03 22:53:51" itemprop="dateModified" datetime="2024-06-03T22:53:51+08:00">2024-06-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <meta name="referrer" content="no-referrer" />






<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>在日常的开发中，我们通常需要在 Activity &#x2F; Fragment 的生命周期方法中进行一些繁重的操作，这样使代码看起来十分臃肿。Lifecycle 的引入主要是用来管理和响应 Activity &#x2F; Fragment 的生命周期的变化，帮助我们编写出更易于组织且通常更加轻量级的代码，让代码变得更易于维护。</p>
<p>Lifecycle 是一个类，它持有 Activity &#x2F; Fragment 生命周期状态的信息，并允许其它对象观察此状态。</p>
<h3 id="Lifecycle-使用"><a href="#Lifecycle-使用" class="headerlink" title="Lifecycle 使用"></a>Lifecycle 使用</h3><p><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vdG9waWMvbGlicmFyaWVzL2FyY2hpdGVjdHVyZS9hZGRpbmctY29tcG9uZW50cw==">添加相关依赖<i class="fa fa-external-link-alt"></i></span></p>
<p>场景：让 MVP 中的 Presenter 观察 Activity 的 onCreate 和 onDestroy 状态。</p>
<ul>
<li>Presenter 继承 LifecycleObserver 接口</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">IPresenter</span> : <span class="type">LifecycleObserver</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnLifecycleEvent(Lifecycle.Event.ON_CREATE)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(owner: <span class="type">LifecycleOwner</span>)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnLifecycleEvent(Lifecycle.Event.ON_DESTROY)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">onDestroy</span><span class="params">(owner: <span class="type">LifecycleOwner</span>)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnLifecycleEvent(Lifecycle.Event.ON_ANY)</span> <span class="comment">// ON_ANY 注解能观察到其它所有的生命周期方法</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">onLifecycleChanged</span><span class="params">(owner: <span class="type">LifecycleOwner</span>, event: <span class="type">Lifecycle</span>.<span class="type">Event</span>)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyPresenter</span> : <span class="type">IPresenter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(owner: <span class="type">LifecycleOwner</span>)</span></span> &#123;</span><br><span class="line">        Log.e(javaClass.simpleName, <span class="string">&quot;onCreate&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDestroy</span><span class="params">(owner: <span class="type">LifecycleOwner</span>)</span></span> &#123;</span><br><span class="line">        Log.e(javaClass.simpleName, <span class="string">&quot;onDestroy&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onLifecycleChanged</span><span class="params">(owner: <span class="type">LifecycleOwner</span>, event: <span class="type">Lifecycle</span>.<span class="type">Event</span>)</span></span> &#123;</span><br><span class="line"><span class="comment">//        Log.e(javaClass.simpleName, &quot;onLifecycleChanged&quot;)</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在 Activity 中添加 LifecycleObserver</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyLifecycleActivity</span> : <span class="type">AppCompatActivity</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> myPresenter: MyPresenter</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_my_lifecycle)</span><br><span class="line"></span><br><span class="line">        Log.e(javaClass.simpleName, <span class="string">&quot;onCreate&quot;</span>)</span><br><span class="line"></span><br><span class="line">        myPresenter = MyPresenter()</span><br><span class="line">        lifecycle.addObserver(myPresenter) <span class="comment">// 添加 LifecycleObserver</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDestroy</span><span class="params">()</span></span> &#123;</span><br><span class="line">        Log.e(javaClass.simpleName, <span class="string">&quot;onDestroy&quot;</span>)</span><br><span class="line">        <span class="keyword">super</span>.onDestroy()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动 Activity 会打印：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MyLifecycleActivity: onCreate</span><br><span class="line">MyPresenter: onCreate</span><br></pre></td></tr></table></figure>

<p>finish Activity 会打印：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MyPresenter: onDestroy</span><br><span class="line">MyLifecycleActivity: onDestroy</span><br></pre></td></tr></table></figure>

<p>以上 Presenter 对象只观察了 Activity 的 onCreate 方法和 onDestroy 方法，我们还可以观察其它的生命周期方法。在 Lifecycle 内部有个枚举类 Event , 它包含了 LifecycleObserver 能够观察到的所有生命周期方法，只需要添加上相应的注解即可。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="keyword">class</span> <span class="title class_">Event</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constant for onCreate event of the [LifecycleOwner].</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ON_CREATE,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constant for onStart event of the [LifecycleOwner].</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ON_START,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constant for onResume event of the [LifecycleOwner].</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ON_RESUME,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constant for onPause event of the [LifecycleOwner].</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ON_PAUSE,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constant for onStop event of the [LifecycleOwner].</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ON_STOP,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constant for onDestroy event of the [LifecycleOwner].</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ON_DESTROY,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * An [Event] constant that can be used to match all events.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ON_ANY</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Lifecycle 内部还有代表了各个<strong>生命周期所处状态</strong>的枚举类 State</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="keyword">class</span> <span class="title class_">State</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Destroyed state for a LifecycleOwner. After this event, this Lifecycle will not dispatch</span></span><br><span class="line"><span class="comment">     * any more events. For instance, for an [android.app.Activity], this state is reached</span></span><br><span class="line"><span class="comment">     * before Activity&#x27;s [onDestroy] call.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    DESTROYED,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Initialized state for a LifecycleOwner. For an [android.app.Activity], this is</span></span><br><span class="line"><span class="comment">     * the state when it is constructed but has not received</span></span><br><span class="line"><span class="comment">     * [onCreate] yet.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    INITIALIZED,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Created state for a LifecycleOwner. For an [android.app.Activity], this state</span></span><br><span class="line"><span class="comment">     * is reached in two cases:</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * after [onCreate] call;</span></span><br><span class="line"><span class="comment">     * before [onStop] call.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    CREATED,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Started state for a LifecycleOwner. For an [android.app.Activity], this state</span></span><br><span class="line"><span class="comment">     * is reached in two cases:</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * after [onStart] call;</span></span><br><span class="line"><span class="comment">     * before [onPause] call.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    STARTED,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Resumed state for a LifecycleOwner. For an [android.app.Activity], this state</span></span><br><span class="line"><span class="comment">     * is reached after [onResume] is called.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    RESUMED;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Compares if this State is greater or equal to the given `state`.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> state State to compare with</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true if this State is greater or equal to the given `state`</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">isAtLeast</span><span class="params">(state: <span class="type">State</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> compareTo(state) &gt;= <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在一般开发中，当 Activity 拥有多个 Presenter 并需要在各个生命周期做一些特殊逻辑时，代码可能是：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onStop</span><span class="params">()</span></span> &#123;</span><br><span class="line">    presenter1.onStop()</span><br><span class="line">    presenter2.onStop()</span><br><span class="line">    presenter3.onStop()</span><br><span class="line">    <span class="keyword">super</span>.onStop()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDestroy</span><span class="params">()</span></span> &#123;</span><br><span class="line">    presenter1.onDestroy()</span><br><span class="line">    presenter2.onDestroy()</span><br><span class="line">    presenter3.onDestroy()</span><br><span class="line">    <span class="keyword">super</span>.onDestroy()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样会使 Activity 的代码变得很臃肿。</p>
<p>如果用 Lifecycle , 只需将持有 Lifecycle 对象的 Activity 的生命周期的响应分发到各个 LifecycleObserver 观察者中即可。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">    setContentView(R.layout.activity_my_lifecycle)</span><br><span class="line">    </span><br><span class="line">    lifecycle.addObserver(presenter1) <span class="comment">// 添加 LifecycleObserver</span></span><br><span class="line">    lifecycle.addObserver(presenter2) <span class="comment">// 添加 LifecycleObserver</span></span><br><span class="line">    lifecycle.addObserver(presenter3) <span class="comment">// 添加 LifecycleObserver</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h3><p><strong>几个概念</strong></p>
<ul>
<li><p><strong>LifecycleObserver 接口</strong></p>
<p>Lifecycle 观察者。实现了该接口的类，被 LifecycleOwner 类的 addObserver 方法注册后，通过注解的方式即可观察到 LifecycleOwner 的生命周期方法。</p>
</li>
<li><p><strong>LifecycleOwner 接口</strong></p>
<p>Lifecycle 持有者。实现了该接口的类持有生命周期（Lifecycle 对象），该接口生命周期（Lifecycle 对象）的改变会被其注册的观察者 LifecycleObserver 观察到并触发其对应的事件。</p>
</li>
<li><p><strong>Lifecycle 类</strong></p>
<p>生命周期。和 LifecycleOwner 不同，LifecycleOwner 通过 getLifecycle() 方法获取到内部的 Lifecycle 对象。</p>
</li>
<li><p><strong>State</strong></p>
<p>当前生命周期所处状态。Lifecycle 将 Activity 的生命周期函数对应成 State .</p>
</li>
<li><p><strong>Event</strong></p>
<p>当前生命周期改变对应的事件。State 变化将触发 Event 事件，从而被已注册的 LifecycleObserver 接收。</p>
</li>
</ul>
<p><strong>实现原理</strong></p>
<h4 id="LifecycleOwner"><a href="#LifecycleOwner" class="headerlink" title="LifecycleOwner"></a>LifecycleOwner</h4><p>  AppCompatActivity 的父类 <code>SupportActivity</code> 和 <code>Fragment</code> 一样，实现了 LifecycleOwner 接口，因此它们都拥有 Lifecycle 对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SupportActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> <span class="keyword">implements</span> <span class="title class_">LifecycleOwner</span>, Component &#123;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// ... </span></span><br><span class="line">   </span><br><span class="line">    <span class="keyword">private</span> <span class="type">LifecycleRegistry</span> <span class="variable">mLifecycleRegistry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LifecycleRegistry</span>(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Lifecycle <span class="title function_">getLifecycle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.mLifecycleRegistry;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">LifecycleOwner</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the Lifecycle of the provider.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The lifecycle of the provider.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    Lifecycle <span class="title function_">getLifecycle</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从源码可知 getLifecycle() 方法返回的是 <code>LifecycleRegistry</code> 对象，而 LifecycleRegistry 是 Lifecycle 的子类，所有对 LifecycleObserver 的操作都是由 LifecycleRegistry 完成的。</p>
<h4 id="LifecycleRegistry"><a href="#LifecycleRegistry" class="headerlink" title="LifecycleRegistry"></a>LifecycleRegistry</h4><p>  生命周期登记处。作为 Lifecycle 的子类，它的作用是添加观察者、响应生命周期事件和分发生命周期事件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LifecycleRegistry</span> <span class="keyword">extends</span> <span class="title class_">Lifecycle</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// LifecycleObserver Map , 每一个 Observer 都有一个 State</span></span><br><span class="line">    <span class="keyword">private</span> FastSafeIterableMap&lt;LifecycleObserver, ObserverWithState&gt; mObserverMap =</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">FastSafeIterableMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前的状态</span></span><br><span class="line">    <span class="keyword">private</span> State mState;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Lifecycle 持有者，如继承了 LifecycleOwner 的 SupportActivity</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WeakReference&lt;LifecycleOwner&gt; mLifecycleOwner;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LifecycleRegistry</span><span class="params">(<span class="meta">@NonNull</span> LifecycleOwner provider)</span> &#123;</span><br><span class="line">        mLifecycleOwner = <span class="keyword">new</span> <span class="title class_">WeakReference</span>&lt;&gt;(provider);</span><br><span class="line">        mState = INITIALIZED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 添加 LifecycleObserver 观察者，并将之前的状态分发给这个 Observer , 例如我们在 onResume 之后注册这个 Observer , </span></span><br><span class="line"><span class="comment">    * 该 Observer 依然能收到 ON_CREATE 事件</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addObserver</span><span class="params">(<span class="meta">@NonNull</span> LifecycleObserver observer)</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// 例如：Observer 初始状态是 INITIALIZED , 当前状态是 RESUMED , 需要将 INITIALIZED 到 RESUMED 之间的</span></span><br><span class="line">        <span class="comment">// 所有事件分发给 Observer</span></span><br><span class="line">        <span class="keyword">while</span> ((statefulObserver.mState.compareTo(targetState) &lt; <span class="number">0</span></span><br><span class="line">                &amp;&amp; mObserverMap.contains(observer))) &#123;</span><br><span class="line">            pushParentState(statefulObserver.mState);</span><br><span class="line">            statefulObserver.dispatchEvent(lifecycleOwner, upEvent(statefulObserver.mState));</span><br><span class="line">            popParentState();</span><br><span class="line">            <span class="comment">// mState / subling may have been changed recalculate</span></span><br><span class="line">            targetState = calculateTargetState(observer);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理生命周期事件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLifecycleEvent</span><span class="params">(<span class="meta">@NonNull</span> Lifecycle.Event event)</span> &#123;</span><br><span class="line">        <span class="type">State</span> <span class="variable">next</span> <span class="operator">=</span> getStateAfter(event);</span><br><span class="line">        moveToState(next);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 改变状态</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">moveToState</span><span class="params">(State next)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mState == next) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mState = next;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        sync();</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步 Observer 状态，并分发事件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sync</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">LifecycleOwner</span> <span class="variable">lifecycleOwner</span> <span class="operator">=</span> mLifecycleOwner.get();</span><br><span class="line">        <span class="keyword">if</span> (lifecycleOwner == <span class="literal">null</span>) &#123;</span><br><span class="line">            Log.w(LOG_TAG, <span class="string">&quot;LifecycleOwner is garbage collected, you shouldn&#x27;t try dispatch &quot;</span></span><br><span class="line">                    + <span class="string">&quot;new events from it.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (!isSynced()) &#123;</span><br><span class="line">            mNewEventOccurred = <span class="literal">false</span>;</span><br><span class="line">            <span class="comment">// State 中，状态值是从 DESTROYED - INITIALIZED - CREATED - STARTED - RESUMED 增大</span></span><br><span class="line">            <span class="comment">// 如果当前状态值 &lt; Observer 状态值，需要通知 Observer 减小状态值，直到等于当前状态值</span></span><br><span class="line">            <span class="keyword">if</span> (mState.compareTo(mObserverMap.eldest().getValue().mState) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                backwardPass(lifecycleOwner);</span><br><span class="line">            &#125;</span><br><span class="line">            Entry&lt;LifecycleObserver, ObserverWithState&gt; newest = mObserverMap.newest();</span><br><span class="line">            <span class="comment">// 如果当前状态值 &gt; Observer 状态值，需要通知 Observer 增大状态值，直到等于当前状态值</span></span><br><span class="line">            <span class="keyword">if</span> (!mNewEventOccurred &amp;&amp; newest != <span class="literal">null</span></span><br><span class="line">                    &amp;&amp; mState.compareTo(newest.getValue().mState) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                forwardPass(lifecycleOwner);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mNewEventOccurred = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 向前传递事件。</span></span><br><span class="line"><span class="comment">     * 增加 Observer 的状态值，直到状态值等于当前状态值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">forwardPass</span><span class="params">(LifecycleOwner lifecycleOwner)</span> &#123;</span><br><span class="line">        Iterator&lt;Entry&lt;LifecycleObserver, ObserverWithState&gt;&gt; ascendingIterator =</span><br><span class="line">                mObserverMap.iteratorWithAdditions();</span><br><span class="line">        <span class="keyword">while</span> (ascendingIterator.hasNext() &amp;&amp; !mNewEventOccurred) &#123;</span><br><span class="line">            Entry&lt;LifecycleObserver, ObserverWithState&gt; entry = ascendingIterator.next();</span><br><span class="line">            <span class="type">ObserverWithState</span> <span class="variable">observer</span> <span class="operator">=</span> entry.getValue();</span><br><span class="line">            <span class="keyword">while</span> ((observer.mState.compareTo(mState) &lt; <span class="number">0</span> &amp;&amp; !mNewEventOccurred</span><br><span class="line">                    &amp;&amp; mObserverMap.contains(entry.getKey()))) &#123;</span><br><span class="line">                pushParentState(observer.mState);</span><br><span class="line">                <span class="comment">// 分发状态改变事件</span></span><br><span class="line">                observer.dispatchEvent(lifecycleOwner, upEvent(observer.mState));</span><br><span class="line">                popParentState();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 向后传递事件。</span></span><br><span class="line"><span class="comment">     * 减小 Observer 的状态值，直到状态值等于当前状态值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">backwardPass</span><span class="params">(LifecycleOwner lifecycleOwner)</span> &#123;</span><br><span class="line">        Iterator&lt;Entry&lt;LifecycleObserver, ObserverWithState&gt;&gt; descendingIterator =</span><br><span class="line">                mObserverMap.descendingIterator();</span><br><span class="line">        <span class="keyword">while</span> (descendingIterator.hasNext() &amp;&amp; !mNewEventOccurred) &#123;</span><br><span class="line">            Entry&lt;LifecycleObserver, ObserverWithState&gt; entry = descendingIterator.next();</span><br><span class="line">            <span class="type">ObserverWithState</span> <span class="variable">observer</span> <span class="operator">=</span> entry.getValue();</span><br><span class="line">            <span class="keyword">while</span> ((observer.mState.compareTo(mState) &gt; <span class="number">0</span> &amp;&amp; !mNewEventOccurred</span><br><span class="line">                    &amp;&amp; mObserverMap.contains(entry.getKey()))) &#123;</span><br><span class="line">                <span class="type">Event</span> <span class="variable">event</span> <span class="operator">=</span> downEvent(observer.mState);</span><br><span class="line">                pushParentState(getStateAfter(event));</span><br><span class="line">                observer.dispatchEvent(lifecycleOwner, event);</span><br><span class="line">                popParentState();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据上面的分析，我们知道 LifecycleRegistry 才是真正替 Lifecycle 去埋头干粗活的类！</p>
<p>接下来继续来看看实现了 LifecycleOwner 接口的 SupportActivity 类是如何将事件分发给 LifecycleRegistry 的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SupportActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> <span class="keyword">implements</span> <span class="title class_">LifecycleOwner</span>, Component &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(<span class="meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        ReportFragment.injectIfNeededIn(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意到 SupportActivity 的 onCreate() 方法里面有行 <code>ReportFragment.injectIfNeededIn(this)</code> 代码，再进入 ReportFragment 类分析。</p>
<h4 id="ReportFragment"><a href="#ReportFragment" class="headerlink" title="ReportFragment"></a>ReportFragment</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReportFragment</span> <span class="keyword">extends</span> <span class="title class_">Fragment</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">injectIfNeededIn</span><span class="params">(Activity activity)</span> &#123;</span><br><span class="line">        android.app.<span class="type">FragmentManager</span> <span class="variable">manager</span> <span class="operator">=</span> activity.getFragmentManager();</span><br><span class="line">        <span class="keyword">if</span> (manager.findFragmentByTag(REPORT_FRAGMENT_TAG) == <span class="literal">null</span>) &#123;</span><br><span class="line">            manager.beginTransaction().add(<span class="keyword">new</span> <span class="title class_">ReportFragment</span>(), REPORT_FRAGMENT_TAG).commit();</span><br><span class="line">            manager.executePendingTransactions();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onActivityCreated</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onActivityCreated(savedInstanceState);</span><br><span class="line">        dispatchCreate(mProcessListener);</span><br><span class="line">        dispatch(Lifecycle.Event.ON_CREATE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStart</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onStart();</span><br><span class="line">        dispatchStart(mProcessListener);</span><br><span class="line">        dispatch(Lifecycle.Event.ON_START);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResume</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onResume();</span><br><span class="line">        dispatchResume(mProcessListener);</span><br><span class="line">        dispatch(Lifecycle.Event.ON_RESUME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPause</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onPause();</span><br><span class="line">        dispatch(Lifecycle.Event.ON_PAUSE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStop</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onStop();</span><br><span class="line">        dispatch(Lifecycle.Event.ON_STOP);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onDestroy();</span><br><span class="line">        dispatch(Lifecycle.Event.ON_DESTROY);</span><br><span class="line">        <span class="comment">// just want to be sure that we won&#x27;t leak reference to an activity</span></span><br><span class="line">        mProcessListener = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分发事件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">dispatch</span><span class="params">(Lifecycle.Event event)</span> &#123;</span><br><span class="line">        <span class="type">Activity</span> <span class="variable">activity</span> <span class="operator">=</span> getActivity();</span><br><span class="line">        <span class="keyword">if</span> (activity <span class="keyword">instanceof</span> LifecycleRegistryOwner) &#123;</span><br><span class="line">            ((LifecycleRegistryOwner) activity).getLifecycle().handleLifecycleEvent(event);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (activity <span class="keyword">instanceof</span> LifecycleOwner) &#123;</span><br><span class="line">            <span class="type">Lifecycle</span> <span class="variable">lifecycle</span> <span class="operator">=</span> ((LifecycleOwner) activity).getLifecycle();</span><br><span class="line">            <span class="keyword">if</span> (lifecycle <span class="keyword">instanceof</span> LifecycleRegistry) &#123;</span><br><span class="line">                ((LifecycleRegistry) lifecycle).handleLifecycleEvent(event);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不难看出这是一个没有 UI 的后台 Fragment , 一般可以为 Activity 提供一些后台行为。在 ReportFragment 的各个生命周期中都调用了 LifecycleRegistry.handleLifecycleEvent() 方法来分发生命周期事件。</p>
<p><strong>为什么不直接在 SupportActivity 的生命周期函数中给 Lifecycle 分发生命周期事件，而是要加一个 Fragment 呢？</strong></p>
<p>在 ReportFragment 的 injectIfNeededIn() 方法中找到答案：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">injectIfNeededIn</span><span class="params">(Activity activity)</span> &#123;</span><br><span class="line">    <span class="comment">// ProcessLifecycleOwner should always correctly work and some activities may not extend</span></span><br><span class="line">    <span class="comment">// FragmentActivity from support lib, so we use framework fragments for activities</span></span><br><span class="line">    android.app.<span class="type">FragmentManager</span> <span class="variable">manager</span> <span class="operator">=</span> activity.getFragmentManager();</span><br><span class="line">    <span class="keyword">if</span> (manager.findFragmentByTag(REPORT_FRAGMENT_TAG) == <span class="literal">null</span>) &#123;</span><br><span class="line">        manager.beginTransaction().add(<span class="keyword">new</span> <span class="title class_">ReportFragment</span>(), REPORT_FRAGMENT_TAG).commit();</span><br><span class="line">        <span class="comment">// Hopefully, we are the first to make a transaction.</span></span><br><span class="line">        manager.executePendingTransactions();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有两个原因：为了能让 ProcessLifecycleOwner 正确地工作；②、并非所有的 Activity 都是继承来自 support 包的 FragmentActivity 类的。因此封装一个同样具有生命周期的后台 Fragment 来给 Lifecycle 分发生命周期事件。</p>
<p><strong>另一方面，假如我们不继承自 SupportActivity , 那 Lifecycle 是如何通过 ReportFragment 分发生命周期事件呢？</strong></p>
<p>鼠标停在 ReportFragment 类，同时按下 <code>Ctrl + Shift + Alt + F7</code> 在 Project and Libraries 的范围下搜索 ReportFragment 被引用的地方。我们发现还有 LifecycleDispatcher 和 ProcessLifecycleOwner 两个类有使用到 ReportFragment .</p>
<h4 id="LifecycleDispatcher"><a href="#LifecycleDispatcher" class="headerlink" title="LifecycleDispatcher"></a>LifecycleDispatcher</h4><p>生命周期分发者。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LifecycleDispatcher</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (sInitialized.getAndSet(<span class="literal">true</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ((Application) context.getApplicationContext())</span><br><span class="line">                .registerActivityLifecycleCallbacks(<span class="keyword">new</span> <span class="title class_">DispatcherActivityCallback</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过注册 Application.registerActivityLifecycleCallbacks 来获取 Activity 的生命周期回调</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DispatcherActivityCallback</span> <span class="keyword">extends</span> <span class="title class_">EmptyActivityLifecycleCallbacks</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> FragmentCallback mFragmentCallback;</span><br><span class="line"></span><br><span class="line">        DispatcherActivityCallback() &#123;</span><br><span class="line">            mFragmentCallback = <span class="keyword">new</span> <span class="title class_">FragmentCallback</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onActivityCreated</span><span class="params">(Activity activity, Bundle savedInstanceState)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (activity <span class="keyword">instanceof</span> FragmentActivity) &#123;</span><br><span class="line">                ((FragmentActivity) activity).getSupportFragmentManager()</span><br><span class="line">                        .registerFragmentLifecycleCallbacks(mFragmentCallback, <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 给每个 Activity 添加 ReportFragment</span></span><br><span class="line">            ReportFragment.injectIfNeededIn(activity);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onActivityStopped</span><span class="params">(Activity activity)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (activity <span class="keyword">instanceof</span> FragmentActivity) &#123;</span><br><span class="line">                markState((FragmentActivity) activity, CREATED);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onActivitySaveInstanceState</span><span class="params">(Activity activity, Bundle outState)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (activity <span class="keyword">instanceof</span> FragmentActivity) &#123;</span><br><span class="line">                markState((FragmentActivity) activity, CREATED);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过递归形式给所有子 Fragment 设置 State</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">markState</span><span class="params">(FragmentManager manager, State state)</span> &#123;</span><br><span class="line">        Collection&lt;Fragment&gt; fragments = manager.getFragments();</span><br><span class="line">        <span class="keyword">if</span> (fragments == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (Fragment fragment : fragments) &#123;</span><br><span class="line">            <span class="keyword">if</span> (fragment == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            markStateIn(fragment, state);</span><br><span class="line">            <span class="keyword">if</span> (fragment.isAdded()) &#123;</span><br><span class="line">                <span class="comment">// 递归</span></span><br><span class="line">                markState(fragment.getChildFragmentManager(), state);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">markStateIn</span><span class="params">(Object object, State state)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (object <span class="keyword">instanceof</span> LifecycleRegistryOwner) &#123;</span><br><span class="line">            <span class="type">LifecycleRegistry</span> <span class="variable">registry</span> <span class="operator">=</span> ((LifecycleRegistryOwner) object).getLifecycle();</span><br><span class="line">            registry.markState(state);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将某 Activity 及其所有子 Fragment 的 State 设置为某状态 </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">markState</span><span class="params">(FragmentActivity activity, State state)</span> &#123;</span><br><span class="line">        markStateIn(activity, state);</span><br><span class="line">        markState(activity.getSupportFragmentManager(), state);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从源码可知，LifecycleDispatcher 是通过注册 Application.registerActivityLifecycleCallbacks 来监听 Activity 的生命周期回调的。</p>
<ul>
<li>在 onActivityCreated 中添加 ReportFragment , 将 Activity 的生命周期交给 ReportFragment 去分发给 LifecycleRegistry ;</li>
<li>在 onActivityStopped() 以及 onActivitySaveInstanceState() 中，将 Activity 及其所有子 Fragment 的 State 置为 CREATED .</li>
</ul>
<h4 id="ProcessLifecycleOwner"><a href="#ProcessLifecycleOwner" class="headerlink" title="ProcessLifecycleOwner"></a>ProcessLifecycleOwner</h4><p>为整个 App 进程提供生命周期的类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProcessLifecycleOwner</span> <span class="keyword">implements</span> <span class="title class_">LifecycleOwner</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">TIMEOUT_MS</span> <span class="operator">=</span> <span class="number">700</span>; <span class="comment">//mls</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        sInstance.attach(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">ActivityInitializationListener</span> <span class="variable">mInitializationListener</span> <span class="operator">=</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ActivityInitializationListener</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">()</span> &#123;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStart</span><span class="params">()</span> &#123;</span><br><span class="line">                    activityStarted();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResume</span><span class="params">()</span> &#123;</span><br><span class="line">                    activityResumed();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">activityStarted</span><span class="params">()</span> &#123;</span><br><span class="line">        mStartedCounter++;</span><br><span class="line">        <span class="keyword">if</span> (mStartedCounter == <span class="number">1</span> &amp;&amp; mStopSent) &#123;</span><br><span class="line">            mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_START);</span><br><span class="line">            mStopSent = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">activityResumed</span><span class="params">()</span> &#123;</span><br><span class="line">        mResumedCounter++;</span><br><span class="line">        <span class="keyword">if</span> (mResumedCounter == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mPauseSent) &#123;</span><br><span class="line">                mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_RESUME);</span><br><span class="line">                mPauseSent = <span class="literal">false</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mHandler.removeCallbacks(mDelayedPauseRunnable);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">activityPaused</span><span class="params">()</span> &#123;</span><br><span class="line">        mResumedCounter--;</span><br><span class="line">        <span class="keyword">if</span> (mResumedCounter == <span class="number">0</span>) &#123;</span><br><span class="line">            mHandler.postDelayed(mDelayedPauseRunnable, TIMEOUT_MS);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">activityStopped</span><span class="params">()</span> &#123;</span><br><span class="line">        mStartedCounter--;</span><br><span class="line">        dispatchStopIfNeeded();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">attach</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        mHandler = <span class="keyword">new</span> <span class="title class_">Handler</span>();</span><br><span class="line">        mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_CREATE);</span><br><span class="line">        <span class="type">Application</span> <span class="variable">app</span> <span class="operator">=</span> (Application) context.getApplicationContext();</span><br><span class="line">        app.registerActivityLifecycleCallbacks(<span class="keyword">new</span> <span class="title class_">EmptyActivityLifecycleCallbacks</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onActivityCreated</span><span class="params">(Activity activity, Bundle savedInstanceState)</span> &#123;</span><br><span class="line">                ReportFragment.get(activity).setProcessListener(mInitializationListener);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onActivityPaused</span><span class="params">(Activity activity)</span> &#123;</span><br><span class="line">                activityPaused();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onActivityStopped</span><span class="params">(Activity activity)</span> &#123;</span><br><span class="line">                activityStopped();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从源码可知：</p>
<ul>
<li>ProcessLifecycleOwner 是用来监听 Application 生命周期的，它只会分发一次 ON_CREATE 事件，并不会分发 ON_DESTROY 事件；</li>
<li>ProcessLifecycleOwner 在 Activity 的 onResume 中调用 Handle.postDelayed() , 在 onPause 中调用了 mHandler.removeCallbacks(mDelayedPauseRunnable) , 是为了处理 Activity 重建时比如横竖屏幕切换时，不会发送事件；</li>
<li>ProcessLifecycleOwner 一般用来判断应用是在前台还是后台，但由于使用了 Handle.postDelayed() , TIMEOUT_MS &#x3D; 700，因此这个判断不是即时的，有 700ms 的延迟；</li>
<li>ProcessLifecycleOwner 与 LifecycleDispatcher 一样，都是通过注册 Application.registerActivityLifecycleCallbacks 来监听 Activity 的生命周期回调，来给每个 Activity 添加 ReportFragment 的。</li>
</ul>
<p>最后，通过点击 init() 方法，我们发现 LifecycleDispatcher 和 ProcessLifecycleOwner 都是在 ProcessLifecycleOwnerInitializer 类下完成初始化的，而 ProcessLifecycleOwnerInitializer 是一个 ContentProvider .</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProcessLifecycleOwnerInitializer</span> <span class="keyword">extends</span> <span class="title class_">ContentProvider</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onCreate</span><span class="params">()</span> &#123;</span><br><span class="line">        LifecycleDispatcher.init(getContext());</span><br><span class="line">        ProcessLifecycleOwner.init(getContext());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Lifecycle 会自动在我们的 AndroidManifest.xml 中添加以下代码用于初始化 ProcessLifecycleOwner 与 LifecycleDispatcher , 这样就不需要我们在 Application 中写代码来初始化了。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span>&gt;</span></span><br><span class="line">  // ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">provider</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;android.arch.lifecycle.ProcessLifecycleOwnerInitializer&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:authorities</span>=<span class="string">&quot;me.baron.achitecturelearning.lifecycle-trojan&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:multiprocess</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Lifecycle-的最佳实践"><a href="#Lifecycle-的最佳实践" class="headerlink" title="Lifecycle 的最佳实践"></a>Lifecycle 的最佳实践</h3><ul>
<li>保持 Activity &#x2F; Fragment 尽可能的精简，它们不应该试图去获取它们所需的数据，要用 ViewModel 来获取，并观察 LiveData 对象将数据变化反映到视图中；</li>
<li>尝试编写数据驱动（data-driven）的 UI , 即 UI 控制器的责任是在数据改变时更新视图或者将用户的操作通知给 ViewModel ;</li>
<li>将数据逻辑放到 ViewModel 类中，ViewModel 应该作为 UI 控制器和应用程序其它部分的连接服务。注意：不是由 ViewModel 负责获取数据（例如：从网络获取）。相反，ViewModel 调用相应的组件获取数据，然后将数据获取结果提供给 UI 控制器；</li>
<li>使用 Data Binding 来保持视图和 UI 控制器之间的接口干净。这样可以让视图更具声明性，并且尽可能减少在 Activity 和 Fragment 中编写更新代码。如果你喜欢在 Java 中执行该操作，请使用像 Butter Knife 这样的库来避免使用样板代码并进行更好的抽象化；</li>
<li>如果 UI 很复杂，可以考虑创建一个 Presenter 类来处理 UI 的修改。虽然通常这样做不是必要的，但可能会让 UI 更容易测试；</li>
<li>不要在 ViewModel 中引用 View 或者 Activity 的 context . 因为如果 ViewModel 存活的比 Activity 时间长（在配置更改的情况下），Activity 将会被泄漏并且无法被正确的回收。</li>
</ul>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3poaWNoL0FuZHJvaWRKZXRwYWNrRGVtbw==">文中 Demo GitHub 地址<i class="fa fa-external-link-alt"></i></span></p>
<p>参考资料：</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9zZWdtZW50ZmF1bHQuY29tL2EvMTE5MDAwMDAxNjQ0MzEwOCNhcnRpY2xlSGVhZGVyOQ==">Android-Lifecycle超能解析-生命周期的那些事儿<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21xMjU1MzI5OS9hcnRpY2xlL2RldGFpbHMvNzkwMjk2NTc=">Android官方架构组件:Lifecycle详解&amp;原理分析<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vdG9waWMvbGlicmFyaWVzL2FyY2hpdGVjdHVyZS9saWZlY3ljbGU=">Android Developers<i class="fa fa-external-link-alt"></i></span></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2016 – 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Copyright © 明年今日。 All Rights Reserved.</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl" data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZw==">NexT.Gemini</span> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL3poaWNo" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.0/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>



  <script src="/js/third-party/pace.js"></script>


  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  <script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"url":"https://zhich.github.io/"}</script>
  <script src="/js/third-party/quicklink.js"></script>

</body>
</html>
